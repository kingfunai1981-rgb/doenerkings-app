<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Bestellungen bereinigen</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1000px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
h1 { color: #E31E24; margin-bottom: 20px; font-size: 28px; }
.warning {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  color: #92400e;
}
.order-item {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.order-item.old {
  border-color: #fca5a5;
  background: #fef2f2;
}
.order-info {
  flex: 1;
}
.order-number {
  font-size: 20px;
  font-weight: 700;
  color: #E31E24;
  margin-bottom: 4px;
}
.order-details {
  font-size: 14px;
  color: #6b7280;
}
.order-age {
  font-size: 12px;
  color: #dc2626;
  font-weight: 600;
  margin-top: 4px;
}
button {
  padding: 10px 20px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-left: 8px;
}
button:hover { opacity: 0.9; }
button.danger { background: #dc2626; }
button.success { background: #10b981; }
button.secondary { background: #6b7280; }
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.stat-card {
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  color: white;
  padding: 16px;
  border-radius: 12px;
  text-align: center;
}
.stat-card .value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}
.stat-card .label {
  font-size: 12px;
  opacity: 0.9;
}
.loading {
  text-align: center;
  padding: 40px;
  color: #6b7280;
}
.result {
  padding: 12px;
  border-radius: 8px;
  margin-top: 12px;
  font-size: 14px;
}
.success-msg { background: #dcfce7; color: #166534; border: 2px solid #86efac; }
.error-msg { background: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }
.actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}
.filter-section {
  background: #f9fafb;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
}
.filter-section label {
  font-weight: 600;
  margin-right: 8px;
  color: #374151;
}
.filter-section select {
  padding: 8px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  margin-right: 12px;
}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>üßπ Admin - Bestellungen bereinigen</h1>
    
    <div class="warning">
      <strong>‚ö†Ô∏è ACHTUNG:</strong> Dieses Tool bereinigt alte "h√§ngengebliebene" Bestellungen.
      Verwende es nur f√ºr Bestellungen die tats√§chlich abgeschlossen wurden!
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="value" id="statTotal">-</div>
        <div class="label">Offene Bestellungen</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statOld">-</div>
        <div class="label">√Ñlter als 1 Std</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statVeryOld">-</div>
        <div class="label">√Ñlter als 4 Std</div>
      </div>
    </div>

    <div class="filter-section">
      <label>Anzeigen:</label>
      <select id="filterAge" onchange="applyFilter()">
        <option value="all">Alle offenen Bestellungen</option>
        <option value="1h">√Ñlter als 1 Stunde</option>
        <option value="4h" selected>√Ñlter als 4 Stunden</option>
        <option value="24h">√Ñlter als 24 Stunden</option>
      </select>
      
      <label>Status:</label>
      <select id="filterStatus" onchange="applyFilter()">
        <option value="all">Alle Status</option>
        <option value="pending">Ausstehend</option>
        <option value="preparing">In Vorbereitung</option>
        <option value="ready">Bereit zur Abholung</option>
      </select>
    </div>

    <div class="actions">
      <button onclick="loadOrders()" class="secondary">üîÑ Aktualisieren</button>
      <button onclick="completeSelectedOld()" class="success">‚úÖ Alle alten als "Abgeschlossen" markieren</button>
      <button onclick="deleteSelectedOld()" class="danger">üóëÔ∏è Alle alten l√∂schen (permanent)</button>
    </div>

    <div id="result"></div>
  </div>

  <div class="card">
    <h2 style="margin-bottom: 16px; color: #374151;">üì¶ Offene Bestellungen</h2>
    <div id="ordersList" class="loading">
      ‚è≥ Lade Bestellungen...
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚ö†Ô∏è WICHTIG: Supabase Credentials hier einf√ºgen!
const SUPABASE_URL = 'DEINE_SUPABASE_URL'
const SUPABASE_ANON_KEY = 'DEIN_SUPABASE_ANON_KEY'

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allOrders = []
let filteredOrders = []

async function loadOrders() {
  try {
    showResult('‚è≥ Lade Bestellungen...', 'info')
    
    // Lade alle offenen Bestellungen
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .in('status', ['pending', 'preparing', 'ready'])
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Fehler:', error)
      showResult('‚ùå Fehler beim Laden: ' + error.message, 'error')
      document.getElementById('ordersList').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #dc2626;">
          <h3>‚ùå Fehler beim Laden</h3>
          <p>${error.message}</p>
          <p style="margin-top: 12px; font-size: 12px;">Bitte √ºberpr√ºfe die Supabase Credentials.</p>
        </div>
      `
      return
    }

    allOrders = data || []
    applyFilter()
    updateStats()
    showResult('‚úÖ Bestellungen geladen!', 'success')

  } catch (e) {
    console.error('Fehler:', e)
    showResult('‚ùå Fehler: ' + e.message, 'error')
  }
}

function applyFilter() {
  const ageFilter = document.getElementById('filterAge').value
  const statusFilter = document.getElementById('filterStatus').value
  
  let filtered = [...allOrders]
  
  // Status Filter
  if (statusFilter !== 'all') {
    filtered = filtered.filter(o => o.status === statusFilter)
  }
  
  // Alters-Filter
  const now = new Date()
  if (ageFilter !== 'all') {
    const hours = parseInt(ageFilter)
    const cutoff = new Date(now - hours * 60 * 60 * 1000)
    filtered = filtered.filter(o => new Date(o.created_at) < cutoff)
  }
  
  filteredOrders = filtered
  renderOrders(filtered)
}

function updateStats() {
  const now = new Date()
  const oneHourAgo = new Date(now - 60 * 60 * 1000)
  const fourHoursAgo = new Date(now - 4 * 60 * 60 * 1000)
  
  const oldOrders = allOrders.filter(o => new Date(o.created_at) < oneHourAgo)
  const veryOldOrders = allOrders.filter(o => new Date(o.created_at) < fourHoursAgo)
  
  document.getElementById('statTotal').textContent = allOrders.length
  document.getElementById('statOld').textContent = oldOrders.length
  document.getElementById('statVeryOld').textContent = veryOldOrders.length
}

function renderOrders(orders) {
  const container = document.getElementById('ordersList')
  
  if (!orders || orders.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #6b7280;">
        <div style="font-size: 48px; margin-bottom: 12px;">‚úÖ</div>
        <h3>Keine Bestellungen gefunden</h3>
        <p>F√ºr die ausgew√§hlten Filter gibt es keine Bestellungen.</p>
      </div>
    `
    return
  }

  const now = new Date()
  
  container.innerHTML = orders.map(order => {
    const createdAt = new Date(order.created_at)
    const ageHours = (now - createdAt) / (1000 * 60 * 60)
    const isOld = ageHours > 1
    
    return `
      <div class="order-item ${isOld ? 'old' : ''}">
        <div class="order-info">
          <div class="order-number">#${order.order_number}</div>
          <div class="order-details">
            ${order.customer_name} | ${order.payment_method === 'paypal' ? 'üí≥ PayPal' : 'üíµ Bar'} | 
            ${formatPrice(order.total)} | 
            Status: <strong>${getStatusText(order.status)}</strong>
          </div>
          <div class="order-age">
            ‚è∞ Erstellt: ${formatDateTime(createdAt)} (${getTimeAgo(createdAt)})
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="completeOrder('${order.id}')" class="success" style="font-size: 12px; padding: 8px 12px;">
            ‚úÖ Abschlie√üen
          </button>
          <button onclick="deleteOrder('${order.id}')" class="danger" style="font-size: 12px; padding: 8px 12px;">
            üóëÔ∏è L√∂schen
          </button>
        </div>
      </div>
    `
  }).join('')
}

function getStatusText(status) {
  const texts = {
    pending: '‚è≥ Ausstehend',
    preparing: 'üë®‚Äçüç≥ In Vorbereitung',
    ready: 'üì¶ Bereit'
  }
  return texts[status] || status
}

function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000)
  if (seconds < 60) return 'Gerade eben'
  if (seconds < 3600) return `vor ${Math.floor(seconds / 60)} Min`
  const hours = Math.floor(seconds / 3600)
  if (hours < 24) return `vor ${hours} Std`
  return `vor ${Math.floor(hours / 24)} Tagen`
}

function formatDateTime(date) {
  return date.toLocaleString('de-DE', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

function formatPrice(price) {
  return parseFloat(price).toFixed(2).replace('.', ',') + ' ‚Ç¨'
}

async function completeOrder(orderId) {
  if (!confirm('Diese Bestellung als "Abgeschlossen" markieren?')) return
  
  try {
    showResult('‚è≥ Bearbeite Bestellung...', 'info')
    
    const { error } = await supabase
      .from('orders')
      .update({ 
        status: 'completed',
        completed_at: new Date().toISOString()
      })
      .eq('id', orderId)
    
    if (error) throw error
    
    showResult('‚úÖ Bestellung abgeschlossen!', 'success')
    loadOrders()
    
  } catch (e) {
    console.error('Fehler:', e)
    showResult('‚ùå Fehler: ' + e.message, 'error')
  }
}

async function deleteOrder(orderId) {
  if (!confirm('‚ö†Ô∏è ACHTUNG: Diese Bestellung permanent l√∂schen?\n\nDies kann nicht r√ºckg√§ngig gemacht werden!')) return
  
  try {
    showResult('‚è≥ L√∂sche Bestellung...', 'info')
    
    const { error } = await supabase
      .from('orders')
      .delete()
      .eq('id', orderId)
    
    if (error) throw error
    
    showResult('‚úÖ Bestellung gel√∂scht!', 'success')
    loadOrders()
    
  } catch (e) {
    console.error('Fehler:', e)
    showResult('‚ùå Fehler: ' + e.message, 'error')
  }
}

async function completeSelectedOld() {
  if (filteredOrders.length === 0) {
    alert('Keine Bestellungen zum Abschlie√üen gefunden!')
    return
  }
  
  const count = filteredOrders.length
  if (!confirm(`${count} Bestellung(en) als "Abgeschlossen" markieren?`)) return
  
  try {
    showResult('‚è≥ Bearbeite Bestellungen...', 'info')
    
    const ids = filteredOrders.map(o => o.id)
    
    const { error } = await supabase
      .from('orders')
      .update({ 
        status: 'completed',
        completed_at: new Date().toISOString()
      })
      .in('id', ids)
    
    if (error) throw error
    
    showResult(`‚úÖ ${count} Bestellung(en) abgeschlossen!`, 'success')
    loadOrders()
    
  } catch (e) {
    console.error('Fehler:', e)
    showResult('‚ùå Fehler: ' + e.message, 'error')
  }
}

async function deleteSelectedOld() {
  if (filteredOrders.length === 0) {
    alert('Keine Bestellungen zum L√∂schen gefunden!')
    return
  }
  
  const count = filteredOrders.length
  if (!confirm(`‚ö†Ô∏è ACHTUNG: ${count} Bestellung(en) permanent l√∂schen?\n\nDies kann nicht r√ºckg√§ngig gemacht werden!`)) return
  
  try {
    showResult('‚è≥ L√∂sche Bestellungen...', 'info')
    
    const ids = filteredOrders.map(o => o.id)
    
    const { error } = await supabase
      .from('orders')
      .delete()
      .in('id', ids)
    
    if (error) throw error
    
    showResult(`‚úÖ ${count} Bestellung(en) gel√∂scht!`, 'success')
    loadOrders()
    
  } catch (e) {
    console.error('Fehler:', e)
    showResult('‚ùå Fehler: ' + e.message, 'error')
  }
}

function showResult(message, type) {
  const resultDiv = document.getElementById('result')
  const className = type === 'success' ? 'success-msg' : type === 'error' ? 'error-msg' : 'result'
  resultDiv.innerHTML = `<div class="result ${className}">${message}</div>`
  
  if (type !== 'info') {
    setTimeout(() => {
      resultDiv.innerHTML = ''
    }, 5000)
  }
}

// Initial laden
loadOrders()

// Auto-Refresh alle 30 Sekunden
setInterval(loadOrders, 30000)
</script>
</body>
</html>
