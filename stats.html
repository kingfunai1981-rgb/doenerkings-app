<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š Business Intelligence - DÃ¶ner Boxx</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<style>
@font-face { font-family: 'Flame'; src: url('Flame-Regular.ttf') format('truetype'); font-weight: normal; font-style: normal; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Flame', system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.header-card { display: flex; align-items: center; gap: 20px; }
.header-logo { width: 80px; height: 80px; flex-shrink: 0; }
.header-logo img { width: 100%; height: 100%; object-fit: contain; }
.header-text { flex: 1; }
h1 { color: #E31E24; font-size: 28px; margin-bottom: 8px; }
h2 { color: #374151; font-size: 20px; margin-bottom: 16px; }
.subtitle { color: #6b7280; font-size: 14px; margin-bottom: 20px; }
.form-label { display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
input[type="date"] { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; margin-bottom: 10px; }
button { padding: 12px 20px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
button.success { background: #F9A825; color: white; width: 100%; }
button.success:hover { background: #f59e0b; }
.stat-btn { padding: 10px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; margin-right: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 600; color: #374151; display: inline-block; }
.stat-btn:hover { border-color: #F9A825; background: #fef3c7; color: #92400e; }
.stat-btn.active { background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border-color: #E31E24; }
</style>
</head>
<body>

<div class="container">
  <div class="card header-card">
    <div class="header-logo"><img src="/logo-round-new.png" alt="DÃ¶ner Boxx"></div>
    <div class="header-text"><h1>ğŸ“Š Business Intelligence</h1><p class="subtitle">Alle Statistiken mit echten Daten aus deiner Datenbank</p></div>
  </div>

  <div class="card" style="border: 3px solid #F9A825;">
    <!-- Zeitraum-Filter -->
    <div style="background: #f9fafb; border-radius: 10px; padding: 16px; margin-bottom: 16px;">
      <label class="form-label">ğŸ“… Zeitraum wÃ¤hlen:</label>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px;">
        <button class="stat-btn" onclick="setTimeRange('today')">Heute</button>
        <button class="stat-btn active" id="btn-7days" onclick="setTimeRange('7days')">7 Tage</button>
        <button class="stat-btn" onclick="setTimeRange('30days')">30 Tage</button>
        <button class="stat-btn" onclick="setTimeRange('thisMonth')">Dieser Monat</button>
        <button class="stat-btn" onclick="setTimeRange('lastMonth')">Letzter Monat</button>
        <button class="stat-btn" onclick="setTimeRange('all')">Alle Zeit</button>
        <button class="stat-btn" onclick="setTimeRange('custom')">Custom</button>
      </div>
      
      <div id="custom-date-range" style="display: none;">
        <div class="form-grid">
          <div>
            <label class="form-label">Von:</label>
            <input type="date" id="date-from">
          </div>
          <div>
            <label class="form-label">Bis:</label>
            <input type="date" id="date-to">
          </div>
        </div>
        <button class="success" onclick="applyCustomRange()">âœ“ Anwenden</button>
      </div>
    </div>
    
    <!-- Statistik-Navigation -->
    <div style="margin-bottom: 16px;">
      <button class="stat-btn active" id="btn-coupon" onclick="loadCouponStats()">ğŸŸï¸ Coupon ROI</button>
      <button class="stat-btn" id="btn-rewards" onclick="loadRewardStats()">ğŸ† PrÃ¤mien-Ranking</button>
      <button class="stat-btn" id="btn-weather" onclick="loadWeatherStats()">ğŸŒ§ï¸ Wetter-Deals</button>
      <button class="stat-btn" id="btn-wheel" onclick="loadWheelStats()">ğŸ¡ GlÃ¼cksrad</button>
      <button class="stat-btn" id="btn-challenges" onclick="loadChallengeStats()">âš¡ Challenges</button>
      <button class="stat-btn" id="btn-segments" onclick="loadSegmentStats()">ğŸ‘¥ Segmente</button>
      <button class="stat-btn" id="btn-trends" onclick="loadTrendStats()">ğŸ“ˆ Trends</button>
    </div>
    
    <!-- Stats Content -->
    <div id="stats-content" style="background: #f9fafb; border-radius: 12px; padding: 20px; min-height: 400px;">
      <div style="text-align: center; padding: 40px; color: #6b7280;">â³ Initialisiere Statistiken...</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

// âœ… Auto-detect ob 'action' oder 'type' Spalte existiert (ohne 400-Fehler)
let ACTION_COLUMN = null

async function detectActionColumn() {
  if (ACTION_COLUMN !== null) return ACTION_COLUMN
  
  const { data, error } = await supabase
    .from('transactions')
    .select('*')
    .limit(1)

  if (error) {
    console.error('âŒ Fehler beim transactions-Check:', error)
    // Fallback
    ACTION_COLUMN = 'type'
    console.log('âš ï¸ Fallback: Using column "type"')
    return ACTION_COLUMN
  }

  const row = data?.[0] || {}

  if ('action' in row) {
    ACTION_COLUMN = 'action'
    console.log('âœ… Detected column: action')
  } else if ('type' in row) {
    ACTION_COLUMN = 'type'
    console.log('âœ… Detected column: type')
  } else {
    // Fallback, falls beides nicht existiert
    ACTION_COLUMN = 'type'
    console.log('âš ï¸ Neither "action" nor "type" found, using "type" as fallback')
  }

  return ACTION_COLUMN
}

let currentTimeRange = { start: null, end: null, label: '7days' }

function setTimeRange(range, skipReload = false) {
  const now = new Date()
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
  
  document.querySelectorAll('.stat-btn[onclick^="setTimeRange"]').forEach(btn => btn.classList.remove('active'))
  currentTimeRange.label = range
  
  switch(range) {
    case 'today':
      currentTimeRange.start = today
      currentTimeRange.end = new Date(today.getTime() + 24*60*60*1000)
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case '7days':
      currentTimeRange.start = new Date(now.getTime() - 7*24*60*60*1000)
      currentTimeRange.end = now
      document.getElementById('custom-date-range').style.display = 'none'
      document.getElementById('btn-7days').classList.add('active')
      break
    case '30days':
      currentTimeRange.start = new Date(now.getTime() - 30*24*60*60*1000)
      currentTimeRange.end = now
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'thisMonth':
      currentTimeRange.start = new Date(now.getFullYear(), now.getMonth(), 1)
      currentTimeRange.end = now
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'lastMonth':
      currentTimeRange.start = new Date(now.getFullYear(), now.getMonth() - 1, 1)
      currentTimeRange.end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59)
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'all':
      currentTimeRange.start = null
      currentTimeRange.end = null
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'custom':
      document.getElementById('custom-date-range').style.display = 'block'
      return
  }
  
  console.log('ğŸ• Zeitraum gesetzt:', currentTimeRange)
  
  if (!skipReload) {
    const activeStatBtn = document.querySelector('.stat-btn[onclick^="load"].active')
    if (activeStatBtn) activeStatBtn.click()
  }
}

function applyCustomRange() {
  const from = document.getElementById('date-from').value
  const to = document.getElementById('date-to').value
  
  if (!from || !to) {
    alert('Bitte beide Daten auswÃ¤hlen!')
    return
  }
  
  currentTimeRange.start = new Date(from)
  currentTimeRange.end = new Date(to + 'T23:59:59')
  currentTimeRange.label = 'custom'
  
  console.log('ğŸ• Custom Range:', currentTimeRange)
  
  const activeStatBtn = document.querySelector('.stat-btn[onclick^="load"].active')
  if (activeStatBtn) activeStatBtn.click()
}

function filterByTimeRange(data, dateField = 'created_at') {
  const total = data?.length || 0
  
  // WICHTIG: Bei "all" keine Filterung
  if (!currentTimeRange.start || !currentTimeRange.end) {
    console.log('â­ Alle Zeit ausgewÃ¤hlt - kein Filter')
    return data
  }
  
  const filtered = data?.filter(item => {
    const date = new Date(item[dateField])
    return date >= currentTimeRange.start && date <= currentTimeRange.end
  })
  
  console.log(`ğŸ“Š Filter: ${total} â†’ ${filtered?.length || 0} EintrÃ¤ge`)
  return filtered
}

async function loadCouponStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade Coupon-Statistiken...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-coupon').classList.add('active')
  
  try {
    const { data: coupons } = await supabase.from('coupons').select('*')
    let { data: activations, error: activationsError } = await supabase
      .from('activated_coupons')
      .select('*, coupons(title, product, price)')
    
    if (activationsError) {
      console.error('âŒ Activations error:', activationsError)
      throw activationsError
    }
    
    console.log('ğŸ“¦ Alle Aktivierungen:', activations?.length)
    const allCount = activations?.length || 0
    activations = filterByTimeRange(activations, 'activated_at')
    console.log('âœ… Nach Filter:', activations?.length)
    
    const totalCoupons = coupons?.length || 0
    const activeCoupons = coupons?.filter(c => c.is_active).length || 0
    const totalActivations = activations?.length || 0
    const usedActivations = activations?.filter(a => a.is_used).length || 0
    
    const couponMap = new Map()
    activations?.forEach(a => {
      const title = a.coupons?.title || 'Unbekannt'
      if (!couponMap.has(title)) {
        couponMap.set(title, { title, activated: 0, used: 0 })
      }
      const entry = couponMap.get(title)
      entry.activated++
      if (a.is_used) entry.used++
    })
    
    const topCoupons = Array.from(couponMap.values())
      .map(c => ({
        ...c,
        rate: c.activated > 0 ? Math.round((c.used / c.activated) * 100) : 0,
        revenue: c.used * 6
      }))
      .sort((a, b) => b.activated - a.activated)
      .slice(0, 5)
    
    const conversionRate = totalActivations > 0 ? Math.round((usedActivations / totalActivations) * 100) : 0
    const revenue = usedActivations * 6
    const avgIncrease = totalActivations > 0 ? (revenue / totalActivations).toFixed(2) : 0
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸŸï¸ Coupon ROI Analyse</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Zeitraum:</strong> ${currentTimeRange.label}<br>
        <span style="color: #1e3a8a;">Gesamt: ${allCount} | Nach Filter: ${totalActivations}</span>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #E31E24;">${totalCoupons}</div>
          <div style="font-size: 13px; color: #6b7280;">Total Coupons</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #10b981;">${activeCoupons}</div>
          <div style="font-size: 13px; color: #6b7280;">Aktive Coupons</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #F9A825;">${totalActivations}</div>
          <div style="font-size: 13px; color: #6b7280;">Aktivierungen</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${usedActivations}</div>
          <div style="font-size: 13px; color: #6b7280;">EinlÃ¶sungen</div>
        </div>
      </div>
      
      <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 16px;">
        <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ’° Performance</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
          <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #10b981;">${conversionRate}%</div>
            <div style="font-size: 12px; color: #6b7280;">Conversion</div>
          </div>
          <div style="background: #dcfce7; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #22c55e;">
            <div style="font-size: 24px; font-weight: 700; color: #166534;">${revenue}â‚¬</div>
            <div style="font-size: 12px; color: #166534;">Umsatz</div>
          </div>
          <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #F9A825;">+${avgIncrease}â‚¬</div>
            <div style="font-size: 12px; color: #6b7280;">Ã˜ pro Kunde</div>
          </div>
        </div>
      </div>
      
      ${topCoupons.length > 0 ? `
        <div style="background: white; padding: 20px; border-radius: 10px;">
          <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ† Top Coupons</div>
          ${topCoupons.map((c, i) => `
            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${i === 0 ? '#F9A825' : '#e5e7eb'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: #111827;">${i + 1}. ${c.title}</div>
                  <div style="font-size: 12px; color: #6b7280;">Aktiviert: ${c.activated}x | EingelÃ¶st: ${c.used}x</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 18px; font-weight: 700; color: ${c.rate >= 75 ? '#22c55e' : c.rate >= 50 ? '#f59e0b' : '#6b7280'};">${c.rate}%</div>
                  <div style="font-size: 11px; color: #6b7280;">${c.revenue}â‚¬</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<div style="text-align: center; padding: 20px; color: #6b7280;">Noch keine Coupon-Daten im gewÃ¤hlten Zeitraum</div>'}
    `
  } catch (e) {
    console.error('âŒ Fehler:', e)
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadRewardStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade PrÃ¤mien-Statistiken...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-rewards')?.classList.add('active')
  
  try {
    // âœ… Detect action column
    const actionCol = await detectActionColumn()
    
    let { data: redeems, error: redeemsError } = await supabase
      .from('transactions')
      .select('points, created_at')
      .eq(actionCol, 'redeem')
    
    if (redeemsError) {
      console.error('âŒ Redeems error:', redeemsError)
      throw redeemsError
    }
    
    const allCount = redeems?.length || 0
    redeems = filterByTimeRange(redeems)
    
    const rewardMap = new Map()
    redeems?.forEach(r => {
      const points = Math.abs(r.points)  // âœ… FIX: use 'points' not 'amount'
      if (!rewardMap.has(points)) {
        rewardMap.set(points, 0)
      }
      rewardMap.set(points, rewardMap.get(points) + 1)
    })
    
    const rewards = Array.from(rewardMap.entries())
      .map(([points, count]) => ({
        points,
        count,
        name: points >= 1000 ? 'GroÃŸe PrÃ¤mie' : points >= 500 ? 'Mittlere PrÃ¤mie' : 'Kleine PrÃ¤mie',
        emoji: points >= 1000 ? 'ğŸ¥™' : points >= 500 ? 'ğŸŸ' : 'ğŸ¥¤'
      }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5)
    
    const totalRedeems = redeems?.length || 0
    const totalPoints = redeems?.reduce((sum, r) => sum + Math.abs(r.points), 0) || 0  // âœ… FIX: use 'points'
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ† PrÃ¤mien-Ranking</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Zeitraum:</strong> ${currentTimeRange.label}<br>
        <span style="color: #1e3a8a;">Gesamt: ${allCount} | Nach Filter: ${totalRedeems}</span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #F9A825;">${totalRedeems}</div>
          <div style="font-size: 13px; color: #6b7280;">EingelÃ¶ste PrÃ¤mien</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #E31E24;">${totalPoints}</div>
          <div style="font-size: 13px; color: #6b7280;">Verbrauchte Punkte</div>
        </div>
      </div>
      
      ${rewards.length > 0 ? rewards.map((r, i) => `
        <div style="background: white; padding: 16px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid ${i === 0 ? '#F9A825' : '#e5e7eb'};">
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 36px;">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…'}</div>
            <div>
              <div style="font-size: 18px; font-weight: 700; color: #111827;">${r.emoji} ${r.name}</div>
              <div style="font-size: 13px; color: #6b7280;">${r.points} Punkte</div>
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 28px; font-weight: 700; color: #F9A825;">${r.count}x</div>
            <div style="font-size: 12px; color: #6b7280;">eingelÃ¶st</div>
          </div>
        </div>
      `).join('') : '<div style="text-align: center; padding: 40px; color: #6b7280;">Noch keine PrÃ¤mien eingelÃ¶st</div>'}
    `
  } catch (e) {
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadWeatherStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade Wetter-Deal Statistiken...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-weather')?.classList.add('active')
  
  try {
    const { data: coupons } = await supabase.from('coupons').select('*')
    let { data: activations, error: activationsError } = await supabase
      .from('activated_coupons')
      .select('*, coupons(title, product)')
    
    if (activationsError) {
      console.error('âŒ Activations error:', activationsError)
      throw activationsError
    }
    
    const allCount = activations?.length || 0
    activations = filterByTimeRange(activations, 'activated_at')
    
    const weatherDeals = coupons?.filter(c => 
      c.title?.includes('3â‚¬') || c.title?.includes('4â‚¬') || c.title?.includes('4.50â‚¬') || c.title?.includes('5â‚¬')
    ) || []
    
    const weatherActivations = activations?.filter(a => 
      a.coupons?.title?.includes('3â‚¬') || a.coupons?.title?.includes('4â‚¬') || 
      a.coupons?.title?.includes('4.50â‚¬') || a.coupons?.title?.includes('5â‚¬')
    ) || []
    
    const totalActivated = weatherActivations.length
    const totalUsed = weatherActivations.filter(a => a.is_used).length
    const avgDiscount = 30
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸŒ§ï¸ Wetter-DÃ¶ner-Deals Performance</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Zeitraum:</strong> ${currentTimeRange.label}<br>
        <span style="color: #1e3a8a;">Gesamt: ${allCount} | Weather-Activations: ${totalActivated}</span>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${weatherDeals.length}</div>
          <div style="font-size: 13px; color: #6b7280;">Aktive Deals</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #F9A825;">${totalActivated}</div>
          <div style="font-size: 13px; color: #6b7280;">Aktivierungen</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">-${avgDiscount}%</div>
          <div style="font-size: 13px; color: #6b7280;">Ã˜ Rabatt</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #10b981;">${totalUsed}</div>
          <div style="font-size: 13px; color: #6b7280;">Bestellungen</div>
        </div>
      </div>
      
      <div style="background: #dcfce7; padding: 16px; border-radius: 10px; border: 2px solid #22c55e;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size: 14px; color: #166534;">Conversion Rate:</div>
          <div style="font-size: 22px; font-weight: 900; color: #166534;">${totalActivated > 0 ? Math.round((totalUsed/totalActivated)*100) : 0}%</div>
        </div>
      </div>
    `
  } catch (e) {
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadChallengeStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade Challenge-Statistiken...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-challenges')?.classList.add('active')
  
  try {
    const { data: challenges } = await supabase.from('challenges').select('*')
    let { data: progress } = await supabase.from('challenge_progress').select('*')
    
    const totalChallenges = challenges?.length || 0
    const activeChallenges = challenges?.filter(c => c.is_active).length || 0
    const totalParticipants = new Set(progress?.map(p => p.customer_id)).size
    const completedChallenges = progress?.filter(p => p.is_completed).length || 0
    const completionRate = progress?.length > 0 ? Math.round((completedChallenges / progress.length) * 100) : 0
    
    const challengeStats = challenges?.map(c => {
      const participations = progress?.filter(p => p.challenge_id === c.id) || []
      const completed = participations.filter(p => p.is_completed).length
      return {
        title: c.title,
        participants: participations.length,
        completed,
        rate: participations.length > 0 ? Math.round((completed / participations.length) * 100) : 0,
        reward: c.reward_points
      }
    }).sort((a, b) => b.participants - a.participants).slice(0, 3) || []
    
    const totalRevenueFromChallenges = completedChallenges * 6
    const avgIncreasePerCustomer = totalParticipants > 0 ? (totalRevenueFromChallenges / totalParticipants).toFixed(2) : 0
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">âš¡ Challenge Performance</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #E31E24;">${totalChallenges}</div>
          <div style="font-size: 13px; color: #6b7280;">Total Challenges</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #10b981;">${activeChallenges}</div>
          <div style="font-size: 13px; color: #6b7280;">Aktiv</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${totalParticipants}</div>
          <div style="font-size: 13px; color: #6b7280;">Teilnehmer</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #F9A825;">${completionRate}%</div>
          <div style="font-size: 13px; color: #6b7280;">Erfolgsrate</div>
        </div>
      </div>
      
      ${challengeStats.length > 0 ? `
        <div style="background: white; padding: 20px; border-radius: 10px;">
          <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ† Top Challenges</div>
          ${challengeStats.map((c, i) => `
            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${i === 0 ? '#F9A825' : '#e5e7eb'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: #111827;">${c.title}</div>
                  <div style="font-size: 12px; color: #6b7280;">Teilnehmer: ${c.participants} | Abgeschlossen: ${c.completed}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 18px; font-weight: 700; color: ${c.rate >= 75 ? '#22c55e' : c.rate >= 50 ? '#f59e0b' : '#6b7280'};">${c.rate}%</div>
                  <div style="font-size: 11px; color: #6b7280;">${c.reward}P</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<div style="text-align: center; padding: 20px; color: #6b7280;">Noch keine Challenges vorhanden</div>'}
    `
  } catch (e) {
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadSegmentStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade Kunden-Segmente...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-segments')?.classList.add('active')
  
  try {
    // âœ… Detect action column
    const actionCol = await detectActionColumn()
    
    // âœ… FIX: Nur KÃ„UFE zÃ¤hlen
    let { data: transactions } = await supabase
      .from('transactions')
      .select('customer_id, created_at')
      .eq(actionCol, 'purchase')
    
    const allCount = transactions?.length || 0
    transactions = filterByTimeRange(transactions)
    
    const customerTxCount = new Map()
    transactions?.forEach(t => {
      customerTxCount.set(t.customer_id, (customerTxCount.get(t.customer_id) || 0) + 1)
    })
    
    let vipCount = 0, stammCount = 0, regularCount = 0, gelegentlichCount = 0, einmaligCount = 0
    
    customerTxCount.forEach(count => {
      if (count >= 20) vipCount++
      else if (count >= 10) stammCount++
      else if (count >= 5) regularCount++
      else if (count >= 2) gelegentlichCount++
      else einmaligCount++
    })
    
    const totalCustomers = customerTxCount.size || 1
    
    const segments = [
      { name: 'VIP', visits: '20+', count: vipCount, percent: Math.round((vipCount/totalCustomers)*100), color: '#dc2626' },
      { name: 'Stamm', visits: '10-19', count: stammCount, percent: Math.round((stammCount/totalCustomers)*100), color: '#f59e0b' },
      { name: 'Regular', visits: '5-9', count: regularCount, percent: Math.round((regularCount/totalCustomers)*100), color: '#3b82f6' },
      { name: 'Gelegentlich', visits: '2-4', count: gelegentlichCount, percent: Math.round((gelegentlichCount/totalCustomers)*100), color: '#6b7280' },
      { name: 'Einmalig', visits: '1', count: einmaligCount, percent: Math.round((einmaligCount/totalCustomers)*100), color: '#9ca3af' }
    ]
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ‘¥ Kunden-Segmente</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Zeitraum:</strong> ${currentTimeRange.label}<br>
        <span style="color: #1e3a8a;">KÃ¤ufe gesamt: ${allCount} | Nach Filter: ${transactions?.length || 0}</span>
      </div>
      
      <div style="background: white; padding: 16px; border-radius: 10px; margin-bottom: 16px; text-align: center;">
        <div style="font-size: 32px; font-weight: 700; color: #E31E24;">${totalCustomers}</div>
        <div style="font-size: 13px; color: #6b7280;">Aktive Kunden</div>
      </div>
      
      ${segments.map(s => `
        <div style="background: white; padding: 16px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${s.color};">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 16px; font-weight: 700; color: #111827;">${s.name}</div>
              <div style="font-size: 13px; color: #6b7280;">${s.visits} KÃ¤ufe</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 28px; font-weight: 700; color: ${s.color};">${s.count}</div>
              <div style="font-size: 13px; color: #6b7280;">${s.percent}%</div>
            </div>
          </div>
          <div style="background: #f3f4f6; height: 8px; border-radius: 4px; margin-top: 12px; overflow: hidden;">
            <div style="background: ${s.color}; height: 100%; width: ${s.percent}%; transition: width 0.3s;"></div>
          </div>
        </div>
      `).join('')}
    `
  } catch (e) {
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadTrendStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade Trend-Daten...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-trends').classList.add('active')
  
  try {
    // âœ… Detect action column
    const actionCol = await detectActionColumn()
    
    let { data: transactions, error } = await supabase
      .from('transactions')
      .select('created_at, amount, points, staff, notes')
      .eq(actionCol, 'purchase')  // â† NUR echte KÃ¤ufe!
      .order('created_at', { ascending: false })
    
    if (error) throw error
    
    console.log('ğŸ“¦ Alle KÃ„UFE geladen:', transactions?.length)
    console.log('ğŸ” Erste KÃ¤ufe:', transactions?.slice(0, 5))
    
    const allCount = transactions?.length || 0
    transactions = filterByTimeRange(transactions)
    console.log('âœ… Nach Filter:', transactions?.length)
    
    const dayCount = new Map()
    const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag']
    
    transactions?.forEach(t => {
      const date = new Date(t.created_at)
      const dayIndex = date.getDay()
      const dayName = dayNames[dayIndex]
      dayCount.set(dayName, (dayCount.get(dayName) || 0) + 1)
    })
    
    const totalTx = transactions?.length || 1
    const days = dayNames
      .map(name => ({
        name,
        orders: dayCount.get(name) || 0,
        percent: Math.round(((dayCount.get(name) || 0) / totalTx) * 100)
      }))
      .sort((a, b) => b.orders - a.orders)
    
    const hourCount = new Map()
    transactions?.forEach(t => {
      const hour = new Date(t.created_at).getHours()
      hourCount.set(hour, (hourCount.get(hour) || 0) + 1)
    })
    
    const rushHours = []
    if (hourCount.size > 0) {
      const lunchCount = [11,12,13,14].reduce((sum, h) => sum + (hourCount.get(h) || 0), 0)
      if (lunchCount > 0) rushHours.push({ time: '11-14 Uhr', count: lunchCount, percent: Math.round((lunchCount/totalTx)*100), color: '#dc2626' })
      
      const dinnerCount = [17,18,19,20].reduce((sum, h) => sum + (hourCount.get(h) || 0), 0)
      if (dinnerCount > 0) rushHours.push({ time: '17-20 Uhr', count: dinnerCount, percent: Math.round((dinnerCount/totalTx)*100), color: '#f59e0b' })
      
      const afternoonCount = [14,15,16,17].reduce((sum, h) => sum + (hourCount.get(h) || 0), 0)
      if (afternoonCount > 0) rushHours.push({ time: '14-17 Uhr', count: afternoonCount, percent: Math.round((afternoonCount/totalTx)*100), color: '#3b82f6' })
    }
    
    rushHours.sort((a, b) => b.percent - a.percent)
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ“ˆ Zeitbasierte Trends (NUR KÃ¤ufe)</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Debug-Info:</strong><br>
        <span style="color: #1e3a8a;">Gesamt KÃ¤ufe in DB: ${allCount} | Nach Zeitfilter: ${totalTx}</span>
      </div>
      
      <div style="margin-bottom: 24px;">
        <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ“… Beste Verkaufstage:</div>
        ${days.slice(0, 7).map((d, i) => `
          <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${i === 0 ? '#F9A825' : i === 1 ? '#f59e0b' : i === 2 ? '#3b82f6' : '#e5e7eb'};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="font-size: 20px;">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ“Š'}</div>
                <div style="font-size: 14px; font-weight: 600; color: #111827;">${d.name}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 20px; font-weight: 700; color: #F9A825;">${d.orders}</div>
                <div style="font-size: 13px; color: #6b7280; min-width: 40px; text-align: right;">${d.percent}%</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      ${rushHours.length > 0 ? `
        <div style="margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ• Rush-Hours:</div>
          ${rushHours.map(r => `
            <div style="background: white; padding: 14px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${r.color};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; font-weight: 600; color: #111827;">${r.time}</div>
                <div>
                  <span style="font-size: 18px; font-weight: 700; color: ${r.color};">${r.count}</span>
                  <span style="font-size: 14px; color: #6b7280; margin-left: 8px;">(${r.percent}%)</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `
  } catch (e) {
    console.error('âŒ Fehler:', e)
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadWheelStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade GlÃ¼cksrad-Statistiken...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-wheel')?.classList.add('active')
  
  try {
    let { data: spins, error } = await supabase
      .from('wheel_spins')
      .select('*')
      .order('spun_at', { ascending: false })
    
    if (error) throw error
    
    console.log('ğŸ“¦ Alle Spins geladen:', spins?.length)
    const allCount = spins?.length || 0
    spins = filterByTimeRange(spins, 'spun_at')
    console.log('âœ… Nach Filter:', spins?.length)
    
    const { data: unlocks } = await supabase.from('wheel_unlocks').select('*')
    const totalSpins = spins?.length || 0
    const totalUnlocks = unlocks?.length || 0
    
    const prizeMap = new Map()
    spins?.forEach(s => {
      const prize = s.prize_value || 'Unbekannt'
      prizeMap.set(prize, (prizeMap.get(prize) || 0) + 1)
    })
    
    const prizes = Array.from(prizeMap.entries())
      .map(([prize, count]) => ({
        prize: prize + ' Punkte',
        count,
        percent: totalSpins > 0 ? Math.round((count / totalSpins) * 100) : 0
      }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5)
    
    const weekAgo = new Date()
    weekAgo.setDate(weekAgo.getDate() - 7)
    const spinsThisWeek = spins?.filter(s => new Date(s.spun_at) >= weekAgo).length || 0
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ¡ GlÃ¼cksrad Performance</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Debug-Info:</strong><br>
        <span style="color: #1e3a8a;">Gesamt Spins in DB: ${allCount} | Nach Zeitfilter: ${totalSpins}</span>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #F9A825;">${totalSpins}</div>
          <div style="font-size: 13px; color: #6b7280;">Gesamt Spins</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${spinsThisWeek}</div>
          <div style="font-size: 13px; color: #6b7280;">Diese Woche</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #10b981;">${totalUnlocks}</div>
          <div style="font-size: 13px; color: #6b7280;">Freischaltungen</div>
        </div>
      </div>
      
      ${prizes.length > 0 ? `
        <div style="background: white; padding: 20px; border-radius: 10px;">
          <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ Gewinn-Verteilung</div>
          ${prizes.map(p => `
            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; font-weight: 600; color: #111827;">${p.prize}</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 18px; font-weight: 700; color: #F9A825;">${p.count}x</div>
                  <div style="font-size: 14px; color: #6b7280;">(${p.percent}%)</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<div style="text-align: center; padding: 20px; color: #6b7280;">Noch keine Gewinne</div>'}
    `
  } catch (e) {
    console.error('âŒ Fehler:', e)
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

window.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ Stats Page geladen (Fixed)')
  setTimeRange('7days', true)
  setTimeout(() => {
    console.log('ğŸ“Š Lade erste Statistik...')
    loadCouponStats()
  }, 300)
})

// âœ… Make functions globally accessible for onclick handlers
window.setTimeRange = setTimeRange
window.applyCustomRange = applyCustomRange
window.loadCouponStats = loadCouponStats
window.loadRewardStats = loadRewardStats
window.loadWeatherStats = loadWeatherStats
window.loadWheelStats = loadWheelStats
window.loadChallengeStats = loadChallengeStats
window.loadSegmentStats = loadSegmentStats
window.loadTrendStats = loadTrendStats

console.log('âœ… Business Intelligence geladen (FIXED)!')
</script>
</body>
</html>
