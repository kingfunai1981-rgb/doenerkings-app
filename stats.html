<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š Business Intelligence - DÃ¶ner Boxx</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<style>
@font-face { font-family: 'Flame'; src: url('Flame-Regular.ttf') format('truetype'); font-weight: normal; font-style: normal; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Flame', system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.header-card { display: flex; align-items: center; gap: 20px; }
.header-logo { width: 80px; height: 80px; flex-shrink: 0; }
.header-logo img { width: 100%; height: 100%; object-fit: contain; }
.header-text { flex: 1; }
h1 { color: #E31E24; font-size: 28px; margin-bottom: 8px; }
h2 { color: #374151; font-size: 20px; margin-bottom: 16px; }
.subtitle { color: #6b7280; font-size: 14px; margin-bottom: 20px; }
.form-label { display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
input[type="date"] { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; margin-bottom: 10px; }
button { padding: 12px 20px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
button.success { background: #F9A825; color: white; width: 100%; }
button.success:hover { background: #f59e0b; }
.stat-btn { padding: 10px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; margin-right: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 600; color: #374151; display: inline-block; }
.stat-btn:hover { border-color: #F9A825; background: #fef3c7; color: #92400e; }
.stat-btn.active { background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border-color: #E31E24; }
.debug-info { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; margin-top: 16px; font-size: 12px; font-family: monospace; color: #666; }
</style>
</head>
<body>

<div class="container">
  <div class="card header-card">
    <div class="header-logo"><img src="/logo-round-new.png" alt="DÃ¶ner Boxx"></div>
    <div class="header-text"><h1>ğŸ“Š Business Intelligence (DEBUG)</h1><p class="subtitle">Fehlersuche fÃ¼r Statistiken</p></div>
  </div>

  <div class="card" style="border: 3px solid #F9A825;">
    <!-- Zeitraum-Filter -->
    <div style="background: #f9fafb; border-radius: 10px; padding: 16px; margin-bottom: 16px;">
      <label class="form-label">ğŸ“… Zeitraum wÃ¤hlen:</label>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px;">
        <button class="stat-btn" onclick="setTimeRange('today')">Heute</button>
        <button class="stat-btn active" id="btn-7days" onclick="setTimeRange('7days')">7 Tage</button>
        <button class="stat-btn" onclick="setTimeRange('30days')">30 Tage</button>
        <button class="stat-btn" onclick="setTimeRange('thisMonth')">Dieser Monat</button>
        <button class="stat-btn" onclick="setTimeRange('lastMonth')">Letzter Monat</button>
        <button class="stat-btn" onclick="setTimeRange('all')">Alle Zeit</button>
        <button class="stat-btn" onclick="setTimeRange('custom')">Custom</button>
      </div>
      
      <div id="custom-date-range" style="display: none;">
        <div class="form-grid">
          <div>
            <label class="form-label">Von:</label>
            <input type="date" id="date-from">
          </div>
          <div>
            <label class="form-label">Bis:</label>
            <input type="date" id="date-to">
          </div>
        </div>
        <button class="success" onclick="applyCustomRange()">âœ“ Anwenden</button>
      </div>
      
      <!-- Debug-Info -->
      <div class="debug-info" id="debug-info">
        <strong>ğŸ” Debug-Info:</strong><br>
        Zeitraum: <span id="debug-range">-</span><br>
        Start: <span id="debug-start">-</span><br>
        Ende: <span id="debug-end">-</span><br>
        Alle Transaktionen: <span id="debug-total">-</span><br>
        Nach Filter: <span id="debug-filtered">-</span>
      </div>
    </div>
    
    <!-- Statistik-Navigation -->
    <div style="margin-bottom: 16px;">
      <button class="stat-btn active" id="btn-trends" onclick="loadTrendStats()">ğŸ“ˆ Trends (Debug)</button>
      <button class="stat-btn" onclick="loadWheelStats()">ğŸ¡ GlÃ¼cksrad</button>
      <button class="stat-btn" onclick="loadAllTransactions()">ğŸ“‹ Alle Transaktionen</button>
    </div>
    
    <!-- Stats Content -->
    <div id="stats-content" style="background: #f9fafb; border-radius: 12px; padding: 20px; min-height: 400px;">
      <div style="text-align: center; padding: 40px; color: #6b7280;">â³ Initialisiere Statistiken...</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

let currentTimeRange = { start: null, end: null, label: '7days' }

function updateDebugInfo(total, filtered) {
  document.getElementById('debug-range').textContent = currentTimeRange.label
  document.getElementById('debug-start').textContent = currentTimeRange.start ? currentTimeRange.start.toISOString() : 'NONE'
  document.getElementById('debug-end').textContent = currentTimeRange.end ? currentTimeRange.end.toISOString() : 'NONE'
  document.getElementById('debug-total').textContent = total || 0
  document.getElementById('debug-filtered').textContent = filtered || 0
}

function setTimeRange(range, skipReload = false) {
  const now = new Date()
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
  
  document.querySelectorAll('.stat-btn[onclick^="setTimeRange"]').forEach(btn => btn.classList.remove('active'))
  currentTimeRange.label = range
  
  switch(range) {
    case 'today':
      currentTimeRange.start = today
      currentTimeRange.end = new Date(today.getTime() + 24*60*60*1000)
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case '7days':
      currentTimeRange.start = new Date(now.getTime() - 7*24*60*60*1000)
      currentTimeRange.end = now
      document.getElementById('custom-date-range').style.display = 'none'
      document.getElementById('btn-7days').classList.add('active')
      break
    case '30days':
      currentTimeRange.start = new Date(now.getTime() - 30*24*60*60*1000)
      currentTimeRange.end = now
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'thisMonth':
      currentTimeRange.start = new Date(now.getFullYear(), now.getMonth(), 1)
      currentTimeRange.end = now
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'lastMonth':
      currentTimeRange.start = new Date(now.getFullYear(), now.getMonth() - 1, 1)
      currentTimeRange.end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59)
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'all':
      currentTimeRange.start = null
      currentTimeRange.end = null
      document.getElementById('custom-date-range').style.display = 'none'
      break
    case 'custom':
      document.getElementById('custom-date-range').style.display = 'block'
      return
  }
  
  console.log('ğŸ• Zeitraum gesetzt:', currentTimeRange)
  
  if (!skipReload) {
    const activeStatBtn = document.querySelector('.stat-btn[onclick^="load"].active')
    if (activeStatBtn) activeStatBtn.click()
  }
}

function applyCustomRange() {
  const from = document.getElementById('date-from').value
  const to = document.getElementById('date-to').value
  
  if (!from || !to) {
    alert('Bitte beide Daten auswÃ¤hlen!')
    return
  }
  
  currentTimeRange.start = new Date(from)
  currentTimeRange.end = new Date(to + 'T23:59:59')
  currentTimeRange.label = 'custom'
  
  console.log('ğŸ• Custom Range:', currentTimeRange)
  
  const activeStatBtn = document.querySelector('.stat-btn[onclick^="load"].active')
  if (activeStatBtn) activeStatBtn.click()
}

function filterByTimeRange(data, dateField = 'created_at') {
  const total = data?.length || 0
  
  // WICHTIG: Bei "all" keine Filterung
  if (!currentTimeRange.start || !currentTimeRange.end) {
    console.log('â­ Alle Zeit ausgewÃ¤hlt - kein Filter')
    updateDebugInfo(total, total)
    return data
  }
  
  const filtered = data?.filter(item => {
    const date = new Date(item[dateField])
    return date >= currentTimeRange.start && date <= currentTimeRange.end
  })
  
  console.log(`ğŸ“Š Filter: ${total} â†’ ${filtered?.length || 0} EintrÃ¤ge`)
  updateDebugInfo(total, filtered?.length || 0)
  return filtered
}

async function loadTrendStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade Trend-Daten...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  document.getElementById('btn-trends').classList.add('active')
  
  try {
    // âœ… FIX: Lade NUR KÃ¤ufe (action = 'purchase')
    let { data: transactions, error } = await supabase
      .from('transactions')
      .select('created_at, action, amount, points, staff, notes')
      .eq('action', 'purchase')  // â† NUR echte KÃ¤ufe!
      .order('created_at', { ascending: false })
    
    if (error) throw error
    
    console.log('ğŸ“¦ Alle KÃ„UFE geladen:', transactions?.length)
    
    // Debug: Zeige erste 5 EintrÃ¤ge
    console.log('ğŸ” Erste KÃ¤ufe:', transactions?.slice(0, 5))
    
    const allCount = transactions?.length || 0
    transactions = filterByTimeRange(transactions)
    console.log('âœ… Nach Filter:', transactions?.length)
    
    const dayCount = new Map()
    const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag']
    
    transactions?.forEach(t => {
      const date = new Date(t.created_at)
      const dayIndex = date.getDay()
      const dayName = dayNames[dayIndex]
      dayCount.set(dayName, (dayCount.get(dayName) || 0) + 1)
    })
    
    const totalTx = transactions?.length || 1
    const days = dayNames
      .map(name => ({
        name,
        orders: dayCount.get(name) || 0,
        percent: Math.round(((dayCount.get(name) || 0) / totalTx) * 100)
      }))
      .sort((a, b) => b.orders - a.orders)
    
    const hourCount = new Map()
    transactions?.forEach(t => {
      const hour = new Date(t.created_at).getHours()
      hourCount.set(hour, (hourCount.get(hour) || 0) + 1)
    })
    
    const rushHours = []
    if (hourCount.size > 0) {
      const lunchCount = [11,12,13,14].reduce((sum, h) => sum + (hourCount.get(h) || 0), 0)
      if (lunchCount > 0) rushHours.push({ time: '11-14 Uhr', count: lunchCount, percent: Math.round((lunchCount/totalTx)*100), color: '#dc2626' })
      
      const dinnerCount = [17,18,19,20].reduce((sum, h) => sum + (hourCount.get(h) || 0), 0)
      if (dinnerCount > 0) rushHours.push({ time: '17-20 Uhr', count: dinnerCount, percent: Math.round((dinnerCount/totalTx)*100), color: '#f59e0b' })
      
      const afternoonCount = [14,15,16,17].reduce((sum, h) => sum + (hourCount.get(h) || 0), 0)
      if (afternoonCount > 0) rushHours.push({ time: '14-17 Uhr', count: afternoonCount, percent: Math.round((afternoonCount/totalTx)*100), color: '#3b82f6' })
    }
    
    rushHours.sort((a, b) => b.percent - a.percent)
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ“ˆ Zeitbasierte Trends (NUR KÃ¤ufe)</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Debug-Info:</strong><br>
        <span style="color: #1e3a8a;">Gesamt KÃ¤ufe in DB: ${allCount} | Nach Zeitfilter: ${totalTx}</span>
      </div>
      
      <div style="margin-bottom: 24px;">
        <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ“… Beste Verkaufstage:</div>
        ${days.slice(0, 7).map((d, i) => `
          <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${i === 0 ? '#F9A825' : i === 1 ? '#f59e0b' : i === 2 ? '#3b82f6' : '#e5e7eb'};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="font-size: 20px;">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ“Š'}</div>
                <div style="font-size: 14px; font-weight: 600; color: #111827;">${d.name}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 20px; font-weight: 700; color: #F9A825;">${d.orders}</div>
                <div style="font-size: 13px; color: #6b7280; min-width: 40px; text-align: right;">${d.percent}%</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      ${rushHours.length > 0 ? `
        <div style="margin-bottom: 20px;">
          <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ• Rush-Hours:</div>
          ${rushHours.map(r => `
            <div style="background: white; padding: 14px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${r.color};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; font-weight: 600; color: #111827;">${r.time}</div>
                <div>
                  <span style="font-size: 18px; font-weight: 700; color: ${r.color};">${r.count}</span>
                  <span style="font-size: 14px; color: #6b7280; margin-left: 8px;">(${r.percent}%)</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `
  } catch (e) {
    console.error('âŒ Fehler:', e)
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadWheelStats() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade GlÃ¼cksrad-Statistiken...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  event.target.classList.add('active')
  
  try {
    let { data: spins, error } = await supabase
      .from('wheel_spins')
      .select('*')
      .order('spun_at', { ascending: false })
    
    if (error) throw error
    
    console.log('ğŸ“¦ Alle Spins geladen:', spins?.length)
    const allCount = spins?.length || 0
    spins = filterByTimeRange(spins, 'spun_at')
    console.log('âœ… Nach Filter:', spins?.length)
    
    const { data: unlocks } = await supabase.from('wheel_unlocks').select('*')
    const totalSpins = spins?.length || 0
    const totalUnlocks = unlocks?.length || 0
    
    const prizeMap = new Map()
    spins?.forEach(s => {
      const prize = s.prize_value || 'Unbekannt'
      prizeMap.set(prize, (prizeMap.get(prize) || 0) + 1)
    })
    
    const prizes = Array.from(prizeMap.entries())
      .map(([prize, count]) => ({
        prize: prize + ' Punkte',
        count,
        percent: totalSpins > 0 ? Math.round((count / totalSpins) * 100) : 0
      }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5)
    
    const weekAgo = new Date()
    weekAgo.setDate(weekAgo.getDate() - 7)
    const spinsThisWeek = spins?.filter(s => new Date(s.spun_at) >= weekAgo).length || 0
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ¡ GlÃ¼cksrad Performance</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Debug-Info:</strong><br>
        <span style="color: #1e3a8a;">Gesamt Spins in DB: ${allCount} | Nach Zeitfilter: ${totalSpins}</span>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #F9A825;">${totalSpins}</div>
          <div style="font-size: 13px; color: #6b7280;">Gesamt Spins</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${spinsThisWeek}</div>
          <div style="font-size: 13px; color: #6b7280;">Diese Woche</div>
        </div>
        <div style="background: white; padding: 16px; border-radius: 10px; text-align: center;">
          <div style="font-size: 32px; font-weight: 700; color: #10b981;">${totalUnlocks}</div>
          <div style="font-size: 13px; color: #6b7280;">Freischaltungen</div>
        </div>
      </div>
      
      ${prizes.length > 0 ? `
        <div style="background: white; padding: 20px; border-radius: 10px;">
          <div style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 12px;">ğŸ Gewinn-Verteilung</div>
          ${prizes.map(p => `
            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; font-weight: 600; color: #111827;">${p.prize}</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="font-size: 18px; font-weight: 700; color: #F9A825;">${p.count}x</div>
                  <div style="font-size: 14px; color: #6b7280;">(${p.percent}%)</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<div style="text-align: center; padding: 20px; color: #6b7280;">Noch keine Gewinne</div>'}
    `
  } catch (e) {
    console.error('âŒ Fehler:', e)
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

async function loadAllTransactions() {
  const content = document.getElementById('stats-content')
  content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">â³ Lade alle Transaktionen...</div>'
  document.querySelectorAll('.stat-btn[onclick^="load"]').forEach(btn => btn.classList.remove('active'))
  event.target.classList.add('active')
  
  try {
    let { data: transactions, error } = await supabase
      .from('transactions')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100)
    
    if (error) throw error
    
    const allCount = transactions?.length || 0
    transactions = filterByTimeRange(transactions)
    
    content.innerHTML = `
      <h3 style="color: #111827; margin-bottom: 16px;">ğŸ“‹ Alle Transaktionen (Letzte 100)</h3>
      
      <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 20px;">
        <strong style="color: #1e40af;">ğŸ” Debug-Info:</strong><br>
        <span style="color: #1e3a8a;">Gesamt Transaktionen: ${allCount} | Nach Zeitfilter: ${transactions?.length || 0}</span>
      </div>
      
      ${transactions?.length > 0 ? transactions.map(tx => {
        const date = new Date(tx.created_at).toLocaleString('de-DE')
        return `
          <div style="background: white; padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${tx.action === 'purchase' ? '#10b981' : tx.staff === 'WHEEL' ? '#f59e0b' : '#6b7280'};">
            <div style="display: flex; justify-content: between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 700; margin-bottom: 4px;">
                  ${tx.action === 'purchase' ? 'ğŸ’°' : tx.staff === 'WHEEL' ? 'ğŸ¡' : 'ğŸ'} 
                  ${tx.action === 'purchase' ? 'Kauf' : tx.staff === 'WHEEL' ? 'Wheel Gewinn' : tx.action}
                </div>
                <div style="font-size: 13px; color: #666;">
                  ${tx.notes || '-'}<br>
                  Staff: ${tx.staff || '-'} | Betrag: ${tx.amount}â‚¬
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 18px; font-weight: 700; color: ${tx.points > 0 ? '#10b981' : '#dc2626'};">
                  ${tx.points > 0 ? '+' : ''}${tx.points}P
                </div>
                <div style="font-size: 11px; color: #999;">${date}</div>
              </div>
            </div>
          </div>
        `
      }).join('') : '<div style="text-align: center; padding: 20px; color: #6b7280;">Keine Transaktionen</div>'}
    `
  } catch (e) {
    console.error('âŒ Fehler:', e)
    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;">âŒ Fehler: ${e.message}</div>`
  }
}

window.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ Stats Page geladen (Debug-Version)')
  setTimeRange('7days', true)
  setTimeout(() => {
    console.log('ğŸ“Š Lade erste Statistik...')
    loadTrendStats()
  }, 300)
})

console.log('âœ… Business Intelligence Debug geladen!')
</script>
</body>
</html>
