<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>D√∂ner Boxx ‚Äì Test Tool</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;color:#111;}
  header{background:linear-gradient(135deg,#E31E24,#F9A825);color:#fff;padding:18px 16px;}
  header h1{margin:0;font-size:18px;}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.05);}
  .card h2{margin:0 0 10px 0;font-size:16px;}
  label{display:block;font-size:12px;color:#4b5563;margin:10px 0 4px;}
  input,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background:#fafafa;}
  button{padding:10px 12px;border:0;border-radius:10px;font-weight:700;cursor:pointer;}
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .btn{background:#111827;color:#fff;}
  .btn2{background:#10b981;color:#fff;}
  .btn3{background:#ef4444;color:#fff;}
  .btn4{background:#3b82f6;color:#fff;}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;}
  .log{background:#0b1020;color:#c7d2fe;border-radius:12px;padding:12px;min-height:180px;white-space:pre-wrap;overflow:auto;}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;}
  .ok{background:#dcfce7;color:#065f46;}
  .bad{background:#fee2e2;color:#991b1b;}
  .warn{background:#fef3c7;color:#92400e;}
  .small{font-size:12px;color:#6b7280;line-height:1.4}
</style>
</head>
<body>
<script>
// üîê LIZENZ & DOMAIN-SCHUTZ (gleiche Whitelist wie im System)
(function() {
  const _0xB = 'D√∂ner Boxx';
  const _0xL = 'DNBX-2025-LOYALTY-SYSTEM-PROTECTED';
  const _0xD = ['localhost', 'doener-boxx.vercel.app', 'doenerboxx.de', 'www.doenerboxx.de'];
  const _0xH = ['528de417', '88a8ce6b', 'a1f62429', '5da2c3a0'];
  const _0xHost = window.location.hostname;
  if (!_0xD.includes(_0xHost)) {
    document.body.innerHTML = '<div style="font-family:sans-serif;text-align:center;padding:50px;background:#1a1a1a;min-height:100vh;color:#ff4444;display:flex;flex-direction:column;align-items:center;justify-content:center;"><h1 style="font-size:48px;margin-bottom:20px;">‚õî</h1><h2>DOMAIN NICHT LIZENZIERT</h2><p style="margin-top:15px;">Dieses Test-Tool ist nicht f√ºr diese Domain lizenziert.</p></div>';
    throw new Error('Unauthorized domain');
  }
  function _0xHash(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) & 0xffffffff;
    if (h < 0) h = h >>> 0;
    return h.toString(16);
  }
  const _0xCalc = _0xHash(_0xB + '|' + _0xHost + '|' + _0xL);
  if (!_0xH.includes(_0xCalc)) {
    document.body.innerHTML = '<div style="font-family:sans-serif;text-align:center;padding:50px;background:#1a1a1a;min-height:100vh;color:#ff4444;display:flex;flex-direction:column;align-items:center;justify-content:center;"><h1 style="font-size:48px;margin-bottom:20px;">‚õî</h1><h2>LIZENZFEHLER</h2><p style="margin-top:15px;">Lizenzpr√ºfung fehlgeschlagen.</p></div>';
    throw new Error('Invalid license');
  }
})();

// üîê PASSWORT-SCHUTZ (gleicher Hash wie admin.html)
const PASSWORT_HASH = 'efc68709a6bc20b7983129e56ce1d98739876e4274463aaece1a3edef374d47e';
const LOCKOUT_DURATION = 5 * 60 * 1000;
const MAX_VERSUCHE = 3;

function getAuthState() {
  const stored = localStorage.getItem('db_auth_state');
  if (!stored) return { versuche: MAX_VERSUCHE, gesperrtBis: null };
  try { return JSON.parse(stored); } catch(e) { return { versuche: MAX_VERSUCHE, gesperrtBis: null }; }
}
function setAuthState(state) { localStorage.setItem('db_auth_state', JSON.stringify(state)); }
function clearAuthState() { localStorage.removeItem('db_auth_state'); }
function isLocked() {
  const state = getAuthState();
  if (state.gesperrtBis && Date.now() < state.gesperrtBis) return true;
  if (state.gesperrtBis && Date.now() >= state.gesperrtBis) clearAuthState();
  return false;
}
function getRemainingLockTime() {
  const state = getAuthState();
  if (!state.gesperrtBis) return 0;
  return Math.max(0, Math.ceil((state.gesperrtBis - Date.now()) / 1000));
}
async function sha256(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}
function showLockScreen() {
  const updateTimer = () => {
    const remaining = getRemainingLockTime();
    if (remaining <= 0) { clearAuthState(); location.reload(); return; }
    const minutes = Math.floor(remaining / 60);
    const seconds = remaining % 60;
    const timerEl = document.getElementById('lockTimer');
    if (timerEl) timerEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;
  };
  document.body.innerHTML = `
    <div style="font-family:system-ui,sans-serif;background:linear-gradient(135deg,#dc2626,#991b1b);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:20px;padding:40px;max-width:420px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);text-align:center;">
        <div style="font-size:60px;margin-bottom:18px;">üö´</div>
        <h1 style="color:#dc2626;margin:0 0 8px 0;font-size:22px;">Zugriff gesperrt</h1>
        <p style="color:#666;margin:0 0 16px 0;">Zu viele Fehlversuche!</p>
        <div style="background:#fee2e2;border:2px solid #dc2626;border-radius:12px;padding:18px;margin-bottom:14px;">
          <div style="color:#991b1b;font-size:13px;margin-bottom:8px;">Sperre endet in:</div>
          <div id="lockTimer" style="font-size:36px;font-weight:800;color:#dc2626;">5:00</div>
        </div>
        <p style="color:#666;font-size:12px;margin:0;">Die Seite entsperrt automatisch.</p>
      </div>
    </div>`;
  updateTimer();
  setInterval(updateTimer, 1000);
}
function showLoginScreen() {
  if (isLocked()) { showLockScreen(); return; }
  const state = getAuthState();
  document.body.innerHTML = `
    <div style="font-family:system-ui,sans-serif;background:linear-gradient(135deg,#E31E24,#F9A825);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:20px;padding:40px;max-width:420px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.2);text-align:center;">
        <div style="font-size:60px;margin-bottom:18px;">üß™</div>
        <h1 style="color:#E31E24;margin:0 0 8px 0;font-size:22px;">Test Tool</h1>
        <p style="color:#666;margin:0 0 18px 0;">Bitte Admin-Passwort eingeben</p>
        <input type="password" id="loginPassword" placeholder="Passwort" style="width:100%;padding:14px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;margin-bottom:12px;text-align:center;" />
        <button id="loginBtn" style="width:100%;padding:14px;background:linear-gradient(135deg,#111827,#374151);color:white;border:none;border-radius:10px;font-size:16px;font-weight:800;cursor:pointer;">üîì Einloggen</button>
        <p id="loginError" style="color:#dc2626;margin-top:12px;font-size:13px;display:none;"></p>
        <p id="loginVersuche" style="color:#666;margin-top:10px;font-size:12px;">${state.versuche} Versuche √ºbrig</p>
      </div>
    </div>`;
  setTimeout(() => document.getElementById('loginPassword')?.focus(), 50);
  document.getElementById('loginBtn').onclick = checkLogin;
  document.getElementById('loginPassword').onkeypress = (e) => { if (e.key === 'Enter') checkLogin(); };
}
async function checkLogin() {
  if (isLocked()) { showLockScreen(); return; }
  const eingabe = document.getElementById('loginPassword').value;
  const errorEl = document.getElementById('loginError');
  const versucheEl = document.getElementById('loginVersuche');
  if (!eingabe) {
    errorEl.style.display='block'; errorEl.textContent='‚ùå Bitte Passwort eingeben!';
    return;
  }
  const hash = await sha256(eingabe);
  const state = getAuthState();
  if (hash === PASSWORT_HASH) {
    setAuthState({ versuche: MAX_VERSUCHE, gesperrtBis: null, ok: true });
    location.reload();
    return;
  }
  state.versuche = Math.max(0, (state.versuche ?? MAX_VERSUCHE) - 1);
  if (state.versuche <= 0) {
    state.gesperrtBis = Date.now() + LOCKOUT_DURATION;
  }
  setAuthState(state);
  errorEl.style.display='block'; errorEl.textContent='‚ùå Falsches Passwort!';
  if (versucheEl) versucheEl.textContent = `${state.versuche} Versuche √ºbrig`;
  if (isLocked()) showLockScreen();
}

// Gate
const auth = getAuthState();
if (!auth.ok) {
  showLoginScreen();
}
</script>

<header>
  <h1>üß™ D√∂ner Boxx ‚Äì Test Tool (Staging / QA)</h1>
</header>

<div class="wrap" id="app" style="display:none;">
  <div class="small">
    Idee: Du erzeugst Testdaten (Testkunden, Test-Transaktionen, Test-Coupons/Bonusse), verschiebst Zeitstempel (z.B. ‚Äû21 Tage inaktiv‚Äú)
    und l√§sst automatische Checks laufen. So merkst <b>DU</b> Bugs bevor ein Kunde sie ausnutzt.
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h2>1) Test-Kunden</h2>
      <div class="small">Erstellt zwei Testkunden: <span class="mono">TEST_A</span> und <span class="mono">TEST_B</span>. (Nur wenn noch nicht vorhanden.)</div>
      <label>Prefix</label>
      <input id="prefix" value="TEST_" />
      <div class="row" style="margin-top:10px;">
        <button class="btn2" onclick="createTestCustomers()">‚ûï Anlegen</button>
        <button class="btn3" onclick="cleanupTestData()">üóëÔ∏è Cleanup</button>
        <button class="btn4" onclick="loadTestCustomers()">üîÑ Laden</button>
      </div>
      <div id="customersOut" class="small" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2>2) Zeit simulieren (Win-Back / Inaktivit√§t)</h2>
      <div class="small">Setzt den Zeitpunkt der <b>letzten Transaktion</b> oder (wenn keine vorhanden) das <b>created_at</b> des Kunden auf ‚ÄûX Tage in der Vergangenheit‚Äú.</div>
      <label>Kunde</label>
      <select id="inactiveCustomer"></select>
      <label>Inaktiv seit (Tage)</label>
      <input id="inactiveDays" type="number" value="21" min="0" />
      <label>Transaktions-Betrag (zum Erzeugen einer Tx, falls keine existiert)</label>
      <input id="inactiveAmount" type="number" value="10" step="0.01" />
      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="simulateInactivity()">üïí Simulieren</button>
        <button class="btn4" onclick="checkInactive()">üîé Pr√ºfen</button>
      </div>
      <div id="inactiveOut" class="small" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2>3) Automatische Checks</h2>
      <div class="small">L√§uft als ‚ÄûCheckliste‚Äú durch die wichtigsten Risiken.</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn2" onclick="runAll()">‚ñ∂Ô∏è Alle Tests</button>
        <button class="btn" onclick="testCouponPriority()">üéüÔ∏è Coupon-Priorit√§t</button>
        <button class="btn" onclick="testGlobalBonusVisibility()">üéÅ Bonus-Sichtbarkeit</button>
        <button class="btn" onclick="testWinBackFilter()">üéØ Win-Back Filter</button>
      </div>
      <div id="testsOut" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2>Log</h2>
      <div class="log mono" id="log"></div>
    </div>
  </div>
</div>

<script>
if (auth.ok) document.getElementById('app').style.display = 'block';

// Supabase init (wie im System)
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let testCustomers = [];

function log(msg) {
  const el = document.getElementById('log');
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}
function pill(text, cls) {
  return `<span class="pill ${cls}">${text}</span>`;
}

async function loadTestCustomers() {
  const prefix = document.getElementById('prefix').value.trim() || 'TEST_';
  const { data, error } = await supabase.from('customers').select('*').ilike('name', `${prefix}%`).order('created_at', {ascending:false});
  if (error) { log('‚ùå loadTestCustomers: ' + error.message); return; }
  testCustomers = data || [];
  const out = document.getElementById('customersOut');
  if (!testCustomers.length) {
    out.innerHTML = pill('Keine Testkunden gefunden', 'warn');
  } else {
    out.innerHTML = testCustomers.map(c => `<div><b>${c.name}</b> ¬∑ ${c.phone} ¬∑ qr_id=${c.qr_id} ¬∑ points=${c.points}</div>`).join('');
  }
  // Dropdown f√ºllen
  const sel = document.getElementById('inactiveCustomer');
  sel.innerHTML = testCustomers.map(c => `<option value="${c.id}">${c.name} (${c.phone})</option>`).join('');
}

function normalizePhone(phone) {
  let normalized = (phone||'').replace(/[\s\-\(\)]/g, '');
  if (normalized.startsWith('+')) normalized = normalized.substring(1);
  if (normalized.startsWith('00')) normalized = normalized.substring(2);
  if (normalized.startsWith('49') && normalized.length > 10) normalized = '0' + normalized.substring(2);
  if (!normalized.startsWith('0') && normalized.length >= 10) normalized = '0' + normalized;
  return normalized;
}

async function createTestCustomers() {
  const prefix = document.getElementById('prefix').value.trim() || 'TEST_';
  const aName = `${prefix}A`;
  const bName = `${prefix}B`;
  // fester ‚ÄûFake‚Äú-Nummernraum, damit du sie sofort erkennst
  const aPhone = normalizePhone('01500000001');
  const bPhone = normalizePhone('01500000002');

  async function ensure(name, phone) {
    const { data: existing, error: e1 } = await supabase.from('customers').select('*').eq('phone', phone).limit(1);
    if (e1) throw e1;
    if (existing && existing.length) return existing[0];
    const qrId = Math.floor(1000 + Math.random() * 9000).toString();
    const { data, error } = await supabase.from('customers').insert({ qr_id: qrId, name, phone, points: 0 }).select().single();
    if (error) throw error;
    return data;
  }

  try {
    log('‚è≥ Erstelle Testkunden...');
    await ensure(aName, aPhone);
    await ensure(bName, bPhone);
    log('‚úÖ Testkunden bereit.');
    await loadTestCustomers();
  } catch (e) {
    log('‚ùå createTestCustomers: ' + e.message);
  }
}

async function cleanupTestData() {
  const prefix = document.getElementById('prefix').value.trim() || 'TEST_';
  log('‚è≥ Cleanup startet (nur Testdaten mit Name-Prefix)...');
  // Kunden holen
  const { data: customers, error } = await supabase.from('customers').select('id,name').ilike('name', `${prefix}%`);
  if (error) { log('‚ùå Cleanup customers: ' + error.message); return; }
  const ids = (customers||[]).map(c => c.id);
  if (!ids.length) { log('‚ÑπÔ∏è Keine Testkunden zum L√∂schen.'); return; }

  // Reihenfolge: abh√§ngige Tabellen ‚Üí customers
  const tables = [
    'activated_coupons',
    'activated_global_bonuses',
    'used_global_bonuses_history',
    'transactions',
    'orders',
    'redeem_codes',
    'wheel_unlocks',
    'wheel_spins',
    'challenge_progress'
  ];
  for (const t of tables) {
    try {
      await supabase.from(t).delete().in('customer_id', ids);
    } catch(_) {}
  }
  // Coupons/Bonusse nur die, die wir im Tool anlegen (title prefix TEST_)
  await supabase.from('coupons').delete().ilike('title', `${prefix}%`);
  await supabase.from('global_bonuses').delete().ilike('title', `${prefix}%`);

  // Customers l√∂schen
  const del = await supabase.from('customers').delete().in('id', ids);
  if (del.error) { log('‚ùå Cleanup delete customers: ' + del.error.message); return; }
  log('‚úÖ Cleanup fertig.');
  await loadTestCustomers();
}

async function ensureLastTransaction(customerId, amount) {
  // hole letzte tx
  const { data: tx } = await supabase.from('transactions').select('*').eq('customer_id', customerId).order('created_at', { ascending:false }).limit(1);
  if (tx && tx.length) return tx[0];
  // sonst eine erstellen (earn)
  const { data: inserted, error } = await supabase.from('transactions').insert({ customer_id: customerId, type:'earn', amount: parseFloat(amount||10), points: Math.round((amount||10)*10), staff:'TEST-TOOL' }).select().single();
  if (error) throw error;
  return inserted;
}

async function simulateInactivity() {
  const customerId = document.getElementById('inactiveCustomer').value;
  const days = parseInt(document.getElementById('inactiveDays').value||0);
  const amount = parseFloat(document.getElementById('inactiveAmount').value||10);
  const out = document.getElementById('inactiveOut');

  if (!customerId) { out.innerHTML = pill('Bitte erst Testkunden laden', 'warn'); return; }
  const targetDate = new Date();
  targetDate.setDate(targetDate.getDate() - days);
  const targetIso = targetDate.toISOString();

  try {
    const lastTx = await ensureLastTransaction(customerId, amount);
    // Versuch: created_at updaten (geht nur, wenn DB es erlaubt)
    let ok = true;
    const upd = await supabase.from('transactions').update({ created_at: targetIso }).eq('id', lastTx.id);
    if (upd.error) {
      ok = false;
      log('‚ö†Ô∏è transactions.created_at konnte nicht geupdatet werden (RLS/DB-Policy?): ' + upd.error.message);
    }
    if (!ok) {
      // Fallback: customer.created_at updaten (f√ºr "keine Transaktionen"-Logik)
      const upd2 = await supabase.from('customers').update({ created_at: targetIso }).eq('id', customerId);
      if (upd2.error) throw upd2.error;
      out.innerHTML = pill('Fallback genutzt: customer.created_at verschoben', 'warn') + ` ¬∑ auf ${targetIso}`;
      log('‚úÖ customer.created_at auf Vergangenheit gesetzt.');
    } else {
      out.innerHTML = pill('OK', 'ok') + ` ¬∑ letzte Tx auf ${days} Tage zur√ºckgesetzt ‚Üí ${targetIso}`;
      log('‚úÖ transactions.created_at auf Vergangenheit gesetzt.');
    }
  } catch (e) {
    out.innerHTML = pill('Fehler: ' + e.message, 'bad');
    log('‚ùå simulateInactivity: ' + e.message);
  }
}

async function checkInactive() {
  const customerId = document.getElementById('inactiveCustomer').value;
  const days = parseInt(document.getElementById('inactiveDays').value||0);
  const out = document.getElementById('inactiveOut');
  if (!customerId) return;

  // gleiche Logik wie admin.previewTargetGroup() (nur Inaktivit√§ts-Teil)
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);

  const { data: customer, error: ce } = await supabase.from('customers').select('*').eq('id', customerId).single();
  if (ce) { out.innerHTML = pill('Fehler: ' + ce.message, 'bad'); return; }

  const { data: lastTx } = await supabase.from('transactions').select('created_at').eq('customer_id', customerId).order('created_at', { ascending:false }).limit(1);
  let lastDate = null;
  let inactive = false;
  if (!lastTx || !lastTx.length) {
    lastDate = new Date(customer.created_at);
    inactive = lastDate < cutoffDate;
  } else {
    lastDate = new Date(lastTx[0].created_at);
    inactive = lastDate < cutoffDate;
  }
  out.innerHTML = (inactive ? pill('INAKTIV', 'ok') : pill('AKTIV', 'bad')) + ` ¬∑ letzte Aktivit√§t: ${lastDate.toISOString()} ¬∑ Cutoff: ${cutoffDate.toISOString()}`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Tests
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function getVisibleCouponsForCustomer(customerId) {
  // entspricht index.html: allCoupons + activatedCouponIds Filter
  const todayStr = new Date().toISOString().split('T')[0];
  const { data: allCoupons, error } = await supabase
    .from('coupons')
    .select('*')
    .eq('is_active', true)
    .lte('start_date', todayStr)
    .gte('end_date', todayStr);
  if (error) throw error;

  const { data: activated, error: aerr } = await supabase
    .from('activated_coupons')
    .select('*')
    .eq('customer_id', customerId);
  if (aerr) {
    // fallback: nur public
    return (allCoupons||[]).filter(c => !c.is_private);
  }
  const activatedIds = (activated||[]).map(a => a.coupon_id);
  return (allCoupons||[]).filter(c => !c.is_private || activatedIds.includes(c.id));
}

function getCouponPrice(productName, activeCoupons) {
  // wie Bugfix: private zuerst, dann global
  const privateCoupon = (activeCoupons||[]).find(c => c.product === productName && c.is_private === true);
  if (privateCoupon) return privateCoupon.price;
  const globalCoupon = (activeCoupons||[]).find(c => c.product === productName && (!c.is_private));
  if (globalCoupon) return globalCoupon.price;
  return null;
}

async function testCouponPriority() {
  const out = document.getElementById('testsOut');
  out.innerHTML = '';
  await loadTestCustomers();
  if (testCustomers.length < 2) {
    out.innerHTML = pill('Bitte erst Testkunden anlegen', 'warn');
    return;
  }
  const A = testCustomers.find(c => c.name.endsWith('A')) || testCustomers[0];
  const B = testCustomers.find(c => c.name.endsWith('B')) || testCustomers[1];

  const today = new Date().toISOString().split('T')[0];
  const prefix = document.getElementById('prefix').value.trim() || 'TEST_';
  const product = 'D√∂ner';

  try {
    // vorhandene Testcoupons entfernen
    await supabase.from('coupons').delete().ilike('title', `${prefix}COUPON%`);

    // global coupon 5‚Ç¨
    const { data: globalC, error: e1 } = await supabase.from('coupons').insert({
      title: `${prefix}COUPON_GLOBAL`,
      product,
      price: 5,
      start_date: today,
      end_date: today,
      is_active: true,
      is_private: false
    }).select().single();
    if (e1) throw e1;

    // private coupon 2‚Ç¨
    const { data: privC, error: e2 } = await supabase.from('coupons').insert({
      title: `${prefix}COUPON_PRIVATE`,
      product,
      price: 2,
      start_date: today,
      end_date: today,
      is_active: true,
      is_private: true
    }).select().single();
    if (e2) throw e2;

    // aktiviere privaten coupon f√ºr A
    await supabase.from('activated_coupons').delete().eq('customer_id', A.id).eq('coupon_id', privC.id);
    const act = await supabase.from('activated_coupons').insert({
      customer_id: A.id,
      coupon_id: privC.id,
      is_used: false
    });
    if (act.error) throw act.error;

    // Preise berechnen
    const couponsA = await getVisibleCouponsForCustomer(A.id);
    const couponsB = await getVisibleCouponsForCustomer(B.id);

    const priceA = getCouponPrice(product, couponsA);
    const priceB = getCouponPrice(product, couponsB);

    const okA = priceA === 2;
    const okB = priceB === 5;

    out.innerHTML += `<div>${okA?pill('PASS','ok'):pill('FAIL','bad')} Kunde A sieht ${priceA}‚Ç¨ (erwartet 2‚Ç¨)</div>`;
    out.innerHTML += `<div>${okB?pill('PASS','ok'):pill('FAIL','bad')} Kunde B sieht ${priceB}‚Ç¨ (erwartet 5‚Ç¨)</div>`;
    log(`üéüÔ∏è CouponPriority: A=${priceA} B=${priceB}`);
  } catch (e) {
    out.innerHTML += `<div>${pill('FEHLER','bad')} ${e.message}</div>`;
    log('‚ùå testCouponPriority: ' + e.message);
  }
}

async function testGlobalBonusVisibility() {
  const out = document.getElementById('testsOut');
  await loadTestCustomers();
  if (!testCustomers.length) { out.innerHTML = pill('Bitte erst Testkunden anlegen', 'warn'); return; }
  const A = testCustomers[0];
  const today = new Date().toISOString().split('T')[0];
  const prefix = document.getElementById('prefix').value.trim() || 'TEST_';

  try {
    // alten Testbonus weg
    await supabase.from('global_bonuses').delete().ilike('title', `${prefix}BONUS%`);
    // private double points bonus
    const { data: b, error } = await supabase.from('global_bonuses').insert({
      title: `${prefix}BONUS_PRIVATE`,
      description: 'Private Bonus f√ºr Test',
      bonus_type: 'double_points',
      bonus_amount: null,
      start_date: today,
      end_date: today,
      is_active: true,
      is_private: true
    }).select().single();
    if (error) throw error;

    // aktivieren f√ºr A
    await supabase.from('activated_global_bonuses').delete().eq('customer_id', A.id).eq('global_bonus_id', b.id);
    const act = await supabase.from('activated_global_bonuses').insert({
      customer_id: A.id,
      global_bonus_id: b.id,
      is_used: false
    });
    if (act.error) throw act.error;

    // Sichtbarkeit pr√ºfen wie index.html
    const { data: allBonuses } = await supabase.from('global_bonuses').select('*').eq('is_active', true).lte('start_date', today).gte('end_date', today);
    const { data: activated } = await supabase.from('activated_global_bonuses').select('*').eq('customer_id', A.id);
    const activatedIds = (activated||[]).map(x => x.global_bonus_id);
    const visible = (allBonuses||[]).filter(bn => !bn.is_private || activatedIds.includes(bn.id));

    const ok = visible.some(v => v.id === b.id);
    out.innerHTML = `<div>${ok?pill('PASS','ok'):pill('FAIL','bad')} Privater Bonus sichtbar f√ºr berechtigten Kunden</div>`;
    log(`üéÅ BonusVisibility: visible=${visible.length} ok=${ok}`);
  } catch (e) {
    out.innerHTML = `<div>${pill('FEHLER','bad')} ${e.message}</div>`;
    log('‚ùå testGlobalBonusVisibility: ' + e.message);
  }
}

async function computeInactiveCustomers(inactiveDays) {
  let query = supabase.from('customers').select('*');
  const { data: allCustomers, error } = await query;
  if (error) throw error;
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - inactiveDays);

  const filtered = [];
  for (const customer of (allCustomers||[])) {
    const { data: lastTx } = await supabase
      .from('transactions')
      .select('created_at')
      .eq('customer_id', customer.id)
      .order('created_at', { ascending:false })
      .limit(1);
    let isInactive = false;
    if (!lastTx || !lastTx.length) {
      isInactive = new Date(customer.created_at) < cutoffDate;
    } else {
      isInactive = new Date(lastTx[0].created_at) < cutoffDate;
    }
    if (isInactive) filtered.push(customer);
  }
  return filtered;
}

async function testWinBackFilter() {
  const out = document.getElementById('testsOut');
  await loadTestCustomers();
  if (!testCustomers.length) { out.innerHTML = pill('Bitte erst Testkunden anlegen', 'warn'); return; }
  const A = testCustomers[0];

  const days = 21;
  // erst simulieren
  document.getElementById('inactiveCustomer').value = A.id;
  document.getElementById('inactiveDays').value = days;
  await simulateInactivity();

  try {
    const list = await computeInactiveCustomers(days);
    const ok = list.some(c => c.id === A.id);
    out.innerHTML = `<div>${ok?pill('PASS','ok'):pill('FAIL','bad')} Kunde A wird als ${days}+ Tage inaktiv erkannt</div>` + 
      `<div class="small">Gefunden: ${list.length} inaktive Kunden (systemweit)</div>`;
    log(`üéØ WinBackFilter: ok=${ok} list=${list.length}`);
  } catch (e) {
    out.innerHTML = `<div>${pill('FEHLER','bad')} ${e.message}</div>`;
    log('‚ùå testWinBackFilter: ' + e.message);
  }
}

async function runAll() {
  const out = document.getElementById('testsOut');
  out.innerHTML = pill('L√§uft...', 'warn');
  log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  log('‚ñ∂Ô∏è RUN ALL TESTS');
  await createTestCustomers();
  await testCouponPriority();
  await testGlobalBonusVisibility();
  await testWinBackFilter();
  log('‚úÖ RUN ALL DONE');
}
</script>
</body>
</html>
