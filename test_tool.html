<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§ª QA & Test Tool - DÃ¶ner Boxx</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: #1a202c;
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #718096;
      font-size: 14px;
    }
    
    .warning-banner {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .warning-banner strong {
      color: #856404;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 24px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #2d3748;
      font-size: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .btn:hover {
      background: #5a67d8;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    
    .btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-danger {
      background: #dc2626;
    }
    
    .btn-danger:hover:not(:disabled) {
      background: #b91c1c;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #059669;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      color: #4a5568;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .result-box {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .result-success {
      background: #d1fae5;
      border: 2px solid #10b981;
      color: #065f46;
    }
    
    .result-error {
      background: #fee2e2;
      border: 2px solid #dc2626;
      color: #991b1b;
    }
    
    .result-info {
      background: #dbeafe;
      border: 2px solid #3b82f6;
      color: #1e40af;
    }
    
    .test-accounts-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 12px;
    }
    
    .test-account-item {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .test-account-item strong {
      color: #2d3748;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 8px;
    }
    
    .badge-test {
      background: #9333ea;
      color: white;
    }
    
    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 20px;
      background: none;
      border: none;
      color: #718096;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <h1>ğŸ§ª QA & Test Tool</h1>
      <p>QualitÃ¤tssicherung & Testing fÃ¼r DÃ¶ner Boxx Loyalty-System</p>
    </div>
    
    <!-- Warning Banner -->
    <div class="warning-banner">
      <span style="font-size: 24px;">âš ï¸</span>
      <div>
        <strong>ACHTUNG:</strong> Dies ist ein internes Test-Tool. 
        Alle Aktionen wirken auf die echte Datenbank. 
        Testaccounts mit <code>is_test_account = true</code> werden markiert und kÃ¶nnen vor Release gelÃ¶scht werden.
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('testaccounts')">Testaccounts</button>
      <button class="tab" onclick="switchTab('time-sim')">Zeit-Simulation</button>
      <button class="tab" onclick="switchTab('cleanup')">Cleanup</button>
      <button class="tab" onclick="switchTab('stats')">Statistiken</button>
    </div>
    
    <!-- Tab: Testaccounts -->
    <div id="tab-testaccounts" class="tab-content active">
      <div class="grid">
        
        <div class="card">
          <h2>ğŸ‘¥ Testaccount erstellen</h2>
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" id="new-test-name" class="form-input" placeholder="z.B. Test Max">
          </div>
          <div class="form-group">
            <label class="form-label">Telefon</label>
            <input type="text" id="new-test-phone" class="form-input" placeholder="z.B. 0176123456">
          </div>
          <div class="form-group">
            <label class="form-label">Start-Punkte</label>
            <input type="number" id="new-test-points" class="form-input" value="100">
          </div>
          <button class="btn btn-success" onclick="createTestAccount()">âœ… Testaccount erstellen</button>
          <div id="create-result"></div>
        </div>
        
        <div class="card">
          <h2>ğŸ“‹ Testaccounts anzeigen</h2>
          <button class="btn" onclick="loadTestAccounts()">ğŸ”„ Testaccounts laden</button>
          <div id="testaccounts-list" class="test-accounts-list"></div>
        </div>
        
      </div>
    </div>
    
    <!-- Tab: Zeit-Simulation -->
    <div id="tab-time-sim" class="tab-content">
      <div class="grid">
        
        <div class="card">
          <h2>â° Registrierung simulieren</h2>
          <div class="form-group">
            <label class="form-label">Testaccount wÃ¤hlen</label>
            <select id="time-sim-account" class="form-select">
              <option value="">-- Testaccount wÃ¤hlen --</option>
            </select>
          </div>
          <div class="btn-group">
            <button class="btn btn-small" onclick="simulateRegistration(7)">-7 Tage</button>
            <button class="btn btn-small" onclick="simulateRegistration(14)">-14 Tage</button>
            <button class="btn btn-small" onclick="simulateRegistration(21)">-21 Tage</button>
            <button class="btn btn-small" onclick="simulateRegistration(30)">-30 Tage</button>
            <button class="btn btn-small" onclick="simulateRegistration(60)">-60 Tage</button>
          </div>
          <div class="form-group">
            <label class="form-label">Oder eigene Anzahl Tage</label>
            <input type="number" id="time-sim-days" class="form-input" placeholder="z.B. 45">
          </div>
          <button class="btn" onclick="simulateRegistrationCustom()">â° Custom Tage setzen</button>
          <div id="time-sim-result"></div>
        </div>
        
        <div class="card">
          <h2>ğŸ›’ Letzte Bestellung simulieren</h2>
          <div class="form-group">
            <label class="form-label">Testaccount wÃ¤hlen</label>
            <select id="last-order-account" class="form-select">
              <option value="">-- Testaccount wÃ¤hlen --</option>
            </select>
          </div>
          <div class="btn-group">
            <button class="btn btn-small" onclick="simulateLastOrder(7)">-7 Tage</button>
            <button class="btn btn-small" onclick="simulateLastOrder(14)">-14 Tage</button>
            <button class="btn btn-small" onclick="simulateLastOrder(21)">-21 Tage</button>
            <button class="btn btn-small" onclick="simulateLastOrder(30)">-30 Tage</button>
          </div>
          <div id="last-order-result"></div>
        </div>
        
      </div>
    </div>
    
    <!-- Tab: Cleanup -->
    <div id="tab-cleanup" class="tab-content">
      <div class="grid">
        
        <div class="card">
          <h2>ğŸ“Š Testdaten zÃ¤hlen</h2>
          <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">
            Zeigt Anzahl aller Testaccounts und deren Daten
          </p>
          <button class="btn" onclick="countTestData()">ğŸ” Testdaten zÃ¤hlen</button>
          <div id="count-result"></div>
        </div>
        
        <div class="card">
          <h2>ğŸ—‘ï¸ Testdaten lÃ¶schen</h2>
          <div class="result-box result-error">
            <strong>âš ï¸ ACHTUNG:</strong> Diese Aktion ist irreversibel!<br>
            LÃ¶scht ALLE Testaccounts und deren Transaktionen, Aktivierungen, etc.
          </div>
          <button class="btn btn-danger" style="margin-top: 12px;" onclick="deleteAllTestData()">
            âš ï¸ ALLE Testdaten lÃ¶schen
          </button>
          <div id="cleanup-result"></div>
        </div>
        
      </div>
    </div>
    
    <!-- Tab: Statistiken -->
    <div id="tab-stats" class="tab-content">
      <div class="grid">
        
        <div class="card">
          <h2>ğŸ“ˆ Produktiv vs. Gesamt</h2>
          <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">
            Vergleicht Gesamt-Kunden mit Produktiv-Kunden (ohne Tests)
          </p>
          <button class="btn" onclick="loadStats()">ğŸ“Š Statistiken laden</button>
          <div id="stats-result"></div>
        </div>
        
        <div class="card">
          <h2>ğŸ” System-Status</h2>
          <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">
            PrÃ¼ft ob production_* Views und Cleanup-Funktionen vorhanden sind
          </p>
          <button class="btn" onclick="checkSystemStatus()">ğŸ” Status prÃ¼fen</button>
          <div id="status-result"></div>
        </div>
        
      </div>
    </div>
    
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” SUPABASE CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // TODO: Anpassen!
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // TODO: Anpassen!
    
    // Fix: Verwende window.supabase.createClient
    let supabase = null;
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const { createClient } = window.supabase;
        supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('âœ… Supabase initialized');
      } catch (e) {
        console.error('âŒ Supabase initialization failed:', e);
        alert('FEHLER: Supabase konnte nicht initialisiert werden. Bitte URL und KEY anpassen!');
      }
    });
    
    let currentTestAccounts = [];
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TESTACCOUNT MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function createTestAccount() {
      if (!supabase) {
        showResult('create-result', 'âŒ Supabase nicht initialisiert! Bitte URL/KEY anpassen.', 'error');
        return;
      }
      
      const name = document.getElementById('new-test-name').value.trim();
      const phone = document.getElementById('new-test-phone').value.trim();
      const points = parseInt(document.getElementById('new-test-points').value) || 100;
      
      if (!name || !phone) {
        showResult('create-result', 'âŒ Bitte Name und Telefon eingeben', 'error');
        return;
      }
      
      try {
        showResult('create-result', 'â³ Erstelle Testaccount...', 'info');
        
        const qrId = Math.floor(1000 + Math.random() * 9000);
        
        const { data, error } = await supabase
          .from('customers')
          .insert({
            name,
            phone,
            qr_id: qrId,
            points,
            is_test_account: true,
            whatsapp_optin: false
          })
          .select()
          .single();
        
        if (error) throw error;
        
        showResult('create-result', `âœ… Testaccount erstellt: ${name} (QR: ${qrId}, ${points}P)`, 'success');
        
        // Clear inputs
        document.getElementById('new-test-name').value = '';
        document.getElementById('new-test-phone').value = '';
        document.getElementById('new-test-points').value = '100';
        
        // Reload list
        loadTestAccounts();
        
      } catch (e) {
        showResult('create-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    async function loadTestAccounts() {
      if (!supabase) {
        document.getElementById('testaccounts-list').innerHTML = 
          '<div class="result-box result-error">âŒ Supabase nicht initialisiert!</div>';
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('customers')
          .select('*')
          .eq('is_test_account', true)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        currentTestAccounts = data || [];
        
        const listDiv = document.getElementById('testaccounts-list');
        
        if (data.length === 0) {
          listDiv.innerHTML = '<div class="result-box result-info">Keine Testaccounts vorhanden</div>';
        } else {
          listDiv.innerHTML = data.map(acc => `
            <div class="test-account-item">
              <strong>${acc.name}</strong>
              <span class="badge badge-test">TEST</span>
              <div style="font-size: 13px; color: #64748b; margin-top: 6px;">
                Telefon: ${acc.phone} | QR: ${acc.qr_id} | Punkte: ${acc.points}
              </div>
              <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                Erstellt: ${new Date(acc.created_at).toLocaleDateString('de-DE')}
              </div>
            </div>
          `).join('');
        }
        
        // Update dropdowns
        updateDropdowns();
        
      } catch (e) {
        document.getElementById('testaccounts-list').innerHTML = 
          `<div class="result-box result-error">âŒ Fehler: ${e.message}</div>`;
        console.error(e);
      }
    }
    
    function updateDropdowns() {
      const options = currentTestAccounts.length === 0
        ? '<option value="">-- Keine Testaccounts --</option>'
        : '<option value="">-- Testaccount wÃ¤hlen --</option>' +
          currentTestAccounts.map(acc => 
            `<option value="${acc.id}">${acc.name} (${acc.points}P)</option>`
          ).join('');
      
      document.getElementById('time-sim-account').innerHTML = options;
      document.getElementById('last-order-account').innerHTML = options;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIME SIMULATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function simulateRegistration(daysAgo) {
      if (!supabase) {
        showResult('time-sim-result', 'âŒ Supabase nicht initialisiert!', 'error');
        return;
      }
      
      const accountId = document.getElementById('time-sim-account').value;
      if (!accountId) {
        showResult('time-sim-result', 'âŒ Bitte Testaccount wÃ¤hlen', 'error');
        return;
      }
      
      try {
        showResult('time-sim-result', `â³ Setze Registrierung auf -${daysAgo} Tage...`, 'info');
        
        const newDate = new Date();
        newDate.setDate(newDate.getDate() - daysAgo);
        
        const { error } = await supabase
          .from('customers')
          .update({ created_at: newDate.toISOString() })
          .eq('id', accountId)
          .eq('is_test_account', true);
        
        if (error) throw error;
        
        showResult('time-sim-result', 
          `âœ… Registrierung zurÃ¼ckdatiert auf ${newDate.toLocaleDateString('de-DE')} (-${daysAgo} Tage)`, 
          'success'
        );
        
        loadTestAccounts(); // Refresh list
        
      } catch (e) {
        showResult('time-sim-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    async function simulateRegistrationCustom() {
      const daysAgo = parseInt(document.getElementById('time-sim-days').value);
      if (!daysAgo || daysAgo < 1) {
        showResult('time-sim-result', 'âŒ Bitte gÃ¼ltige Anzahl Tage eingeben', 'error');
        return;
      }
      await simulateRegistration(daysAgo);
    }
    
    async function simulateLastOrder(daysAgo) {
      if (!supabase) {
        showResult('last-order-result', 'âŒ Supabase nicht initialisiert!', 'error');
        return;
      }
      
      const accountId = document.getElementById('last-order-account').value;
      if (!accountId) {
        showResult('last-order-result', 'âŒ Bitte Testaccount wÃ¤hlen', 'error');
        return;
      }
      
      try {
        showResult('last-order-result', `â³ Setze letzte Bestellung auf -${daysAgo} Tage...`, 'info');
        
        const newDate = new Date();
        newDate.setDate(newDate.getDate() - daysAgo);
        
        // Check if customer has transactions
        const { data: existingTrans } = await supabase
          .from('transactions')
          .select('id')
          .eq('customer_id', accountId)
          .order('created_at', { ascending: false })
          .limit(1);
        
        if (existingTrans && existingTrans.length > 0) {
          // Update existing
          const { error } = await supabase
            .from('transactions')
            .update({ created_at: newDate.toISOString() })
            .eq('id', existingTrans[0].id);
          
          if (error) throw error;
          
          showResult('last-order-result', 
            `âœ… Letzte Bestellung zurÃ¼ckdatiert auf ${newDate.toLocaleDateString('de-DE')} (-${daysAgo} Tage)`, 
            'success'
          );
        } else {
          // Create test transaction
          const { error } = await supabase
            .from('transactions')
            .insert({
              customer_id: accountId,
              items: JSON.stringify([{ name: 'Test Order', price: 10 }]),
              total: 10,
              points_earned: 10,
              created_at: newDate.toISOString()
            });
          
          if (error) throw error;
          
          showResult('last-order-result', 
            `âœ… Test-Bestellung erstellt und zurÃ¼ckdatiert auf ${newDate.toLocaleDateString('de-DE')} (-${daysAgo} Tage)`, 
            'success'
          );
        }
        
      } catch (e) {
        showResult('last-order-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLEANUP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function countTestData() {
      if (!supabase) {
        showResult('count-result', 'âŒ Supabase nicht initialisiert!', 'error');
        return;
      }
      
      try {
        const resultDiv = document.getElementById('count-result');
        showResult('count-result', 'â³ ZÃ¤hle Testdaten...', 'info');
        
        const { data, error } = await supabase.rpc('count_test_data');
        
        if (error) throw error;
        
        const html = `
          <div class="result-box result-info">
            <strong>ğŸ“Š Testdaten-Ãœbersicht:</strong><br>
            <div style="margin-top: 8px; line-height: 1.8;">
              Testaccounts: <strong>${data.test_customers}</strong><br>
              Test-Transaktionen: <strong>${data.test_transactions}</strong><br>
              Test-Coupons: <strong>${data.test_coupons}</strong><br>
              Test-Bonusse: <strong>${data.test_bonuses}</strong><br>
              Test-Codes: <strong>${data.test_codes}</strong>
            </div>
          </div>
        `;
        
        resultDiv.innerHTML = html;
        
      } catch (e) {
        showResult('count-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    async function deleteAllTestData() {
      if (!supabase) {
        alert('Supabase nicht initialisiert!');
        return;
      }
      
      if (!confirm('âš ï¸ WARNUNG!\n\nWirklich ALLE Testdaten lÃ¶schen?\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
      if (!confirm('Bist du SICHER?\n\nDies lÃ¶scht ALLE Testaccounts und deren Daten!')) return;
      
      try {
        showResult('cleanup-result', 'â³ LÃ¶sche alle Testdaten...', 'info');
        
        const { data, error } = await supabase.rpc('cleanup_all_test_data');
        
        if (error) throw error;
        
        const html = `
          <div class="result-box result-success">
            <strong>âœ… Testdaten erfolgreich gelÃ¶scht:</strong><br>
            <div style="margin-top: 8px; line-height: 1.8;">
              Testaccounts: <strong>${data.deleted_customers}</strong><br>
              Transaktionen: <strong>${data.deleted_transactions}</strong><br>
              Coupons: <strong>${data.deleted_coupons}</strong><br>
              Bonusse: <strong>${data.deleted_bonuses}</strong><br>
              Codes: <strong>${data.deleted_codes}</strong>
            </div>
          </div>
        `;
        
        document.getElementById('cleanup-result').innerHTML = html;
        
        // Reset lists
        currentTestAccounts = [];
        updateDropdowns();
        document.getElementById('testaccounts-list').innerHTML = 
          '<div class="result-box result-info">Keine Testaccounts vorhanden</div>';
        
      } catch (e) {
        showResult('cleanup-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATISTICS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadStats() {
      if (!supabase) {
        showResult('stats-result', 'âŒ Supabase nicht initialisiert!', 'error');
        return;
      }
      
      try {
        showResult('stats-result', 'â³ Lade Statistiken...', 'info');
        
        // Gesamt
        const { count: totalCustomers } = await supabase
          .from('customers')
          .select('*', { count: 'exact', head: true });
        
        // Produktiv (try both production_customers view and fallback)
        let prodCustomers = 0;
        try {
          const { count } = await supabase
            .from('production_customers')
            .select('*', { count: 'exact', head: true });
          prodCustomers = count;
        } catch (e) {
          // Fallback if view doesn't exist
          const { count } = await supabase
            .from('customers')
            .select('*', { count: 'exact', head: true })
            .eq('is_test_account', false);
          prodCustomers = count;
        }
        
        const testCustomers = totalCustomers - prodCustomers;
        
        const html = `
          <div class="result-box result-info">
            <strong>ğŸ“Š Kunden-Statistik:</strong><br>
            <div style="margin-top: 8px; line-height: 1.8;">
              Gesamt: <strong>${totalCustomers}</strong><br>
              Produktiv: <strong>${prodCustomers}</strong><br>
              Testaccounts: <strong>${testCustomers}</strong>
            </div>
          </div>
        `;
        
        document.getElementById('stats-result').innerHTML = html;
        
      } catch (e) {
        showResult('stats-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    async function checkSystemStatus() {
      if (!supabase) {
        showResult('status-result', 'âŒ Supabase nicht initialisiert!', 'error');
        return;
      }
      
      try {
        showResult('status-result', 'â³ PrÃ¼fe System-Status...', 'info');
        
        let status = '<div class="result-box result-info"><strong>ğŸ” System-Status:</strong><br><div style="margin-top: 8px; line-height: 1.8;">';
        
        // Check production_customers view
        try {
          await supabase.from('production_customers').select('id').limit(1);
          status += 'âœ… production_customers View vorhanden<br>';
        } catch (e) {
          status += 'âŒ production_customers View fehlt<br>';
        }
        
        // Check count_test_data function
        try {
          await supabase.rpc('count_test_data');
          status += 'âœ… count_test_data() Funktion vorhanden<br>';
        } catch (e) {
          status += 'âŒ count_test_data() Funktion fehlt<br>';
        }
        
        // Check cleanup_all_test_data function
        // Don't actually call it, just check if it exists
        status += 'âœ… cleanup_all_test_data() Funktion (nicht geprÃ¼ft)<br>';
        
        status += '</div></div>';
        
        document.getElementById('status-result').innerHTML = status;
        
      } catch (e) {
        showResult('status-result', 'âŒ Fehler: ' + e.message, 'error');
        console.error(e);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function showResult(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="result-box result-${type}">${message}</div>`;
    }
    
  </script>
</body>
</html>
