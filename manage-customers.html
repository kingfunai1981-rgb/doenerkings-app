<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kunden verwalten - D√∂ner Boxx</title>
<link rel="icon" href="/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Flame', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.header-card {
  display: flex;
  align-items: center;
  gap: 20px;
}
.header-logo {
  width: 70px;
  height: 70px;
  flex-shrink: 0;
}
.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.header-text {
  flex: 1;
}
h1 { color: #E31E24; margin-bottom: 10px; font-size: 28px; }
h2 { font-size: 18px; margin-bottom: 12px; color: #374151; }

.tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.tab { flex: 1; min-width: 100px; padding: 12px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #6b7280; font-size: 13px; }
.tab.active { background: linear-gradient(135deg, #E31E24, #F9A825); color: white; }

input, select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 10px; font-family: 'Flame', system-ui, sans-serif; }
button { width: 100%; padding: 14px; background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; font-family: 'Flame', system-ui, sans-serif; }
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }
button.danger { background: #dc2626; }
button.small { width: auto; padding: 8px 16px; font-size: 14px; display: inline-block; margin: 4px; }

.result { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
.success { background: #fef3c7; color: #92400e; }
.error { background: #fee2e2; color: #991b1b; }
.info { background: #dbeafe; color: #1e40af; }

.customer-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
.customer-item h3 { font-size: 16px; margin-bottom: 8px; color: #E31E24; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.wheel-config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 768px) { .wheel-config-grid { grid-template-columns: 1fr; } }

.prize-item { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 14px; margin-bottom: 10px; display: grid; grid-template-columns: 50px 1fr auto; gap: 12px; align-items: center; }
.prize-color { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #ddd; }

.stat-card { background: linear-gradient(135deg, #F9A825, #f59e0b); color: white; border-radius: 12px; padding: 20px; text-align: center; }
.stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
.stat-card .stat-number { font-size: 32px; font-weight: 700; }
</style>
</head>
<body>

<div class="container">
  <div class="card header-card">
    <div class="header-logo">
      <img src="/logo-round.png" alt="D√∂ner Boxx">
    </div>
    <div class="header-text">
      <h1>D√∂ner Boxx Verwaltung</h1>
      <div style="color: #666; font-size: 14px;">geladen!</div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="showTab('customers')">üë• Kunden</button>
      <button class="tab" onclick="showTab('bonuses')">üéâ Bonuses</button>
      <button class="tab" onclick="showTab('challenges')">üéØ Challenges</button>
      <button class="tab" onclick="showTab('coupons')">üéüÔ∏è Coupons</button>
      <button class="tab" onclick="showTab('wheel')">üé° Wheel</button>
    </div>
  </div>

  <!-- CUSTOMERS TAB -->
  <div id="tab-customers" class="card tab-content active">
    <h2>üë• Kunden verwalten</h2>
    <button onclick="loadCustomers()">üîÑ Aktualisieren</button>
    <div id="customers-list" style="margin-top: 16px;"></div>
  </div>

  <!-- BONUSES TAB -->
  <div id="tab-bonuses" class="card tab-content">
    <h2>üéâ Globale Bonuses</h2>
    <input id="bonus-title" placeholder="Titel (z.B. 'Weekend Special')">
    <select id="bonus-type">
      <option value="double_points">Doppelte Punkte</option>
      <option value="bonus_points">Bonus Punkte</option>
    </select>
    <input id="bonus-amount" type="number" placeholder="Bonus-Punkte (nur bei 'Bonus Punkte')" value="100">
    <input id="bonus-expires" type="date" placeholder="Ablaufdatum">
    <button onclick="createBonus()">üéÅ Bonus erstellen</button>
    <div id="result-bonus"></div>
    <h3 style="margin-top: 24px;">Aktive Bonuses:</h3>
    <div id="bonuses-list" style="margin-top: 16px;"></div>
  </div>

  <!-- CHALLENGES TAB -->
  <div id="tab-challenges" class="card tab-content">
    <h2>üéØ Challenges</h2>
    <input id="challenge-orders" type="number" placeholder="Anzahl Bestellungen (z.B. 5)">
    <input id="challenge-min-amount" type="number" step="0.01" placeholder="Mindestbestellwert (z.B. 10.00)">
    <input id="challenge-points" type="number" placeholder="Bonus-Punkte (z.B. 500)">
    <input id="challenge-start" type="date" placeholder="Startdatum">
    <input id="challenge-end" type="date" placeholder="Enddatum">
    <button onclick="createChallenge()">üéØ Challenge erstellen</button>
    <div id="result-challenge"></div>
    <h3 style="margin-top: 24px;">Aktive Challenges:</h3>
    <div id="challenges-list" style="margin-top: 16px;"></div>
  </div>

  <!-- COUPONS TAB -->
  <div id="tab-coupons" class="card tab-content">
    <h2>üéüÔ∏è Coupons</h2>
    <input id="coupon-title" placeholder="Titel (z.B. 'Deal der Woche')">
    <input id="coupon-product" placeholder="Produkt (z.B. 'D√∂ner + Cola')">
    <input id="coupon-price" type="number" step="0.01" placeholder="Preis (z.B. 7.50)">
    <input id="coupon-desc" placeholder="Beschreibung (optional)">
    <input id="coupon-expires" type="date" placeholder="Ablaufdatum">
    <button onclick="createCoupon()">üéüÔ∏è Coupon erstellen</button>
    <div id="result-coupon"></div>
    <h3 style="margin-top: 24px;">Aktive Coupons:</h3>
    <div id="coupons-list" style="margin-top: 16px;"></div>
  </div>

  <!-- üé° WHEEL TAB -->
  <div id="tab-wheel" class="card tab-content">
    <h2>üé° Gl√ºcksrad Verwaltung</h2>
    
    <!-- Config Section -->
    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
      <h3 style="margin-bottom: 16px;">‚öôÔ∏è Einstellungen</h3>
      <div class="wheel-config-grid">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Status</label>
          <select id="wheel-active">
            <option value="true">‚úÖ Aktiv</option>
            <option value="false">‚ùå Inaktiv</option>
          </select>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mindestbestellwert (‚Ç¨)</label>
          <input id="wheel-min-amount" type="number" step="0.01" value="10.00">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Startdatum</label>
          <input id="wheel-start-date" type="datetime-local">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enddatum</label>
          <input id="wheel-end-date" type="datetime-local">
        </div>
      </div>
      <button onclick="saveWheelConfig()" style="margin-top: 16px;">üíæ Einstellungen speichern</button>
      <div id="result-wheel-config"></div>
    </div>

    <!-- Stats Section -->
    <h3 style="margin-bottom: 16px;">üìä Statistiken</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div class="stat-card">
        <h3>Heute gedreht</h3>
        <div class="stat-number" id="wheel-stat-today">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #E31E24, #dc2626);">
        <h3>D√∂ner gewonnen</h3>
        <div class="stat-number" id="wheel-stat-doener">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #2E86C1, #1a5490);">
        <h3>Punkte verteilt</h3>
        <div class="stat-number" id="wheel-stat-points">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
        <h3>Eingel√∂st</h3>
        <div class="stat-number" id="wheel-stat-redeemed">0</div>
      </div>
    </div>

    <!-- Prizes Section -->
    <h3 style="margin-bottom: 16px;">üéÅ Preise bearbeiten (18 Felder)</h3>
    <div id="prizes-list"></div>
    <div id="result-prizes"></div>

    <!-- Recent Spins -->
    <h3 style="margin-top: 24px; margin-bottom: 16px;">üé∞ Letzte Spins</h3>
    <button onclick="loadWheelSpins()" class="secondary">üîÑ Aktualisieren</button>
    <div id="wheel-spins-list" style="margin-top: 16px;"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

// ==========================================
// CRYPTO HELPER
// ==========================================

function generateSecureCode() {
  const array = new Uint32Array(1);
  crypto.getRandomValues(array);
  return (1000 + (array[0] % 9000)).toString();
}

// ==========================================
// HELPER FUNCTIONS
// ==========================================

function showResult(id, msg, type) {
  const el = document.getElementById(id)
  if (!msg) { el.className = ''; el.innerHTML = ''; return }
  el.className = `result ${type}`
  el.innerHTML = msg
}

function showTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
  const tabs = ['customers', 'bonuses', 'challenges', 'coupons', 'wheel']
  document.querySelectorAll('.tab')[tabs.indexOf(name)].classList.add('active')
  document.getElementById(`tab-${name}`).classList.add('active')
  
  if (name === 'customers') loadCustomers()
  if (name === 'bonuses') loadBonuses()
  if (name === 'challenges') loadChallenges()
  if (name === 'coupons') loadCoupons()
  if (name === 'wheel') loadWheelTab()
}

// ==========================================
// üé° WHEEL FUNCTIONS
// ==========================================

async function loadWheelTab() {
  await loadWheelConfig()
  await loadWheelPrizes()
  await loadWheelStats()
  await loadWheelSpins()
}

async function loadWheelConfig() {
  try {
    const { data, error } = await supabase.from('wheel_config').select('*').single()
    if (error) throw error
    
    if (data) {
      document.getElementById('wheel-active').value = data.is_active ? 'true' : 'false'
      document.getElementById('wheel-min-amount').value = data.min_order_amount
      
      if (data.start_date) {
        const start = new Date(data.start_date)
        document.getElementById('wheel-start-date').value = start.toISOString().slice(0, 16)
      }
      
      if (data.end_date) {
        const end = new Date(data.end_date)
        document.getElementById('wheel-end-date').value = end.toISOString().slice(0, 16)
      }
    }
  } catch (e) {
    console.error('‚ùå Load config error:', e)
  }
}

async function saveWheelConfig() {
  try {
    showResult('result-wheel-config', '‚è≥ Speichere...', 'info')
    
    const isActive = document.getElementById('wheel-active').value === 'true'
    const minAmount = parseFloat(document.getElementById('wheel-min-amount').value)
    const startDate = document.getElementById('wheel-start-date').value
    const endDate = document.getElementById('wheel-end-date').value
    
    if (!startDate || !endDate) {
      showResult('result-wheel-config', '‚ùå Bitte Start- und Enddatum angeben!', 'error')
      return
    }
    
    const { error } = await supabase.from('wheel_config').update({
      is_active: isActive,
      min_order_amount: minAmount,
      start_date: new Date(startDate).toISOString(),
      end_date: new Date(endDate).toISOString(),
      updated_at: new Date().toISOString()
    }).eq('id', 1)
    
    if (error) throw error
    
    showResult('result-wheel-config', '‚úÖ Einstellungen gespeichert!', 'success')
  } catch (e) {
    showResult('result-wheel-config', '‚ùå Fehler: ' + e.message, 'error')
    console.error('Save config error:', e)
  }
}

async function loadWheelPrizes() {
  try {
    const { data, error } = await supabase.from('wheel_prizes').select('*').order('position')
    if (error) throw error
    
    const list = document.getElementById('prizes-list')
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="result info">Keine Preise gefunden</div>'
      return
    }
    
    list.innerHTML = data.map(prize => `
      <div class="prize-item">
        <div style="text-align: center; font-weight: 700; color: #666;">${prize.position}</div>
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">${prize.label}</div>
          <div style="font-size: 13px; color: #666;">
            Typ: ${prize.prize_type} | Wert: ${prize.prize_value || '-'}
          </div>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div class="prize-color" style="background: ${prize.color};"></div>
          <button class="small secondary" onclick="editPrize(${prize.id})">‚úèÔ∏è</button>
        </div>
      </div>
    `).join('')
  } catch (e) {
    console.error('‚ùå Load prizes error:', e)
  }
}

async function editPrize(prizeId) {
  try {
    const { data: prize, error } = await supabase.from('wheel_prizes').select('*').eq('id', prizeId).single()
    if (error) throw error
    
    const newLabel = prompt('Label:', prize.label)
    if (!newLabel) return
    
    const newType = prompt('Typ (reward/points/discount/spin_again):', prize.prize_type)
    if (!newType) return
    
    const newValue = prompt('Wert:', prize.prize_value)
    if (newValue === null) return
    
    const newColor = prompt('Farbe (#RRGGBB):', prize.color)
    if (!newColor) return
    
    const { error: updateError } = await supabase.from('wheel_prizes').update({
      label: newLabel,
      prize_type: newType,
      prize_value: newValue,
      color: newColor
    }).eq('id', prizeId)
    
    if (updateError) throw updateError
    
    showResult('result-prizes', '‚úÖ Preis aktualisiert!', 'success')
    loadWheelPrizes()
  } catch (e) {
    showResult('result-prizes', '‚ùå Fehler: ' + e.message, 'error')
  }
}

async function loadWheelStats() {
  try {
    const today = new Date().toISOString().split('T')[0]
    
    // Today spins
    const { data: todaySpins } = await supabase.from('wheel_spins').select('id', { count: 'exact' }).gte('created_at', today + 'T00:00:00')
    document.getElementById('wheel-stat-today').textContent = todaySpins?.length || 0
    
    // D√∂ner wins (all time)
    const { data: doenerWins } = await supabase.from('wheel_spins').select('id', { count: 'exact' }).ilike('prize_label', '%D√ñNER%')
    document.getElementById('wheel-stat-doener').textContent = doenerWins?.length || 0
    
    // Points distributed (all time)
    const { data: pointsSpins } = await supabase.from('wheel_spins').select('prize_value').eq('prize_type', 'points')
    const totalPoints = pointsSpins?.reduce((sum, spin) => sum + parseInt(spin.prize_value || 0), 0) || 0
    document.getElementById('wheel-stat-points').textContent = totalPoints
    
    // Redeemed
    const { data: redeemed } = await supabase.from('wheel_spins').select('id', { count: 'exact' }).eq('is_redeemed', true)
    document.getElementById('wheel-stat-redeemed').textContent = redeemed?.length || 0
    
  } catch (e) {
    console.error('‚ùå Load stats error:', e)
  }
}

async function loadWheelSpins() {
  try {
    const { data, error } = await supabase.from('wheel_spins').select('*, customers(name, phone)').order('created_at', { ascending: false }).limit(20)
    if (error) throw error
    
    const list = document.getElementById('wheel-spins-list')
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="result info">Noch keine Spins</div>'
      return
    }
    
    list.innerHTML = data.map(spin => {
      const date = new Date(spin.created_at)
      const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })
      const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
      const isRedeemed = spin.is_redeemed
      
      return `
        <div class="customer-item" style="${isRedeemed ? 'background: #fef3c7; border-color: #fbbf24;' : ''}">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <div style="font-weight: 700;">${spin.customers?.name || 'Unbekannt'}</div>
            <div style="font-size: 12px; color: #666;">${dateStr} ${timeStr}</div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
            <div>üéÅ ${spin.prize_label}</div>
            <div>üì± ${spin.customers?.phone || '-'}</div>
            <div style="font-weight: 600; color: #f59e0b;">Code: ${spin.prize_code}</div>
            <div style="color: ${isRedeemed ? '#059669' : '#dc2626'}; font-weight: 600;">
              ${isRedeemed ? '‚úÖ Eingel√∂st' : '‚è≥ Wartet'}
            </div>
          </div>
        </div>
      `
    }).join('')
  } catch (e) {
    console.error('‚ùå Load spins error:', e)
  }
}

// ==========================================
// CUSTOMERS FUNCTIONS
// ==========================================

async function loadCustomers() {
  try {
    const { data, error } = await supabase.from('customers').select('*').order('created_at', { ascending: false })
    if (error) throw error
    
    const list = document.getElementById('customers-list')
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="result info">Keine Kunden gefunden</div>'
      return
    }
    
    list.innerHTML = data.map(customer => `
      <div class="customer-item">
        <h3>${customer.name}</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
          <div>üì± ${customer.phone}</div>
          <div>üÜî ${customer.qr_id}</div>
          <div>‚≠ê ${customer.points} Punkte</div>
          <div>üìÖ ${new Date(customer.created_at).toLocaleDateString('de-DE')}</div>
        </div>
        <div style="margin-top: 10px;">
          <button class="small secondary" onclick="editCustomer(${customer.id}, '${customer.name}', '${customer.phone}', ${customer.points})">‚úèÔ∏è Bearbeiten</button>
          <button class="small danger" onclick="deleteCustomer(${customer.id}, '${customer.name}')">üóëÔ∏è L√∂schen</button>
        </div>
      </div>
    `).join('')
  } catch (e) {
    console.error('‚ùå Load customers error:', e)
  }
}

async function editCustomer(id, currentName, currentPhone, currentPoints) {
  const newName = prompt('Name:', currentName)
  if (!newName) return
  
  const newPhone = prompt('Telefon:', currentPhone)
  if (!newPhone) return
  
  const newPoints = prompt('Punkte:', currentPoints)
  if (newPoints === null) return
  
  try {
    const { error } = await supabase.from('customers').update({
      name: newName,
      phone: newPhone,
      points: parseInt(newPoints)
    }).eq('id', id)
    
    if (error) throw error
    alert('‚úÖ Kunde aktualisiert!')
    loadCustomers()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

async function deleteCustomer(id, name) {
  if (!confirm(`Kunde "${name}" wirklich l√∂schen?`)) return
  
  try {
    const { error } = await supabase.from('customers').delete().eq('id', id)
    if (error) throw error
    alert('‚úÖ Kunde gel√∂scht!')
    loadCustomers()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

// ==========================================
// BONUSES FUNCTIONS
// ==========================================

async function createBonus() {
  const title = document.getElementById('bonus-title').value.trim()
  const type = document.getElementById('bonus-type').value
  const amount = parseInt(document.getElementById('bonus-amount').value)
  const expires = document.getElementById('bonus-expires').value
  
  if (!title || !expires) {
    showResult('result-bonus', '‚ùå Bitte alle Felder ausf√ºllen!', 'error')
    return
  }
  
  try {
    showResult('result-bonus', '‚è≥ Erstelle Bonus...', 'info')
    
    const { error } = await supabase.from('global_bonuses').insert({
      title: title,
      bonus_type: type,
      bonus_amount: type === 'bonus_points' ? amount : null,
      expires_at: new Date(expires).toISOString(),
      is_active: true
    })
    
    if (error) throw error
    
    showResult('result-bonus', '‚úÖ Bonus erstellt!', 'success')
    document.getElementById('bonus-title').value = ''
    document.getElementById('bonus-expires').value = ''
    loadBonuses()
  } catch (e) {
    showResult('result-bonus', '‚ùå Fehler: ' + e.message, 'error')
  }
}

async function loadBonuses() {
  try {
    const { data, error } = await supabase.from('global_bonuses').select('*').order('created_at', { ascending: false })
    if (error) throw error
    
    const list = document.getElementById('bonuses-list')
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="result info">Keine Bonuses</div>'
      return
    }
    
    list.innerHTML = data.map(bonus => {
      const isActive = bonus.is_active && new Date(bonus.expires_at) > new Date()
      return `
        <div class="customer-item">
          <h3>${bonus.title}</h3>
          <div style="font-size: 14px; color: #666; margin-top: 4px;">
            ${bonus.bonus_type === 'double_points' ? '‚≠ê Doppelte Punkte' : `üí∞ +${bonus.bonus_amount} Punkte`}
          </div>
          <div style="font-size: 13px; color: #666; margin-top: 4px;">
            L√§uft ab: ${new Date(bonus.expires_at).toLocaleDateString('de-DE')}
          </div>
          <div style="margin-top: 8px;">
            <span style="padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; background: ${isActive ? '#fef3c7' : '#fee2e2'}; color: ${isActive ? '#92400e' : '#991b1b'};">
              ${isActive ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}
            </span>
          </div>
          <button class="small danger" onclick="deleteBonus(${bonus.id})" style="margin-top: 8px;">üóëÔ∏è L√∂schen</button>
        </div>
      `
    }).join('')
  } catch (e) {
    console.error('‚ùå Load bonuses error:', e)
  }
}

async function deleteBonus(id) {
  if (!confirm('Bonus wirklich l√∂schen?')) return
  try {
    await supabase.from('global_bonuses').delete().eq('id', id)
    loadBonuses()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

// ==========================================
// CHALLENGES FUNCTIONS
// ==========================================

async function createChallenge() {
  const orders = parseInt(document.getElementById('challenge-orders').value)
  const minAmount = parseFloat(document.getElementById('challenge-min-amount').value)
  const points = parseInt(document.getElementById('challenge-points').value)
  const startDate = document.getElementById('challenge-start').value
  const endDate = document.getElementById('challenge-end').value
  
  if (!orders || !minAmount || !points || !startDate || !endDate) {
    showResult('result-challenge', '‚ùå Bitte alle Felder ausf√ºllen!', 'error')
    return
  }
  
  try {
    showResult('result-challenge', '‚è≥ Erstelle Challenge...', 'info')
    
    const { error } = await supabase.from('challenges').insert({
      required_orders: orders,
      min_order_amount: minAmount,
      bonus_points: points,
      start_date: startDate,
      end_date: endDate,
      is_active: true
    })
    
    if (error) throw error
    
    showResult('result-challenge', '‚úÖ Challenge erstellt!', 'success')
    document.getElementById('challenge-orders').value = ''
    document.getElementById('challenge-min-amount').value = ''
    document.getElementById('challenge-points').value = ''
    document.getElementById('challenge-start').value = ''
    document.getElementById('challenge-end').value = ''
    loadChallenges()
  } catch (e) {
    showResult('result-challenge', '‚ùå Fehler: ' + e.message, 'error')
  }
}

async function loadChallenges() {
  try {
    const { data, error } = await supabase.from('challenges').select('*').order('created_at', { ascending: false })
    if (error) throw error
    
    const list = document.getElementById('challenges-list')
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="result info">Keine Challenges</div>'
      return
    }
    
    list.innerHTML = data.map(challenge => {
      const isActive = challenge.is_active && new Date(challenge.end_date) >= new Date()
      return `
        <div class="customer-item">
          <h3>üéÅ ${challenge.bonus_points} Punkte</h3>
          <div style="font-size: 14px; color: #666; margin-top: 4px;">
            ${challenge.required_orders} Bestellungen ab ${challenge.min_order_amount} ‚Ç¨
          </div>
          <div style="font-size: 13px; color: #666; margin-top: 4px;">
            ${new Date(challenge.start_date).toLocaleDateString('de-DE')} - ${new Date(challenge.end_date).toLocaleDateString('de-DE')}
          </div>
          <div style="margin-top: 8px;">
            <span style="padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; background: ${isActive ? '#fef3c7' : '#fee2e2'}; color: ${isActive ? '#92400e' : '#991b1b'};">
              ${isActive ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}
            </span>
          </div>
          <button class="small danger" onclick="deleteChallenge(${challenge.id})" style="margin-top: 8px;">üóëÔ∏è L√∂schen</button>
        </div>
      `
    }).join('')
  } catch (e) {
    console.error('‚ùå Load challenges error:', e)
  }
}

async function deleteChallenge(id) {
  if (!confirm('Challenge wirklich l√∂schen?')) return
  try {
    await supabase.from('challenges').delete().eq('id', id)
    loadChallenges()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

// ==========================================
// COUPONS FUNCTIONS
// ==========================================

async function createCoupon() {
  const title = document.getElementById('coupon-title').value.trim()
  const product = document.getElementById('coupon-product').value.trim()
  const price = parseFloat(document.getElementById('coupon-price').value)
  const description = document.getElementById('coupon-desc').value.trim()
  const expires = document.getElementById('coupon-expires').value
  
  if (!title || !product || !price || !expires) {
    showResult('result-coupon', '‚ùå Bitte Pflichtfelder ausf√ºllen!', 'error')
    return
  }
  
  try {
    showResult('result-coupon', '‚è≥ Erstelle Coupon...', 'info')
    
    const { error } = await supabase.from('coupons').insert({
      title: title,
      product: product,
      price: price,
      description: description || null,
      expires_at: new Date(expires).toISOString(),
      is_active: true
    })
    
    if (error) throw error
    
    showResult('result-coupon', '‚úÖ Coupon erstellt!', 'success')
    document.getElementById('coupon-title').value = ''
    document.getElementById('coupon-product').value = ''
    document.getElementById('coupon-price').value = ''
    document.getElementById('coupon-desc').value = ''
    document.getElementById('coupon-expires').value = ''
    loadCoupons()
  } catch (e) {
    showResult('result-coupon', '‚ùå Fehler: ' + e.message, 'error')
  }
}

async function loadCoupons() {
  try {
    const { data, error } = await supabase.from('coupons').select('*').order('created_at', { ascending: false })
    if (error) throw error
    
    const list = document.getElementById('coupons-list')
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="result info">Keine Coupons</div>'
      return
    }
    
    list.innerHTML = data.map(coupon => {
      const isActive = coupon.is_active && new Date(coupon.expires_at) > new Date()
      return `
        <div class="customer-item">
          <h3>${coupon.title}</h3>
          <div style="font-size: 14px; color: #666; margin-top: 4px;">
            üç¥ ${coupon.product} - ${coupon.price.toFixed(2)} ‚Ç¨
          </div>
          ${coupon.description ? `<div style="font-size: 13px; color: #666; margin-top: 4px;">${coupon.description}</div>` : ''}
          <div style="font-size: 13px; color: #666; margin-top: 4px;">
            L√§uft ab: ${new Date(coupon.expires_at).toLocaleDateString('de-DE')}
          </div>
          <div style="margin-top: 8px;">
            <span style="padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; background: ${isActive ? '#fef3c7' : '#fee2e2'}; color: ${isActive ? '#92400e' : '#991b1b'};">
              ${isActive ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}
            </span>
          </div>
          <button class="small danger" onclick="deleteCoupon(${coupon.id})" style="margin-top: 8px;">üóëÔ∏è L√∂schen</button>
        </div>
      `
    }).join('')
  } catch (e) {
    console.error('‚ùå Load coupons error:', e)
  }
}

async function deleteCoupon(id) {
  if (!confirm('Coupon wirklich l√∂schen?')) return
  try {
    await supabase.from('coupons').delete().eq('id', id)
    loadCoupons()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

// ==========================================
// INIT
// ==========================================

window.onload = () => {
  loadCustomers()
  
  // Set default dates for wheel
  const now = new Date()
  const oneMonthLater = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)
  document.getElementById('wheel-start-date').value = now.toISOString().slice(0, 16)
  document.getElementById('wheel-end-date').value = oneMonthLater.toISOString().slice(0, 16)
}

console.log('‚úÖ D√∂ner Boxx Verwaltung geladen (mit Wheel Integration)')
console.log('üîí Verwendet crypto.getRandomValues() f√ºr sichere Zufallszahlen')
</script>

</body>
</html>
