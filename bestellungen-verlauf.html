<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bestellverlauf - D√∂ner Boxx</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Flame', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

.header-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
}
.header-logo {
  width: 70px;
  height: 70px;
  flex-shrink: 0;
}
.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
h1 { color: #E31E24; margin-bottom: 10px; font-size: 28px; }

.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filter-group label {
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

select, input[type="date"] {
  padding: 10px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 14px;
  font-family: 'Flame', system-ui;
  background: white;
  cursor: pointer;
}

select:focus, input[type="date"]:focus {
  outline: none;
  border-color: #E31E24;
}

button { 
  padding: 10px 20px; 
  background: linear-gradient(135deg, #E31E24, #F9A825); 
  color: white; 
  border: none; 
  border-radius: 10px; 
  font-size: 14px; 
  font-weight: 600; 
  cursor: pointer; 
}
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.stat-card .value {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 4px;
}

.stat-card .label {
  font-size: 14px;
  opacity: 0.9;
}

.order-card {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
}

.order-card.completed {
  background: #f0fdf4;
  border-color: #86efac;
}

.order-card.cancelled {
  background: #fef2f2;
  border-color: #fca5a5;
  opacity: 0.7;
}

.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e5e7eb;
}

.order-number {
  font-size: 24px;
  font-weight: 700;
  color: #E31E24;
}

.order-status {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.order-status.completed {
  background: #86efac;
  color: #166534;
}

.order-status.cancelled {
  background: #fca5a5;
  color: #991b1b;
}

.customer-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-item .icon {
  font-size: 18px;
}

.info-item .text {
  font-size: 14px;
  color: #374151;
}

.info-item .label {
  font-weight: 600;
  color: #111827;
}

.items-list {
  background: white;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 12px;
}

.item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #e5e7eb;
}

.item:last-child {
  border-bottom: none;
}

.item-name {
  font-weight: 600;
  color: #111827;
}

.item-price {
  color: #E31E24;
  font-weight: 700;
}

.order-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #fef3c7;
  border-radius: 10px;
  margin-top: 12px;
}

.order-total .label {
  font-size: 18px;
  font-weight: 600;
  color: #92400e;
}

.order-total .amount {
  font-size: 24px;
  font-weight: 700;
  color: #E31E24;
}

.timestamps {
  display: flex;
  gap: 20px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
  font-size: 12px;
  color: #6b7280;
}

.timestamp {
  display: flex;
  align-items: center;
  gap: 6px;
}

.no-orders {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.no-orders .icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.loading {
  text-align: center;
  padding: 40px;
  font-size: 18px;
  color: #6b7280;
}

.payment-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 8px;
}

.payment-badge.bar {
  background: #fef3c7;
  color: #92400e;
}

.payment-badge.paypal {
  background: #dbeafe;
  color: #1e40af;
}
</style>
</head>
<body>
<div class="container">
  <div class="card header-card">
    <div class="header-logo">
      <img src="/icon-new.png" alt="D√∂ner Boxx" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23E31E24%22/%3E%3Ctext x=%2250%22 y=%2260%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22white%22%3EDB%3C/text%3E%3C/svg%3E'">
    </div>
    <div style="flex: 1;">
      <h1>üì¶ Bestellverlauf</h1>
      <p style="color: #6b7280;">Alle abgeschlossenen und stornierten Bestellungen</p>
    </div>
    <button onclick="window.location.href='scanner.html'" class="secondary">‚Üê Zur√ºck zum Scanner</button>
  </div>

  <div class="card">
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="value" id="statTotal">-</div>
        <div class="label">Gesamtumsatz</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statCompleted">-</div>
        <div class="label">Abgeschlossen</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statCancelled">-</div>
        <div class="label">Storniert</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statAverage">-</div>
        <div class="label">√ò Bestellung</div>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>Status:</label>
        <select id="filterStatus" onchange="applyFilters()">
          <option value="all">Alle</option>
          <option value="completed" selected>Abgeschlossen</option>
          <option value="cancelled">Storniert</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Zeitraum:</label>
        <select id="filterPeriod" onchange="handlePeriodChange()">
          <option value="today">Heute</option>
          <option value="yesterday">Gestern</option>
          <option value="week">Diese Woche</option>
          <option value="month">Dieser Monat</option>
          <option value="custom">Benutzerdefiniert</option>
          <option value="all" selected>Alle Zeit</option>
        </select>
      </div>

      <div class="filter-group" id="customDateRange" style="display: none;">
        <input type="date" id="dateFrom" onchange="applyFilters()">
        <span>bis</span>
        <input type="date" id="dateTo" onchange="applyFilters()">
      </div>

      <div class="filter-group">
        <label>Zahlung:</label>
        <select id="filterPayment" onchange="applyFilters()">
          <option value="all">Alle</option>
          <option value="bar">Bar</option>
          <option value="paypal">PayPal</option>
        </select>
      </div>

      <button onclick="applyFilters()">üîÑ Aktualisieren</button>
    </div>
  </div>

  <div class="card">
    <div id="ordersList" class="loading">
      ‚è≥ Lade Bestellungen...
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚ö†Ô∏è WICHTIG: Supabase Credentials hier einf√ºgen!
const SUPABASE_URL = 'DEINE_SUPABASE_URL'
const SUPABASE_ANON_KEY = 'DEIN_SUPABASE_ANON_KEY'

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let allOrders = []

async function loadOrders() {
  try {
    // Lade ALLE Bestellungen mit Status completed oder cancelled
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .in('status', ['completed', 'cancelled'])
      .order('created_at', { ascending: false })
      .limit(1000) // Maximal 1000 Bestellungen

    if (error) {
      console.error('Fehler beim Laden:', error)
      document.getElementById('ordersList').innerHTML = `
        <div class="no-orders">
          <div class="icon">‚ùå</div>
          <h3>Fehler beim Laden</h3>
          <p>${error.message}</p>
          <p style="margin-top: 12px; font-size: 11px;">Bitte √ºberpr√ºfe die Supabase Credentials im Code.</p>
        </div>
      `
      return
    }

    allOrders = data || []
    applyFilters()

  } catch (e) {
    console.error('Fehler:', e)
    document.getElementById('ordersList').innerHTML = `
      <div class="no-orders">
        <div class="icon">‚ùå</div>
        <h3>Fehler</h3>
        <p>${e.message}</p>
      </div>
    `
  }
}

function applyFilters() {
  const statusFilter = document.getElementById('filterStatus').value
  const periodFilter = document.getElementById('filterPeriod').value
  const paymentFilter = document.getElementById('filterPayment').value

  let filtered = [...allOrders]

  // Status Filter
  if (statusFilter !== 'all') {
    filtered = filtered.filter(o => o.status === statusFilter)
  }

  // Zeitraum Filter
  if (periodFilter !== 'all') {
    const now = new Date()
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
    
    if (periodFilter === 'today') {
      filtered = filtered.filter(o => new Date(o.created_at) >= today)
    } else if (periodFilter === 'yesterday') {
      const yesterday = new Date(today)
      yesterday.setDate(yesterday.getDate() - 1)
      filtered = filtered.filter(o => {
        const date = new Date(o.created_at)
        return date >= yesterday && date < today
      })
    } else if (periodFilter === 'week') {
      const weekStart = new Date(today)
      weekStart.setDate(weekStart.getDate() - weekStart.getDay())
      filtered = filtered.filter(o => new Date(o.created_at) >= weekStart)
    } else if (periodFilter === 'month') {
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1)
      filtered = filtered.filter(o => new Date(o.created_at) >= monthStart)
    } else if (periodFilter === 'custom') {
      const dateFrom = document.getElementById('dateFrom').value
      const dateTo = document.getElementById('dateTo').value
      
      if (dateFrom) {
        const from = new Date(dateFrom)
        filtered = filtered.filter(o => new Date(o.created_at) >= from)
      }
      if (dateTo) {
        const to = new Date(dateTo)
        to.setHours(23, 59, 59)
        filtered = filtered.filter(o => new Date(o.created_at) <= to)
      }
    }
  }

  // Zahlungs Filter
  if (paymentFilter !== 'all') {
    filtered = filtered.filter(o => o.payment_method === paymentFilter)
  }

  renderOrders(filtered)
  updateStats(filtered)
}

function handlePeriodChange() {
  const periodFilter = document.getElementById('filterPeriod').value
  const customDateRange = document.getElementById('customDateRange')
  
  if (periodFilter === 'custom') {
    customDateRange.style.display = 'flex'
  } else {
    customDateRange.style.display = 'none'
  }
  
  applyFilters()
}

function updateStats(orders) {
  const completed = orders.filter(o => o.status === 'completed')
  const cancelled = orders.filter(o => o.status === 'cancelled')
  
  const totalRevenue = completed.reduce((sum, o) => sum + parseFloat(o.total), 0)
  const avgOrder = completed.length > 0 ? totalRevenue / completed.length : 0

  document.getElementById('statTotal').textContent = formatPrice(totalRevenue)
  document.getElementById('statCompleted').textContent = completed.length
  document.getElementById('statCancelled').textContent = cancelled.length
  document.getElementById('statAverage').textContent = formatPrice(avgOrder)
}

function renderOrders(orders) {
  const container = document.getElementById('ordersList')
  
  if (!orders || orders.length === 0) {
    container.innerHTML = `
      <div class="no-orders">
        <div class="icon">üì¶</div>
        <h3>Keine Bestellungen gefunden</h3>
        <p>F√ºr die ausgew√§hlten Filter wurden keine Bestellungen gefunden.</p>
      </div>
    `
    return
  }

  container.innerHTML = orders.map(order => {
    const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items
    const createdAt = new Date(order.created_at)
    const completedAt = order.completed_at ? new Date(order.completed_at) : null
    const cancelledAt = order.cancelled_at ? new Date(order.cancelled_at) : null
    
    return `
      <div class="order-card ${order.status}">
        <div class="order-header">
          <div>
            <span class="order-number">#${order.order_number}</span>
            <span class="payment-badge ${order.payment_method}">${order.payment_method === 'paypal' ? 'üí≥ PayPal' : 'üíµ Bar'}</span>
          </div>
          <span class="order-status ${order.status}">
            ${order.status === 'completed' ? '‚úÖ Abgeschlossen' : '‚ùå Storniert'}
          </span>
        </div>

        <div class="customer-info">
          <div class="info-item">
            <span class="icon">üë§</span>
            <div class="text">
              <div class="label">${order.customer_name}</div>
            </div>
          </div>
          <div class="info-item">
            <span class="icon">üìû</span>
            <div class="text">
              <div class="label">${order.customer_phone}</div>
            </div>
          </div>
          <div class="info-item">
            <span class="icon">üé´</span>
            <div class="text">
              <div class="label">QR: ${order.qr_id}</div>
            </div>
          </div>
          <div class="info-item">
            <span class="icon">üöó</span>
            <div class="text">
              <div class="label">${order.pickup_type === 'later' ? 'üïê Sp√§ter: ' + order.pickup_time : '‚ö° Sofort'}</div>
            </div>
          </div>
        </div>

        <div class="items-list">
          ${items.map(item => `
            <div class="item">
              <span class="item-name">${item.name} ${item.quantity > 1 ? `(${item.quantity}x)` : ''}</span>
              <span class="item-price">${formatPrice(item.price * item.quantity)}</span>
            </div>
          `).join('')}
        </div>

        ${order.notes ? `<div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 14px;"><strong>üí¨ Notiz:</strong> ${order.notes}</div>` : ''}

        <div class="order-total">
          <span class="label">Gesamt:</span>
          <span class="amount">${formatPrice(order.total)}</span>
        </div>

        <div class="timestamps">
          <div class="timestamp">
            <span>üïê</span>
            <span>Erstellt: ${formatDateTime(createdAt)}</span>
          </div>
          ${completedAt ? `
            <div class="timestamp">
              <span>‚úÖ</span>
              <span>Abgeschlossen: ${formatDateTime(completedAt)}</span>
            </div>
          ` : ''}
          ${cancelledAt ? `
            <div class="timestamp">
              <span>‚ùå</span>
              <span>Storniert: ${formatDateTime(cancelledAt)}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `
  }).join('')
}

function formatPrice(price) {
  return parseFloat(price).toFixed(2).replace('.', ',') + ' ‚Ç¨'
}

function formatDateTime(date) {
  return date.toLocaleString('de-DE', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

// Initial laden
loadOrders()

// Auto-Refresh alle 30 Sekunden
setInterval(loadOrders, 30000)
</script>
</body>
</html>
