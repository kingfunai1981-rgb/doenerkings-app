<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂nerkings Loyalty</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

.header {
  background: white;
  padding: 16px 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.logo { font-size: 20px; font-weight: 700; color: #667eea; }

.container { max-width: 600px; margin: 0 auto; padding: 20px; }

.card {
  background: white;
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.points-circle {
  width: 200px;
  height: 200px;
  margin: 20px auto;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}
.points-num { font-size: 56px; font-weight: 700; }
.points-label { font-size: 16px; opacity: 0.9; margin-top: 8px; }

.qr-display {
  text-align: center;
  padding: 20px;
  background: #f9fafb;
  border-radius: 16px;
  margin: 20px 0;
}
.qr-img {
  width: 240px;
  height: 240px;
  margin: 0 auto;
  border-radius: 12px;
  background: white;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 16px;
  margin-bottom: 12px;
}
input:focus { outline: none; border-color: #667eea; }

button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 16px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}
button:active { transform: scale(0.98); }
button.secondary {
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  box-shadow: none;
}

.reward {
  background: #f9fafb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.reward h3 { font-size: 16px; margin-bottom: 4px; }
.reward .pts { font-size: 14px; color: #667eea; font-weight: 600; }
.reward button {
  width: auto;
  padding: 10px 20px;
  margin: 0;
  font-size: 14px;
}
.reward button:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  box-shadow: none;
}

.result {
  padding: 12px;
  border-radius: 12px;
  margin-top: 12px;
  font-size: 14px;
  text-align: center;
}
.success { background: #d1fae5; color: #065f46; }
.error { background: #fee2e2; color: #991b1b; }
.info { color: #6b7280; font-size: 14px; text-align: center; margin-top: 10px; }

.screen { display: none; }
.screen.active { display: block; }

.welcome {
  text-align: center;
  padding: 60px 20px;
  color: white;
}
.welcome h1 { font-size: 36px; margin-bottom: 12px; text-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.welcome p { font-size: 18px; opacity: 0.95; margin-bottom: 20px; }
</style>
</head>
<body>

<!-- WELCOME SCREEN -->
<div id="welcome" class="screen active">
  <div class="welcome">
    <h1>üåØ D√∂nerkings</h1>
    <p>Treue wird belohnt!</p>
    <p style="font-size: 14px; opacity: 0.8;">1 ‚Ç¨ = 10 Punkte</p>
  </div>
  <div class="container">
    <div class="card">
      <h2 style="margin-bottom: 16px;">Neu hier?</h2>
      <input id="regName" placeholder="Dein Name">
      <input id="regPhone" type="tel" placeholder="Handynummer (z.B. 0151...)">
      <button onclick="register()">Jetzt registrieren</button>
      <button class="secondary" onclick="showLogin()">Ich habe schon einen Account</button>
      <div id="regResult"></div>
    </div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="login" class="screen">
  <div class="header">
    <div class="logo">Anmelden</div>
    <button onclick="showWelcome()" style="width: auto; padding: 8px 16px; background: #f3f4f6; color: #6b7280; font-size: 14px; box-shadow: none;">Zur√ºck</button>
  </div>
  <div class="container">
    <div class="card">
      <h2 style="margin-bottom: 16px;">Anmelden</h2>
      <input id="loginPhone" type="tel" placeholder="Handynummer">
      <button onclick="loginCustomer()">Anmelden</button>
      <div id="loginResult"></div>
    </div>
  </div>
</div>

<!-- CUSTOMER APP -->
<div id="customerApp" class="screen">
  <div class="header">
    <div class="logo">Mein Account</div>
    <button onclick="logout()" style="width: auto; padding: 8px 16px; background: #f3f4f6; color: #6b7280; font-size: 14px; box-shadow: none;">Abmelden</button>
  </div>
  
  <div class="container">
    <div class="card">
      <div class="points-circle">
        <div class="points-num" id="custPoints">0</div>
        <div class="points-label">Punkte</div>
      </div>
      <div class="info">
        <div><strong id="custName">-</strong></div>
        <div id="custPhone">-</div>
      </div>
    </div>
    
    <div class="card">
      <h3 style="margin-bottom: 16px; text-align: center;">Dein Treue-QR</h3>
      <div class="qr-display">
        <img id="custQR" class="qr-img" alt="QR Code">
        <div class="info" style="margin-top: 12px;">Zeige diesen Code beim Bezahlen</div>
        <div class="info" style="font-size: 12px; margin-top: 8px;">QR-ID: <strong id="qrIdDisplay">-</strong></div>
      </div>
    </div>
    
    <div class="card">
      <h3 style="margin-bottom: 16px;">Pr√§mien einl√∂sen</h3>
      <div id="rewardsList">
        <div class="reward">
          <div>
            <h3>Getr√§nk 0,5l</h3>
            <div class="pts">50 Punkte</div>
          </div>
          <button onclick="redeemReward('Getr√§nk 0,5l', 50)" id="btn50">Einl√∂sen</button>
        </div>
        <div class="reward">
          <div>
            <h3>Pommes</h3>
            <div class="pts">100 Punkte</div>
          </div>
          <button onclick="redeemReward('Pommes', 100)" id="btn100">Einl√∂sen</button>
        </div>
        <div class="reward">
          <div>
            <h3>D√∂ner</h3>
            <div class="pts">200 Punkte</div>
          </div>
          <button onclick="redeemReward('D√∂ner', 200)" id="btn200">Einl√∂sen</button>
        </div>
        <div class="reward">
          <div>
            <h3>Men√º</h3>
            <div class="pts">300 Punkte</div>
          </div>
          <button onclick="redeemReward('Men√º (D√∂ner + Getr√§nk)', 300)" id="btn300">Einl√∂sen</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
let currentCustomer = null

function showResult(elementId, message, isSuccess) {
  const el = document.getElementById(elementId)
  el.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">${message}</div>`
}

function showWelcome() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'))
  document.getElementById('welcome').classList.add('active')
}

function showLogin() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'))
  document.getElementById('login').classList.add('active')
}

function showCustomerApp() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'))
  document.getElementById('customerApp').classList.add('active')
}

function logout() {
  currentCustomer = null
  localStorage.removeItem('customerData')
  showWelcome()
}

async function register() {
  const name = document.getElementById('regName').value.trim()
  const phone = document.getElementById('regPhone').value.trim()
  
  if (!name || !phone) {
    showResult('regResult', 'Bitte Name und Handynummer eingeben!', false)
    return
  }
  
  try {
    const { data, error } = await supabase.rpc('signup_customer', {
      p_name: name,
      p_phone: phone
    })
    
    if (error) throw error
    
    if (data.existing) {
      showResult('regResult', 'Nummer bereits registriert! Wird angemeldet...', true)
    } else {
      showResult('regResult', '‚úÖ Erfolgreich registriert!', true)
    }
    
    setTimeout(() => {
      const customer = {
        id: data.id,
        name,
        phone,
        qr_id: data.qr_id,
        points: data.points
      }
      loadCustomer(customer)
    }, 1000)
    
  } catch (e) {
    showResult('regResult', '‚ùå Fehler: ' + e.message, false)
  }
}

async function loginCustomer() {
  const phone = document.getElementById('loginPhone').value.trim()
  
  if (!phone) {
    showResult('loginResult', 'Bitte Handynummer eingeben!', false)
    return
  }
  
  try {
    const { data, error } = await supabase.rpc('get_customer_by_phone', { p_phone: phone })
    
    if (error) throw error
    if (!data.ok) throw new Error('Nummer nicht gefunden')
    
    const customer = {
      id: data.id,
      name: data.name,
      phone: data.phone,
      qr_id: data.qr_id,
      points: data.points
    }
    loadCustomer(customer)
    
  } catch (e) {
    showResult('loginResult', '‚ùå ' + e.message, false)
  }
}

function loadCustomer(customer) {
  currentCustomer = customer
  localStorage.setItem('customerData', JSON.stringify(customer))
  
  document.getElementById('custName').textContent = customer.name
  document.getElementById('custPhone').textContent = customer.phone
  document.getElementById('custPoints').textContent = customer.points
  document.getElementById('qrIdDisplay').textContent = customer.qr_id
  document.getElementById('custQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${customer.qr_id}`
  
  updateRewardButtons(customer.points)
  showCustomerApp()
}

function updateRewardButtons(points) {
  document.getElementById('btn50').disabled = points < 50
  document.getElementById('btn100').disabled = points < 100
  document.getElementById('btn200').disabled = points < 200
  document.getElementById('btn300').disabled = points < 300
}

async function redeemReward(name, cost) {
  if (!currentCustomer) return
  
  if (!confirm(`${name} f√ºr ${cost} Punkte einl√∂sen?`)) return
  
  try {
    const { data, error } = await supabase.rpc('make_redeem', {
      p_qr_id: currentCustomer.qr_id,
      p_reward: name,
      p_cost: cost
    })
    
    if (error) throw error
    
    const expires = new Date(Date.now() + 24*60*60*1000)
    alert(`‚úÖ Eingel√∂st!\n\nDein Code: ${data.code}\n\nZeige diesen Code an der Kasse!\n\nG√ºltig bis: ${expires.toLocaleString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'})}`)
    
    // Reload
    const { data: updated, error: err } = await supabase.rpc('get_customer_by_qr', { p_qr_id: currentCustomer.qr_id })
    if (!err && updated.ok) {
      currentCustomer.points = updated.points
      document.getElementById('custPoints').textContent = updated.points
      updateRewardButtons(updated.points)
      localStorage.setItem('customerData', JSON.stringify(currentCustomer))
    }
    
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

// Auto-login
window.onload = () => {
  const stored = localStorage.getItem('customerData')
  if (stored) {
    try {
      const customer = JSON.parse(stored)
      loadCustomer(customer)
    } catch (e) {
      localStorage.removeItem('customerData')
    }
  }
}

console.log('‚úÖ Kunden-App geladen!')
</script>

</body>
</html>