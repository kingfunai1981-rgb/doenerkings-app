<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bestellung - D√∂ner Boxx</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon-new.png">
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 80px;
}

.container { 
  max-width: 500px; 
  margin: 0 auto;
  background: white;
  min-height: 100vh;
}

/* Header */
.header {
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-logo {
  width: 80px;
  height: 80px;
  margin: 0 auto 12px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.header h1 {
  color: white;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.header p {
  color: white;
  font-size: 14px;
  opacity: 0.9;
}

/* Produkt-Karten */
.products {
  padding: 16px;
}

.category-section {
  margin-bottom: 8px;
}

.category-header {
  background: linear-gradient(135deg, #f9fafb, #f3f4f6);
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 0;
}

.category-header:hover {
  border-color: #E31E24;
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
}

.category-title {
  font-size: 18px;
  font-weight: 700;
  color: #232122;
  display: flex;
  align-items: center;
  gap: 8px;
}

.category-count {
  font-size: 14px;
  font-weight: 600;
  color: #666;
  background: white;
  padding: 2px 8px;
  border-radius: 12px;
}

.category-arrow {
  font-size: 16px;
  color: #E31E24;
  font-weight: 700;
  transition: transform 0.3s;
}

.category-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  padding: 0 4px;
}

.category-content.open {
  max-height: 5000px;
  padding: 12px 4px 0;
}

.product-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 2px solid #f0f0f0;
  cursor: pointer;
  transition: all 0.2s;
}

.product-card:hover {
  border-color: #E31E24;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.15);
}

.product-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.product-name {
  font-size: 18px;
  font-weight: 700;
  color: #232122;
}

.product-price {
  font-size: 20px;
  font-weight: 700;
  color: #E31E24;
}

.product-desc {
  font-size: 13px;
  color: #666;
  margin-bottom: 12px;
  line-height: 1.5;
}

.add-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  margin-top: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.add-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 9999;
  align-items: flex-end;
  justify-content: center;
}

.modal.active {
  display: flex;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  border-radius: 20px 20px 0 0;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-header {
  position: sticky;
  top: 0;
  background: white;
  padding: 20px;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 1;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  color: #232122;
}

.modal-close {
  background: #f5f5f5;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-body {
  padding: 20px;
}

.option-group {
  margin-bottom: 24px;
}

.option-label {
  font-size: 15px;
  font-weight: 700;
  color: #232122;
  margin-bottom: 12px;
  display: block;
}

.option-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.option-btn {
  flex: 1;
  min-width: 60px;
  padding: 10px 16px;
  background: #f5f5f5;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.option-btn:hover {
  background: #ebebeb;
}

.option-btn.active {
  background: linear-gradient(135deg, #E31E24, #F9A825);
  border-color: #E31E24;
  color: white;
}

.option-btn.disabled,
.option-btn:disabled {
  background: #f5f5f5;
  border-color: #e5e7eb;
  color: #d1d5db;
  cursor: not-allowed;
  opacity: 0.5;
}

.option-btn.disabled:hover,
.option-btn:disabled:hover {
  background: #f5f5f5;
  transform: none;
}

.extra-item {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all 0.2s;
}

.extra-item:hover {
  border-color: #E31E24;
  background: #fef2f2;
}

.extra-item.selected {
  border-color: #E31E24;
  background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(249, 168, 37, 0.1));
}

.extra-info {
  flex: 1;
}

.extra-name {
  font-size: 14px;
  font-weight: 600;
  color: #232122;
}

.extra-price {
  font-size: 16px;
  font-weight: 700;
  color: #E31E24;
}

.modal-footer {
  position: sticky;
  bottom: 0;
  background: white;
  padding: 16px 20px;
  border-top: 1px solid #f0f0f0;
}

.modal-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 18px;
  font-weight: 700;
}

.modal-total-price {
  color: #E31E24;
  font-size: 24px;
}

/* Warenkorb */
.cart-fixed {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px 16px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  z-index: 999;
}

.cart-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}

.cart-btn:hover {
  opacity: 0.9;
}

.cart-count {
  background: white;
  color: #E31E24;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
}

.cart-modal .modal-content {
  border-radius: 20px 20px 0 0;
}

.cart-item {
  background: #f9fafb;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  border: 2px solid #e5e7eb;
}

.cart-item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.cart-item-name {
  font-size: 16px;
  font-weight: 700;
  color: #232122;
}

.cart-item-price {
  font-size: 18px;
  font-weight: 700;
  color: #E31E24;
}

.cart-item-options {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
  line-height: 1.6;
}

.cart-item-actions {
  display: flex;
  gap: 8px;
}

.cart-item-btn {
  flex: 1;
  padding: 8px;
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
}

.cart-item-btn:hover {
  background: #ebebeb;
}

.cart-item-btn.delete {
  background: #fee2e2;
  border-color: #fecaca;
  color: #991b1b;
}

.cart-empty {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.cart-empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

/* Checkout */
.checkout-section {
  margin-bottom: 20px;
}

.checkout-section h3 {
  font-size: 16px;
  font-weight: 700;
  color: #232122;
  margin-bottom: 12px;
}

input[type="text"],
input[type="tel"],
textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  font-family: 'Flame', sans-serif;
  margin-bottom: 8px;
  transition: all 0.2s;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #E31E24;
}

.payment-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.payment-btn {
  padding: 16px;
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.payment-btn:hover {
  border-color: #E31E24;
  background: #fef2f2;
}

.payment-btn.active {
  border-color: #E31E24;
  background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(249, 168, 37, 0.1));
}

.payment-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.payment-name {
  font-size: 14px;
  font-weight: 600;
  color: #232122;
}

.pickup-time-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.pickup-time-btn {
  padding: 16px;
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.pickup-time-btn:hover {
  border-color: #E31E24;
  background: #fef2f2;
}

.pickup-time-btn.active {
  border-color: #E31E24;
  background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(249, 168, 37, 0.1));
}

.pickup-time-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.pickup-time-name {
  font-size: 15px;
  font-weight: 600;
  color: #232122;
  margin-bottom: 4px;
}

.pickup-time-desc {
  font-size: 12px;
  color: #666;
}

.order-summary {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.summary-row.total {
  font-size: 18px;
  font-weight: 700;
  padding-top: 12px;
  border-top: 2px solid #e5e7eb;
  margin-top: 8px;
  color: #E31E24;
}

.place-order-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.place-order-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.place-order-btn:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  transform: none;
}

.success-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.success-modal.active {
  display: flex;
}

.success-content {
  background: white;
  border-radius: 20px;
  padding: 40px 30px;
  max-width: 400px;
  text-align: center;
  animation: scaleIn 0.5s;
}

@keyframes scaleIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

.success-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.success-title {
  font-size: 24px;
  font-weight: 700;
  color: #232122;
  margin-bottom: 12px;
}

.success-text {
  font-size: 15px;
  color: #666;
  margin-bottom: 24px;
  line-height: 1.6;
}

.order-number {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 24px;
}

.order-number-label {
  font-size: 13px;
  color: #92400e;
  margin-bottom: 4px;
}

.order-number-value {
  font-size: 32px;
  font-weight: 700;
  color: #E31E24;
  font-family: 'Courier New', monospace;
  letter-spacing: 2px;
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-logo">
      <img src="/logo-round-new.png" alt="D√∂ner Boxx">
    </div>
    <h1>Online Bestellen</h1>
    <p>W√§hle deine Lieblingsgerichte</p>
  </div>

  <!-- Produkte -->
  <div class="products" id="products">
    <!-- Wird dynamisch gef√ºllt -->
  </div>
</div>

<!-- Warenkorb Button (fixiert unten) -->
<div class="cart-fixed" id="cartFixed" style="display: none;">
  <button class="cart-btn" onclick="openCart()">
    <span>üõí Warenkorb ansehen</span>
    <div>
      <span class="cart-count" id="cartCount">0</span>
      <span id="cartTotal" style="margin-left: 8px;">0,00 ‚Ç¨</span>
    </div>
  </button>
</div>

<!-- Produkt-Anpassung Modal -->
<div class="modal" id="customizeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Produkt anpassen</h2>
      <button class="modal-close" onclick="closeCustomizeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Wird dynamisch gef√ºllt -->
    </div>
    <div class="modal-footer">
      <div class="modal-total">
        <span>Gesamt:</span>
        <span class="modal-total-price" id="modalTotal">0,00 ‚Ç¨</span>
      </div>
      <button class="add-btn" onclick="addToCart()">
        In den Warenkorb
      </button>
    </div>
  </div>
</div>

<!-- Warenkorb Modal -->
<div class="modal cart-modal" id="cartModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Dein Warenkorb</h2>
      <button class="modal-close" onclick="closeCart()">‚úï</button>
    </div>
    <div class="modal-body" id="cartItems">
      <!-- Wird dynamisch gef√ºllt -->
    </div>
    <div class="modal-footer">
      <div class="modal-total">
        <span>Gesamt:</span>
        <span class="modal-total-price" id="cartModalTotal">0,00 ‚Ç¨</span>
      </div>
      <button class="add-btn" onclick="goToCheckout()">
        Zur Kasse (üõí <span id="cartModalCount">0</span>)
      </button>
    </div>
  </div>
</div>

<!-- Checkout Modal -->
<div class="modal" id="checkoutModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Bestellung abschlie√üen</h2>
      <button class="modal-close" onclick="closeCheckout()">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Kontaktdaten -->
      <div class="checkout-section">
        <h3>üì± Kontaktdaten</h3>
        <input type="text" id="customerName" placeholder="Dein Name" required>
        <input type="tel" id="customerPhone" placeholder="Telefonnummer" required>
        <textarea id="customerNotes" placeholder="Anmerkungen zur Bestellung (optional)" rows="3"></textarea>
      </div>

      <!-- Abholzeit -->
      <div class="checkout-section">
        <h3>üïê Abholzeit</h3>
        <div class="pickup-time-options">
          <div class="pickup-time-btn active" id="pickupNow" onclick="selectPickupTime('now')">
            <div class="pickup-time-icon">‚ö°</div>
            <div class="pickup-time-name">Sofort</div>
            <div class="pickup-time-desc">~15 Min.</div>
          </div>
          <div class="pickup-time-btn" id="pickupLater" onclick="selectPickupTime('later')">
            <div class="pickup-time-icon">üïê</div>
            <div class="pickup-time-name">Sp√§ter</div>
            <div class="pickup-time-desc">Uhrzeit w√§hlen</div>
          </div>
        </div>
        <div id="timePickerContainer" style="display: none; margin-top: 12px;">
          <input type="time" id="pickupTimeInput" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
        </div>
      </div>

      <!-- Bestell√ºbersicht -->
      <div class="checkout-section">
        <h3>üì¶ Deine Bestellung</h3>
        <div class="order-summary" id="checkoutSummary">
          <!-- Wird dynamisch gef√ºllt -->
        </div>
      </div>

      <!-- Zahlungsart -->
      <div class="checkout-section">
        <h3>üí≥ Zahlungsart</h3>
        <div class="payment-options">
          <div class="payment-btn" id="paymentCash" onclick="selectPayment('cash')">
            <div class="payment-icon">üíµ</div>
            <div class="payment-name">Bar bezahlen</div>
          </div>
          <div class="payment-btn" id="paymentPaypal" onclick="selectPayment('paypal')">
            <div class="payment-icon">üí≥</div>
            <div class="payment-name">PayPal</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()" disabled>
        Jetzt bestellen - <span id="finalTotal">0,00 ‚Ç¨</span>
      </button>
    </div>
  </div>
</div>

<!-- Erfolgs-Modal -->
<div class="success-modal" id="successModal">
  <div class="success-content">
    <div class="success-icon">‚úÖ</div>
    <h2 class="success-title">Bestellung erfolgreich!</h2>
    <p class="success-text">
      Deine Bestellung wurde erfolgreich aufgegeben. 
      Wir bereiten sie jetzt f√ºr dich zu!
    </p>
    <div class="order-number">
      <div class="order-number-label">Bestellnummer</div>
      <div class="order-number-value" id="orderNumber">#0000</div>
    </div>
    
    <!-- QR Code Section -->
    <div style="background: white; border: 3px solid #E31E24; border-radius: 16px; padding: 20px; margin: 20px 0;">
      <div style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">
        üéÅ Zeige diesen Code beim Abholen
      </div>
      <div id="qrCodeContainer" style="display: flex; justify-content: center; margin: 16px 0;">
        <!-- QR Code wird hier eingef√ºgt -->
      </div>
      <div style="font-size: 32px; font-weight: 700; color: #E31E24; font-family: 'Courier New', monospace; letter-spacing: 3px; text-align: center;" id="orderQRID">
        000000
      </div>
      <div style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
        ‚Üí Punkte werden automatisch gutgeschrieben
      </div>
    </div>
    
    <button class="add-btn" onclick="closeSuccess()">
      Neue Bestellung
    </button>
  </div>
</div>

<script>
// ===== SUPABASE KONFIGURATION =====
// WICHTIG: Ersetze diese Werte mit deinen echten Supabase-Credentials!
const supabaseUrl = 'DEINE_SUPABASE_URL_HIER'
const supabaseKey = 'DEIN_ANON_KEY_HIER'
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

// ===== PRODUKT-DATEN =====
const products = [
  {
    id: 'doener',
    name: 'D√∂ner',
    price: 6.00,
    description: 'Klassischer D√∂ner im Fladenbrot',
    defaultSauce: 2, // 2x Knoblauch
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'doener-xl',
    name: 'D√∂ner XL',
    price: 8.00,
    description: 'Extra gro√üer D√∂ner f√ºr gro√üen Hunger',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      kaese: { label: 'K√§se', choices: [0, 1], default: 0 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'doener-box',
    name: 'D√∂ner Box',
    price: 7.00,
    description: 'D√∂nerfleisch mit Pommes in der Box',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'dueruem',
    name: 'D√ºr√ºm D√∂ner',
    price: 7.00,
    description: 'D√∂ner gerollt im d√ºnnen Fladenbrot',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'lahmacun',
    name: 'Lahmacun',
    price: 4.00,
    description: 'T√ºrkische Pizza',
    defaultSauce: 2,
    options: {
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'lahmacun-spezial',
    name: 'Lahmacun Spezial',
    price: 8.00,
    description: 'Lahmacun mit D√∂nerfleisch',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'doener-teller',
    name: 'D√∂ner Teller',
    price: 10.00,
    description: 'D√∂nerfleisch mit Pommes und Salat auf dem Teller',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'rindswurst-broetchen',
    name: 'Rindswurst im Br√∂tchen',
    price: 3.50,
    description: 'Gegrillte Rindswurst im frischen Br√∂tchen',
    options: {
      ketchup: { label: 'Ketchup', choices: [0, 1], default: 1 }
    },
    extras: []
  },
  {
    id: 'curry-rindswurst',
    name: 'Curry Rindswurst mit Pommes',
    price: 6.90,
    description: 'Currywurst mit knusprigen Pommes',
    options: {
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      currysauce: { label: 'Currysauce', choices: [0, 1], default: 1 },
      mayo: { label: 'Mayonnaise', choices: [0, 1], default: 0 }
    },
    extras: []
  },
  {
    id: 'koefte-brot',
    name: 'K√∂fte im Brot (5 Stk.)',
    price: 6.00,
    description: 'Gegrillte Hackfleischb√§llchen im Fladenbrot',
    defaultSauce: 2,
    options: {
      koefte: { label: 'K√∂fte', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraKoefte', name: 'Extra K√∂fte', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'koefte-teller',
    name: 'K√∂fte Teller (7 Stk.)',
    price: 11.00,
    description: 'Gegrillte Hackfleischb√§llchen mit Pommes und Salat',
    defaultSauce: 2,
    options: {
      koefte: { label: 'K√∂fte', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Sauce Knoblauch', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Sauce Scharf', choices: [0, 1, 2], default: 0 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraKoefte', name: 'Extra K√∂fte', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Sauce Knoblauch', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Sauce Scharf', price: 0.70 }
    ]
  },
  {
    id: 'chicken-nuggets',
    name: 'Chicken Nuggets (6 Stk.)',
    price: 6.00,
    description: 'Knusprige Chicken Nuggets mit Pommes',
    options: {
      nuggets: { label: 'Chicken Nuggets', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      ketchup: { label: 'Ketchup', choices: [0, 1], default: 1 },
      mayo: { label: 'Mayonnaise', choices: [0, 1], default: 0 }
    },
    extras: [
      { id: 'extraNuggets', name: 'Extra Nuggets (3 Stk.)', price: 2.00 }
    ]
  },
  {
    id: 'crispy-chicken-burger',
    name: 'Crispy Chicken Burger',
    price: 4.00,
    description: 'Knuspriger Chicken Burger',
    options: {
      mayo: { label: 'Mayonnaise', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 }
    },
    extras: []
  },
  {
    id: 'pommes',
    name: 'Pommes',
    price: 3.50,
    description: 'Knusprige Pommes Frites',
    options: {
      sauce: { label: 'Sauce', choices: ['Ohne', 'Ketchup', 'Mayonnaise'], default: 'Ketchup' }
    },
    extras: [
      { id: 'extraKetchup', name: 'Extra Ketchup', price: 0.30 },
      { id: 'extraMayo', name: 'Extra Mayonnaise', price: 0.30 }
    ]
  },
  {
    id: 'ayran',
    name: 'Ayran (0,25 l)',
    price: 1.50,
    description: 'Erfrischendes t√ºrkisches Joghurtgetr√§nk',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'wasser',
    name: 'Wasser still (0,5 l)',
    price: 1.50,
    description: 'Stilles Mineralwasser (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'cola',
    name: 'Cola (0,33 l)',
    price: 2.00,
    description: 'Coca Cola (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'fanta',
    name: 'Fanta (0,33 l)',
    price: 2.00,
    description: 'Fanta Orange (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'cola-zero',
    name: 'Cola Zero (0,33 l)',
    price: 2.00,
    description: 'Coca Cola Zero (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  }
]

// ===== STATE =====
let cart = []
let currentProduct = null
let currentCustomization = {}
let selectedPayment = null
let selectedPickupTime = 'now' // 'now' oder 'later'
let selectedPickupTimeValue = null // Uhrzeit wenn 'later'

// ===== INITIALISIERUNG =====
function init() {
  renderProducts()
}

// ===== PRODUKTE RENDERN =====
function renderProducts() {
  const container = document.getElementById('products')
  
  // Gruppiere Produkte nach Kategorien
  const categories = [
    {
      name: 'üåØ D√∂ner & D√ºr√ºm',
      ids: ['doener', 'doener-xl', 'dueruem', 'doener-box', 'doener-teller'],
      open: true // Erste Kategorie standardm√§√üig offen
    },
    {
      name: 'ü•ô Lahmacun',
      ids: ['lahmacun', 'lahmacun-spezial'],
      open: false
    },
    {
      name: 'üçñ K√∂fte',
      ids: ['koefte-brot', 'koefte-teller'],
      open: false
    },
    {
      name: 'üå≠ Wurst',
      ids: ['rindswurst-broetchen', 'curry-rindswurst'],
      open: false
    },
    {
      name: 'üçó Chicken',
      ids: ['chicken-nuggets', 'crispy-chicken-burger'],
      open: false
    },
    {
      name: 'üçü Beilagen',
      ids: ['pommes'],
      open: false
    },
    {
      name: 'ü•§ Getr√§nke',
      ids: ['ayran', 'wasser', 'cola', 'fanta', 'cola-zero'],
      open: false
    }
  ]
  
  let html = ''
  
  categories.forEach((category, index) => {
    const categoryProducts = products.filter(p => category.ids.includes(p.id))
    if (categoryProducts.length === 0) return
    
    html += `
      <div class="category-section">
        <div class="category-header" onclick="toggleCategory(${index})">
          <h3 class="category-title">
            ${category.name}
            <span class="category-count">(${categoryProducts.length})</span>
          </h3>
          <span class="category-arrow" id="arrow-${index}">
            ${category.open ? '‚ñº' : '‚ñ∂'}
          </span>
        </div>
        <div class="category-content ${category.open ? 'open' : ''}" id="category-${index}">
          ${categoryProducts.map(product => {
            const hasOptions = Object.keys(product.options).length > 0 || product.extras.length > 0
            const buttonText = hasOptions ? 'Anpassen & Bestellen' : 'In den Warenkorb'
            
            return `
              <div class="product-card" onclick="openCustomize('${product.id}')">
                <div class="product-header">
                  <div class="product-name">${product.name}</div>
                  <div class="product-price">${formatPrice(product.price)}</div>
                </div>
                <div class="product-desc">${product.description}</div>
                <button class="add-btn" onclick="event.stopPropagation(); openCustomize('${product.id}')">
                  ${buttonText}
                </button>
              </div>
            `
          }).join('')}
        </div>
      </div>
    `
  })
  
  container.innerHTML = html
}

function toggleCategory(index) {
  const content = document.getElementById(`category-${index}`)
  const arrow = document.getElementById(`arrow-${index}`)
  
  if (content.classList.contains('open')) {
    content.classList.remove('open')
    arrow.textContent = '‚ñ∂'
  } else {
    content.classList.add('open')
    arrow.textContent = '‚ñº'
  }
}

// ===== ANPASSUNGS-MODAL √ñFFNEN =====
function openCustomize(productId) {
  currentProduct = products.find(p => p.id === productId)
  currentCustomization = {
    product: currentProduct,
    options: {},
    extras: []
  }
  
  // Standardwerte setzen
  Object.keys(currentProduct.options).forEach(key => {
    currentCustomization.options[key] = currentProduct.options[key].default
  })
  
  // Wenn Produkt keine Optionen hat, direkt zum Warenkorb hinzuf√ºgen
  if (Object.keys(currentProduct.options).length === 0 && currentProduct.extras.length === 0) {
    addToCart()
    return
  }
  
  renderCustomizeModal()
  document.getElementById('customizeModal').classList.add('active')
}

function closeCustomizeModal() {
  document.getElementById('customizeModal').classList.remove('active')
  currentProduct = null
  currentCustomization = {}
}

// ===== ANPASSUNGS-MODAL RENDERN =====
function renderCustomizeModal() {
  document.getElementById('modalTitle').textContent = currentProduct.name
  
  let optionsHtml = ''
  
  // Berechne aktuelle Sauce-Summe f√ºr Sauce-Limit
  const currentKnoblauch = currentCustomization.options['knoblauch'] || 0
  const currentScharf = currentCustomization.options['scharf'] || 0
  const totalSauce = currentKnoblauch + currentScharf
  
  // Optionen rendern
  Object.keys(currentProduct.options).forEach(key => {
    const option = currentProduct.options[key]
    const isSauce = key === 'knoblauch' || key === 'scharf'
    const hasStringChoices = Array.isArray(option.choices) && typeof option.choices[0] === 'string'
    
    optionsHtml += `
      <div class="option-group">
        <label class="option-label">
          ${option.label}
          ${isSauce ? '<span style="font-size: 12px; color: #666; font-weight: 400;"> (Max. 2 Portionen gesamt)</span>' : ''}
        </label>
        <div class="option-buttons">
          ${option.choices.map(choice => {
            let disabled = false
            let displayText = ''
            let isActive = false
            
            if (hasStringChoices) {
              // String-basierte Auswahl (z.B. Cola, Fanta, etc.)
              displayText = choice
              isActive = currentCustomization.options[key] === choice
            } else {
              // Numerische Auswahl (0, 1, 2)
              displayText = choice === 0 ? 'Ohne' : choice === 1 ? '1x' : '2x'
              isActive = currentCustomization.options[key] === choice
              
              // Disable Sauce-Buttons wenn Maximum √ºberschritten w√ºrde
              if (isSauce && choice > 0) {
                const otherSauce = key === 'knoblauch' ? 'scharf' : 'knoblauch'
                const otherValue = currentCustomization.options[otherSauce] || 0
                disabled = (choice + otherValue > 2)
              }
            }
            
            const choiceValue = hasStringChoices ? `'${choice}'` : choice
            
            return `
              <button class="option-btn ${isActive ? 'active' : ''} ${disabled ? 'disabled' : ''}" 
                      onclick="selectOption('${key}', ${choiceValue})"
                      ${disabled ? 'disabled' : ''}>
                ${displayText}
              </button>
            `
          }).join('')}
        </div>
      </div>
    `
  })
  
  // Extras rendern
  optionsHtml += `
    <div class="option-group">
      <label class="option-label">Extras hinzuf√ºgen</label>
      ${currentProduct.extras.map(extra => `
        <div class="extra-item ${currentCustomization.extras.includes(extra.id) ? 'selected' : ''}" 
             onclick="toggleExtra('${extra.id}')">
          <div class="extra-info">
            <div class="extra-name">${extra.name}</div>
          </div>
          <div class="extra-price">+ ${formatPrice(extra.price)}</div>
        </div>
      `).join('')}
    </div>
  `
  
  document.getElementById('modalBody').innerHTML = optionsHtml
  updateModalTotal()
}

function selectOption(key, value) {
  // Spezielle Logik f√ºr Saucen: Maximal 2 Portionen INSGESAMT
  if (key === 'knoblauch' || key === 'scharf') {
    const otherSauce = key === 'knoblauch' ? 'scharf' : 'knoblauch'
    const otherValue = currentCustomization.options[otherSauce] || 0
    
    // Pr√ºfe ob Gesamt-Saucen-Anzahl > 2 w√§re
    if (value + otherValue > 2) {
      // Reduziere die andere Sauce automatisch
      const maxOther = 2 - value
      currentCustomization.options[otherSauce] = maxOther
      
      // Zeige kurze Benachrichtigung
      showSauceNotification(value, maxOther, key === 'knoblauch')
    }
  }
  
  // Spezielle Logik f√ºr Pommes-Produkt: Entweder Ketchup ODER Mayo
  if (key === 'sauce' && currentProduct.id === 'pommes') {
    // Sauce ist String-basiert: 'Ohne', 'Ketchup', 'Mayonnaise'
    currentCustomization.options[key] = value
    renderCustomizeModal()
    return
  }
  
  currentCustomization.options[key] = value
  renderCustomizeModal()
}

function showSauceNotification(mainValue, otherValue, isKnoblauch) {
  const mainName = isKnoblauch ? 'Knoblauch' : 'Scharf'
  const otherName = isKnoblauch ? 'Scharf' : 'Knoblauch'
  
  // Erstelle Notification Element falls nicht vorhanden
  let notification = document.getElementById('sauceNotification')
  if (!notification) {
    notification = document.createElement('div')
    notification.id = 'sauceNotification'
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      color: #92400e;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      z-index: 10001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: slideDown 0.3s ease-out;
      max-width: 90%;
      text-align: center;
    `
    document.body.appendChild(notification)
  }
  
  notification.textContent = `üí° ${mainValue}x ${mainName}, ${otherValue}x ${otherName} (Max. 2 Portionen gesamt)`
  notification.style.display = 'block'
  
  // Nach 2 Sekunden ausblenden
  setTimeout(() => {
    notification.style.display = 'none'
  }, 2000)
}

function toggleExtra(extraId) {
  const index = currentCustomization.extras.indexOf(extraId)
  if (index > -1) {
    currentCustomization.extras.splice(index, 1)
  } else {
    currentCustomization.extras.push(extraId)
  }
  renderCustomizeModal()
}

function updateModalTotal() {
  let total = currentProduct.price
  currentCustomization.extras.forEach(extraId => {
    const extra = currentProduct.extras.find(e => e.id === extraId)
    if (extra) total += extra.price
  })
  document.getElementById('modalTotal').textContent = formatPrice(total)
}

// ===== WARENKORB =====
function addToCart() {
  const item = {
    id: Date.now(),
    ...currentCustomization,
    price: calculateItemPrice(currentCustomization)
  }
  cart.push(item)
  updateCartUI()
  closeCustomizeModal()
  
  // Animation
  const cartBtn = document.getElementById('cartFixed')
  cartBtn.style.transform = 'scale(1.1)'
  setTimeout(() => cartBtn.style.transform = 'scale(1)', 200)
}

function calculateItemPrice(item) {
  let total = item.product.price
  item.extras.forEach(extraId => {
    const extra = item.product.extras.find(e => e.id === extraId)
    if (extra) total += extra.price
  })
  return total
}

function updateCartUI() {
  const count = cart.length
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  
  document.getElementById('cartCount').textContent = count
  document.getElementById('cartTotal').textContent = formatPrice(total)
  document.getElementById('cartFixed').style.display = count > 0 ? 'block' : 'none'
}

function openCart() {
  renderCart()
  document.getElementById('cartModal').classList.add('active')
}

function closeCart() {
  document.getElementById('cartModal').classList.remove('active')
}

function renderCart() {
  const container = document.getElementById('cartItems')
  
  if (cart.length === 0) {
    container.innerHTML = `
      <div class="cart-empty">
        <div class="cart-empty-icon">üõí</div>
        <p>Dein Warenkorb ist leer</p>
      </div>
    `
    document.getElementById('cartModalTotal').textContent = '0,00 ‚Ç¨'
    document.getElementById('cartModalCount').textContent = '0'
    return
  }
  
  container.innerHTML = cart.map((item, index) => {
    const optionsText = Object.keys(item.options)
      .map(key => {
        const value = item.options[key]
        const label = item.product.options[key].label
        
        // String-Wert (z.B. "Cola")
        if (typeof value === 'string') {
          return `${label}: ${value}`
        }
        
        // Numerischer Wert (0, 1, 2)
        return `${label}: ${value === 0 ? 'Ohne' : value === 1 ? '1x' : '2x'}`
      })
      .join(', ')
    
    const extrasText = item.extras.length > 0
      ? item.extras.map(extraId => {
          const extra = item.product.extras.find(e => e.id === extraId)
          return extra ? `+ ${extra.name}` : ''
        }).join(', ')
      : ''
    
    return `
      <div class="cart-item">
        <div class="cart-item-header">
          <div class="cart-item-name">${item.product.name}</div>
          <div class="cart-item-price">${formatPrice(item.price)}</div>
        </div>
        ${optionsText || extrasText ? `
          <div class="cart-item-options">
            ${optionsText}
            ${extrasText ? '<br>' + extrasText : ''}
          </div>
        ` : ''}
        <div class="cart-item-actions">
          <button class="cart-item-btn" onclick="editCartItem(${index})">‚úèÔ∏è Bearbeiten</button>
          <button class="cart-item-btn delete" onclick="deleteCartItem(${index})">üóëÔ∏è L√∂schen</button>
        </div>
      </div>
    `
  }).join('')
  
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  document.getElementById('cartModalTotal').textContent = formatPrice(total)
  document.getElementById('cartModalCount').textContent = cart.length
}

function editCartItem(index) {
  const item = cart[index]
  currentProduct = item.product
  currentCustomization = {
    product: item.product,
    options: {...item.options},
    extras: [...item.extras]
  }
  
  // Item aus Warenkorb entfernen
  cart.splice(index, 1)
  updateCartUI()
  
  closeCart()
  renderCustomizeModal()
  document.getElementById('customizeModal').classList.add('active')
}

function deleteCartItem(index) {
  if (confirm('Artikel wirklich aus dem Warenkorb entfernen?')) {
    cart.splice(index, 1)
    updateCartUI()
    renderCart()
  }
}

// ===== CHECKOUT =====
function goToCheckout() {
  if (cart.length === 0) {
    alert('Dein Warenkorb ist leer!')
    return
  }
  
  closeCart()
  renderCheckout()
  document.getElementById('checkoutModal').classList.add('active')
}

function closeCheckout() {
  document.getElementById('checkoutModal').classList.remove('active')
}

function renderCheckout() {
  const summary = document.getElementById('checkoutSummary')
  
  const items = cart.map(item => {
    const optionsText = Object.keys(item.options)
      .filter(key => {
        const value = item.options[key]
        const defaultValue = item.product.options[key].default
        // String-Vergleich oder numerischer Vergleich
        return value !== defaultValue
      })
      .map(key => {
        const value = item.options[key]
        const label = item.product.options[key].label
        
        // String-Wert (z.B. "Cola")
        if (typeof value === 'string') {
          return `${label}: ${value}`
        }
        
        // Numerischer Wert (0, 1, 2)
        return `${label}: ${value === 0 ? 'Ohne' : value === 1 ? '1x' : '2x'}`
      })
      .join(', ')
    
    const extrasText = item.extras.map(extraId => {
      const extra = item.product.extras.find(e => e.id === extraId)
      return extra ? `+ ${extra.name}` : ''
    }).join(', ')
    
    return `
      <div class="summary-row">
        <span>${item.product.name}${optionsText || extrasText ? ' (' + [optionsText, extrasText].filter(Boolean).join(', ') + ')' : ''}</span>
        <span>${formatPrice(item.price)}</span>
      </div>
    `
  }).join('')
  
  // Berechne MwSt
  let total7 = 0  // Lebensmittel 7%
  let total19 = 0 // Getr√§nke 19%
  
  cart.forEach(item => {
    if (item.product.vatRate === 19) {
      total19 += item.price
    } else {
      total7 += item.price
    }
  })
  
  const vat7 = total7 * 0.07 / 1.07
  const vat19 = total19 * 0.19 / 1.19
  const totalVat = vat7 + vat19
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  const netTotal = total - totalVat
  
  summary.innerHTML = items + `
    <div class="summary-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 13px;">
      <span>Netto</span>
      <span>${formatPrice(netTotal)}</span>
    </div>
    ${total7 > 0 ? `
      <div class="summary-row" style="font-size: 13px; color: #666;">
        <span>MwSt. 7% (Speisen)</span>
        <span>${formatPrice(vat7)}</span>
      </div>
    ` : ''}
    ${total19 > 0 ? `
      <div class="summary-row" style="font-size: 13px; color: #666;">
        <span>MwSt. 19% (Getr√§nke)</span>
        <span>${formatPrice(vat19)}</span>
      </div>
    ` : ''}
    <div class="summary-row total">
      <span>Gesamt</span>
      <span>${formatPrice(total)}</span>
    </div>
  `
  
  document.getElementById('finalTotal').textContent = formatPrice(total)
}

function selectPayment(type) {
  selectedPayment = type
  
  document.getElementById('paymentCash').classList.remove('active')
  document.getElementById('paymentPaypal').classList.remove('active')
  document.getElementById(`payment${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active')
  
  checkCheckoutReady()
}

function selectPickupTime(type) {
  selectedPickupTime = type
  
  document.getElementById('pickupNow').classList.remove('active')
  document.getElementById('pickupLater').classList.remove('active')
  document.getElementById(`pickup${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active')
  
  const timePickerContainer = document.getElementById('timePickerContainer')
  if (type === 'later') {
    timePickerContainer.style.display = 'block'
    // Setze Default Zeit auf jetzt + 30 Minuten
    const now = new Date()
    now.setMinutes(now.getMinutes() + 30)
    const hours = String(now.getHours()).padStart(2, '0')
    const minutes = String(Math.round(now.getMinutes() / 15) * 15).padStart(2, '0')
    document.getElementById('pickupTimeInput').value = `${hours}:${minutes}`
  } else {
    timePickerContainer.style.display = 'none'
    selectedPickupTimeValue = null
  }
  
  checkCheckoutReady()
}

function checkCheckoutReady() {
  const name = document.getElementById('customerName').value.trim()
  const phone = document.getElementById('customerPhone').value.trim()
  const ready = name && phone && selectedPayment
  
  document.getElementById('placeOrderBtn').disabled = !ready
}

// Event Listeners f√ºr Checkout-Inputs
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('customerName')?.addEventListener('input', checkCheckoutReady)
  document.getElementById('customerPhone')?.addEventListener('input', checkCheckoutReady)
})

// ===== BESTELLUNG AUFGEBEN =====
async function placeOrder() {
  const name = document.getElementById('customerName').value.trim()
  const phone = document.getElementById('customerPhone').value.trim()
  const notes = document.getElementById('customerNotes').value.trim()
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  
  // Abholzeit ermitteln
  let pickupTime = null
  if (selectedPickupTime === 'later') {
    pickupTime = document.getElementById('pickupTimeInput').value
  }
  
  // Button deaktivieren w√§hrend Verarbeitung
  const btn = document.getElementById('placeOrderBtn')
  btn.disabled = true
  btn.innerHTML = '‚è≥ Bestellung wird verarbeitet...'
  
  try {
    // Generiere eindeutige Order ID (6-stellig)
    const orderQRID = generateOrderQRID()
    const orderNumber = generateOrderNumber()
    
    // Berechne MwSt
    let total7 = 0
    let total19 = 0
    cart.forEach(item => {
      if (item.product.vatRate === 19) {
        total19 += item.price
      } else {
        total7 += item.price
      }
    })
    
    // Speichere Bestellung in Supabase
    const orderData = {
      order_number: orderNumber,
      qr_id: orderQRID,
      customer_name: name,
      customer_phone: phone,
      notes: notes || null,
      items: cart,
      total: total,
      total_7_percent: total7,
      total_19_percent: total19,
      payment_method: selectedPayment,
      pickup_time: pickupTime,
      pickup_type: selectedPickupTime,
      status: 'pending',
      created_at: new Date().toISOString()
    }
    
    const { data, error } = await supabase
      .from('orders')
      .insert([orderData])
      .select()
    
    if (error) {
      console.error('Supabase Error:', error)
      throw new Error('Bestellung konnte nicht gespeichert werden: ' + error.message)
    }
    
    console.log('‚úÖ Bestellung erfolgreich gespeichert:', data)
    
    // PayPal Integration
    if (selectedPayment === 'paypal') {
      alert('PayPal-Integration w√ºrde hier starten.\n\nF√ºr die Produktion ben√∂tigst du:\n‚Ä¢ PayPal Business Account\n‚Ä¢ PayPal SDK Integration\n‚Ä¢ Backend f√ºr Zahlungsabwicklung')
    }
    
    // Zeige Erfolgs-Modal mit QR-Code
    showSuccess(orderNumber, orderQRID)
    
    // Warenkorb leeren
    cart = []
    updateCartUI()
    closeCheckout()
    
  } catch (error) {
    console.error('‚ùå Fehler beim Aufgeben der Bestellung:', error)
    alert('‚ùå Es gab einen Fehler beim Aufgeben deiner Bestellung. Bitte versuche es erneut oder kontaktiere uns direkt.')
    
    // Button wieder aktivieren
    btn.disabled = false
    btn.innerHTML = `Jetzt bestellen - ${formatPrice(total)}`
  }
}

function generateOrderNumber() {
  return Math.floor(1000 + Math.random() * 9000)
}

function generateOrderQRID() {
  // Generiere 6-stellige eindeutige ID
  return Math.floor(100000 + Math.random() * 900000)
}

function showSuccess(orderNumber, qrID) {
  document.getElementById('orderNumber').textContent = '#' + orderNumber
  document.getElementById('orderQRID').textContent = qrID
  
  // Generiere QR-Code
  const qrContainer = document.getElementById('qrCodeContainer')
  qrContainer.innerHTML = '' // Leere vorherigen QR-Code
  
  new QRCode(qrContainer, {
    text: String(qrID),
    width: 200,
    height: 200,
    colorDark: '#E31E24',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  })
  
  document.getElementById('successModal').classList.add('active')
}

function closeSuccess() {
  document.getElementById('successModal').classList.remove('active')
  // Seite neu laden f√ºr neue Bestellung
  location.reload()
}

// ===== HILFSFUNKTIONEN =====
function formatPrice(price) {
  return price.toFixed(2).replace('.', ',') + ' ‚Ç¨'
}

// ===== START =====
init()

console.log('‚úÖ D√∂ner Boxx Bestellseite geladen!')
</script>

</body>
</html>
