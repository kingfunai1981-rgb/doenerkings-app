<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂ner Boxx Loyalty</title>
<link rel="icon" href="/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: #f5f5f5;
  min-height: 100vh;
  padding: 0;
  margin: 0;
}

.container { 
  max-width: 500px; 
  margin: 0 auto;
  background: white;
  min-height: 100vh;
}

.header-image {
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  padding: 20px 20px 24px;
  text-align: center;
  position: relative;
}

.header-logo {
  width: 120px;
  height: 120px;
  margin: 0 auto 16px;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  clip-path: circle(50%);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.header-image h1 {
  color: white;
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 20px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.header-image p {
  color: white;
  font-size: 16px;
  opacity: 0.95;
  margin-bottom: 4px;
}

.header-image p.small {
  font-size: 13px;
  opacity: 0.8;
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  margin-top: 8px;
}

.header-qr-mini {
  width: 60px;
  height: 60px;
  background: white;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  flex-shrink: 0;
}

.header-qr-mini:hover { transform: scale(1.05); }
.header-qr-mini img { width: 50px; height: 50px; border-radius: 6px; }

.qr-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.qr-modal.active { display: flex; }

.qr-modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  position: relative;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-50px) scale(0.9); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.qr-modal-close {
  position: absolute;
  top: 10px; right: 10px;
  background: #f5f5f5;
  border: none;
  width: 40px; height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  transition: all 0.2s;
}

.qr-modal-close:hover {
  background: #e5e5e5;
  transform: rotate(90deg);
}

.qr-modal-img {
  width: 260px; height: 260px;
  margin: 20px auto;
  background: white;
  padding: 15px;
  border-radius: 12px;
  border: 3px solid #E31E24;
}

.qr-modal-id {
  font-size: 42px;
  font-weight: 700;
  color: #E31E24;
  letter-spacing: 5px;
  margin: 16px 0;
  font-family: 'Courier New', monospace;
}

.qr-modal-label { font-size: 14px; color: #666; margin-bottom: 8px; }

.card {
  background: white;
  padding: 24px;
  margin: 0;
}

.card h2 {
  font-size: 22px;
  color: #374151;
  margin-bottom: 16px;
}

.stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.stat-box {
  background: linear-gradient(135deg, #E31E24, #F9A825);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  color: white;
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.2);
}

.stat-number {
  font-size: 36px;
  font-weight: 700;
  margin-bottom: 4px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-label {
  font-size: 13px;
  opacity: 0.95;
  font-weight: 600;
}

.rewards {
  display: grid;
  gap: 12px;
  margin-top: 20px;
}

.reward-item {
  background: linear-gradient(135deg, #F9A825, #f59e0b);
  border-radius: 16px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(249, 168, 37, 0.2);
}

.reward-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(249, 168, 37, 0.3); }

.reward-item.inactive {
  background: #f3f4f6;
  cursor: not-allowed;
  opacity: 0.6;
}

.reward-icon {
  font-size: 48px;
  flex-shrink: 0;
}

.reward-info {
  flex: 1;
  color: white;
}

.reward-item.inactive .reward-info { color: #9ca3af; }

.reward-info h3 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
}

.reward-info p {
  font-size: 14px;
  opacity: 0.95;
}

button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'Flame', sans-serif;
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.2);
}

button:hover { opacity: 0.9; transform: translateY(-2px); }
button:active { transform: translateY(0); }

.screen { display: none; }
.screen.active { display: block; }

.bonus-item {
  background: linear-gradient(135deg, #F9A825, #f59e0b);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  color: white;
}

.bonus-item.active { background: linear-gradient(135deg, #10b981, #059669); }

.bonus-item h3 { font-size: 18px; margin-bottom: 8px; }
.bonus-desc { font-size: 14px; margin-bottom: 8px; opacity: 0.95; }
.bonus-status { font-size: 13px; font-weight: 600; margin-bottom: 12px; }
.bonus-item button { margin-top: 8px; background: rgba(255,255,255,0.2); box-shadow: none; }
.bonus-item button:hover { background: rgba(255,255,255,0.3); }

.challenge-item {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.challenge-item h3 { color: #374151; font-size: 16px; margin-bottom: 8px; }
.challenge-desc { font-size: 14px; color: #6b7280; margin-bottom: 12px; }
.challenge-date { font-size: 13px; color: #9ca3af; margin-top: 12px; }

.challenge-progress {
  margin: 12px 0;
}

.challenge-progress-bar {
  width: 100%;
  height: 12px;
  background: #e5e7eb;
  border-radius: 6px;
  overflow: hidden;
  margin-top: 8px;
}

.challenge-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #E31E24, #F9A825);
  transition: width 0.3s;
}

.coupon-item {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.coupon-item.activated {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-color: #F9A825;
}

.coupon-item h3 { color: #92400e; font-size: 18px; margin-bottom: 8px; }
.coupon-product { font-size: 14px; color: #92400e; margin-bottom: 4px; }
.coupon-price { font-size: 16px; font-weight: 700; color: #f59e0b; margin-bottom: 4px; }
.coupon-desc { font-size: 13px; color: #92400e; margin-bottom: 8px; }
.coupon-expiry { font-size: 13px; color: #92400e; display: block; margin-top: 8px; }
.coupon-expiry.warning { color: #dc2626; font-weight: 600; }

.coupon-code-display {
  font-size: 28px;
  font-weight: 700;
  color: #f59e0b;
  letter-spacing: 8px;
  margin: 12px 0;
  padding: 12px;
  background: white;
  border-radius: 8px;
  text-align: center;
}

.coupon-activated-badge {
  background: #10b981;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  margin-top: 12px;
  display: inline-block;
}

.pending-code {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.pending-code h3 { color: #92400e; font-size: 18px; margin-bottom: 12px; }

.code {
  font-size: 32px;
  font-weight: 700;
  color: #f59e0b;
  letter-spacing: 8px;
  margin: 12px 0;
  text-align: center;
}

.code-info {
  font-size: 14px;
  color: #92400e;
  margin-bottom: 12px;
}

button.small {
  width: auto;
  padding: 8px 16px;
  font-size: 14px;
  display: inline-block;
  margin: 4px;
}

#wheel-section {
  text-align: center;
  padding: 20px;
  display: none;
}

#wheel-section.active { display: block; }

.wheel-container {
  position: relative;
  max-width: 400px;
  margin: 0 auto;
}

#wheelCanvas {
  width: 100%;
  height: auto;
  display: block;
  max-width: 400px;
  margin: 0 auto;
  cursor: pointer;
}

.wheel-pointer {
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 20px solid transparent;
  border-right: 20px solid transparent;
  border-top: 30px solid #E31E24;
  z-index: 10;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

#spin-button {
  margin-top: 24px;
  font-size: 18px;
  padding: 18px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  animation: pulse 2s infinite;
}

#spin-button:disabled {
  background: #d1d5db;
  cursor: not-allowed;
  animation: none;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.wheel-result-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.wheel-result-modal.active { display: flex; }

.wheel-result-content {
  background: white;
  border-radius: 20px;
  padding: 40px 30px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: slideIn 0.3s ease-out;
}

.wheel-result-icon {
  font-size: 80px;
  margin-bottom: 16px;
}

.wheel-result-content h2 {
  color: #E31E24;
  font-size: 28px;
  margin-bottom: 8px;
}

.wheel-result-prize {
  font-size: 22px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 20px;
}

.wheel-result-code-box {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.wheel-result-code-box h3 {
  font-size: 16px;
  color: #92400e;
  margin-bottom: 12px;
}

.wheel-result-code {
  font-size: 36px;
  font-weight: 700;
  color: #f59e0b;
  letter-spacing: 10px;
  margin: 12px 0;
}

.wheel-result-expiry {
  font-size: 14px;
  color: #92400e;
  margin-top: 8px;
}

.wheel-result-qr {
  width: 200px;
  height: 200px;
  margin: 16px auto;
  border: 3px solid #E31E24;
  border-radius: 12px;
  padding: 8px;
  background: white;
}

.wheel-result-note {
  font-size: 14px;
  color: #6b7280;
  margin-top: 16px;
  margin-bottom: 24px;
}

.wheel-result-content button {
  background: linear-gradient(135deg, #E31E24, #F9A825);
}

.wheel-badge-unlocked {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  margin: 16px 0;
  display: inline-block;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.wheel-info-box {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  text-align: left;
}

.wheel-info-box h3 {
  font-size: 16px;
  color: #374151;
  margin-bottom: 12px;
}

.wheel-info-box p {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 8px;
}

.wheel-logo-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 96px;
  height: 96px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 5;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}

.wheel-logo-center:hover {
  transform: translate(-50%, -50%) scale(1.05);
}

.wheel-logo-center img {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  object-fit: cover;
}

</style>
</head>
<body>

<div class="container">
  <div id="start-screen" class="screen active">
    <div class="header-image">
      <div class="header-logo">
        <img src="/logo-round.png" alt="D√∂ner Boxx">
      </div>
      <h1>D√∂ner Boxx</h1>
      <p>Willkommen zur√ºck! üëã</p>
      <p class="small">Scanne deinen QR-Code</p>
    </div>
    
    <div class="card">
      <h2>üîê Mit QR-Code anmelden</h2>
      <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
        Scanne deinen pers√∂nlichen QR-Code mit dem Scanner im Laden
      </p>
      <button onclick="window.location.reload()">üîÑ Neu laden</button>
    </div>
  </div>

  <div id="app-screen" class="screen">
    <div class="header-image">
      <div class="header-content">
        <div>
          <h1 id="customer-name">-</h1>
          <p>Aktueller Punktestand</p>
          <p style="font-size: 24px; font-weight: 700; margin-top: 8px;">
            <span id="customer-points">0</span> Punkte
          </p>
        </div>
        <div class="header-qr-mini" id="header-qr-mini" onclick="showQRModal()">
          <img id="qr-mini-img" src="" alt="QR">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat-box">
          <div class="stat-number" id="customer-points-stat">0</div>
          <div class="stat-label">üí∞ Punkte</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="customer-id-stat">-</div>
          <div class="stat-label">üÜî Deine ID</div>
        </div>
      </div>

      <div id="wheel-badge-container" style="display: none;">
        <div class="wheel-badge-unlocked" onclick="showScreen('wheel')">
          üé° Du hast <span id="wheel-unlocks-count">0</span> freie Drehung(en)!
        </div>
      </div>

      <h2>üéÅ Pr√§mien einl√∂sen</h2>
      <div class="rewards" id="rewards-list">
        <div class="reward-item inactive">
          <div class="reward-icon">üçî</div>
          <div class="reward-info">
            <h3>D√∂ner</h3>
            <p>500 Punkte</p>
          </div>
        </div>
        <div class="reward-item inactive">
          <div class="reward-icon">ü•§</div>
          <div class="reward-info">
            <h3>Getr√§nk</h3>
            <p>200 Punkte</p>
          </div>
        </div>
        <div class="reward-item inactive">
          <div class="reward-icon">üçü</div>
          <div class="reward-info">
            <h3>Pommes</h3>
            <p>150 Punkte</p>
          </div>
        </div>
      </div>

      <div id="pending-section" style="display: none; margin-top: 24px;">
        <h2>‚è≥ Deine offenen Codes</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 12px;">Zeige diese Codes beim n√§chsten Besuch</p>
        <div id="pending-list"></div>
      </div>

      <div id="bonuses-section" style="display: none; margin-top: 24px;">
        <h2>üéâ Verf√ºgbare Bonuses</h2>
        <div id="bonuses-list"></div>
      </div>

      <div id="challenges-section" style="display: none; margin-top: 24px;">
        <h2>üéØ Deine Challenges</h2>
        <div id="challenges-list"></div>
      </div>

      <div id="coupons-section" style="display: none; margin-top: 24px;">
        <h2>üéüÔ∏è Verf√ºgbare Coupons</h2>
        <div id="coupons-list"></div>
      </div>

      <div id="wheel-codes-section" style="display: none; margin-top: 24px;">
        <h2>üé° Deine Gl√ºcksrad-Gewinne</h2>
        <div id="wheel-codes-list"></div>
      </div>

      <button onclick="logout()" style="margin-top: 24px; background: #6b7280;">
        ‚Ü©Ô∏è Abmelden
      </button>
    </div>
  </div>

  <div id="wheel-screen" class="screen">
    <div class="header-image">
      <h1>Drehe am Gl√ºcksrad!</h1>
      <p>Gewinne tolle Preise! üéÅ</p>
    </div>

    <div class="card" id="wheel-section">
      <div class="wheel-info-box">
        <h3>üé° Wie funktioniert's?</h3>
        <p>‚úÖ Du hast eine Drehung freigeschaltet!</p>
        <p>üéØ Klicke auf das Logo in der Mitte zum Drehen</p>
        <p>üéÅ Gewinne Punkte, D√∂ner, Getr√§nke & mehr!</p>
      </div>

      <div class="wheel-container">
        <div class="wheel-pointer"></div>
        <canvas id="wheelCanvas" width="400" height="400"></canvas>
        <div class="wheel-logo-center" id="wheel-logo-spin" onclick="spinWheelCustomer()">
          <img src="/logo-round.png" alt="Spin">
        </div>
      </div>

      <button onclick="showScreen('app')" style="margin-top: 24px; background: #6b7280;">
        ‚Üê Zur√ºck zur √úbersicht
      </button>
    </div>
  </div>
</div>

<div class="qr-modal" id="qr-modal" onclick="closeQRModal(event)">
  <div class="qr-modal-content" onclick="event.stopPropagation()">
    <button class="qr-modal-close" onclick="closeQRModal()">√ó</button>
    <h2 style="color: #E31E24; margin-bottom: 8px;">Dein QR-Code</h2>
    <p class="qr-modal-label">Zeige diesen Code beim Scannen</p>
    <img class="qr-modal-img" id="qr-modal-img" src="" alt="QR Code">
    <div class="qr-modal-id" id="qr-modal-id">-</div>
  </div>
</div>

<div class="wheel-result-modal" id="wheel-result-modal">
  <div class="wheel-result-content">
    <div class="wheel-result-icon" id="wheel-result-icon">‚≠ê</div>
    <h2 id="wheel-result-title">Gl√ºckwunsch! üéâ</h2>
    <div class="wheel-result-prize" id="wheel-result-prize">-</div>
    
    <div class="wheel-result-code-box" id="wheel-result-code-box">
      <h3>Dein Gewinn-Code:</h3>
      <div class="wheel-result-code" id="wheel-result-code">----</div>
      <div class="wheel-result-expiry">G√ºltig bis: <span id="wheel-result-expiry">-</span></div>
      <img class="wheel-result-qr" id="wheel-result-qr" src="" alt="QR Code">
    </div>
    
    <div class="wheel-result-note" id="wheel-result-note">Zeige diesen Code beim n√§chsten Besuch!</div>
    <button onclick="closeWheelResult()">Weiter</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

let currentCustomer = null
let refreshInterval = null
let wheelUnlockData = null
let wheelPrizes = []
let wheelCanvas = null
let wheelCtx = null
let wheelRotation = 0
let wheelSpinning = false

// ==========================================
// CRYPTO HELPER (Sichere Zufallszahlen)
// ==========================================

function generateSecureCode() {
  const array = new Uint32Array(1);
  crypto.getRandomValues(array);
  return (1000 + (array[0] % 9000)).toString();
}

function getSecureRandomFloat() {
  const array = new Uint32Array(1);
  crypto.getRandomValues(array);
  return array[0] / (0xFFFFFFFF + 1);
}

// ==========================================
// WHEEL FUNCTIONS
// ==========================================

async function hasUnusedWheelUnlock(customerId) {
  try {
    const { data, error } = await supabase.from('wheel_unlocks').select('*').eq('customer_id', customerId).eq('is_used', false).gt('expires_at', new Date().toISOString()).limit(1);
    if (error) throw error;
    return data && data.length > 0 ? data[0] : null;
  } catch (e) {
    console.error('‚ùå Check unlock error:', e);
    return null;
  }
}

async function loadWheelPrizes() {
  try {
    const { data, error } = await supabase.from('wheel_prizes').select('*').order('position');
    if (error) throw error;
    return data || [];
  } catch (e) {
    console.error('‚ùå Load prizes error:', e);
    return [];
  }
}

function drawWheel() {
  if (!wheelCtx || !wheelPrizes || wheelPrizes.length === 0) return;
  
  const centerX = wheelCanvas.width / 2;
  const centerY = wheelCanvas.height / 2;
  const radius = wheelCanvas.width / 2 - 5;

  wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
  wheelCtx.save();
  wheelCtx.translate(centerX, centerY);
  wheelCtx.rotate(wheelRotation);

  const totalSegments = wheelPrizes.length;
  const anglePerSegment = (2 * Math.PI) / totalSegments;

  wheelPrizes.forEach((prize, i) => {
    const startAngle = i * anglePerSegment;
    const endAngle = startAngle + anglePerSegment;

    wheelCtx.beginPath();
    wheelCtx.moveTo(0, 0);
    wheelCtx.arc(0, 0, radius, startAngle, endAngle);
    wheelCtx.closePath();
    wheelCtx.fillStyle = prize.color;
    wheelCtx.fill();

    wheelCtx.save();
    wheelCtx.rotate(startAngle + anglePerSegment / 2);
    wheelCtx.textAlign = 'center';
    wheelCtx.textBaseline = 'middle';
    wheelCtx.fillStyle = prize.text_color || '#FFFFFF';
    
    const words = prize.label.split(' ');
    if (words.length === 1) {
      wheelCtx.font = 'bold 14px Flame, Arial';
      wheelCtx.fillText(prize.label, radius * 0.7, 0);
    } else {
      wheelCtx.font = 'bold 12px Flame, Arial';
      wheelCtx.fillText(words[0], radius * 0.7, -6);
      wheelCtx.fillText(words[1], radius * 0.7, 6);
    }
    wheelCtx.restore();
  });

  wheelCtx.restore();
}

function getRandomPrize() {
  const randomIndex = Math.floor(getSecureRandomFloat() * wheelPrizes.length);
  return wheelPrizes[randomIndex];
}

async function spinWheelCustomer() {
  if (wheelSpinning || !wheelUnlockData) return;
  
  wheelSpinning = true;
  
  const winningPrize = getRandomPrize();
  const winningIndex = wheelPrizes.indexOf(winningPrize);
  const anglePerSegment = (2 * Math.PI) / wheelPrizes.length;
  
  // üî¥ FIX: Startposition auf D√ñNER (rotes Feld in der Mitte oben)
  // Position 0 ist D√ñNER, also bei 0¬∞ anfangen
  const offsetToTop = Math.PI / 2; // 90¬∞ nach oben
  
  const randomOffset = ((getSecureRandomFloat() - 0.5) * 0.6) * anglePerSegment;
  const targetAngle = winningIndex * anglePerSegment + anglePerSegment / 2 + randomOffset;
  const spins = 5 + Math.floor(getSecureRandomFloat() * 3);
  const totalRotation = spins * 2 * Math.PI + (2 * Math.PI - targetAngle) + offsetToTop;

  const startRotation = wheelRotation;
  const startTime = Date.now();
  const duration = 4000 + Math.floor(getSecureRandomFloat() * 1000);

  function animate() {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easeOut = 1 - Math.pow(1 - progress, 4);
    
    wheelRotation = startRotation + (easeOut * totalRotation);
    drawWheel();

    if (progress < 1) {
      requestAnimationFrame(animate);
    } else {
      wheelSpinning = false;
      showWheelResult(winningPrize);
    }
  }

  animate();
}

async function showWheelResult(prize) {
  try {
    // üî¥ FIX: Bei PUNKTEN automatisch gutschreiben
    if (prize.prize_type === 'points') {
      const points = parseInt(prize.prize_value);
      const newTotal = currentCustomer.points + points;
      
      await supabase.from('customers').update({ points: newTotal }).eq('id', currentCustomer.id);
      await supabase.from('transactions').insert({
        customer_id: currentCustomer.id,
        type: 'earn',
        amount: 0,
        points: points,
        staff: 'GL√úCKSRAD',
        notes: `Gl√ºcksrad: ${prize.label}`
      });
      
      // Mark unlock as used
      await supabase.from('wheel_unlocks').update({ 
        is_used: true, 
        used_at: new Date().toISOString() 
      }).eq('id', wheelUnlockData.id);
      
      // Save spin WITHOUT code (already redeemed)
      await supabase.from('wheel_spins').insert({
        customer_id: currentCustomer.id,
        unlock_id: wheelUnlockData.id,
        prize_label: prize.label,
        prize_type: prize.prize_type,
        prize_value: prize.prize_value,
        prize_code: null,
        is_redeemed: true,
        redeemed_at: new Date().toISOString(),
        redeemed_by: 'AUTO',
        expires_at: new Date().toISOString()
      });
      
      // Show simple success modal
      const modal = document.getElementById('wheel-result-modal');
      const icon = document.getElementById('wheel-result-icon');
      const title = document.getElementById('wheel-result-title');
      const prizeText = document.getElementById('wheel-result-prize');
      const codeBox = document.getElementById('wheel-result-code-box');
      const note = document.getElementById('wheel-result-note');
      
      icon.textContent = '‚≠ê';
      title.textContent = 'Gl√ºckwunsch! üéâ';
      prizeText.textContent = prize.label; // üî¥ FIX: Zeigt jetzt den richtigen Wert
      codeBox.style.display = 'none';
      note.textContent = `${points} Punkte wurden automatisch gutgeschrieben!`;
      
      modal.classList.add('active');
      
      // Refresh data
      wheelUnlockData = null;
      await refreshCustomerData();
      
    } else {
      // üî¥ FIX: Bei PR√ÑMIEN/RABATTEN Code generieren
      let code;
      let attempts = 0;
      
      while (attempts < 10) {
        code = generateSecureCode();
        const { data } = await supabase.from('wheel_spins').select('id').eq('prize_code', code).limit(1);
        if (!data || data.length === 0) break;
        attempts++;
      }
      
      if (!code) throw new Error('Code generation failed');
      
      const { data: spin, error } = await supabase.from('wheel_spins').insert({
        customer_id: currentCustomer.id,
        unlock_id: wheelUnlockData.id,
        prize_label: prize.label,
        prize_type: prize.prize_type,
        prize_value: prize.prize_value,
        prize_code: code,
        is_redeemed: false,
        expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
      }).select().single();
      
      if (error) throw error;
      
      // Mark unlock as used
      await supabase.from('wheel_unlocks').update({ 
        is_used: true, 
        used_at: new Date().toISOString() 
      }).eq('id', wheelUnlockData.id);
      
      // Show result with code
      const modal = document.getElementById('wheel-result-modal');
      const icon = document.getElementById('wheel-result-icon');
      const title = document.getElementById('wheel-result-title');
      const prizeText = document.getElementById('wheel-result-prize');
      const codeText = document.getElementById('wheel-result-code');
      const expiryText = document.getElementById('wheel-result-expiry');
      const qrImg = document.getElementById('wheel-result-qr');
      const codeBox = document.getElementById('wheel-result-code-box');
      const note = document.getElementById('wheel-result-note');
      
      if (prize.label.includes('D√ñNER')) icon.textContent = 'üçî';
      else if (prize.label.includes('AYRAN')) icon.textContent = 'ü•§';
      else if (prize.label.includes('COLA')) icon.textContent = 'ü•§';
      else if (prize.label.includes('POMMES')) icon.textContent = 'üçü';
      else icon.textContent = 'üéÅ';
      
      title.textContent = 'Gl√ºckwunsch! üéâ';
      prizeText.textContent = prize.label;
      codeText.textContent = code;
      
      const expiry = new Date(spin.expires_at);
      expiryText.textContent = expiry.toLocaleDateString('de-DE', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
      });
      
      qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${code}`;
      codeBox.style.display = 'block';
      note.textContent = 'Zeige diesen Code beim n√§chsten Besuch!';
      
      modal.classList.add('active');
      
      // Refresh data
      wheelUnlockData = null;
      await refreshCustomerData();
    }
    
  } catch (e) {
    console.error('‚ùå Show result error:', e);
    alert('‚ùå Fehler beim Speichern des Gewinns. Bitte kontaktiere uns.');
  }
}

function closeWheelResult() {
  document.getElementById('wheel-result-modal').classList.remove('active');
  showScreen('app');
}

async function loadWheelCodes() {
  if (!currentCustomer) return;
  try {
    const { data, error } = await supabase.from('wheel_spins').select('*').eq('customer_id', currentCustomer.id).eq('is_redeemed', false).order('created_at', { ascending: false });
    if (error) throw error;
    
    const section = document.getElementById('wheel-codes-section');
    const list = document.getElementById('wheel-codes-list');
    
    if (!data || data.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    section.style.display = 'block';
    list.innerHTML = data.map(item => {
      const expiry = new Date(item.expires_at);
      const now = new Date();
      const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
      const isExpired = expiry < now;
      
      let expiryText = '';
      if (isExpired) {
        expiryText = '<span style="color:#dc2626;font-weight:600;">‚ö†Ô∏è Abgelaufen</span>';
      } else if (daysLeft <= 3) {
        expiryText = `<span style="color:#dc2626;font-weight:600;">‚è∞ L√§uft in ${daysLeft} ${daysLeft === 1 ? 'Tag' : 'Tagen'} ab</span>`;
      } else {
        expiryText = `<span style="color:#92400e;">G√ºltig bis: ${expiry.toLocaleDateString('de-DE')}</span>`;
      }
      
      return `<div class="pending-code"><h3>üéÅ ${item.prize_label}</h3><div class="code">${item.prize_code}</div><div class="code-info">${expiryText}<br>Zeige diesen Code beim n√§chsten Besuch!</div></div>`;
    }).join('');
  } catch (e) {
    console.error('‚ùå Load wheel codes error:', e);
  }
}

// ==========================================
// UI FUNCTIONS
// ==========================================

function showScreen(screenName) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenName + '-screen').classList.add('active');
  
  if (screenName === 'wheel') {
    initWheel();
  }
}

async function initWheel() {
  if (!currentCustomer) return;
  
  wheelPrizes = await loadWheelPrizes();
  wheelUnlockData = await hasUnusedWheelUnlock(currentCustomer.id);
  
  const section = document.getElementById('wheel-section');
  
  if (!wheelUnlockData || wheelPrizes.length === 0) {
    section.classList.remove('active');
    alert('‚ùå Keine freien Drehungen verf√ºgbar');
    showScreen('app');
    return;
  }
  
  section.classList.add('active');
  
  wheelCanvas = document.getElementById('wheelCanvas');
  wheelCtx = wheelCanvas.getContext('2d');
  
  // üî¥ FIX: Startposition auf D√ñNER (rotes Feld oben)
  wheelRotation = Math.PI / 2; // 90¬∞ = rotes Feld oben
  
  drawWheel();
}

function showQRModal() {
  if (!currentCustomer) return;
  document.getElementById('qr-modal-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${currentCustomer.qr_id}`;
  document.getElementById('qr-modal-id').textContent = currentCustomer.qr_id;
  document.getElementById('qr-modal').classList.add('active');
}

function closeQRModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('qr-modal').classList.remove('active');
}

async function loadCustomer(customer) {
  currentCustomer = customer;
  localStorage.setItem('customerData', JSON.stringify(customer));
  
  document.getElementById('customer-name').textContent = customer.name;
  document.getElementById('customer-points').textContent = customer.points;
  document.getElementById('customer-points-stat').textContent = customer.points;
  document.getElementById('customer-id-stat').textContent = customer.qr_id;
  
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=${customer.qr_id}`;
  document.getElementById('qr-mini-img').src = qrUrl;
  
  showScreen('app');
  await refreshCustomerData();
  
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(refreshCustomerData, 30000);
}

async function refreshCustomerData() {
  if (!currentCustomer) return;
  
  try {
    const { data, error } = await supabase.from('customers').select('*').eq('id', currentCustomer.id).single();
    if (error) throw error;
    
    currentCustomer = data;
    document.getElementById('customer-points').textContent = data.points;
    document.getElementById('customer-points-stat').textContent = data.points;
    
    updateRewardsList(data.points);
    await loadPendingCodes();
    await loadBonuses();
    await loadChallenges();
    await loadCoupons();
    await loadWheelCodes();
    await updateWheelBadge();
    
  } catch (e) {
    console.error('‚ùå Refresh error:', e);
  }
}

async function updateWheelBadge() {
  if (!currentCustomer) return;
  
  try {
    const { data, error } = await supabase.from('wheel_unlocks')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('is_used', false)
      .gt('expires_at', new Date().toISOString());
    
    if (error) throw error;
    
    const badge = document.getElementById('wheel-badge-container');
    const count = document.getElementById('wheel-unlocks-count');
    
    if (data && data.length > 0) {
      count.textContent = data.length;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  } catch (e) {
    console.error('‚ùå Update wheel badge error:', e);
  }
}

function updateRewardsList(points) {
  const rewards = [
    { name: 'D√∂ner', icon: 'üçî', cost: 500 },
    { name: 'Getr√§nk', icon: 'ü•§', cost: 200 },
    { name: 'Pommes', icon: 'üçü', cost: 150 }
  ];
  
  const list = document.getElementById('rewards-list');
  list.innerHTML = rewards.map(reward => {
    const canRedeem = points >= reward.cost;
    return `
      <div class="reward-item ${canRedeem ? '' : 'inactive'}" ${canRedeem ? `onclick="redeemReward('${reward.name}', ${reward.cost})"` : ''}>
        <div class="reward-icon">${reward.icon}</div>
        <div class="reward-info">
          <h3>${reward.name}</h3>
          <p>${reward.cost} Punkte</p>
        </div>
      </div>
    `;
  }).join('');
}

async function redeemReward(rewardName, cost) {
  if (!currentCustomer || currentCustomer.points < cost) {
    alert('‚ùå Nicht genug Punkte!');
    return;
  }
  
  const confirmed = confirm(`${rewardName} f√ºr ${cost} Punkte einl√∂sen?\n\nDu erh√§ltst einen 4-stelligen Code, den du beim n√§chsten Besuch zeigen kannst.`);
  if (!confirmed) return;
  
  try {
    let code;
    let attempts = 0;
    
    while (attempts < 10) {
      code = generateSecureCode();
      const { data } = await supabase.from('redeem_codes').select('id').eq('code', code).limit(1);
      if (!data || data.length === 0) break;
      attempts++;
    }
    
    if (!code) {
      alert('‚ùå Fehler beim Erstellen des Codes. Bitte nochmal versuchen.');
      return;
    }
    
    const expires = new Date(Date.now() + 24*60*60*1000);
    const { error } = await supabase.from('redeem_codes').insert({
      code,
      customer_id: currentCustomer.id,
      reward_name: rewardName,
      points_cost: cost,
      valid_until: expires.toISOString(),
      used: false
    });
    
    if (error) {
      console.error('‚ùå Redeem error:', error);
      alert('‚ùå Fehler beim Erstellen des Codes. Bitte nochmal versuchen.');
      return;
    }
    
    loadPendingCodes();
    
  } catch (e) {
    console.error('‚ùå Redeem error:', e);
    alert('‚ùå Fehler: ' + e.message);
  }
}

async function loadPendingCodes() {
  if (!currentCustomer) return;
  
  try {
    const { data, error } = await supabase.from('redeem_codes').select('*').eq('customer_id', currentCustomer.id).eq('used', false).order('created_at', { ascending: false });
    if (error) throw error;
    
    const section = document.getElementById('pending-section');
    const list = document.getElementById('pending-list');
    
    if (!data || data.length === 0) {
      section.style.display = 'none';
      list.innerHTML = '';
      return;
    }
    
    section.style.display = 'block';
    list.innerHTML = data.map(item => {
      const expires = new Date(item.valid_until).toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="pending-code">
          <h3>üéÅ ${item.reward_name}</h3>
          <div class="code">${item.code}</div>
          <div class="code-info">
            G√ºltig bis: ${expires}<br>
            Kosten: ${item.points_cost} Punkte
          </div>
          <button class="small" style="background: #ef4444;" onclick="cancelCode('${item.code}')">
            üóëÔ∏è Stornieren
          </button>
        </div>
      `;
    }).join('');
    
  } catch (e) {
    console.error('Load pending error:', e);
  }
}

async function cancelCode(code) {
  if (!confirm('Code wirklich stornieren?')) return;
  
  try {
    await supabase.from('redeem_codes').delete().eq('code', code).eq('used', false);
    loadPendingCodes();
  } catch (e) {
    console.error('Cancel error:', e);
    loadPendingCodes();
  }
}

async function loadBonuses() {
  if (!currentCustomer) return;
  
  try {
    const now = new Date().toISOString().split('T')[0];
    const { data: bonuses, error } = await supabase.from('global_bonuses').select('*').eq('is_active', true).gte('expires_at', now).order('created_at', { ascending: false });
    if (error) throw error;
    
    const section = document.getElementById('bonuses-section');
    const list = document.getElementById('bonuses-list');
    
    if (!bonuses || bonuses.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    const { data: activatedBonuses } = await supabase.from('activated_global_bonuses').select('global_bonus_id, is_used').eq('customer_id', currentCustomer.id);
    const activatedMap = new Map(activatedBonuses?.map(a => [a.global_bonus_id, a.is_used]) || []);
    
    const availableBonuses = bonuses.filter(bonus => {
      const isUsed = activatedMap.get(bonus.id);
      return !isUsed;
    });
    
    if (availableBonuses.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    section.style.display = 'block';
    list.innerHTML = availableBonuses.map(bonus => {
      const bonusAmount = bonus.bonus_amount || 100;
      const isActivated = activatedMap.has(bonus.id);
      
      let descText = '';
      if (bonus.bonus_type === 'double_points') {
        descText = 'Bei der n√§chsten Bestellung bekommst du doppelte Punkte!';
      } else {
        descText = `Bei der n√§chsten Bestellung erh√§ltst du ${bonusAmount} Extra-Punkte!`;
      }
      
      if (bonus.description) {
        descText += `<br><small>${bonus.description}</small>`;
      }
      
      const expiry = new Date(bonus.expires_at);
      const daysLeft = Math.ceil((expiry - new Date()) / (1000 * 60 * 60 * 24));
      
      let statusText = '';
      let buttonHTML = '';
      
      if (isActivated) {
        statusText = 'üî• Aktiv f√ºr n√§chste Bestellung!';
      } else {
        statusText = `‚è≥ Bereit zum Aktivieren (noch ${daysLeft} ${daysLeft === 1 ? 'Tag' : 'Tage'})`;
        buttonHTML = `<button onclick="activateBonus(${bonus.id})">üöÄ Jetzt aktivieren</button>`;
      }
      
      return `
        <div class="bonus-item ${isActivated ? 'active' : ''}">
          <h3>${bonus.title || (bonus.bonus_type === 'double_points' ? '‚≠ê Doppelte Punkte' : `üí∞ +${bonusAmount} Bonus-Punkte`)}</h3>
          <div class="bonus-desc">${descText}</div>
          <div class="bonus-status">${statusText}</div>
          ${buttonHTML}
        </div>
      `;
    }).join('');
    
  } catch (e) {
    console.error('‚ùå Load bonuses error:', e);
  }
}

async function activateBonus(bonusId) {
  try {
    const { data: existingActive } = await supabase.from('activated_global_bonuses').select('*').eq('customer_id', currentCustomer.id).eq('is_used', false);
    
    if (existingActive && existingActive.length > 0) {
      alert('‚ùå Du hast bereits einen aktiven Bonus! Bitte verwende ihn zuerst.');
      return;
    }
    
    const { error } = await supabase.from('activated_global_bonuses').insert({
      customer_id: currentCustomer.id,
      global_bonus_id: bonusId,
      activated_at: new Date().toISOString(),
      is_used: false
    });
    
    if (error) throw error;
    
    loadBonuses();
    
  } catch (e) {
    console.error('‚ùå Activate error:', e);
    alert('‚ùå Fehler beim Aktivieren: ' + e.message);
  }
}

async function loadChallenges() {
  if (!currentCustomer) return;
  
  try {
    const now = new Date();
    const { data: challenges, error } = await supabase.from('challenges').select('*').eq('is_active', true).gte('end_date', now.toISOString().split('T')[0]).order('created_at', { ascending: false });
    if (error) throw error;
    
    const section = document.getElementById('challenges-section');
    const list = document.getElementById('challenges-list');
    
    if (!challenges || challenges.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    const challengeHTML = [];
    
    for (const challenge of challenges) {
      const { data: progressRows, error: progressError } = await supabase.from('challenge_progress').select('*').eq('customer_id', currentCustomer.id).eq('challenge_id', challenge.id).limit(1);
      if (progressError) {
        console.error('Progress load error:', progressError);
        continue;
      }
      
      const progress = (progressRows && progressRows.length > 0) ? progressRows[0] : null;
      const isActivated = progress !== null;
      const completedOrders = progress?.completed_orders || 0;
      const isCompleted = progress?.is_completed || false;
      
      if (isCompleted) continue;
      
      const progressPercent = Math.min((completedOrders / challenge.required_orders) * 100, 100);
      const startDate = new Date(challenge.start_date).toLocaleDateString('de-DE');
      const endDate = new Date(challenge.end_date).toLocaleDateString('de-DE');
      const remaining = challenge.required_orders - completedOrders;
      
      if (!isActivated) {
        challengeHTML.push(`
          <div class="challenge-item">
            <h3>üéÅ ${challenge.bonus_points} Extra-Punkte f√ºr ${challenge.required_orders} Bestellungen ab ${challenge.min_order_amount} ‚Ç¨</h3>
            <div class="challenge-desc">Aktiviere diese Challenge um teilzunehmen!</div>
            <div class="challenge-date">üìÖ G√ºltig: ${startDate} - ${endDate}</div>
            <button onclick="activateChallenge(${challenge.id})" style="margin-top: 12px;">üöÄ Jetzt aktivieren</button>
          </div>
        `);
      } else {
        challengeHTML.push(`
          <div class="challenge-item" style="background: linear-gradient(135deg, #F9A825, #f59e0b);">
            <h3>üéÅ ${challenge.bonus_points} Extra-Punkte f√ºr ${challenge.required_orders} Bestellungen ab ${challenge.min_order_amount} ‚Ç¨</h3>
            <div class="challenge-desc">${remaining} ${remaining === 1 ? 'Bestellung' : 'Bestellungen'} offen</div>
            <div class="challenge-progress">
              <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: 600;">
                <span>${completedOrders} / ${challenge.required_orders} Bestellungen</span>
                <span>${Math.round(progressPercent)}%</span>
              </div>
              <div class="challenge-progress-bar">
                <div class="challenge-progress-fill" style="width: ${progressPercent}%"></div>
              </div>
            </div>
            <div class="challenge-date">üìÖ G√ºltig: ${startDate} - ${endDate}</div>
          </div>
        `);
      }
    }
    
    if (challengeHTML.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    section.style.display = 'block';
    list.innerHTML = challengeHTML.join('');
    
  } catch (e) {
    console.error('Load challenges error:', e);
  }
}

async function activateChallenge(challengeId) {
  try {
    await supabase.from('challenge_progress').insert({
      customer_id: currentCustomer.id,
      challenge_id: challengeId,
      completed_orders: 0,
      is_completed: false
    });
    
    loadChallenges();
    
  } catch (e) {
    console.error('Activate challenge error:', e);
  }
}

async function loadCoupons() {
  if (!currentCustomer) return;
  
  try {
    const { data: coupons, error } = await supabase.from('coupons').select('*').eq('is_active', true).order('created_at', { ascending: false });
    if (error) throw error;
    
    const section = document.getElementById('coupons-section');
    const list = document.getElementById('coupons-list');
    
    if (!coupons || coupons.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    const now = new Date();
    const activeCoupons = coupons.filter(c => new Date(c.expires_at) > now);
    
    if (activeCoupons.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    const { data: activated } = await supabase.from('activated_coupons').select('coupon_id, unique_code').eq('customer_id', currentCustomer.id).eq('is_used', false);
    const activatedMap = new Map(activated?.map(a => [a.coupon_id, a.unique_code]) || []);
    
    section.style.display = 'block';
    list.innerHTML = activeCoupons.map(coupon => {
      const expiry = new Date(coupon.expires_at);
      const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
      const isActivated = activatedMap.has(coupon.id);
      const uniqueCode = activatedMap.get(coupon.id);
      
      let expiryText = '';
      if (daysLeft === 0) {
        expiryText = '<span class="coupon-expiry warning">‚ö†Ô∏è L√§uft heute ab!</span>';
      } else if (daysLeft <= 3) {
        expiryText = `<span class="coupon-expiry warning">‚è∞ L√§uft in ${daysLeft} Tagen ab</span>`;
      } else {
        expiryText = `<span class="coupon-expiry">‚è∞ L√§uft in ${daysLeft} Tagen ab</span>`;
      }
      
      const formattedPrice = parseFloat(coupon.price || 0).toFixed(2).replace('.', ',') + ' ‚Ç¨';
      
      return `
        <div class="coupon-item ${isActivated ? 'activated' : ''}">
          <h3>${coupon.title}</h3>
          <div class="coupon-product">üç¥ ${coupon.product}</div>
          <div class="coupon-price">üí∞ ${formattedPrice}</div>
          ${coupon.description ? `<div class="coupon-desc">üìù ${coupon.description}</div>` : ''}
          ${isActivated ? `<div class="coupon-code-display">${uniqueCode}</div>` : ''}
          ${expiryText}
          ${isActivated 
            ? `<div class="coupon-activated-badge">‚úÖ Aktiviert! Zeige Code beim Scannen</div><button onclick="deactivateCoupon(${coupon.id})" style="background: #ef4444; margin-top: 8px;">‚ùå Stornieren</button>` 
            : `<button onclick="activateCoupon(${coupon.id})">üöÄ Jetzt aktivieren</button>`
          }
        </div>
      `;
    }).join('');
    
  } catch (e) {
    console.error('Load coupons error:', e);
  }
}

async function activateCoupon(couponId) {
  try {
    const id = parseInt(couponId);
    
    const { data: existing } = await supabase.from('activated_coupons').select('*').eq('customer_id', currentCustomer.id).eq('coupon_id', id).eq('is_used', false);
    
    if (existing && existing.length > 0) {
      loadCoupons();
      return;
    }
    
    const uniqueCode = generateSecureCode();
    
    const { error } = await supabase.from('activated_coupons').insert({
      customer_id: currentCustomer.id,
      coupon_id: id,
      unique_code: uniqueCode,
      activated_at: new Date().toISOString(),
      is_used: false
    });
    
    if (error) {
      console.error('‚ùå Activate coupon error:', error);
      alert('‚ùå Fehler beim Aktivieren. Bitte nochmal versuchen.');
      return;
    }
    
    loadCoupons();
    
  } catch (e) {
    console.error('‚ùå Fehler beim Aktivieren:', e);
    alert('‚ùå Fehler: ' + e.message);
    loadCoupons();
  }
}

async function deactivateCoupon(couponId) {
  try {
    const id = parseInt(couponId);
    await supabase.from('activated_coupons').delete().eq('customer_id', currentCustomer.id).eq('coupon_id', id).eq('is_used', false);
    loadCoupons();
  } catch (e) {
    console.error('Fehler beim Stornieren:', e.message);
    loadCoupons();
  }
}

function logout() {
  if (refreshInterval) clearInterval(refreshInterval);
  currentCustomer = null;
  localStorage.removeItem('customerData');
  showScreen('start');
}

window.onload = () => {
  const stored = localStorage.getItem('customerData');
  
  if (stored) {
    try {
      const customer = JSON.parse(stored);
      if (!customer || !customer.id || !customer.qr_id) {
        console.error('‚ùå Ung√ºltige Kundendaten im localStorage');
        localStorage.removeItem('customerData');
        return;
      }
      loadCustomer(customer);
    } catch (e) {
      console.error('‚ùå Fehler beim Laden:', e);
      localStorage.removeItem('customerData');
    }
  }
};

console.log('‚úÖ D√∂ner Boxx Kunden-App geladen (mit Wheel Integration)');
console.log('üîí Verwendet crypto.getRandomValues() f√ºr sichere Zufallszahlen');
console.log('üî¥ Startposition: D√ñNER (rotes Feld oben)');
console.log('üéØ Logo klickbar f√ºr Spin');
console.log('‚ö° Punkte werden automatisch gutgeschrieben');
</script>
</body>
</html>
