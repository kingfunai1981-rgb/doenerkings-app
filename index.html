<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂ner Boxx Loyalty & Bestellung</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon-new.png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: #f5f5f5;
  min-height: 100vh;
  padding: 0 0 80px 0;
  margin: 0;
}

.container { 
  max-width: 500px; 
  margin: 0 auto;
  background: white;
  min-height: 100vh;
}

.header-image {
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  padding: 20px 20px 24px;
  text-align: center;
  position: relative;
}

.header-logo {
  width: 120px;
  height: 120px;
  margin: 0 auto 16px;
  background: transparent;
  border-radius: 50%;
  padding: 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  clip-path: circle(50%);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.header-image h1 {
  color: white;
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 20px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.header-image p {
  color: white;
  font-size: 16px;
  opacity: 0.95;
  margin-bottom: 4px;
}

.header-image p.small {
  font-size: 13px;
  opacity: 0.8;
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  margin-top: 8px;
}

.header-qr-mini {
  width: 60px;
  height: 60px;
  background: white;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  flex-shrink: 0;
}

.header-qr-mini:hover { transform: scale(1.05); }
.header-qr-mini img { width: 50px; height: 50px; border-radius: 6px; }

.qr-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.qr-modal.active { display: flex; }

.qr-modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  position: relative;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-50px) scale(0.9); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.qr-modal-close {
  position: absolute;
  top: 10px; right: 10px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  border: none;
  width: 40px; height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  transition: all 0.2s;
}

.qr-modal-close:hover {
  opacity: 0.9;
  transform: rotate(90deg);
}

.qr-modal-img {
  width: 260px; height: 260px;
  margin: 20px auto;
  background: white;
  padding: 15px;
  border-radius: 12px;
  border: 3px solid #E31E24;
}

.qr-modal-id {
  font-size: 42px;
  font-weight: 700;
  color: #E31E24;
  letter-spacing: 5px;
  margin: 16px 0;
  font-family: 'Courier New', monospace;
}

.qr-modal-label { font-size: 14px; color: #666; margin-bottom: 8px; }

.card {
  background: white;
  border-radius: 0;
  padding: 24px 16px;
  margin-bottom: 0;
  border-bottom: 1px solid #f0f0f0;
}

h2 { font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #232122; }
.subtitle { color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 20px; }

input {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  margin-bottom: 10px;
  background: #fafafa;
  transition: all 0.2s;
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

input:focus { outline: none; border-color: #E31E24; background: white; }

button {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 6px;
  transition: all 0.2s;
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

button:hover { opacity: 0.9; transform: translateY(-1px); }
button:active { transform: translateY(0); }
button.secondary { background: #f5f5f5; color: #E31E24; border: 1px solid #e0e0e0; }
button.secondary:hover { background: #ebebeb; }
button.small { width: auto; padding: 8px 16px; font-size: 13px; margin: 4px; display: inline-block; }
button:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; transform: none; }
.option-btn:disabled { opacity: 0.4; background: #e5e7eb !important; color: #9ca3af !important; pointer-events: none; }

/* üîô Zur√ºck-Button Styling */
.header button[onclick*="closeOrderModal"]:hover {
  transform: scale(1.08) translateY(-1px);
  box-shadow: 0 6px 16px rgba(227, 30, 36, 0.4) !important;
}

.header button[onclick*="closeOrderModal"]:active {
  transform: scale(0.98);
}

.result {
  padding: 10px 12px;
  border-radius: 6px;
  margin-top: 10px;
  font-size: 13px;
  text-align: center;
}

.success { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; }
.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
.info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }

.points-circle {
  width: 100px; height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  box-shadow: 0 4px 16px rgba(227, 30, 36, 0.25);
  flex-shrink: 0;
}

.points-num { font-size: 36px; font-weight: 700; line-height: 1; }
.points-label { font-size: 12px; opacity: 0.9; margin-top: 4px; }

.reward {
  background: #fafafa;
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid #f0f0f0;
  transition: all 0.2s;
}

.reward:hover { background: #f5f5f5; border-color: #e0e0e0; }
.reward-info h3 { font-size: 15px; font-weight: 600; margin: 0 0 4px 0; color: #232122; }
.reward-info .pts { font-size: 13px; color: #E31E24; font-weight: 600; }
.reward button { width: 100px !important; padding: 10px 12px !important; font-size: 13px !important; }

.pending-code {
  background: #fffbeb;
  border: 2px solid #fbbf24;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 10px;
}

.pending-code h3 { color: #92400e; font-size: 15px; font-weight: 600; margin-bottom: 8px; }
.pending-code .code { font-size: 28px; font-weight: 700; color: #f59e0b; letter-spacing: 5px; margin: 10px 0; font-family: 'Courier New', monospace; }
.pending-code .code-info { font-size: 12px; color: #92400e; margin-bottom: 10px; line-height: 1.5; }

.screen { display: none; }
.screen.active { display: block; }

.header {
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-logo-order {
  width: 80px;
  height: 80px;
  margin: 0 auto 12px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.header-logo-order img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.header h1 {
  color: white;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.header p {
  color: white;
  font-size: 14px;
  opacity: 0.9;
}

.products {
  padding: 16px;
}

.category-section {
  margin-bottom: 8px;
}

.category-header {
  background: linear-gradient(135deg, #f9fafb, #f3f4f6);
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 0;
}

.category-header:hover {
  border-color: #E31E24;
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
}

.category-title {
  font-size: 18px;
  font-weight: 700;
  color: #232122;
  display: flex;
  align-items: center;
  gap: 8px;
}

.category-count {
  font-size: 14px;
  font-weight: 600;
  color: #666;
  background: white;
  padding: 2px 8px;
  border-radius: 12px;
}

.category-arrow {
  font-size: 16px;
  color: #E31E24;
  font-weight: 700;
  transition: transform 0.3s;
}

.category-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  padding: 0 4px;
}

.category-content.open {
  max-height: 5000px;
  padding: 12px 4px 0;
}

.product-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 2px solid #f0f0f0;
  cursor: pointer;
  transition: all 0.2s;
}

.product-card:hover {
  border-color: #E31E24;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.15);
}

.product-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.product-name {
  font-size: 18px;
  font-weight: 700;
  color: #232122;
}

.product-price {
  font-size: 20px;
  font-weight: 700;
  color: #E31E24;
}

.product-desc {
  font-size: 13px;
  color: #666;
  margin-bottom: 12px;
  line-height: 1.5;
}

.add-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  margin-top: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.add-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 9999;
  align-items: flex-end;
  justify-content: center;
}

.modal.active {
  display: flex;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  border-radius: 20px 20px 0 0;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-header {
  position: sticky;
  top: 0;
  background: white;
  padding: 20px;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 1;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  color: #232122;
}

.modal-close {
  background: #f5f5f5;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-body {
  padding: 20px;
}

.option-group {
  margin-bottom: 24px;
}

.option-label {
  font-size: 15px;
  font-weight: 700;
  color: #232122;
  margin-bottom: 12px;
  display: block;
}

.option-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.option-btn {
  flex: 1;
  min-width: 60px;
  padding: 10px 16px;
  background: #f5f5f5;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.option-btn:hover {
  background: #ebebeb;
}

.option-btn.active {
  background: linear-gradient(135deg, #E31E24, #F9A825);
  border-color: #E31E24;
  color: white;
}

.extra-item {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all 0.2s;
}

.extra-item:hover {
  border-color: #E31E24;
  background: #fef2f2;
}

.extra-item.selected {
  border-color: #E31E24;
  background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(249, 168, 37, 0.1));
}

.extra-info {
  flex: 1;
}

.extra-name {
  font-size: 14px;
  font-weight: 600;
  color: #232122;
}

.extra-price {
  font-size: 16px;
  font-weight: 700;
  color: #E31E24;
}

.modal-footer {
  position: sticky;
  bottom: 0;
  background: white;
  padding: 16px 20px;
  border-top: 1px solid #f0f0f0;
}

.modal-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 18px;
  font-weight: 700;
}

.modal-total-price {
  color: #E31E24;
  font-size: 24px;
}

.cart-fixed {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px 16px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  z-index: 999;
}

.cart-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}

.cart-btn:hover {
  opacity: 0.9;
}

.cart-count {
  background: white;
  color: #E31E24;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
}

.cart-item {
  background: #f9fafb;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  border: 2px solid #e5e7eb;
}

.cart-item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.cart-item-name {
  font-size: 16px;
  font-weight: 700;
  color: #232122;
}

.cart-item-price {
  font-size: 18px;
  font-weight: 700;
  color: #E31E24;
}

.cart-item-options {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
  line-height: 1.6;
}

.cart-item-actions {
  display: flex;
  gap: 8px;
}

.cart-item-btn {
  flex: 1;
  padding: 8px;
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
}

.cart-item-btn:hover {
  background: #ebebeb;
}

.cart-item-btn.delete {
  background: #fee2e2;
  border-color: #fecaca;
  color: #991b1b;
}

.cart-empty {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.cart-empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

/* üéÅ MEN√ú-BUNDLE STYLES */
.menu-bundle-offer {
  background: linear-gradient(135deg, #FFF9E6, #FFF4D6);
  border: 2px solid #F9A825;
  border-radius: 16px;
  padding: 20px;
  margin: 16px 0;
  box-shadow: 0 4px 12px rgba(249, 168, 37, 0.2);
  animation: pulseGlow 2s infinite;
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 4px 12px rgba(249, 168, 37, 0.2); }
  50% { box-shadow: 0 6px 20px rgba(249, 168, 37, 0.4); }
}

.menu-bundle-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.menu-bundle-icon {
  font-size: 24px;
}

.menu-bundle-title {
  font-size: 18px;
  font-weight: 700;
  color: #E31E24;
}

.menu-bundle-subtitle {
  font-size: 13px;
  color: #92400e;
  margin-bottom: 12px;
}

.menu-bundle-items {
  background: white;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
}

.menu-bundle-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  font-size: 14px;
  color: #374151;
}

.menu-bundle-item-icon {
  font-size: 16px;
}

.menu-bundle-pricing {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.menu-bundle-original {
  font-size: 14px;
  color: #666;
  text-decoration: line-through;
}

.menu-bundle-price {
  font-size: 24px;
  font-weight: 700;
  color: #E31E24;
}

.menu-bundle-savings {
  background: #10b981;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 12px;
}

.menu-bundle-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.menu-bundle-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(227, 30, 36, 0.4);
}

.checkout-section {
  margin-bottom: 20px;
}

.checkout-section h3 {
  font-size: 16px;
  font-weight: 700;
  color: #232122;
  margin-bottom: 12px;
}

input[type="text"],
input[type="tel"],
textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  font-family: 'Flame', sans-serif;
  margin-bottom: 8px;
  transition: all 0.2s;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #E31E24;
}

.payment-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.payment-btn {
  padding: 16px;
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.payment-btn:hover {
  border-color: #E31E24;
  background: #fef2f2;
}

.payment-btn.active {
  border-color: #E31E24;
  background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(249, 168, 37, 0.1));
}

.payment-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.payment-name {
  font-size: 14px;
  font-weight: 600;
  color: #232122;
}

.pickup-time-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.pickup-time-btn {
  padding: 16px;
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.pickup-time-btn:hover {
  border-color: #E31E24;
  background: #fef2f2;
}

.pickup-time-btn.active {
  border-color: #E31E24;
  background: linear-gradient(135deg, rgba(227, 30, 36, 0.1), rgba(249, 168, 37, 0.1));
}

.pickup-time-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.pickup-time-name {
  font-size: 15px;
  font-weight: 600;
  color: #232122;
  margin-bottom: 4px;
}

.pickup-time-desc {
  font-size: 12px;
  color: #666;
}

.order-summary {
  background: #f9fafb;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.summary-row.total {
  font-size: 18px;
  font-weight: 700;
  padding-top: 12px;
  border-top: 2px solid #e5e7eb;
  margin-top: 8px;
  color: #E31E24;
}

.place-order-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.place-order-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.place-order-btn:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  transform: none;
}

.success-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.success-modal.active {
  display: flex;
}

.success-content {
  background: white;
  border-radius: 20px;
  padding: 40px 30px;
  max-width: 400px;
  text-align: center;
  animation: scaleIn 0.5s;
}

@keyframes scaleIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.success-title {
  font-size: 24px;
  font-weight: 700;
  color: #232122;
  margin-bottom: 12px;
}

.success-text {
  font-size: 15px;
  color: #666;
  margin-bottom: 24px;
  line-height: 1.6;
}

.order-number {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 24px;
}

.order-number-label {
  font-size: 13px;
  color: #92400e;
  margin-bottom: 4px;
}

.order-number-value {
  font-size: 32px;
  font-weight: 700;
  color: #E31E24;
  font-family: 'Courier New', monospace;
  letter-spacing: 2px;
}

/* üé° NEU: Lucky Wheel Styles */
.wheel-section {
  display: none; /* Standard: versteckt */
}

.wheel-section.active {
  display: block;
}

.wheel-badge {
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  padding: 12px 20px;
  border-radius: 10px;
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.3);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.wheel-container {
  position: relative;
  width: 100%;
  max-width: 350px;
  margin: 0 auto 20px;
}

.wheel-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
}

#wheelCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.wheel-pointer {
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 30px solid #E31E24;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  z-index: 10;
}

.wheel-info-box {
  background: #f9fafb;
  border-radius: 10px;
  padding: 16px;
  text-align: center;
  font-size: 14px;
  color: #666;
  margin-top: 20px;
}

.wheel-result-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.wheel-result-modal.active {
  display: flex;
}

.wheel-result-content {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 350px;
  width: 100%;
  text-align: center;
  animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes popIn {
  0% { transform: scale(0.5); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.wheel-result-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.wheel-result-title {
  font-size: 24px;
  font-weight: 700;
  color: #E31E24;
  margin-bottom: 12px;
}

.wheel-result-prize {
  font-size: 20px;
  color: #333;
  margin-bottom: 24px;
}

/* Footer Styling */
.footer {
  text-align: center;
  padding: 30px 20px;
  color: #333; /* ‚úÖ Schwarz statt wei√ü f√ºr bessere Lesbarkeit */
  font-size: 13px;
  margin-top: 40px;
  opacity: 1; /* ‚úÖ Volle Deckkraft */
}

.footer p {
  margin: 0 0 8px 0;
}

.footer-legal {
  font-size: 12px;
  opacity: 0.8;
  margin: 0;
  color: #555; /* ‚úÖ Dunkelgrau f√ºr zweiten Text */
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üì¶ BESTELLHISTORIE STYLES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.order-history-item {
  background: white;
  border: 2px solid #eee;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.2s;
}

.order-history-item:hover {
  border-color: #E31E24;
  box-shadow: 0 2px 8px rgba(227, 30, 36, 0.1);
}

.order-history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid #eee;
}

.order-history-number {
  font-weight: 600;
  font-size: 16px;
  color: #333;
}

.order-history-date {
  font-size: 12px;
  color: #999;
}

.order-history-status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.order-history-status.completed {
  background: #e8f5e9;
  color: #2e7d32;
}

.order-history-status.cancelled {
  background: #ffebee;
  color: #c62828;
}

.order-history-items {
  margin: 12px 0;
}

.order-history-item-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 8px 0;
  font-size: 14px;
}

.order-history-item-name {
  flex: 1;
  color: #333;
  font-weight: 500;
}

.order-history-item-options {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
  padding-left: 12px;
}

.order-history-item-price {
  color: #E31E24;
  font-weight: 600;
  white-space: nowrap;
  margin-left: 12px;
}

.order-history-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 12px;
  margin-top: 12px;
  border-top: 2px solid #eee;
  font-size: 16px;
  font-weight: 600;
}

.order-history-total-label {
  color: #333;
}

.order-history-total-amount {
  color: #E31E24;
  font-size: 18px;
}

.order-history-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.order-history-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.order-history-btn.primary {
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
}

.order-history-btn.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.3);
}

.order-history-btn.secondary {
  background: white;
  color: #E31E24;
  border: 2px solid #E31E24;
}

.order-history-btn.secondary:hover {
  background: #E31E24;
  color: white;
}

.order-history-details {
  background: #f8f8f8;
  border-radius: 8px;
  padding: 12px;
  margin-top: 12px;
  display: none;
  animation: slideDown 0.3s ease;
}

.order-history-details.show {
  display: block;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.order-history-detail-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  font-size: 13px;
  color: #666;
}

.order-history-detail-label {
  font-weight: 500;
  color: #333;
}

.order-history-empty {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.order-history-empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.order-history-empty-text {
  font-size: 14px;
  line-height: 1.6;
}


</style>
</head>
<body>

<div class="container">
  <div id="screen-start" class="screen active">
    <div class="header-image">
      <div class="header-logo">
        <img src="/logo-round-new.png" alt="D√∂ner Boxx">
      </div>
      <h1>D√∂ner Boxx</h1>
      <p>Treue wird belohnt!</p>
      <p class="small">1 ‚Ç¨ = 10 Punkte</p>
    </div>
    
    <div class="card">
      <h2>Neu hier?</h2>
      <p class="subtitle">Registriere dich jetzt und sammle Punkte bei jeder Bestellung!</p>
      <button onclick="showScreen('register')">‚ú® Jetzt registrieren</button>
      <button class="secondary" onclick="showScreen('login')">üîì Ich habe schon einen Account</button>
    </div>
  </div>

  <div id="screen-register" class="screen">
    <div class="header-image">
      <div class="header-logo">
        <img src="/logo-round-new.png" alt="D√∂ner Boxx">
      </div>
      <h1>D√∂ner Boxx</h1>
    </div>
    
    <div class="card">
      <h2>Jetzt registrieren</h2>
      <input id="reg-name" type="text" placeholder="Dein Name">
      <input id="reg-phone" type="tel" placeholder="Handynummer">
      <button onclick="register()">‚úÖ Registrieren</button>
      <button class="secondary" onclick="showScreen('start')">‚Ü©Ô∏è Zur√ºck</button>
      <div id="reg-result"></div>
    </div>
  </div>

  <div id="screen-login" class="screen">
    <div class="header-image">
      <div class="header-logo">
        <img src="/logo-round-new.png" alt="D√∂ner Boxx">
      </div>
      <h1>D√∂ner Boxx</h1>
    </div>
    
    <div class="card">
      <h2>Anmelden</h2>
      <input id="login-phone" type="tel" placeholder="Handynummer">
      <button onclick="login()">üîì Anmelden</button>
      <button class="secondary" onclick="showScreen('start')">‚Ü©Ô∏è Zur√ºck</button>
      <div id="login-result"></div>
    </div>
  </div>

  <div id="screen-app" class="screen">
    <div class="header-image">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="header-logo" style="width: 60px; height: 60px; margin: 0;">
          <img src="/logo-round-new.png" alt="D√∂ner Boxx">
        </div>
        <button onclick="logout()" class="small secondary" style="margin: 0;">Abmelden</button>
      </div>
      
      <div class="header-content">
        <div class="points-circle">
          <div class="points-num" id="app-points">0</div>
          <div class="points-label">Punkte</div>
        </div>
        
        <div class="header-qr-mini" onclick="openQRModal()">
          <img id="header-qr-mini" alt="QR">
        </div>
      </div>
      
      <p style="font-size: 11px; margin-top: 10px; opacity: 0.9;">Tippe auf QR zum Vergr√∂√üern</p>
    </div>

    <div id="qr-modal" class="qr-modal" onclick="closeQRModal(event)">
      <div class="qr-modal-content" onclick="event.stopPropagation()">
        <button class="qr-modal-close" onclick="closeQRModal(event)">√ó</button>
        <div class="qr-modal-label">Zeige diesen Code beim Bezahlen</div>
        <img id="modal-qr" class="qr-modal-img" alt="QR">
        <div class="qr-modal-label">Oder nenne diese ID:</div>
        <div class="qr-modal-id" id="modal-qr-id">------</div>
      </div>
    </div>

    <!-- üé° Lucky Wheel Section (nur bei Freischaltung sichtbar) -->
    <div id="wheel-section" class="wheel-section">
      <div class="card">
        <h2>üé° Lucky Wheel</h2>
        
        <!-- Badge wenn verf√ºgbar -->
        <div id="wheel-available-badge" style="display: none;">
          <div class="wheel-badge">
            üé° Du hast <span id="wheel-count">0</span> freie Drehung(en)!
          </div>
        </div>
        
        <!-- Wheel Canvas -->
        <div class="wheel-container">
          <div class="wheel-wrapper">
            <div class="wheel-pointer"></div>
            <canvas id="wheelCanvas" width="400" height="400"></canvas>
          </div>
        </div>
        
        <!-- Info wenn nicht verf√ºgbar -->
        <div id="wheel-info" class="wheel-info-box">
          üéâ Klicke auf das Logo zum Drehen!
        </div>
      </div>
    </div>

    <!-- Wheel Result Modal -->
    <div id="wheel-result-modal" class="wheel-result-modal">
      <div class="wheel-result-content">
        <div class="wheel-result-icon" id="wheel-result-icon">‚≠ê</div>
        <div class="wheel-result-title" id="wheel-result-title">Gl√ºckwunsch!</div>
        <div class="wheel-result-prize" id="wheel-result-prize">+100 Punkte</div>
        <button onclick="closeWheelResult()">Weiter</button>
      </div>
    </div>

    <div class="card" style="padding: 12px; margin-bottom: 16px;">
      <button onclick="openOrderModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <span style="font-size: 20px;">üõí</span>
        <span>Jetzt bestellen</span>
      </button>
    </div>

    <!-- üì¶ NEU: Vorherige Bestellungen Section (zugeklappt) -->
    <div id="order-history-section" class="card" style="margin-bottom: 16px;">
      <div onclick="toggleHistorySection()" style="cursor: pointer; user-select: none;">
        <h2 style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0;">
          <span style="display: flex; align-items: center; gap: 8px;">
            <span>üì¶</span>
            <span>Vorherige Bestellungen</span>
          </span>
          <span id="history-toggle-icon" style="font-size: 20px; transition: transform 0.3s;">‚ñº</span>
        </h2>
      </div>
      
      <div id="order-history-list" style="display: none; margin-top: 16px;">
        <div style="text-align: center; padding: 20px; color: #999;">
          Lade Bestellhistorie...
        </div>
      </div>
    </div>

    <!-- üéØ Challenge Section -->
    <div id="challenge-section" style="display: none;">
      <div class="card">
        <h2>üéØ Aktive Challenges</h2>
        <div id="challenge-list"></div>
      </div>
    </div>

    <div id="pending-section" style="display: none;">
      <div class="card">
        <h2>‚è≥ Wartet auf Best√§tigung</h2>
        <div id="pending-list"></div>
      </div>
    </div>

    
    <!-- üì± WhatsApp-Benachrichtigungen Section (VOR Pr√§mien) -->
    <div id="whatsapp-section-top">
      <!-- Wird dynamisch geladen -->
    </div>

    <!-- ====== üåü GLOBALE BONUSSE ====== -->
    <div class="card" id="globalBonusSection" style="display: none;">
      <h2>üåü Exklusive Angebote</h2>
      <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
        Aktiviere einen Bonus und erhalte extra Punkte bei deiner n√§chsten Bestellung!
      </p>
      <div id="globalBonusList"></div>
    </div>

<div class="card">
      <h2>üéÅ Pr√§mien einl√∂sen</h2>
      <div class="reward">
        <div class="reward-info">
          <h3>Ayran (0.25 l)</h3>
          <div class="pts">250 Punkte</div>
        </div>
        <button onclick="redeem('Ayran (0.25 l)', 250)" id="btn-250">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div class="reward-info">
          <h3>Pommes</h3>
          <div class="pts">500 Punkte</div>
        </div>
        <button onclick="redeem('Pommes', 500)" id="btn-500">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div class="reward-info">
          <h3>D√∂ner Box</h3>
          <div class="pts">750 Punkte</div>
        </div>
        <button onclick="redeem('D√∂ner Box', 750)" id="btn-750">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div class="reward-info">
          <h3>D√∂ner XL</h3>
          <div class="pts">1000 Punkte</div>
        </div>
        <button onclick="redeem('D√∂ner XL', 1000)" id="btn-1000">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div class="reward-info">
          <h3>D√∂ner Teller</h3>
          <div class="pts">1250 Punkte</div>
        </div>
        <button onclick="redeem('D√∂ner Teller', 1250)" id="btn-1250">Einl√∂sen</button>
      </div>
    </div>

    <!-- üì± WhatsApp-Benachrichtigungen Section (NACH Pr√§mien) -->
    <div id="whatsapp-section-bottom">
      <!-- Wird dynamisch geladen -->
    </div>
  </div>

  <div id="order-section" style="display: none;">
    <div class="header" style="position: relative;">
      <button onclick="closeOrderModal()" style="position: absolute; top: 20px; left: 20px; background: linear-gradient(135deg, #E31E24, #F9A825); border: none; width: 48px; height: 48px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(227, 30, 36, 0.35); transition: all 0.3s ease; z-index: 10;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 2px;">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
      </button>
      <div class="header-logo-order">
        <img src="/logo-round-new.png" alt="D√∂ner Boxx">
      </div>
      <h1>Jetzt Bestellen</h1>
      <p>W√§hle deine Lieblingsgerichte</p>
    </div>

    <div class="products" id="products"></div>
  </div>
</div>

<div class="cart-fixed" id="cartFixed" style="display: none;">
  <button class="cart-btn" onclick="openCart()">
    <span>üõí Warenkorb ansehen</span>
    <div>
      <span class="cart-count" id="cartCount">0</span>
      <span id="cartTotal" style="margin-left: 8px;">0,00 ‚Ç¨</span>
    </div>
  </button>
</div>

<div class="modal" id="customizeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Produkt anpassen</h2>
      <button class="modal-close" onclick="closeCustomizeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <div class="modal-total">
        <span>Gesamt:</span>
        <span class="modal-total-price" id="modalTotal">0,00 ‚Ç¨</span>
      </div>
      <button class="add-btn" onclick="addToCart()">In den Warenkorb</button>
    </div>
  </div>
</div>

<div class="modal cart-modal" id="cartModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Dein Warenkorb</h2>
      <button class="modal-close" onclick="closeCart()">‚úï</button>
    </div>
    <div class="modal-body" id="cartItems"></div>
    <div class="modal-footer">
      <div class="modal-total">
        <span>Gesamt:</span>
        <span class="modal-total-price" id="cartModalTotal">0,00 ‚Ç¨</span>
      </div>
      <button class="add-btn" onclick="goToCheckout()">
        Zur Kasse (üõí <span id="cartModalCount">0</span>)
      </button>
    </div>
  </div>
</div>

<div class="modal" id="checkoutModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Bestellung abschlie√üen</h2>
      <button class="modal-close" onclick="closeCheckout()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="checkout-section">
        <h3>üì± Kontaktdaten</h3>
        <input type="text" id="customerName" placeholder="Dein Name" required>
        <input type="tel" id="customerPhone" placeholder="Telefonnummer" required>
        <textarea id="customerNotes" placeholder="Anmerkungen zur Bestellung (optional)" rows="3"></textarea>
      </div>

      <div class="checkout-section">
        <h3>üïê Abholzeit</h3>
        <div class="pickup-time-options">
          <div class="pickup-time-btn active" id="pickupNow" onclick="selectPickupTime('now')">
            <div class="pickup-time-icon">‚ö°</div>
            <div class="pickup-time-name">Sofort</div>
            <div class="pickup-time-desc">~15 Min.</div>
          </div>
          <div class="pickup-time-btn" id="pickupLater" onclick="selectPickupTime('later')">
            <div class="pickup-time-icon">üïê</div>
            <div class="pickup-time-name">Sp√§ter</div>
            <div class="pickup-time-desc">Uhrzeit w√§hlen</div>
          </div>
        </div>
        <div id="timePickerContainer" style="display: none; margin-top: 12px;">
          <input type="time" id="pickupTimeInput" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
        </div>
      </div>

      <div class="checkout-section">
        <h3>üì¶ Deine Bestellung</h3>
        <div class="order-summary" id="checkoutSummary"></div>
      </div>

      <div class="checkout-section">
        <h3>üí≥ Zahlungsart</h3>
        <div class="payment-options">
          <div class="payment-btn" id="paymentCash" onclick="selectPayment('cash')">
            <div class="payment-icon">üíµ</div>
            <div class="payment-name">Bar bezahlen</div>
          </div>
          <div class="payment-btn" id="paymentPaypal" onclick="selectPayment('paypal')">
            <div class="payment-icon">üí≥</div>
            <div class="payment-name">PayPal</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()" disabled>
        Jetzt bestellen - <span id="finalTotal">0,00 ‚Ç¨</span>
      </button>
    </div>
  </div>
</div>

<div class="success-modal" id="successModal">
  <div class="success-content">
    <h2 class="success-title">Bestellung erfolgreich!</h2>
    <div class="order-number">
      <div class="order-number-label">Bestellnummer</div>
      <div class="order-number-value" id="orderNumber">#0000</div>
    </div>
    <button class="add-btn" onclick="closeSuccess()">üè† Zur√ºck zum Men√º</button>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <p>¬© 2025 D√∂ner Boxx. Alle Rechte vorbehalten.</p>
  <p class="footer-legal">Entwickelt exklusiv f√ºr D√∂ner Boxx. Unerlaubte Nutzung verboten.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

// ü§ñ Telegram Bot Konfiguration
// ‚ö†Ô∏è TOKENS WURDEN ENTFERNT - Jetzt sicher im Backend!
// Die Benachrichtigung erfolgt √ºber Supabase Edge Function


// üéØ DOM Element Cache f√ºr bessere Performance
const DOM = {
  screens: {},
  modals: {},
  buttons: {},
  inputs: {}
}

// DOM Elemente beim Start cachen
function cacheDOMElements() {
  // Screens
  DOM.screens.start = document.getElementById('screen-start')
  DOM.screens.register = document.getElementById('screen-register')
  DOM.screens.login = document.getElementById('screen-login')
  DOM.screens.app = document.getElementById('screen-app')
  
  // Modals
  DOM.modals.customize = document.getElementById('customizeModal')
  DOM.modals.cart = document.getElementById('cartModal')
  DOM.modals.checkout = document.getElementById('checkoutModal')
  DOM.modals.success = document.getElementById('successModal')
  DOM.modals.qr = document.getElementById('qr-modal')
  
  // Wichtige Container
  DOM.productsContainer = document.getElementById('products')
  DOM.cartContainer = document.getElementById('cartItems')
  DOM.checkoutSummary = document.getElementById('checkoutSummary')
  
  console.log('‚úÖ DOM Elemente gecacht')
}

// Wheel Check Throttling
let wheelCheckInProgress = false
let lastWheelCheck = 0
const WHEEL_CHECK_COOLDOWN = 5000

// üé° Lucky Wheel Variablen
let logoImg = null
let wheelHandlersAttached = false
let isSpinning = false
let wheelRotation = 0
let currentWheelUnlockId = null // F√ºr Spin Again

// Event Handler Referenzen f√ºr Cleanup
let wheelClickHandler = null
let wheelMoveHandler = null

const anglePerSegment = (2 * Math.PI) / 18
const WHEEL_OFFSET = -Math.PI / 2 - anglePerSegment / 2

const wheelPrizes = [
  { label: '500', color: '#E31E24', textColor: '#FFFFFF', type: 'points', value: 500 },          // 1 - ROT
  { label: '50', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 50 },            // 2 - WEI√ü
  { label: '100', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 100 },          // 3 - SCHWARZ
  { label: '25', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 25 },            // 4 - WEI√ü
  { label: '75', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },            // 5 - SCHWARZ
  { label: 'DREHE NOCHMAL!', color: '#FFFFFF', textColor: '#000000', type: 'spin_again', value: 0 }, // 6 - WEI√ü
  { label: '50', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },            // 7 - SCHWARZ
  { label: '100', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 100 },          // 8 - WEI√ü
  { label: '25', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 25 },            // 9 - SCHWARZ
  { label: '500', color: '#E31E24', textColor: '#FFFFFF', type: 'points', value: 500 },          // 10 - ROT
  { label: '75', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },            // 11 - SCHWARZ
  { label: '50', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 50 },            // 12 - WEI√ü
  { label: 'DREHE NOCHMAL!', color: '#000000', textColor: '#FFFFFF', type: 'spin_again', value: 0 }, // 13 - SCHWARZ
  { label: '100', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 100 },          // 14 - WEI√ü
  { label: '25', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 25 },            // 15 - SCHWARZ
  { label: '75', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 75 },            // 16 - WEI√ü
  { label: '50', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },            // 17 - SCHWARZ
  { label: '100', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 100 }           // 18 - WEI√ü
]

let currentCustomer = null
let refreshInterval = null
let refreshErrorCount = 0
const MAX_REFRESH_ERRORS = 3

function getRandomPrize() {
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  const randomIndex = Math.floor((array[0] / (0xFFFFFFFF + 1)) * wheelPrizes.length)
  return wheelPrizes[randomIndex]
}

// üîí Sichere localStorage Helper-Funktionen
function safeSetItem(key, value) {
  try {
    localStorage.setItem(key, value)
    return true
  } catch (e) {
    console.warn('‚ö†Ô∏è localStorage nicht verf√ºgbar:', e.message)
    return false
  }
}

function safeGetItem(key) {
  try {
    return localStorage.getItem(key)
  } catch (e) {
    console.warn('‚ö†Ô∏è localStorage nicht verf√ºgbar:', e.message)
    return null
  }
}

function safeRemoveItem(key) {
  try {
    localStorage.removeItem(key)
    return true
  } catch (e) {
    console.warn('‚ö†Ô∏è localStorage nicht verf√ºgbar:', e.message)
    return false
  }
}

function normalizePhone(phone) {
  let normalized = phone.replace(/[\s\-\(\)]/g, '')
  if (normalized.startsWith('+')) normalized = normalized.substring(1)
  if (normalized.startsWith('00')) normalized = normalized.substring(2)
  if (normalized.startsWith('49') && normalized.length > 10) normalized = '0' + normalized.substring(2)
  if (!normalized.startsWith('0') && normalized.length >= 10) normalized = '0' + normalized
  return normalized
}

function showScreen(screenName) {
  console.log(`üîÑ Wechsel zu Screen: ${screenName}`)
  
  // FORCE: Alle Screens verstecken
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.remove('active')
    s.style.display = 'none' // FORCE: display none
  })
  
  // FORCE: Gew√ºnschten Screen anzeigen
  const targetScreen = document.getElementById(`screen-${screenName}`)
  if (targetScreen) {
    targetScreen.classList.add('active')
    targetScreen.style.display = 'block' // FORCE: display block
    console.log(`‚úÖ Screen "${screenName}" aktiviert`)
  } else {
    console.error(`‚ùå Screen "screen-${screenName}" nicht gefunden!`)
  }
}

function showResult(elementId, message, type) {
  const el = document.getElementById(elementId)
  if (!message) { el.className = ''; el.innerHTML = ''; return }
  el.className = `result ${type}`
  el.innerHTML = message
}

async function generateUniqueCode(table, column) {
  for (let attempt = 0; attempt < 10; attempt++) {
    const code = Math.floor(1000 + Math.random() * 9000).toString()
    const { data, error } = await supabase.from(table).select(column).eq(column, code).limit(1)
    if (error) { console.error('Code check error:', error); continue }
    if (!data || data.length === 0) return code
    console.log(`‚ö†Ô∏è Code ${code} existiert bereits, versuche neuen...`)
  }
  return Date.now().toString().slice(-4)
}

async function register() {
  const name = document.getElementById('reg-name').value.trim()
  const phoneRaw = document.getElementById('reg-phone').value.trim()
  
  if (!name || !phoneRaw) { showResult('reg-result', '‚ùå Bitte Name und Handynummer eingeben!', 'error'); return }
  
  const phone = normalizePhone(phoneRaw)
  
  if (!/^\d+$/.test(phone)) { showResult('reg-result', '‚ùå Ung√ºltige Handynummer!', 'error'); return }
  if (phone.length < 10 || phone.length > 17) { showResult('reg-result', '‚ùå Telefonnummer muss 10-17 Ziffern haben!', 'error'); return }
  
  try {
    showResult('reg-result', '‚è≥ Wird registriert...', 'info')
    
    const { data: existing } = await supabase.from('customers').select('*').eq('phone', phone).limit(1)
    
    if (existing && existing.length > 0) { showResult('reg-result', '‚ùå Diese Nummer ist bereits registriert!', 'error'); return }
    
    const qrId = Math.floor(1000 + Math.random() * 9000).toString()
    
    const { data, error } = await supabase.from('customers').insert({ qr_id: qrId, name: name, phone: phone, points: 0 }).select().single()
    
    if (error) throw error
    
    showResult('reg-result', '‚úÖ Erfolgreich registriert!', 'success')
    setTimeout(() => {
      safeSetItem('customerData', JSON.stringify(data))
      loadCustomer(data)
    }, 1000)
    
  } catch (e) {
    showResult('reg-result', '‚ùå Fehler: ' + e.message, 'error')
    console.error('Registration error:', e)
  }
}

async function login() {
  const phoneRaw = document.getElementById('login-phone').value.trim()
  if (!phoneRaw) { showResult('login-result', '‚ùå Bitte Handynummer eingeben!', 'error'); return }
  
  const phone = normalizePhone(phoneRaw)
  
  try {
    showResult('login-result', '‚è≥ Suche Konto...', 'info')
    const { data: customers, error } = await supabase.from('customers').select('*').eq('phone', phone).limit(1)
    if (error) throw error
    if (!customers || customers.length === 0) { showResult('login-result', '‚ùå Handynummer nicht gefunden!', 'error'); return }
    
    showResult('login-result', '‚úÖ Erfolgreich angemeldet!', 'success')
    setTimeout(() => {
      safeSetItem('customerData', JSON.stringify(customers[0]))
      loadCustomer(customers[0])
    }, 500)
    
  } catch (e) {
    showResult('login-result', '‚ùå Fehler: ' + e.message, 'error')
    console.error('Login error:', e)
  }
}

async function loadCustomer(customer) {
  if (!customer || !customer.id) { console.error('‚ùå Ung√ºltiger Kunde √ºbergeben'); logout(); return }
  
  currentCustomer = customer
  refreshErrorCount = 0
  
  try {
    await refreshCustomerData()
    
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${customer.qr_id}`
    document.getElementById('header-qr-mini').src = qrUrl
    document.getElementById('modal-qr').src = qrUrl
    document.getElementById('modal-qr-id').textContent = customer.qr_id
    
    showScreen('app')
    
    // ‚úÖ Starte intelligentes Refresh (stoppt bei Hintergrund)
    startRefreshInterval()
    
    loadPendingCodes()
    loadActiveChallenges() // ‚úÖ Lade Challenges beim Login
    loadActiveCoupons() // ‚úÖ FIX 2: Lade Coupons beim Login
    loadGlobalBonuses() // ‚úÖ Lade Global Bonusse beim Login
    loadOrderHistory() // ‚úÖ NEU: Lade Bestellhistorie
    
  } catch (e) {
    console.error('‚ùå Fehler beim Laden des Kunden:', e)
    alert('‚ùå Fehler beim Laden. Bitte neu anmelden.')
    logout()
  }
}

// ‚úÖ Intelligentes Refresh-Interval mit Page Visibility API
function startRefreshInterval() {
  if (refreshInterval) clearInterval(refreshInterval)
  refreshInterval = setInterval(refreshCustomerData, 5000)
  console.log('‚úÖ Refresh-Interval gestartet')
}

function stopRefreshInterval() {
  if (refreshInterval) {
    clearInterval(refreshInterval)
    refreshInterval = null
    console.log('‚è∏Ô∏è Refresh-Interval gestoppt (App im Hintergrund)')
  }
}

async function refreshCustomerData() {
  if (!currentCustomer || !currentCustomer.id) { console.error('‚ùå Kein currentCustomer oder ID fehlt'); return }
  
  try {
    const { data, error } = await supabase.from('customers').select('*').eq('id', currentCustomer.id).maybeSingle()
    
    if (error) { 
      console.error('‚ùå Supabase error:', error)
      refreshErrorCount++
      if (refreshErrorCount >= MAX_REFRESH_ERRORS) {
        if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null }
        alert('‚ùå Verbindungsfehler. Bitte neu anmelden.')
        logout()
      }
      return
    }
    
    if (!data) { 
      console.error('‚ùå Kunde nicht mehr in Datenbank')
      if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null }
      alert('‚ö†Ô∏è Dein Account wurde gel√∂scht. Bitte neu registrieren.')
      logout()
      return
    }
    
    refreshErrorCount = 0
    currentCustomer = data
    document.getElementById('app-points').textContent = data.points
    updateRewardButtons(data.points)
    checkWheelAvailability()
    loadWhatsAppStatus()
    loadPendingCodes() // ‚úÖ Auto-Refresh f√ºr "Wartet auf Best√§tigung"
    loadActiveChallenges() // ‚úÖ Auto-Refresh f√ºr Challenges
    loadActiveCoupons() // ‚úÖ FIX 2: Auto-Refresh f√ºr Coupons
    loadGlobalBonuses() // ‚úÖ Auto-Refresh f√ºr Global Bonusse
    safeSetItem('customerData', JSON.stringify(data))
    
  } catch (e) { 
    console.error('‚ùå Refresh error:', e)
    if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null }
    alert('‚ùå Fehler beim Laden. Bitte neu anmelden.')
    logout()
  }
}

function openQRModal() {
  console.log('üîç QR-Modal wird ge√∂ffnet')
  const modal = document.getElementById('qr-modal')
  if (modal) {
    modal.classList.add('active')
    document.body.style.overflow = 'hidden'
    console.log('‚úÖ QR-Modal ge√∂ffnet')
  } else {
    console.error('‚ùå QR-Modal nicht gefunden!')
  }
}

function closeQRModal(event) {
  console.log('üîç QR-Modal wird geschlossen')
  const modal = document.getElementById('qr-modal')
  
  // Wenn kein Event (Button-Click) oder Click auf Hintergrund
  if (!event || event.target.id === 'qr-modal' || event.target.classList.contains('qr-modal-close')) {
    if (modal) {
      modal.classList.remove('active')
      document.body.style.overflow = 'auto'
      console.log('‚úÖ QR-Modal geschlossen')
    }
  }
}

function updateRewardButtons(points) {
  document.getElementById('btn-250').disabled = points < 250
  document.getElementById('btn-500').disabled = points < 500
  document.getElementById('btn-750').disabled = points < 750
  document.getElementById('btn-1000').disabled = points < 1000
  document.getElementById('btn-1250').disabled = points < 1250
}

let redeemInProgress = {}

async function checkWheelAvailability() {
  if (!currentCustomer) return
  
  // Throttle: Verhindere zu h√§ufige Checks
  const now = Date.now()
  if (wheelCheckInProgress || (now - lastWheelCheck < WHEEL_CHECK_COOLDOWN)) {
    return  // Skip wenn Check bereits l√§uft oder zu k√ºrzlich war
  }
  
  wheelCheckInProgress = true
  lastWheelCheck = now
  
  try {
    const { data: unlocks, error } = await supabase
      .from('wheel_unlocks')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('is_used', false)
      .gt('expires_at', new Date().toISOString())
    
    if (error) {
      console.log('‚ö†Ô∏è Wheel check error:', error)
      // Bei Fehler: Wheel ausblenden
      hideWheel()
      return
    }
    
    if (unlocks && unlocks.length > 0) {
      // ‚úÖ KUNDE HAT FREISCHALTUNG - ZEIGE WHEEL!
      showWheel(unlocks.length)
    } else {
      // ‚ùå KEINE FREISCHALTUNG - VERSTECKE WHEEL!
      hideWheel()
    }
  } catch (e) {
    console.log('Wheel error:', e)
    hideWheel()
  } finally {
    wheelCheckInProgress = false
  }
}


function showWheel(count) {
  const section = document.getElementById('wheel-section')
  const badge = document.getElementById('wheel-available-badge')
  // Spin button entfernt - Logo ist jetzt klickbar
  const wheelInfo = document.getElementById('wheel-info')
  const countSpan = document.getElementById('wheel-count')
  
  if (!section) return
  
  section.classList.add('active')  // Macht Sektion sichtbar
  badge.style.display = 'block'
  countSpan.textContent = count
  wheelInfo.style.display = 'none'
  
  // Initialisiere Wheel Canvas
  initWheel()
  
  console.log(`‚úÖ Wheel angezeigt - ${count} Drehung(en) verf√ºgbar`)
}

function hideWheel() {
  const section = document.getElementById('wheel-section')
  if (section) {
    section.classList.remove('active')  // Macht Sektion unsichtbar
    console.log('üîí Wheel versteckt - keine Freischaltung')
  }
}


function initWheel() {
  const canvas = document.getElementById('wheelCanvas')
  if (!canvas) return

  // Logo laden (nur einmal)
  if (!logoImg) {
    logoImg = new Image()
    logoImg.src = '/logo-round-new.png'
    logoImg.onload = () => drawWheel()
  }

  // ‚úÖ Event-Handler nur EINMAL registrieren
  if (!wheelHandlersAttached) {
    // Handler definieren
    wheelClickHandler = (event) => {
      const rect = canvas.getBoundingClientRect()
      const x = event.clientX - rect.left
      const y = event.clientY - rect.top

      const centerX = rect.width / 2
      const centerY = rect.height / 2

      const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2))

      // Nur wenn innerhalb des Logo-Bereichs (Radius 58)
      if (distance <= 58) {
        spinWheel()
      }
    }

    wheelMoveHandler = (event) => {
      const rect = canvas.getBoundingClientRect()
      const x = event.clientX - rect.left
      const y = event.clientY - rect.top

      const centerX = rect.width / 2
      const centerY = rect.height / 2
      const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2))

      canvas.style.cursor = distance <= 58 ? 'pointer' : 'default'
    }
    
    // Handler registrieren
    canvas.addEventListener('click', wheelClickHandler)
    canvas.addEventListener('mousemove', wheelMoveHandler)

    wheelHandlersAttached = true
    console.log('‚úÖ Wheel Event-Handler registriert (einmalig)')
  }

  drawWheel()
}

// Cleanup-Funktion f√ºr Wheel Event Listener
function cleanupWheelHandlers() {
  const canvas = document.getElementById('wheelCanvas')
  if (canvas && wheelHandlersAttached) {
    if (wheelClickHandler) canvas.removeEventListener('click', wheelClickHandler)
    if (wheelMoveHandler) canvas.removeEventListener('mousemove', wheelMoveHandler)
    wheelHandlersAttached = false
    console.log('üßπ Wheel Event-Handler entfernt')
  }
}

function drawWheel() {
  const canvas = document.getElementById('wheelCanvas')
  if (!canvas) return

  const ctx = canvas.getContext('2d')

  // üìê Aktuelle sichtbare Gr√∂√üe des Canvas (in CSS-Pixeln)
  const rect = canvas.getBoundingClientRect()
  const ratio = window.devicePixelRatio || 1

  // Canvas-Aufl√∂sung an Bildschirmdichte anpassen (f√ºr Sch√§rfe)
  const targetWidth = rect.width * ratio
  const targetHeight = rect.height * ratio

  if (canvas.width !== targetWidth || canvas.height !== targetHeight) {
    canvas.width = targetWidth
    canvas.height = targetHeight
  }

  // Zeichenkoordinaten wieder auf CSS-Pixel normalisieren
  ctx.setTransform(ratio, 0, 0, ratio, 0, 0)

  const centerX = rect.width / 2
  const centerY = rect.height / 2
  const radius = rect.width / 2 - 5

  // Canvas in CSS-Einheiten l√∂schen
  ctx.clearRect(0, 0, rect.width, rect.height)

  // üé° Segmente zeichnen
  ctx.save()
  ctx.translate(centerX, centerY)
  ctx.rotate(wheelRotation + WHEEL_OFFSET)

  wheelPrizes.forEach((prize, i) => {
    const startAngle = i * anglePerSegment
    const endAngle = startAngle + anglePerSegment

    ctx.beginPath()
    ctx.moveTo(0, 0)
    ctx.arc(0, 0, radius, startAngle, endAngle)
    ctx.closePath()
    ctx.fillStyle = prize.color
    ctx.fill()

    ctx.save()
    ctx.rotate(startAngle + anglePerSegment / 2)
    ctx.textAlign = 'center'
    ctx.textBaseline = 'middle'
    ctx.fillStyle = prize.textColor

    if (prize.label === 'DREHE NOCHMAL!') {
      ctx.font = 'bold 11px Flame, Arial'
      ctx.fillText('DREHE', radius * 0.68, -8)
      ctx.fillText('NOCHMAL!', radius * 0.68, 8)
    } else {
      ctx.font = 'bold 28px Flame, Arial'
      ctx.fillText(prize.label, radius * 0.7, 0)
    }
    ctx.restore()
  })

  ctx.restore()

  // üßø Logo mittig
  ctx.save()
  ctx.translate(centerX, centerY)

  const logoRadius = 57.3  // Logo-Gr√∂√üe

  // Logo scharf einzeichnen (ohne wei√üen Rahmen)
  if (logoImg && logoImg.complete) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(0, 0, logoRadius, 0, 2 * Math.PI)
    ctx.clip()
    ctx.drawImage(logoImg, -logoRadius, -logoRadius, logoRadius * 2, logoRadius * 2)
    ctx.restore()
  }

  ctx.restore()
}

async function spinWheel() {
  if (isSpinning || !currentCustomer) return
  
  try {
    const { data: unlocks, error } = await supabase
      .from('wheel_unlocks')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('is_used', false)
      .gt('expires_at', new Date().toISOString())
      .limit(1)
    
    if (error || !unlocks || unlocks.length === 0) {
      alert('‚ùå Du hast derzeit keine freie Drehung!')
      return
    }
    
    const unlock = unlocks[0]
    isSpinning = true

    const winningPrize = getRandomPrize()
    const winningIndex = wheelPrizes.indexOf(winningPrize)
    
    const array = new Uint32Array(1)
    crypto.getRandomValues(array)
    const randomOffset = ((array[0] / 0xFFFFFFFF) - 0.5) * 0.6 * anglePerSegment
    
    // WICHTIG: Rotation auf 0 zur√ºcksetzen f√ºr konsistente Startposition
    wheelRotation = 0
    
    // 6-10 volle Drehungen (mehr f√ºr bessere Animation)
    const spins = 6 + Math.floor((array[0] / 0xFFFFFFFF) * 5)
    const baseRotation = spins * 2 * Math.PI
    
    // Berechne Zielfeld
    const fieldMidAngle = winningIndex * anglePerSegment + anglePerSegment / 2 + randomOffset
    const targetRotation = -Math.PI / 2 - WHEEL_OFFSET - fieldMidAngle
    
    // Normalisiere f√ºr positive Rotation
    let normalizedTarget = targetRotation
    while (normalizedTarget < 0) {
      normalizedTarget += 2 * Math.PI
    }
    
    const totalRotation = baseRotation + normalizedTarget

    const startRotation = 0 // Immer von 0 starten
    const startTime = Date.now()
    const duration = 5000 + Math.floor((array[0] / 0xFFFFFFFF) * 1000) // 5-6 Sekunden

    function animate() {
      const elapsed = Date.now() - startTime
      const progress = Math.min(elapsed / duration, 1)
      const easeOut = 1 - Math.pow(1 - progress, 4)
      
      wheelRotation = startRotation + (easeOut * totalRotation)
      drawWheel()

      if (progress < 1) {
        requestAnimationFrame(animate)
      } else {
        isSpinning = false
        
        let normalizedRotation = wheelRotation % (2 * Math.PI)
        if (normalizedRotation > Math.PI) normalizedRotation -= 2 * Math.PI
        if (normalizedRotation < -Math.PI) normalizedRotation += 2 * Math.PI
        
        let fieldAngle = -Math.PI / 2 - normalizedRotation - WHEEL_OFFSET
        if (fieldAngle < 0) fieldAngle += 2 * Math.PI
        
        const fieldIndex = Math.floor(fieldAngle / anglePerSegment) % wheelPrizes.length
        const actualPrize = wheelPrizes[fieldIndex]
        
        console.log('üéØ Gewonnen:', actualPrize.label, actualPrize.type, actualPrize.value)
        
        // Rotation auf 0 zur√ºcksetzen f√ºr n√§chsten Spin
        wheelRotation = 0
        drawWheel()
        
        // Pr√ºfe ob "Spin Again"
        if (actualPrize.type === 'spin_again') {
          showSpinAgainResult()
        } else {
          // Echte Punkte gewonnen
          showWheelResult(actualPrize)
          saveWheelSpin(unlock.id, actualPrize)
          currentWheelUnlockId = null // Reset
        }
      }
    }

    animate()
  } catch (e) {
    console.error('‚ùå Spin error:', e)
    isSpinning = false
  }
}

function showWheelResult(prize) {
  const modal = document.getElementById('wheel-result-modal')
  const icon = document.getElementById('wheel-result-icon')
  const title = document.getElementById('wheel-result-title')
  const prizeText = document.getElementById('wheel-result-prize')

  icon.textContent = '‚≠ê'
  title.textContent = 'Gl√ºckwunsch! üéâ'
  prizeText.textContent = `+${prize.value} Punkte`

  modal.classList.add('active')
}

function showSpinAgainResult() {
  const modal = document.getElementById('wheel-result-modal')
  const icon = document.getElementById('wheel-result-icon')
  const title = document.getElementById('wheel-result-title')
  const prizeText = document.getElementById('wheel-result-prize')

  icon.textContent = 'üîÑ'
  title.textContent = 'Drehe nochmal!'
  prizeText.textContent = 'Du darfst nochmal drehen! üéâ'

  modal.classList.add('active')
  
  // Button-Text √§ndern
  const closeButton = modal.querySelector('button')
  if (closeButton) {
    closeButton.textContent = 'üé∞ Nochmal drehen!'
    closeButton.onclick = () => {
      closeSpinAgainResult()
    }
  }
}

function closeSpinAgainResult() {
  const modal = document.getElementById('wheel-result-modal')
  modal.classList.remove('active')
  
  // Button zur√ºcksetzen
  const closeButton = modal.querySelector('button')
  if (closeButton) {
    closeButton.textContent = 'Weiter'
    closeButton.onclick = closeWheelResult
  }
  
  // Button wieder aktivieren f√ºr n√§chsten Spin
  // Spin button entfernt - Logo ist jetzt klickbar
}

function closeWheelResult() {
  document.getElementById('wheel-result-modal').classList.remove('active')
  // Spin button entfernt - Logo ist jetzt klickbar
  document.getElementById('wheel-info').innerHTML = '‚úÖ Punkte wurden gutgeschrieben!'
  document.getElementById('wheel-info').style.display = 'block'
  document.getElementById('wheel-available-badge').style.display = 'none'
  
  // Refresh customer data
  if (currentCustomer) {
    setTimeout(() => {
      checkWheelAvailability()  // Pr√ºfe ob weitere Drehungen verf√ºgbar
      refreshCustomerData()
    }, 1000)
  }
}

async function saveWheelSpin(unlockId, prize) {
  try {
    // Markiere unlock als verwendet
    const { error: unlockError } = await supabase
      .from('wheel_unlocks')
      .update({ is_used: true })
      .eq('id', unlockId)
    
    if (unlockError) {
      console.error('‚ùå Fehler beim Markieren des Unlocks:', unlockError)
      throw unlockError
    }
    
    // Speichere Spin - mit Ihrem AKTUELLEN Schema
    // Generiere einen KURZEN 4-stelligen Code (varchar(4))
    const prizeCode = Math.random().toString(36).substr(2, 4).toUpperCase()
    
    const { error: spinError } = await supabase.from('wheel_spins').insert({
      customer_id: currentCustomer.id,       // bigint ID
      prize_type: prize.type,                // "points" oder "spin_again" (max 20 Zeichen)
      prize_value: String(prize.value),      // "50" als String (max 100 Zeichen)
      prize_code: prizeCode,                 // 4-stelliger Code: "A3X9"
      prize_points: prize.value,             // 50 als Integer
      is_redeemed: false                     // noch nicht eingel√∂st
      // spun_at: wird automatisch gesetzt (DEFAULT now())
      // created_at: wird automatisch gesetzt (DEFAULT now())
      // expires_at: wird automatisch gesetzt (DEFAULT now() + 30 days)
    })
    
    if (spinError) {
      console.error('‚ùå Fehler beim Speichern des Spins:', spinError)
      throw spinError
    }
    
    // ‚úÖ NUR bei Erfolg UND bei echten Punktgewinnen: Punkte gutschreiben
    if (prize.type === 'points' && prize.value > 0) {
      const newPoints = currentCustomer.points + prize.value
      
      const { error: pointsError } = await supabase
        .from('customers')
        .update({ points: newPoints })
        .eq('id', currentCustomer.id)
      
      if (pointsError) {
        console.error('‚ùå Fehler beim Gutschreiben der Punkte:', pointsError)
        throw pointsError
      }
      
      // ‚úÖ Nach erfolgreichem Punkte-Update: Transaction-Eintrag erstellen
      // Damit der Gewinn im Scanner-Verlauf sichtbar wird
      const { error: transactionError } = await supabase
        .from('transactions')
        .insert({
          customer_id: currentCustomer.id,
          type: 'earn',
          amount: 0,                              // Wheel-Gewinne kosten nichts
          points: prize.value,                    // Gewonnene Punkte
          staff: 'WHEEL',                         // Kennzeichnung f√ºr Scanner-Verlauf
          notes: `Lucky Wheel: ${prize.value}P`   // Beschreibung
        })
      
      if (transactionError) {
        // Transaction-Fehler loggen, aber nicht blockieren (Punkte sind bereits gutgeschrieben)
        console.warn('‚ö†Ô∏è Transaction-Eintrag konnte nicht erstellt werden:', transactionError)
      } else {
        console.log('‚úÖ Transaction-Eintrag f√ºr Wheel-Gewinn erstellt')
      }
      
      // Update local customer object
      currentCustomer.points = newPoints
      document.getElementById('app-points').textContent = newPoints
    }
    
    console.log('‚úÖ Spin gespeichert und Punkte gutgeschrieben!')
  } catch (e) {
    console.error('‚ùå Fehler beim Speichern des Wheel Spins:', e)
    alert('‚ö†Ô∏è Es gab einen Fehler beim Speichern deines Gewinns. Bitte kontaktiere den Support.')
    throw e  // Fehler weitergeben
  }
}

async function loadWhatsAppStatus() {
  if (!currentCustomer || !currentCustomer.id) return
  
  const topContainer = document.getElementById('whatsapp-section-top')
  const bottomContainer = document.getElementById('whatsapp-section-bottom')
  const isOptedIn = currentCustomer.whatsapp_optin === true
  
  if (isOptedIn) {
    // ‚úÖ AKTIVIERT ‚Üí Block wandert NACH UNTEN (unter Pr√§mien)
    topContainer.innerHTML = '' // Oben leeren
    
    const optinDate = currentCustomer.whatsapp_optin_date ? 
      new Date(currentCustomer.whatsapp_optin_date).toLocaleDateString('de-DE') : 'k√ºrzlich'
    
    bottomContainer.innerHTML = `
      <div class="card" style="margin-top: 16px;">
        <div style="background: linear-gradient(135deg, #dcfce7, #d1fae5); border: 2px solid #25D366; border-radius: 12px; padding: 14px; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="font-size: 24px;">‚úÖ</div>
              <div>
                <div style="font-weight: 700; color: #166534; font-size: 15px;">WhatsApp aktiviert</div>
                <div style="font-size: 12px; color: #166534; opacity: 0.8;">Seit ${optinDate}</div>
              </div>
            </div>
          </div>
          <div style="font-size: 13px; color: #166534; margin-bottom: 10px;">
            Du erh√§ltst jetzt exklusive Angebote & Happy Hour Alerts! üéâ
          </div>
          <button onclick="deactivateWhatsApp()" style="background: #6b7280; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%;">
            Deaktivieren
          </button>
        </div>
      </div>
    `
  } else {
    // ‚ùå NICHT AKTIVIERT ‚Üí Block bleibt OBEN (prominent, vor Pr√§mien)
    bottomContainer.innerHTML = '' // Unten leeren
    
    topContainer.innerHTML = `
      <div class="card" style="margin-top: 16px;">
        <h2>üì± WhatsApp-Benachrichtigungen</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
          Erhalte exklusive Angebote, Happy Hour Alerts & Gl√ºcksrad-Erinnerungen direkt per WhatsApp!
        </p>
        
        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="font-size: 32px;">üì±</div>
            <div>
              <div style="font-weight: 700; color: #92400e; font-size: 16px;">Aktiviere WhatsApp</div>
              <div style="font-size: 13px; color: #92400e;">Verpasse keine Angebote mehr!</div>
            </div>
          </div>
          <div style="font-size: 13px; color: #92400e; margin-bottom: 12px;">
            Erhalte:<br>
            ‚Ä¢ üî• Happy Hour Alerts (2x Punkte!)<br>
            ‚Ä¢ üé° Gl√ºcksrad-Erinnerungen<br>
            ‚Ä¢ üéØ Challenge-Updates<br>
            ‚Ä¢ üéÅ Exklusive Deals
          </div>
          <button onclick="activateWhatsApp()" style="background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; padding: 12px 16px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%;">
            üì± Jetzt aktivieren
          </button>
        </div>
        <div style="font-size: 11px; color: #666; text-align: center; padding: 8px;">
          Datenschutz: Deine Nummer wird nur f√ºr Angebote genutzt. Abmeldung jederzeit m√∂glich.
        </div>
      </div>
    `
  }
}

async function activateWhatsApp() {
  if (!currentCustomer || !currentCustomer.phone) {
    alert('‚ùå Fehler: Kundendaten nicht geladen')
    return
  }
  
  const phone = currentCustomer.phone
  const name = currentCustomer.name
  
  // WhatsApp Opt-In Text (NICHT encoden - Backend macht das!)
  const message = 
    `Hallo D√∂ner Boxx Team! üëã\n\n` +
    `Ich m√∂chte exklusive Angebote, Happy Hour Alerts und Gl√ºcksrad-Erinnerungen per WhatsApp erhalten.\n\n` +
    `Name: ${name}\n` +
    `Telefon: ${phone}\n\n` +
    `Mit dieser Nachricht best√§tige ich meine Einwilligung.\n\n` +
    `üì± Abmeldung jederzeit √ºber dein Kundenkonto m√∂glich`
  
  try {
    // ‚úÖ SICHERHEIT: WhatsApp URL √ºber Edge Function holen
    // Nummer ist NICHT mehr im Frontend sichtbar!
    const { data: urlData, error: urlError } = await supabase.functions.invoke('get-whatsapp-url', {
      body: { message }
    })
    
    if (urlError || !urlData?.url) {
      throw new Error('WhatsApp URL konnte nicht erstellt werden')
    }
    
    const waUrl = urlData.url
  
    // In Datenbank als "wartet auf Best√§tigung" markieren
    const { error } = await supabase
      .from('customers')
      .update({ 
        whatsapp_optin: true,
        whatsapp_optin_date: new Date().toISOString()
      })
      .eq('id', currentCustomer.id)
    
    if (error) throw error
    
    // Update lokales Objekt
    currentCustomer.whatsapp_optin = true
    currentCustomer.whatsapp_optin_date = new Date().toISOString()
    
    // UI aktualisieren
    loadWhatsAppStatus()
    
    // WhatsApp √∂ffnen
    window.open(waUrl, '_blank')
    
  } catch (e) {
    console.error('WhatsApp activation error:', e)
    alert('‚ùå Fehler beim Aktivieren: ' + e.message)
  }
}

async function deactivateWhatsApp() {
  if (!confirm('M√∂chtest du WhatsApp-Benachrichtigungen wirklich deaktivieren?\n\nDu verpasst dann exklusive Angebote und Happy Hour Alerts! üò¢')) {
    return
  }
  
  try {
    const { error } = await supabase
      .from('customers')
      .update({ 
        whatsapp_optin: false,
        whatsapp_optout_date: new Date().toISOString()
      })
      .eq('id', currentCustomer.id)
    
    if (error) throw error
    
    // Update lokales Objekt
    currentCustomer.whatsapp_optin = false
    currentCustomer.whatsapp_optout_date = new Date().toISOString()
    
    // UI aktualisieren
    loadWhatsAppStatus()
    
    alert('‚úÖ WhatsApp-Benachrichtigungen wurden deaktiviert.')
    
  } catch (e) {
    console.error('WhatsApp deactivation error:', e)
    alert('‚ùå Fehler beim Deaktivieren: ' + e.message)
  }
}

async function redeem(rewardName, cost) {
  if (!currentCustomer || currentCustomer.points < cost) {
    alert('‚ùå Nicht genug Punkte!')
    return
  }
  
  if (redeemInProgress['any']) {
    console.log('‚è≥ Einl√∂sung bereits in Bearbeitung...')
    return
  }
  
  try {
    redeemInProgress['any'] = true
    
    const btn = document.getElementById(`btn-${cost}`)
    if (btn) {
      btn.disabled = true
      btn.textContent = '‚è≥ Wird erstellt...'
    }
    
    const { data: existingCodes } = await supabase
      .from('redeem_codes')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('used', false)
    
    if (existingCodes && existingCodes.length > 0) {
      alert(`‚ùå Du hast bereits wartende Codes! Bitte l√∂se sie zuerst ein.`)
      throw new Error('Existing pending codes')
    }
    
    const code = await generateUniqueCode('redeem_codes', 'code')
    const expires = new Date(Date.now() + 24*60*60*1000)
    
    const { error: insertError } = await supabase
      .from('redeem_codes')
      .insert({ 
        code, 
        customer_id: currentCustomer.id, 
        reward_name: rewardName, 
        points_cost: cost, 
        valid_until: expires.toISOString(), 
        used: false 
      })
    
    if (insertError) throw insertError
    
    if (btn) btn.textContent = '‚úÖ Code erstellt!'
    
    await loadPendingCodes()
    await refreshCustomerData()
    
    setTimeout(() => {
      if (btn) {
        btn.disabled = false
        btn.textContent = 'Einl√∂sen'
      }
      redeemInProgress['any'] = false
    }, 2000)
    
  } catch (e) {
    console.error('‚ùå Redeem error:', e)
    const btn = document.getElementById(`btn-${cost}`)
    if (btn) {
      btn.disabled = false
      btn.textContent = 'Einl√∂sen'
    }
    redeemInProgress['any'] = false
    if (e.message !== 'Existing pending codes') {
      alert('‚ùå Fehler beim Erstellen des Codes.')
    }
  }
}

async function loadPendingCodes() {
  if (!currentCustomer) return
  try {
    const { data, error } = await supabase.from('redeem_codes').select('*').eq('customer_id', currentCustomer.id).eq('used', false).order('created_at', { ascending: false })
    if (error) throw error
    const section = document.getElementById('pending-section')
    const list = document.getElementById('pending-list')
    if (!data || data.length === 0) { section.style.display = 'none'; return }
    section.style.display = 'block'
    list.innerHTML = data.map(item => {
      const expires = new Date(item.valid_until).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
      return `<div class="pending-code"><h3>üéÅ ${item.reward_name}</h3><div class="code">${item.code}</div><div class="code-info">G√ºltig bis: ${expires}<br>Kosten: ${item.points_cost} Punkte</div><button class="small" style="background: #ef4444;" onclick="cancelCode('${item.code}')">üóëÔ∏è Stornieren</button></div>`
    }).join('')
  } catch (e) { console.error('Load pending error:', e) }
}

async function loadActiveChallenges() {
  if (!currentCustomer) return
  try {
    const now = new Date().toISOString().split('T')[0]
    
    // Hole aktive Challenges
    const { data: challenges, error: challengeError } = await supabase
      .from('challenges')
      .select('*')
      .eq('is_active', true)
      .lte('start_date', now)
      .gte('end_date', now)
    
    if (challengeError) throw challengeError
    
    const section = document.getElementById('challenge-section')
    const list = document.getElementById('challenge-list')
    
    if (!challenges || challenges.length === 0) {
      section.style.display = 'none'
      return
    }
    
    // Hole Progress f√ºr Kunden
    const { data: progress, error: progressError } = await supabase
      .from('challenge_progress')
      .select('*')
      .eq('customer_id', currentCustomer.id)
    
    if (progressError) throw progressError
    
    section.style.display = 'block'
    
    // ‚úÖ FIX: Filtere abgeschlossene Challenges raus
    const activeChallengesForUser = challenges.filter(challenge => {
      const userProgress = progress?.find(p => p.challenge_id === challenge.id)
      const isCompleted = userProgress?.is_completed || false
      return !isCompleted // Nur nicht-abgeschlossene anzeigen
    })
    
    // Wenn alle Challenges abgeschlossen sind, verstecke Section
    if (activeChallengesForUser.length === 0) {
      section.style.display = 'none'
      return
    }
    
    list.innerHTML = activeChallengesForUser.map(challenge => {
      const userProgress = progress?.find(p => p.challenge_id === challenge.id)
      const completed = userProgress?.completed_orders || 0
      const percentage = Math.min((completed / challenge.required_orders) * 100, 100)
      
      const endDate = new Date(challenge.end_date).toLocaleDateString('de-DE')
      
      return `
        <div class="challenge-card" style="border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: #fef3c7;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; color: #1f2937;">üéØ ${challenge.bonus_points} Punkte Challenge</h3>
          </div>
          <p style="margin: 8px 0; color: #4b5563; font-size: 14px;">
            ${challenge.required_orders} Bestellungen ab ${challenge.min_order_amount.toFixed(2)}‚Ç¨
          </p>
          <div style="margin: 12px 0;">
            <div style="background: #e5e7eb; border-radius: 8px; height: 24px; overflow: hidden;">
              <div style="background: #f59e0b; height: 100%; width: ${percentage}%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;">
                ${completed}/${challenge.required_orders}
              </div>
            </div>
          </div>
          <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 12px;">
            üìÖ G√ºltig bis: ${endDate}
          </p>
        </div>
      `
    }).join('')
  } catch (e) {
    console.error('Load challenges error:', e)
  }
}

async function cancelCode(code) {
  if (!confirm('Code wirklich stornieren?')) return
  try { await supabase.from('redeem_codes').delete().eq('code', code).eq('used', false); loadPendingCodes() } catch (e) { console.error('Cancel error:', e) }
}

function logout() {
  console.log('üö™ Logout - Resette alles...')
  
  // ‚ö° KRITISCH: LocalStorage SOFORT l√∂schen (BEVOR irgendetwas anderes)
  currentCustomer = null
  safeRemoveItem('customerData')
  console.log('‚úÖ LocalStorage gel√∂scht')
  
  // 1. Intervalle stoppen
  if (refreshInterval) {
    clearInterval(refreshInterval)
    refreshInterval = null
  }
  refreshErrorCount = 0
  
  // 1b. Event Listener aufr√§umen
  cleanupWheelHandlers()
  
  // 2. Alle Screens verstecken und zu Start-Screen wechseln
  console.log('üîÑ Wechsel zu Start-Screen...')
  showScreen('start')  // ‚úÖ Nutzt die zentrale showScreen() Funktion
  
  // 4. ALLE Modals schlie√üen (NUR mit Klassen - kein inline display!)
  const modals = [
    'customizeModal',
    'cartModal',
    'checkoutModal',
    'successModal',
    'qr-modal'
  ]
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId)
    if (modal) {
      modal.classList.remove('active')
      modal.style.display = ''  // ‚úÖ Inline-Style ENTFERNEN statt setzen
    }
  })
  
  // 4b. order-section ist KEIN normales Modal - explizit schlie√üen
  const orderSection = document.getElementById('order-section')
  if (orderSection) {
    orderSection.style.display = 'none'  // ‚úÖ Muss explizit none sein
  }
  
  // 5. Warenkorb leeren
  cart = []
  updateCart()
  
  // 6. Resette Input-Felder
  const inputs = [
    'reg-name',
    'reg-phone',
    'login-phone',
    'checkout-name',
    'checkout-phone',
    'checkout-notes'
  ]
  inputs.forEach(inputId => {
    const input = document.getElementById(inputId)
    if (input) input.value = ''
  })
  
  // 7. Resette Result-Divs
  const results = [
    'reg-result',
    'login-result'
  ]
  results.forEach(resultId => {
    const result = document.getElementById(resultId)
    if (result) {
      result.className = ''
      result.innerHTML = ''
    }
  })
  
  // 8. Kategorien-Status zur√ºcksetzen
  openCategories = []
  
  // 9. Scrolle nach oben
  window.scrollTo(0, 0)
  
  console.log('‚úÖ Logout komplett - Start-Screen aktiv')
}

window.onload = () => {
  console.log('üöÄ Seite geladen - Pr√ºfe gespeicherte Kundendaten...')
  
  const stored = safeGetItem('customerData')
  
  if (!stored) {
    console.log('‚ÑπÔ∏è Keine gespeicherten Kundendaten - zeige Start-Screen')
    // Stelle sicher dass Start-Screen angezeigt wird
    showScreen('start')
    return
  }
  
  try {
    const customer = JSON.parse(stored)
    
    // Validierung: Pr√ºfe ob Kundendaten vollst√§ndig sind
    if (!customer || !customer.id || !customer.qr_id) {
      console.warn('‚ö†Ô∏è Unvollst√§ndige Kundendaten - l√∂sche und zeige Start-Screen')
      safeRemoveItem('customerData')
      showScreen('start')
      return
    }
    
    console.log('‚úÖ G√ºltige Kundendaten gefunden - lade Kunde:', customer.name)
    loadCustomer(customer)
    
  } catch (e) { 
    console.error('‚ùå Fehler beim Laden der Kundendaten:', e)
    safeRemoveItem('customerData')
    showScreen('start')
  }
}

const products = [
  {
    id: 'doener',
    name: 'D√∂ner',
    price: 6.00,
    description: 'Klassischer D√∂ner im Fladenbrot',
    defaultSauce: 2, // 2x Knoblauch
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'doener-xl',
    name: 'D√∂ner XL',
    price: 8.00,
    description: 'Extra gro√üer D√∂ner f√ºr gro√üen Hunger',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      kaese: { label: 'K√§se', choices: [0, 1], default: 0 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'doener-box',
    name: 'D√∂ner Box',
    price: 7.00,
    description: 'D√∂nerfleisch mit Pommes in der Box',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'dueruem',
    name: 'D√ºr√ºm D√∂ner',
    price: 7.00,
    description: 'D√∂ner gerollt im d√ºnnen Fladenbrot',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'lahmacun',
    name: 'Lahmacun',
    price: 4.00,
    description: 'T√ºrkische Pizza',
    defaultSauce: 2,
    options: {
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'lahmacun-spezial',
    name: 'Lahmacun Spezial',
    price: 8.00,
    description: 'Lahmacun mit D√∂nerfleisch',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'doener-teller',
    name: 'D√∂ner Teller',
    price: 10.00,
    description: 'D√∂nerfleisch mit Pommes und Salat auf dem Teller',
    defaultSauce: 2,
    options: {
      fleisch: { label: 'D√∂nerfleisch', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraFleisch', name: 'Extra D√∂nerfleisch (60g)', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'rindswurst-broetchen',
    name: 'Rindswurst im Br√∂tchen',
    price: 3.50,
    description: 'Gegrillte Rindswurst im frischen Br√∂tchen',
    options: {
      ketchup: { label: 'Ketchup', choices: [0, 1], default: 1 }
    },
    extras: []
  },
  {
    id: 'curry-rindswurst',
    name: 'Curry Rindswurst mit Pommes',
    price: 6.90,
    description: 'Currywurst mit knusprigen Pommes',
    options: {
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      currysauce: { label: 'Currysauce', choices: [0, 1], default: 1 },
      mayo: { label: 'Mayonnaise', choices: [0, 1], default: 0 }
    },
    extras: []
  },
  {
    id: 'koefte-brot',
    name: 'K√∂fte im Brot (5 Stk.)',
    price: 6.00,
    description: 'Gegrillte Hackfleischb√§llchen im Fladenbrot',
    defaultSauce: 2,
    options: {
      koefte: { label: 'K√∂fte', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraKoefte', name: 'Extra K√∂fte', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'koefte-teller',
    name: 'K√∂fte Teller (7 Stk.)',
    price: 11.00,
    description: 'Gegrillte Hackfleischb√§llchen mit Pommes und Salat',
    defaultSauce: 2,
    options: {
      koefte: { label: 'K√∂fte', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      knoblauch: { label: 'Knoblauchsauce', choices: [0, 1, 2], default: 2 },
      scharf: { label: 'Scharfe Sauce', choices: [0, 1, 2], default: 0 },
      weiss: { label: 'Wei√ükraut', choices: [0, 1], default: 1 },
      rot: { label: 'Rotkraut', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 },
      zwiebel: { label: 'Zwiebel', choices: [0, 1], default: 1 }
    },
    extras: [
      { id: 'extraKoefte', name: 'Extra K√∂fte', price: 2.00 },
      { id: 'extraKaese', name: 'Extra K√§se', price: 1.00 },
      { id: 'extraKnoblauch', name: 'Extra Knoblauchsauce', price: 0.70 },
      { id: 'extraScharf', name: 'Extra Scharfe Sauce', price: 0.70 },
      { id: 'extraScharfPulver', name: 'Scharf (Pulver)', price: 0.00 }
    ]
  },
  {
    id: 'chicken-nuggets',
    name: 'Chicken Nuggets (6 Stk.)',
    price: 6.00,
    description: 'Knusprige Chicken Nuggets mit Pommes',
    options: {
      nuggets: { label: 'Chicken Nuggets', choices: [0, 1], default: 1 },
      pommes: { label: 'Pommes', choices: [0, 1], default: 1 },
      ketchup: { label: 'Ketchup', choices: [0, 1], default: 1 },
      mayo: { label: 'Mayonnaise', choices: [0, 1], default: 0 }
    },
    extras: [
      { id: 'extraNuggets', name: 'Extra Nuggets (3 Stk.)', price: 2.00 }
    ]
  },
  {
    id: 'crispy-chicken-burger',
    name: 'Crispy Chicken Burger',
    price: 4.00,
    description: 'Knuspriger Chicken Burger',
    options: {
      mayo: { label: 'Mayonnaise', choices: [0, 1], default: 1 },
      salat: { label: 'Eisbergsalat', choices: [0, 1], default: 1 },
      tomate: { label: 'Tomate', choices: [0, 1], default: 1 }
    },
    extras: []
  },
  {
    id: 'pommes',
    name: 'Pommes',
    price: 3.50,
    description: 'Knusprige Pommes Frites',
    options: {
      sauce: { label: 'Sauce', choices: ['Ohne', 'Ketchup', 'Mayonnaise'], default: 'Ketchup' }
    },
    extras: [
      { id: 'extraKetchup', name: 'Extra Ketchup', price: 0.30 },
      { id: 'extraMayo', name: 'Extra Mayonnaise', price: 0.30 }
    ]
  },
  {
    id: 'ayran',
    name: 'Ayran (0,25 l)',
    price: 1.50,
    description: 'Erfrischendes t√ºrkisches Joghurtgetr√§nk',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'wasser',
    name: 'Wasser still (0,5 l)',
    price: 1.50,
    description: 'Stilles Mineralwasser (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'cola',
    name: 'Cola (0,33 l)',
    price: 2.00,
    description: 'Coca Cola (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'fanta',
    name: 'Fanta (0,33 l)',
    price: 2.00,
    description: 'Fanta Orange (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  },
  {
    id: 'cola-zero',
    name: 'Cola Zero (0,33 l)',
    price: 2.00,
    description: 'Coca Cola Zero (inkl. Pfand)',
    vatRate: 19,
    options: {},
    extras: []
  }
]

let cart = []
let currentProduct = null
let currentCustomization = {}
let selectedPayment = null
let selectedPickupTime = 'now'
let selectedPickupTimeValue = null

function openOrderModal() {
  if (!currentCustomer) {
    alert('‚ùå Bitte melde dich erst an!')
    return
  }
  
  document.getElementById('order-section').style.display = 'block'
  document.getElementById('screen-app').style.display = 'none'
  document.body.style.overflow = 'auto'
  window.scrollTo(0, 0)
  
  renderProducts()
}

function closeOrderModal() {
  document.getElementById('order-section').style.display = 'none'
  document.getElementById('screen-app').style.display = 'block'
  window.scrollTo(0, 0)
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üéüÔ∏è COUPON SYSTEM - FIX 2 & 4
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeCoupons = []
let previousCoupons = [] // ‚úÖ NEU: Speichere vorherige Coupons zum Vergleich
let openCategories = [] // ‚úÖ FIX 1: Speichere welche Kategorien offen sind

async function loadActiveCoupons() {
  try {
    const now = new Date()
    const todayStr = now.toISOString().split('T')[0]
    
    const { data: coupons, error } = await supabase
      .from('coupons')
      .select('*')
      .eq('is_active', true)
      .lte('start_date', todayStr)
      .gte('end_date', todayStr)
    
    if (error) throw error
    
    // ‚úÖ NEU: Pr√ºfe ob sich Coupons ge√§ndert haben
    const couponsChanged = JSON.stringify(previousCoupons) !== JSON.stringify(coupons)
    
    activeCoupons = coupons || []
    previousCoupons = coupons || []
    
    console.log('‚úÖ Aktive Coupons geladen:', activeCoupons.length)
    
    // ‚úÖ NEU: Rendere nur neu, wenn sich Coupons ge√§ndert haben
    if (couponsChanged) {
      console.log('üîÑ Coupons haben sich ge√§ndert - rendere neu')
      renderProducts()
    } else {
      console.log('‚úÖ Coupons unver√§ndert - kein Re-Render n√∂tig')
    }
    
  } catch (e) {
    console.error('‚ùå Fehler beim Laden von Coupons:', e)
    activeCoupons = []
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üåü GLOBALE BONUSSE LADEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadGlobalBonuses() {
  try {
    const now = new Date()
    const todayStr = now.toISOString().split('T')[0]
    
    // Lade aktive globale Bonusse
    const { data: bonuses, error } = await supabase
      .from('global_bonuses')
      .select('*')
      .eq('is_active', true)
      .lte('start_date', todayStr)
      .gte('end_date', todayStr)
    
    if (error) throw error
    
    if (!bonuses || bonuses.length === 0) {
      document.getElementById('globalBonusSection').style.display = 'none'
      console.log('‚ÑπÔ∏è Keine aktiven Global Bonusse')
      return
    }
    
    console.log('‚úÖ Aktive Global Bonusse geladen:', bonuses.length)
    
    // Pr√ºfe welche der Kunde bereits aktiviert hat
    const { data: activated, error: activatedError } = await supabase
      .from('activated_global_bonuses')
      .select('*')
      .eq('customer_id', currentCustomer.id)
    
    if (activatedError) throw activatedError
    
    const activatedIds = activated ? activated.map(a => a.global_bonus_id) : []
    console.log('üìã Aktivierte Boni (noch nicht eingel√∂st):', activatedIds)
    
    // ‚úÖ NEU: Lade Historie der bereits eingel√∂sten Boni f√ºr diesen Kunden
    // Ein Kunde darf jeden global_bonus nur EINMAL einl√∂sen (pro bonus_id, nicht pro Tag!)
    const { data: usedHistory, error: historyError } = await supabase
      .from('used_global_bonuses_history')
      .select('*')
      .eq('customer_id', currentCustomer.id)
    
    if (historyError) {
      console.error('‚ùå Fehler beim Laden der Historie:', historyError)
      throw historyError
    }
    
    console.log('üìú Raw Historie-Daten:', usedHistory)
    
    // IDs der bereits eingel√∂sten Boni sammeln
    const usedBonusIds = usedHistory ? usedHistory.map(h => h.global_bonus_id) : []
    console.log('‚ÑπÔ∏è Bereits eingel√∂ste Boni:', usedBonusIds.length, usedBonusIds)
    
    // Filtere Boni: Zeige nur solche an, die NICHT bereits eingel√∂st wurden
    const availableBonuses = bonuses.filter(bonus => {
      const isUsed = usedBonusIds.includes(bonus.id)
      console.log(`üîç Bonus ${bonus.id}:`, isUsed ? '‚ùå Bereits eingel√∂st' : '‚úÖ Verf√ºgbar')
      return !isUsed
    })
    
    console.log('‚ú® Verf√ºgbare Boni nach Filter:', availableBonuses.length)
    
    // Wenn keine verf√ºgbaren Boni √ºbrig sind, verstecke die Sektion
    if (availableBonuses.length === 0 && activatedIds.length === 0) {
      document.getElementById('globalBonusSection').style.display = 'none'
      console.log('‚ÑπÔ∏è Alle Boni wurden bereits eingel√∂st - Sektion versteckt')
      return
    }
    
    // Rendere Bonusse
    const section = document.getElementById('globalBonusSection')
    const list = document.getElementById('globalBonusList')
    
    list.innerHTML = availableBonuses.map(bonus => {
      const isActivated = activatedIds.includes(bonus.id)
      const bonusText = bonus.bonus_type === 'double_points' 
        ? 'üî• Doppelte Punkte!' 
        : `üí∞ +${bonus.bonus_amount} Bonus-Punkte`
      
      if (isActivated) {
        // ‚úÖ AKTIVER BONUS: Wurde aktiviert, aber noch nicht eingel√∂st
        return `
          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;">‚úÖ AKTIV</span>
              <span style="font-size: 12px; color: #92400e;">G√ºltig bis ${new Date(bonus.end_date).toLocaleDateString('de-DE')}</span>
            </div>
            <div style="font-size: 20px; font-weight: 700; color: #E31E24; margin: 8px 0;">${bonusText}</div>
            <p style="font-size: 13px; color: #92400e; margin: 8px 0;">Bei deiner n√§chsten Bestellung einl√∂sbar!</p>
          </div>
        `
      } else {
        // ‚≠ê VERF√úGBARER BONUS: Nicht aktiviert, nicht eingel√∂st
        return `
          <div style="background: linear-gradient(135deg, #fff, #f9fafb); border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 12px; color: #666;">G√ºltig bis ${new Date(bonus.end_date).toLocaleDateString('de-DE')}</span>
            </div>
            <div style="font-size: 20px; font-weight: 700; color: #E31E24; margin: 8px 0;">${bonusText}</div>
            <p style="font-size: 13px; color: #666; margin: 8px 0 12px 0;">Aktiviere diesen Bonus f√ºr deine n√§chste Bestellung!</p>
            <button onclick="activateGlobalBonus('${bonus.id}')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              ‚≠ê Jetzt aktivieren
            </button>
          </div>
        `
      }
    }).join('')
    
    section.style.display = 'block'
    
  } catch (e) {
    console.error('‚ùå Fehler beim Laden von Global Bonussen:', e)
    document.getElementById('globalBonusSection').style.display = 'none'
  }
}

async function activateGlobalBonus(bonusId) {
  try {
    // Pr√ºfe ob Kunde bereits einen aktiven Bonus hat (keine is_used Pr√ºfung mehr n√∂tig)
    const { data: existing, error: checkError } = await supabase
      .from('activated_global_bonuses')
      .select('*')
      .eq('customer_id', currentCustomer.id)
    
    if (checkError) throw checkError
    
    if (existing && existing.length > 0) {
      alert('‚ö†Ô∏è Du hast bereits einen aktiven Bonus!\n\nBitte l√∂se ihn erst bei deiner n√§chsten Bestellung ein, bevor du einen neuen aktivierst.')
      return
    }
    
    // Aktiviere Bonus
    const { error: insertError } = await supabase
      .from('activated_global_bonuses')
      .insert({
        customer_id: currentCustomer.id,
        global_bonus_id: bonusId,
        is_used: false
      })
    
    if (insertError) throw insertError
    
    console.log('‚úÖ Bonus aktiviert!')
    
    // Neu laden
    loadGlobalBonuses()
    
  } catch (e) {
    console.error('‚ùå Fehler beim Aktivieren:', e)
    alert('‚ùå Fehler: ' + e.message)
  }
}

// ‚úÖ FIX 4: Finde Coupon-Preis f√ºr Produkt
function getCouponPrice(productName) {
  const coupon = activeCoupons.find(c => {
    // ‚úÖ FIX: NUR exakte √úbereinstimmung (case-insensitive)
    const couponProduct = c.product.toLowerCase().trim()
    const checkName = productName.toLowerCase().trim()
    
    console.log(`üîç Vergleiche: Coupon"${couponProduct}" === Produkt"${checkName}"? ${couponProduct === checkName}`)
    
    // NUR exakte √úbereinstimmung!
    return couponProduct === checkName
  })
  
  if (coupon && coupon.price) {
    // Parse Preis aus String wie "5.00 ‚Ç¨" oder "5,00 ‚Ç¨"
    const priceStr = coupon.price.toString().replace('‚Ç¨', '').replace(',', '.').trim()
    const price = parseFloat(priceStr)
    if (!isNaN(price)) {
      console.log(`‚úÖ Coupon gefunden f√ºr "${productName}": ${price}‚Ç¨ (Original: ${products.find(p => p.name === productName)?.price}‚Ç¨)`)
      return price
    }
  }
  
  return null
}

function renderProducts() {
  const container = document.getElementById('products')
  
  // ‚úÖ NEU: Lese aktuellen Zustand aus DOM aus, BEVOR wir neu rendern
  // Damit bleiben ge√∂ffnete Kategorien beim Refresh offen!
  for (let i = 0; i < 7; i++) {
    const categoryContent = document.getElementById(`category-${i}`)
    if (categoryContent) {
      openCategories[i] = categoryContent.classList.contains('open')
    }
  }
  
  const categories = [
    {
      name: 'üåØ D√∂ner & D√ºr√ºm',
      ids: ['doener', 'doener-xl', 'dueruem', 'doener-box', 'doener-teller'],
      open: openCategories[0] !== undefined ? openCategories[0] : true // ‚úÖ FIX 1: Nutze gespeicherten Status
    },
    {
      name: 'ü•ô Lahmacun',
      ids: ['lahmacun', 'lahmacun-spezial'],
      open: openCategories[1] !== undefined ? openCategories[1] : false // ‚úÖ FIX 1: Nutze gespeicherten Status
    },
    {
      name: 'üçñ K√∂fte',
      ids: ['koefte-brot', 'koefte-teller'],
      open: openCategories[2] !== undefined ? openCategories[2] : false // ‚úÖ FIX 1
    },
    {
      name: 'üå≠ Wurst',
      ids: ['rindswurst-broetchen', 'curry-rindswurst'],
      open: openCategories[3] !== undefined ? openCategories[3] : false // ‚úÖ FIX 1
    },
    {
      name: 'üçó Chicken',
      ids: ['chicken-nuggets', 'crispy-chicken-burger'],
      open: openCategories[4] !== undefined ? openCategories[4] : false // ‚úÖ FIX 1
    },
    {
      name: 'üçü Beilagen',
      ids: ['pommes'],
      open: openCategories[5] !== undefined ? openCategories[5] : false // ‚úÖ FIX 1
    },
    {
      name: 'ü•§ Getr√§nke',
      ids: ['ayran', 'wasser', 'cola', 'fanta', 'cola-zero'],
      open: openCategories[6] !== undefined ? openCategories[6] : false // ‚úÖ FIX 1
    }
  ]
  
  let html = ''
  
  categories.forEach((category, index) => {
    const categoryProducts = products.filter(p => category.ids.includes(p.id))
    if (categoryProducts.length === 0) return
    
    html += `
      <div class="category-section">
        <div class="category-header" onclick="toggleCategory(${index})">
          <h3 class="category-title">
            ${category.name}
            <span class="category-count">(${categoryProducts.length})</span>
          </h3>
          <span class="category-arrow" id="arrow-${index}">
            ${category.open ? '‚ñº' : '‚ñ∂'}
          </span>
        </div>
        <div class="category-content ${category.open ? 'open' : ''}" id="category-${index}">
          ${categoryProducts.map(product => {
            const hasOptions = Object.keys(product.options).length > 0 || product.extras.length > 0
            const buttonText = hasOptions ? 'Anpassen & Bestellen' : 'In den Warenkorb'
            
            // ‚úÖ FIX 4: Check for coupon price
            const couponPrice = getCouponPrice(product.name)
            const finalPrice = couponPrice !== null ? couponPrice : product.price
            const hasCoupon = couponPrice !== null
            
            return `
              <div class="product-card" onclick="openCustomize('${product.id}')">
                <div class="product-header">
                  <div class="product-name">${product.name}</div>
                  <div class="product-price">
                    ${hasCoupon ? `<span style="text-decoration: line-through; color: #999; font-size: 14px;">${formatPrice(product.price)}</span> ` : ''}
                    <span style="${hasCoupon ? 'color: #E31E24; font-weight: 700;' : ''}">${formatPrice(finalPrice)}</span>
                    ${hasCoupon ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 6px; font-weight: 600;">üéüÔ∏è Deal</span>' : ''}
                  </div>
                </div>
                <div class="product-desc">${product.description}</div>
                <button class="add-btn" onclick="openCustomizeFromButton(this, '${product.id}')">
                  ${buttonText}
                </button>
              </div>
            `
          }).join('')}
        </div>
      </div>
    `
  })
  
  // ‚úÖ SICHERHEIT: Sanitize HTML mit onclick-Support
  // SAFE_FOR_TEMPLATES erlaubt onclick, solange kein JavaScript:-Protokoll verwendet wird
  container.innerHTML = DOMPurify.sanitize(html, {
    ADD_ATTR: ['onclick'], // Erlaube onclick-Attribute
    ALLOW_UNKNOWN_PROTOCOLS: false // Blockiere javascript: URLs
  })
}

function toggleCategory(index) {
  const content = document.getElementById(`category-${index}`)
  const arrow = document.getElementById(`arrow-${index}`)
  
  if (content.classList.contains('open')) {
    content.classList.remove('open')
    arrow.textContent = '‚ñ∂'
    openCategories[index] = false // ‚úÖ FIX 1: Speichere Status
  } else {
    content.classList.add('open')
    arrow.textContent = '‚ñº'
    openCategories[index] = true // ‚úÖ FIX 1: Speichere Status
  }
}

function openCustomizeFromButton(button, productId) {
  // Stop event from bubbling to parent card
  if (window.event) {
    window.event.cancelBubble = true
    if (window.event.stopPropagation) {
      window.event.stopPropagation()
    }
  }
  
  console.log('üü¢ Button clicked for product:', productId)
  openCustomize(productId)
}

function handleProductClick(event, productId) {
  if (event && event.stopPropagation) {
    event.stopPropagation()
  }
  openCustomize(productId)
}

function openCustomize(productId) {
  console.log('üîµ openCustomize called with productId:', productId)
  console.log('üîç Event object:', event)  // Debug: check if event exists
  
  try {
    // Pr√ºfe ob products existiert
    if (!products || products.length === 0) {
      console.error('‚ùå Products array ist leer oder undefined!')
      alert('Fehler: Produkte nicht geladen. Bitte Seite neu laden.')
      return
    }
    
    // Finde Produkt
    currentProduct = products.find(p => p.id === productId)
    
    if (!currentProduct) {
      console.error('‚ùå Produkt nicht gefunden:', productId)
      console.log('üìã Verf√ºgbare Produkt-IDs:', products.map(p => p.id))
      alert('Fehler: Produkt nicht gefunden. ProductId: ' + productId)
      return
    }
    
    console.log('‚úÖ Produkt gefunden:', currentProduct.name)
    
    // Initialisiere Customization
    currentCustomization = {
      product: currentProduct,
      options: {},
      extras: []
    }
    
    // Setze Default-Optionen
    Object.keys(currentProduct.options).forEach(key => {
      currentCustomization.options[key] = currentProduct.options[key].default
    })
    
    console.log('‚úÖ Customization initialisiert:', currentCustomization)
    
    // Wenn keine Optionen/Extras, direkt in Warenkorb
    if (Object.keys(currentProduct.options).length === 0 && currentProduct.extras.length === 0) {
      console.log('‚ÑπÔ∏è Keine Optionen, f√ºge direkt zum Warenkorb hinzu')
      addToCart()
      return
    }
    
    // Pr√ºfe ob Modal existiert
    const modal = document.getElementById('customizeModal')
    if (!modal) {
      console.error('‚ùå customizeModal Element nicht gefunden!')
      alert('Fehler: Modal nicht gefunden. Bitte Seite neu laden.')
      return
    }
    
    console.log('‚úÖ Modal gefunden, rendere...')
    renderCustomizeModal()
    
    console.log('‚úÖ √ñffne Modal...')
    modal.classList.add('active')
    
    console.log('üéâ Modal erfolgreich ge√∂ffnet!')
    
  } catch (error) {
    console.error('‚ùå Fehler in openCustomize:', error)
    console.error('‚ùå Stack:', error.stack)
    alert('Fehler beim √ñffnen: ' + error.message)
  }
}

function closeCustomizeModal() {
  document.getElementById('customizeModal').classList.remove('active')
  currentProduct = null
  currentCustomization = {}
}

function renderCustomizeModal() {
  document.getElementById('modalTitle').textContent = currentProduct.name
  
  let html = ''
  
  // üéØ Berechne aktuelle Saucen-Anzahl
  const knoblauch = currentCustomization.options['knoblauch'] || 0
  const scharf = currentCustomization.options['scharf'] || 0
  const totalSauces = knoblauch + scharf
  
  Object.keys(currentProduct.options).forEach(key => {
    const option = currentProduct.options[key]
    html += `<div class="option-group">
      <label class="option-label">${option.label}</label>
      <div class="option-buttons">`
    
    if (Array.isArray(option.choices)) {
      option.choices.forEach(choice => {
        const isActive = currentCustomization.options[key] === choice ? 'active' : ''
        
        let label
        if (typeof choice === 'number') {
          label = choice === 0 ? 'Ohne' : choice === 1 ? '1x' : '2x'
        } else {
          label = choice
        }
        
        const choiceValue = typeof choice === 'string' ? `'${choice}'` : choice
        
        // üéØ SAUCEN-LOGIK: Buttons deaktivieren wenn zu viele Saucen
        let isDisabled = false
        if ((key === 'knoblauch' || key === 'scharf') && typeof choice === 'number') {
          const otherSauce = key === 'knoblauch' ? scharf : knoblauch
          const wouldBeTotalSauces = choice + otherSauce
          
          // Deaktiviere Button wenn Gesamtzahl > 2 w√§re
          if (wouldBeTotalSauces > 2) {
            isDisabled = true
          }
        }
        
        const disabledAttr = isDisabled ? 'disabled' : ''
        
        html += `<button class="option-btn ${isActive}" ${disabledAttr} onclick="selectOption('${key}', ${choiceValue})">${label}</button>`
      })
    }
    
    html += `</div></div>`
  })
  
  if (currentProduct.extras.length > 0) {
    html += `<div class="option-group"><label class="option-label">Extras</label>`
    currentProduct.extras.forEach(extra => {
      const isSelected = currentCustomization.extras.includes(extra.id) ? 'selected' : ''
      html += `<div class="extra-item ${isSelected}" onclick="toggleExtra('${extra.id}')">
        <div class="extra-info">
          <div class="extra-name">${extra.name}</div>
        </div>
        <div class="extra-price">${formatPrice(extra.price)}</div>
      </div>`
    })
    html += `</div>`
  }
  
  document.getElementById('modalBody').innerHTML = html
  updateCustomizePrice()
}

function selectOption(key, value) {
  currentCustomization.options[key] = value
  
  // üéØ SAUCEN-LOGIK: Maximal 2 Saucen insgesamt (Knoblauch + Scharf)
  if ((key === 'knoblauch' || key === 'scharf')) {
    const knoblauch = currentCustomization.options['knoblauch'] || 0
    const scharf = currentCustomization.options['scharf'] || 0
    const totalSauces = knoblauch + scharf
    
    // Wenn zu viele Saucen, setze die andere Sauce zur√ºck
    if (totalSauces > 2) {
      if (key === 'knoblauch') {
        currentCustomization.options['scharf'] = 0
      } else {
        currentCustomization.options['knoblauch'] = 0
      }
    }
  }
  
  renderCustomizeModal()
}

function toggleExtra(extraId) {
  const index = currentCustomization.extras.indexOf(extraId)
  if (index > -1) {
    currentCustomization.extras.splice(index, 1)
  } else {
    currentCustomization.extras.push(extraId)
  }
  renderCustomizeModal()
}

function updateCustomizePrice() {
  // ‚úÖ FIX 4: Nutze Coupon-Preis falls vorhanden
  const couponPrice = getCouponPrice(currentProduct.name)
  let price = couponPrice !== null ? couponPrice : currentProduct.price
  
  currentCustomization.extras.forEach(extraId => {
    const extra = currentProduct.extras.find(e => e.id === extraId)
    if (extra) price += extra.price
  })
  document.getElementById('modalTotal').textContent = formatPrice(price)
}

function addToCart() {
  // ‚úÖ FIX 4: Nutze Coupon-Preis falls vorhanden
  const couponPrice = getCouponPrice(currentProduct.name)
  let price = couponPrice !== null ? couponPrice : currentProduct.price
  
  currentCustomization.extras.forEach(extraId => {
    const extra = currentProduct.extras.find(e => e.id === extraId)
    if (extra) price += extra.price
  })
  
  cart.push({
    product: currentProduct,
    options: { ...currentCustomization.options },
    extras: [...currentCustomization.extras],
    price: price
  })
  
  updateCart()
  closeCustomizeModal()
}

function updateCart() {
  const count = cart.length
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  
  document.getElementById('cartCount').textContent = count
  document.getElementById('cartTotal').textContent = formatPrice(total)
  document.getElementById('cartFixed').style.display = count > 0 ? 'block' : 'none'
}

function openCart() {
  renderCart()
  document.getElementById('cartModal').classList.add('active')
}

function closeCart() {
  document.getElementById('cartModal').classList.remove('active')
}

function renderCart() {
  const container = document.getElementById('cartItems')
  
  if (cart.length === 0) {
    container.innerHTML = '<div class="cart-empty"><div class="cart-empty-icon">üõí</div><p>Dein Warenkorb ist leer</p></div>'
    document.getElementById('cartModalTotal').textContent = '0,00 ‚Ç¨'
    document.getElementById('cartModalCount').textContent = '0'
    return
  }
  
  // üéÅ MEN√ú-BUNDLE CHECK
  const menuOffer = checkForMenuBundle()
  
  const html = cart.map((item, index) => {
    // üéÅ Spezielle Anzeige f√ºr Men√º-Bundles
    if (item.isBundle) {
      const bundleItemsList = item.bundleItems.map(bundleItem => 
        `<div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 13px; color: #666;">
          <span>${bundleItem.icon}</span>
          <span>${bundleItem.name}</span>
        </div>`
      ).join('')
      
      return `
        <div class="cart-item" style="border: 2px solid #F9A825; background: linear-gradient(135deg, #FFFBF0, #FFF9E6);">
          <div class="cart-item-header">
            <div class="cart-item-name" style="color: #E31E24;">üéÅ ${item.product.name}</div>
            <div class="cart-item-price" style="color: #E31E24; font-weight: 700;">${formatPrice(item.price)}</div>
          </div>
          <div style="background: white; border-radius: 8px; padding: 10px; margin: 8px 0;">
            <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 6px;">Enth√§lt:</div>
            ${bundleItemsList}
          </div>
          <div class="cart-item-actions">
            <button class="cart-item-btn delete" onclick="removeFromCart(${index})">üóëÔ∏è Entfernen</button>
          </div>
        </div>
      `
    }
    
    // Normale Produkte
    let optionsText = ''
    let extrasText = ''
    
    if (item.options && item.product.options) {
      optionsText = Object.keys(item.options)
        .filter(key => {
          const value = item.options[key]
          const defaultValue = item.product.options[key]?.default
          return value !== defaultValue
        })
        .map(key => {
          const value = item.options[key]
          const label = item.product.options[key]?.label || key
          if (typeof value === 'string') return `${label}: ${value}`
          return `${label}: ${value === 0 ? 'Ohne' : value === 1 ? '1x' : '2x'}`
        })
        .join(', ')
    }
    
    if (item.extras && item.product.extras) {
      extrasText = item.extras.map(extraId => {
        const extra = item.product.extras.find(e => e.id === extraId)
        return extra ? `+ ${extra.name}` : ''
      }).join(', ')
    }
    
    return `
      <div class="cart-item">
        <div class="cart-item-header">
          <div class="cart-item-name">${item.product.name}</div>
          <div class="cart-item-price">${formatPrice(item.price)}</div>
        </div>
        ${optionsText || extrasText ? `<div class="cart-item-options">${[optionsText, extrasText].filter(Boolean).join(', ')}</div>` : ''}
        <div class="cart-item-actions">
          <button class="cart-item-btn delete" onclick="removeFromCart(${index})">üóëÔ∏è Entfernen</button>
        </div>
      </div>
    `
  }).join('')
  
  // üéÅ MEN√ú-BUNDLE ANGEBOT EINF√úGEN (falls verf√ºgbar)
  let finalHTML = html
  if (menuOffer) {
    finalHTML += generateMenuBundleHTML(menuOffer)
  }
  
  // ‚úÖ SICHERHEIT: Sanitize HTML mit onclick-Support
  container.innerHTML = DOMPurify.sanitize(finalHTML, {
    ADD_ATTR: ['onclick'],
    ALLOW_UNKNOWN_PROTOCOLS: false
  })
  
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  document.getElementById('cartModalTotal').textContent = formatPrice(total)
  document.getElementById('cartModalCount').textContent = cart.length
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üéÅ MEN√ú-BUNDLE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MENU_BUNDLES = [
  {
    id: 'doener-menu',
    name: 'D√∂ner Men√º',
    icon: 'üåØ',
    requiredProduct: 'D√∂ner Klassik',
    includes: [
      { name: 'D√∂ner Klassik', icon: 'üåØ' },
      { name: 'Pommes Frites', icon: 'üçü' },
      { name: 'Ayran 0,33L', icon: 'ü•§' }
    ],
    originalPrice: 13.00,  // Beispiel: D√∂ner (7,50) + Pommes (3,50) + Ayran (2,00)
    menuPrice: 9.50,
    savings: 3.50
  },
  {
    id: 'burger-menu',
    name: 'Crispy Chicken Burger Men√º',
    icon: 'üçî',
    requiredProduct: 'Crispy Chicken Burger',
    includes: [
      { name: 'Crispy Chicken Burger', icon: 'üçî' },
      { name: 'Pommes Frites', icon: 'üçü' },
      { name: 'Cola 0,33L', icon: 'ü•§' }
    ],
    originalPrice: 12.00,  // Beispiel: Burger (6,50) + Pommes (3,50) + Cola (2,00)
    menuPrice: 9.00,
    savings: 3.00
  }
]

function checkForMenuBundle() {
  // Pr√ºfe f√ºr jedes Men√º-Bundle, ob das Hauptprodukt im Warenkorb ist
  for (const bundle of MENU_BUNDLES) {
    const hasMainProduct = cart.some(item => 
      item.product.name === bundle.requiredProduct
    )
    
    if (hasMainProduct) {
      // Pr√ºfe ob bereits ein komplettes Men√º im Warenkorb ist
      const hasAllItems = bundle.includes.every(menuItem => 
        cart.some(cartItem => cartItem.product.name === menuItem.name)
      )
      
      // Zeige Angebot nur wenn NICHT alle Items schon da sind
      if (!hasAllItems) {
        return bundle
      }
    }
  }
  
  return null
}

function generateMenuBundleHTML(bundle) {
  return `
    <div class="menu-bundle-offer">
      <div class="menu-bundle-header">
        <div class="menu-bundle-icon">${bundle.icon}</div>
        <div class="menu-bundle-title">UPGRADE ZU MEN√ú!</div>
      </div>
      
      <div class="menu-bundle-subtitle">
        ${bundle.name}
      </div>
      
      <div class="menu-bundle-items">
        ${bundle.includes.map(item => `
          <div class="menu-bundle-item">
            <span class="menu-bundle-item-icon">${item.icon}</span>
            <span>${item.name}</span>
          </div>
        `).join('')}
      </div>
      
      <div class="menu-bundle-pricing">
        <div>
          <div class="menu-bundle-original">Einzeln: ${formatPrice(bundle.originalPrice)}</div>
          <div class="menu-bundle-price">${formatPrice(bundle.menuPrice)}</div>
        </div>
      </div>
      
      <div class="menu-bundle-savings">
        üí∞ Spare ${formatPrice(bundle.savings)}!
      </div>
      
      <button class="menu-bundle-btn" onclick="upgradeToMenu('${bundle.id}')">
        ‚ûï Zum Men√º upgraden
      </button>
    </div>
  `
}

function upgradeToMenu(bundleId) {
  const bundle = MENU_BUNDLES.find(b => b.id === bundleId)
  if (!bundle) return
  
  // Entferne das Hauptprodukt aus dem Warenkorb
  const mainProductIndex = cart.findIndex(item => 
    item.product.name === bundle.requiredProduct
  )
  
  if (mainProductIndex === -1) {
    alert('‚ùå Hauptprodukt nicht mehr im Warenkorb!')
    return
  }
  
  // Entferne das alte Produkt
  cart.splice(mainProductIndex, 1)
  
  // F√ºge das komplette Men√º als Bundle hinzu
  // (Erstelle ein spezielles Bundle-Produkt)
  const menuProduct = {
    product: {
      name: bundle.name,
      price: bundle.menuPrice,
      category: 'menu',
      image: '/menu-bundle.jpg'
    },
    price: bundle.menuPrice,
    options: {},
    extras: [],
    isBundle: true,
    bundleItems: bundle.includes
  }
  
  cart.push(menuProduct)
  
  // UI aktualisieren
  updateCart()
  renderCart()
  
  // Erfolgs-Feedback
  showToast(`‚úÖ ${bundle.name} zum Warenkorb hinzugef√ºgt!`)
}

function showToast(message) {
  const toast = document.createElement('div')
  toast.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 14px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    z-index: 10001;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    animation: slideUpToast 0.3s ease;
  `
  toast.textContent = message
  
  const style = document.createElement('style')
  style.textContent = `
    @keyframes slideUpToast {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  `
  document.head.appendChild(style)
  document.body.appendChild(toast)
  
  setTimeout(() => {
    toast.style.animation = 'slideUpToast 0.3s ease reverse'
    setTimeout(() => {
      toast.remove()
      style.remove()
    }, 300)
  }, 2500)
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function removeFromCart(index) {
  cart.splice(index, 1)
  updateCart()
  renderCart()
}

function goToCheckout() {
  if (cart.length === 0) {
    alert('Dein Warenkorb ist leer!')
    return
  }
  
  closeCart()
  document.getElementById('checkoutModal').classList.add('active')
  renderCheckout()
  
  if (currentCustomer) {
    document.getElementById('customerName').value = currentCustomer.name
    document.getElementById('customerPhone').value = currentCustomer.phone
  }
  
  checkCheckoutReady()
}

function closeCheckout() {
  document.getElementById('checkoutModal').classList.remove('active')
}

function renderCheckout() {
  const summary = document.getElementById('checkoutSummary')
  
  const items = cart.map(item => {
    let optionsText = ''
    if (item.options && item.product.options) {
      optionsText = Object.keys(item.options)
        .filter(key => {
          const value = item.options[key]
          const defaultValue = item.product.options[key]?.default
          return value !== defaultValue
        })
        .map(key => {
          const value = item.options[key]
          const label = item.product.options[key]?.label || key
          if (typeof value === 'string') return `${label}: ${value}`
          return `${label}: ${value === 0 ? 'Ohne' : value === 1 ? '1x' : '2x'}`
        })
        .join(', ')
    }
    
    let extrasText = ''
    if (item.extras && item.product.extras) {
      extrasText = item.extras.map(extraId => {
        const extra = item.product.extras.find(e => e.id === extraId)
        return extra ? `+ ${extra.name}` : ''
      }).join(', ')
    }
    
    return `
      <div class="summary-row">
        <span>${item.product.name}${optionsText || extrasText ? ' (' + [optionsText, extrasText].filter(Boolean).join(', ') + ')' : ''}</span>
        <span>${formatPrice(item.price)}</span>
      </div>
    `
  }).join('')
  
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  
  summary.innerHTML = items + `
    <div class="summary-row total">
      <span>Gesamt</span>
      <span>${formatPrice(total)}</span>
    </div>
  `
  
  document.getElementById('finalTotal').textContent = formatPrice(total)
}

function selectPayment(type) {
  selectedPayment = type
  
  document.getElementById('paymentCash').classList.remove('active')
  document.getElementById('paymentPaypal').classList.remove('active')
  document.getElementById(`payment${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active')
  
  checkCheckoutReady()
}

function selectPickupTime(type) {
  selectedPickupTime = type
  
  document.getElementById('pickupNow').classList.remove('active')
  document.getElementById('pickupLater').classList.remove('active')
  document.getElementById(`pickup${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active')
  
  const timePickerContainer = document.getElementById('timePickerContainer')
  if (type === 'later') {
    timePickerContainer.style.display = 'block'
    const now = new Date()
    now.setMinutes(now.getMinutes() + 30)
    const hours = String(now.getHours()).padStart(2, '0')
    const minutes = String(Math.round(now.getMinutes() / 15) * 15).padStart(2, '0')
    document.getElementById('pickupTimeInput').value = `${hours}:${minutes}`
  } else {
    timePickerContainer.style.display = 'none'
    selectedPickupTimeValue = null
  }
  
  checkCheckoutReady()
}

function checkCheckoutReady() {
  const name = document.getElementById('customerName').value.trim()
  const phone = document.getElementById('customerPhone').value.trim()
  const ready = name && phone && selectedPayment
  
  document.getElementById('placeOrderBtn').disabled = !ready
}

async function placeOrder() {
  const name = document.getElementById('customerName').value.trim()
  const phone = document.getElementById('customerPhone').value.trim()
  const notes = document.getElementById('customerNotes').value.trim()
  const total = cart.reduce((sum, item) => sum + item.price, 0)
  
  let pickupTime = null
  if (selectedPickupTime === 'later') {
    pickupTime = document.getElementById('pickupTimeInput').value
  }
  
  // ‚úÖ Stelle sicher dass pickup_type nie NULL ist
  const finalPickupType = selectedPickupTime || 'now'
  
  const btn = document.getElementById('placeOrderBtn')
  btn.disabled = true
  btn.innerHTML = '‚è≥ Bestellung wird verarbeitet...'
  
  try {
    // üí≥ PAYPAL: Wenn PayPal gew√§hlt, √∂ffne PayPal.Me Link
    if (selectedPayment === 'paypal') {
      const orderQRID = Math.floor(1000 + Math.random() * 9000).toString()
      const orderNumber = Math.floor(1000 + Math.random() * 9000).toString() // ‚úÖ Als String f√ºr Supabase
      
      // Speichere Bestellung zuerst
      const orderData = {
        order_number: orderNumber, // String
        qr_id: orderQRID,
        customer_id: currentCustomer.id, // ‚úÖ WICHTIG: Verkn√ºpfe mit Kunden-ID
        customer_name: name,
        customer_phone: phone,
        notes: notes || null,
        items: cart,
        total: total,
        payment_method: 'paypal',
        pickup_time: pickupTime,
        pickup_type: finalPickupType, // ‚úÖ Nie NULL
        status: 'pending'
        // created_at wird automatisch von Supabase gesetzt
      }
      
      const { data, error } = await supabase
        .from('orders')
        .insert([orderData])
      
      if (error) {
        console.error('Supabase error:', error)
        console.error('Error details:', JSON.stringify(error, null, 2))
        throw new Error('Bestellung konnte nicht gespeichert werden: ' + (error.message || 'Unbekannter Fehler'))
      }
      
      // ü§ñ Sende Telegram Benachrichtigung
      sendOrderNotification(orderNumber, name, phone, total, 'paypal', cart, pickupTime, finalPickupType, notes)
      
      // PayPal Zahlung - Direkt zu deinem PayPal.Me Link
      const paypalEmail = 'ahmetdemirel@freenet.de'
      const amount = total.toFixed(2)
      
      // PayPal.Me Link zu DoenerBoxx mit Betrag
      const paypalUrl = `https://paypal.me/DoenerBoxx/${amount}EUR`
      
      // Info-Alert - kompakt mit Freunde & Familie Hinweis
      alert(`üí≥ PayPal-Zahlung\n\n‚úÖ Bestellung #${orderNumber} wurde erfasst!\n\n‚û°Ô∏è Du wirst zu PayPal weitergeleitet.\n\nüí∞ Betrag: ${formatPrice(total)}\n‚ö†Ô∏è Bitte als "Freunde & Familie" senden (keine Geb√ºhren!)`)
      
      // √ñffne PayPal.Me Link mit Betrag
      window.open(paypalUrl, '_blank')
      
      // Zeige Erfolgs-Modal - NUR Bestellnummer
      document.getElementById('orderNumber').textContent = orderNumber
      
      closeCheckout()
      document.getElementById('successModal').classList.add('active')
      
      cart = []
      updateCart()
      
      btn.disabled = false
      btn.innerHTML = 'Jetzt bestellen - <span id="finalTotal">0,00 ‚Ç¨</span>'
      return
    }
    
    // üíµ BAR-ZAHLUNG: Normale Bestellung ohne PayPal
    const orderQRID = Math.floor(1000 + Math.random() * 9000).toString()
    const orderNumber = Math.floor(1000 + Math.random() * 9000).toString() // ‚úÖ Als String
    
    const orderData = {
      order_number: orderNumber, // String
      qr_id: orderQRID,
      customer_id: currentCustomer.id, // ‚úÖ WICHTIG: Verkn√ºpfe mit Kunden-ID
      customer_name: name,
      customer_phone: phone,
      notes: notes || null,
      items: cart,
      total: total,
      payment_method: selectedPayment,
      pickup_time: pickupTime,
      pickup_type: finalPickupType, // ‚úÖ Nie NULL
      status: 'pending'
      // created_at wird automatisch von Supabase gesetzt
    }
    
    const { data, error } = await supabase
      .from('orders')
      .insert([orderData])
    
    if (error) {
      console.error('Supabase error:', error)
      console.error('Error details:', JSON.stringify(error, null, 2))
      throw new Error('Bestellung konnte nicht gespeichert werden: ' + (error.message || 'Unbekannter Fehler'))
    }
    
    // ü§ñ Sende Telegram Benachrichtigung
    sendOrderNotification(orderNumber, name, phone, total, 'cash', cart, pickupTime, finalPickupType, notes)
    
    // Zeige nur Bestellnummer - KEIN QR-Code
    document.getElementById('orderNumber').textContent = orderNumber
    
    closeCheckout()
    document.getElementById('successModal').classList.add('active')
    
    cart = []
    updateCart()
    
    // ‚úÖ Button zur√ºcksetzen
    btn.disabled = false
    btn.innerHTML = 'Jetzt bestellen - <span id="finalTotal">0,00 ‚Ç¨</span>'
    
  } catch (error) {
    console.error('Error:', error)
    alert('‚ùå Fehler bei der Bestellung: ' + error.message)
    btn.disabled = false
    btn.innerHTML = 'Jetzt bestellen - <span id="finalTotal">0,00 ‚Ç¨</span>'
    renderCheckout()
  }
}

function formatPrice(price) {
  return price.toFixed(2).replace('.', ',') + ' ‚Ç¨'
}

// ü§ñ SICHERE Telegram Benachrichtigung √ºber Edge Function
async function sendOrderNotification(orderNumber, customerName, customerPhone, total, paymentMethod, items, pickupTime, pickupType, notes) {
  try {
    // ‚úÖ SICHER: Rufe Supabase Edge Function auf
    // Token ist NICHT mehr im Frontend!
    const { data, error } = await supabase.functions.invoke('send-telegram-notification', {
      body: {
        orderNumber,
        customerName,
        customerPhone,
        total,
        paymentMethod,
        items,
        pickupTime,
        pickupType,
        notes
      }
    })
    
    if (error) {
      console.error('‚ùå Telegram Benachrichtigung fehlgeschlagen:', error)
    } else {
      console.log('‚úÖ Telegram Benachrichtigung gesendet!', data)
    }
    
  } catch (error) {
    console.error('‚ùå Telegram Benachrichtigung fehlgeschlagen:', error)
    // Fehler nicht an Benutzer weitergeben - Bestellung wurde trotzdem gespeichert
  }
}

function closeSuccess() {
  document.getElementById('successModal').classList.remove('active')
  closeOrderModal()
}

document.addEventListener('DOMContentLoaded', () => {
  // Cache DOM Elemente
  cacheDOMElements()
  
  document.getElementById('customerName')?.addEventListener('input', checkCheckoutReady)
  document.getElementById('customerPhone')?.addEventListener('input', checkCheckoutReady)
  document.getElementById('pickupTimeInput')?.addEventListener('change', checkCheckoutReady)
  
  // ‚úÖ Debug: Pr√ºfe wichtige Elemente
  console.log('üîç System-Check:')
  console.log('  - Products loaded:', products ? `‚úÖ ${products.length} Produkte` : '‚ùå Nicht geladen')
  console.log('  - customizeModal:', document.getElementById('customizeModal') ? '‚úÖ Vorhanden' : '‚ùå Fehlt')
  console.log('  - modalTitle:', document.getElementById('modalTitle') ? '‚úÖ Vorhanden' : '‚ùå Fehlt')
  console.log('  - modalBody:', document.getElementById('modalBody') ? '‚úÖ Vorhanden' : '‚ùå Fehlt')
  console.log('  - products container:', document.getElementById('products') ? '‚úÖ Vorhanden' : '‚ùå Fehlt')
  
  // Test ob openCustomize Funktion verf√ºgbar ist
  if (typeof openCustomize === 'function') {
    console.log('  - openCustomize function: ‚úÖ Verf√ºgbar')
  } else {
    console.error('  - openCustomize function: ‚ùå Nicht gefunden!')
  }
})

// ‚úÖ Page Visibility API - Stoppe Refresh wenn App im Hintergrund
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // App ist im Hintergrund ‚Üí Stoppe Refresh
    stopRefreshInterval()
  } else {
    // App ist wieder im Vordergrund ‚Üí Starte Refresh
    if (currentCustomer && currentCustomer.id) {
      startRefreshInterval()
      // Sofortiges Refresh beim Zur√ºckkommen
      refreshCustomerData()
    }
  }
})

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üì¶ BESTELLHISTORIE FUNKTIONEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleHistorySection() {
  const list = document.getElementById('order-history-list')
  const icon = document.getElementById('history-toggle-icon')
  
  if (!list || !icon) return
  
  if (list.style.display === 'none') {
    list.style.display = 'block'
    icon.textContent = '‚ñ≤'
  } else {
    list.style.display = 'none'
    icon.textContent = '‚ñº'
  }
}

async function loadOrderHistory() {
  const container = document.getElementById('order-history-list')
  if (!container || !currentCustomer) return
  
  try {
    // Lade letzte 3 abgeschlossene Bestellungen DIESER Kunden-ID
    // ‚úÖ WICHTIG: Nach customer_id filtern, NICHT customer_phone!
    // Wenn Kunde gel√∂scht und neu registriert wird, bekommt er neue ID
    const { data: orders, error } = await supabase
      .from('orders')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .in('status', ['completed', 'cancelled'])
      .order('created_at', { ascending: false })
      .limit(3)
    
    if (error) {
      console.error('‚ùå Fehler beim Laden der Bestellhistorie:', error)
      container.innerHTML = `
        <div class="order-history-empty">
          <div class="order-history-empty-icon">‚ö†Ô∏è</div>
          <div class="order-history-empty-text">
            Bestellhistorie konnte nicht geladen werden.
          </div>
        </div>
      `
      return
    }
    
    if (!orders || orders.length === 0) {
      container.innerHTML = `
        <div class="order-history-empty">
          <div class="order-history-empty-icon">üì¶</div>
          <div class="order-history-empty-text">
            Noch keine Bestellungen.<br>
            Bestelle jetzt und sammle Punkte!
          </div>
        </div>
      `
      return
    }
    
    // Rendere Bestellungen
    container.innerHTML = orders.map(order => renderOrderHistoryItem(order)).join('')
    
  } catch (e) {
    console.error('‚ùå Fehler beim Laden der Bestellhistorie:', e)
  }
}

function renderOrderHistoryItem(order) {
  const date = new Date(order.created_at)
  const dateStr = date.toLocaleDateString('de-DE', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
  
  const statusText = order.status === 'completed' ? 'Abgeschlossen' : 'Storniert'
  const statusClass = order.status
  
  // Rendere Items
  const itemsHtml = order.items.map(item => {
    let optionsHtml = ''
    
    if (item.options) {
      const optionsList = Object.keys(item.options)
        .filter(key => {
          const value = item.options[key]
          const defaultValue = item.product?.options?.[key]?.default
          return value !== defaultValue
        })
        .map(key => {
          const value = item.options[key]
          const label = item.product?.options?.[key]?.label || key
          if (typeof value === 'string') return `${label}: ${value}`
          return `${label}: ${value === 0 ? 'Ohne' : value === 1 ? '1x' : '2x'}`
        })
      
      const extrasList = item.extras?.map(extraId => {
        const extra = item.product?.extras?.find(e => e.id === extraId)
        return extra ? `+ ${extra.name}` : ''
      }).filter(Boolean) || []
      
      const allOptions = [...optionsList, ...extrasList].filter(Boolean)
      if (allOptions.length > 0) {
        optionsHtml = `<div class="order-history-item-options">${allOptions.join(', ')}</div>`
      }
    }
    
    return `
      <div class="order-history-item-row">
        <div>
          <div class="order-history-item-name">${item.product?.name || 'Unbekanntes Produkt'}</div>
          ${optionsHtml}
        </div>
        <div class="order-history-item-price">${formatPrice(item.price)}</div>
      </div>
    `
  }).join('')
  
  // Details
  const detailsHtml = `
    <div class="order-history-details" id="details-${order.id}">
      <div class="order-history-detail-row">
        <span class="order-history-detail-label">Bestellnummer:</span>
        <span>#${order.order_number}</span>
      </div>
      <div class="order-history-detail-row">
        <span class="order-history-detail-label">Zahlungsart:</span>
        <span>${order.payment_method === 'paypal' ? 'PayPal' : 'Bar'}</span>
      </div>
      ${order.pickup_type === 'later' && order.pickup_time ? `
        <div class="order-history-detail-row">
          <span class="order-history-detail-label">Abholzeit:</span>
          <span>${order.pickup_time} Uhr</span>
        </div>
      ` : ''}
      ${order.notes ? `
        <div class="order-history-detail-row">
          <span class="order-history-detail-label">Notiz:</span>
          <span>${order.notes}</span>
        </div>
      ` : ''}
      ${order.points_earned ? `
        <div class="order-history-detail-row">
          <span class="order-history-detail-label">Punkte erhalten:</span>
          <span style="color: #2e7d32; font-weight: 600;">+${order.points_earned} Punkte</span>
        </div>
      ` : ''}
    </div>
  `
  
  return `
    <div class="order-history-item">
      <div class="order-history-header">
        <div>
          <div class="order-history-number">#${order.order_number}</div>
          <div class="order-history-date">${dateStr}</div>
        </div>
        <span class="order-history-status ${statusClass}">${statusText}</span>
      </div>
      
      <div class="order-history-items">
        ${itemsHtml}
      </div>
      
      <div class="order-history-total">
        <span class="order-history-total-label">Gesamt:</span>
        <span class="order-history-total-amount">${formatPrice(order.total)}</span>
      </div>
      
      ${detailsHtml}
      
      <div class="order-history-actions">
        <button class="order-history-btn secondary" onclick="toggleOrderDetails('${order.id}')">
          <span id="toggle-icon-${order.id}">üëÅÔ∏è</span>
          <span id="toggle-text-${order.id}">Details</span>
        </button>
        ${order.status === 'completed' ? `
          <button class="order-history-btn primary" onclick="reorderItems('${order.id}')">
            <span>üîÑ</span>
            <span>Wieder bestellen</span>
          </button>
        ` : ''}
      </div>
    </div>
  `
}

function toggleOrderDetails(orderId) {
  const details = document.getElementById(`details-${orderId}`)
  const icon = document.getElementById(`toggle-icon-${orderId}`)
  const text = document.getElementById(`toggle-text-${orderId}`)
  
  if (!details) return
  
  if (details.classList.contains('show')) {
    details.classList.remove('show')
    icon.textContent = 'üëÅÔ∏è'
    text.textContent = 'Details'
  } else {
    details.classList.add('show')
    icon.textContent = 'üîº'
    text.textContent = 'Verbergen'
  }
}

async function reorderItems(orderId) {
  try {
    // Hole die Bestellung
    const { data: order, error } = await supabase
      .from('orders')
      .select('*')
      .eq('id', orderId)
      .single()
    
    if (error || !order) {
      alert('‚ùå Bestellung konnte nicht geladen werden.')
      return
    }
    
    // F√ºge Items zum Warenkorb hinzu
    if (!order.items || order.items.length === 0) {
      alert('‚ùå Diese Bestellung enth√§lt keine Artikel.')
      return
    }
    
    // L√∂sche aktuellen Warenkorb
    cart = []
    
    let unavailableItems = []
    
    // F√ºge alle Items hinzu - MIT AKTUELLEN PREISEN!
    order.items.forEach(item => {
      const productId = item.product?.id
      
      if (!productId) {
        console.warn('‚ö†Ô∏è Produkt-ID fehlt:', item)
        unavailableItems.push(item.product?.name || 'Unbekannt')
        return
      }
      
      // ‚úÖ WICHTIG: Finde Produkt aus products Array (AKTUELLE PREISE!)
      const currentProduct = products.find(p => p.id === productId)
      
      if (!currentProduct) {
        console.warn('‚ö†Ô∏è Produkt nicht mehr verf√ºgbar:', productId)
        unavailableItems.push(item.product?.name || productId)
        return
      }
      
      // Berechne AKTUELLEN Preis (Basis + Extras)
      let currentPrice = currentProduct.price
      
      // F√ºge Extra-Preise hinzu
      if (item.extras && item.extras.length > 0) {
        item.extras.forEach(extraId => {
          const extra = currentProduct.extras?.find(e => e.id === extraId)
          if (extra) {
            currentPrice += extra.price
          }
        })
      }
      
      // ‚úÖ WICHTIG: Verwende AKTUELLEN Preis, NICHT den alten Deal-Preis!
      cart.push({
        product: currentProduct,
        price: currentPrice,  // ‚Üê AKTUELLER Preis, kein Deal!
        options: item.options || {},
        extras: item.extras || []
      })
      
      console.log(`‚úÖ ${currentProduct.name} hinzugef√ºgt mit aktuellem Preis: ${currentPrice}‚Ç¨ (alter Preis war: ${item.price}‚Ç¨)`)
    })
    
    if (cart.length === 0) {
      alert('‚ö†Ô∏è Keine der Artikel aus dieser Bestellung ist mehr verf√ºgbar.')
      return
    }
    
    // √ñffne Bestellmodal
    updateCart()
    renderCart()
    openOrderModal()
    
    // Zeige Erfolgs-Nachricht mit Hinweis falls Preise anders sind
    setTimeout(() => {
      let message = `‚úÖ ${cart.length} Artikel wurden in den Warenkorb gelegt!`
      
      if (unavailableItems.length > 0) {
        message += `\n\n‚ö†Ô∏è Nicht verf√ºgbar:\n${unavailableItems.join(', ')}`
      }
      
      // Pr√ºfe ob Preise sich ge√§ndert haben
      const oldTotal = order.total
      const newTotal = cart.reduce((sum, item) => sum + item.price, 0)
      
      if (Math.abs(oldTotal - newTotal) > 0.01) {
        message += `\n\n‚ÑπÔ∏è Hinweis: Die Preise k√∂nnen sich seit deiner letzten Bestellung ge√§ndert haben.`
        message += `\nAlter Preis: ${oldTotal.toFixed(2)}‚Ç¨`
        message += `\nNeuer Preis: ${newTotal.toFixed(2)}‚Ç¨`
      }
      
      alert(message)
    }, 300)
    
  } catch (e) {
    console.error('‚ùå Fehler beim Wiederholen der Bestellung:', e)
    alert('‚ùå Fehler beim Laden der Bestellung.')
  }
}

console.log('‚úÖ D√∂ner Boxx App geladen!')
</script>
</body>
</html>
