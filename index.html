<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂nerkings Loyalty</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 500px; margin: 0 auto; }
.card {
  background: white;
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h1 { 
  color: #667eea; 
  margin-bottom: 10px; 
  font-size: 32px; 
  text-align: center;
}
h2 { 
  font-size: 22px; 
  margin-bottom: 16px; 
  color: #374151;
  text-align: center;
}
p.subtitle {
  text-align: center;
  color: #6b7280;
  font-size: 16px;
  margin-bottom: 24px;
  line-height: 1.5;
}

/* Forms */
input {
  width: 100%;
  padding: 14px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 16px;
  margin-bottom: 12px;
}
input:focus {
  outline: none;
  border-color: #667eea;
}
button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}
button:hover { opacity: 0.9; }
button.secondary {
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  box-shadow: none;
}
button.small {
  width: auto;
  padding: 10px 20px;
  font-size: 14px;
  margin: 4px;
}
button.danger {
  background: #ef4444;
}

/* Results */
.result {
  padding: 12px;
  border-radius: 8px;
  margin-top: 12px;
  font-size: 14px;
  text-align: center;
}
.success { background: #d1fae5; color: #065f46; }
.error { background: #fee2e2; color: #991b1b; }
.info { background: #dbeafe; color: #1e40af; }
.warning { background: #fef3c7; color: #92400e; }

/* QR Display */
.qr-box {
  background: #f9fafb;
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  margin: 20px 0;
}
.qr-img {
  width: 260px;
  height: 260px;
  margin: 0 auto 16px;
  background: white;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.qr-id {
  font-size: 28px;
  font-weight: 700;
  color: #667eea;
  letter-spacing: 4px;
  margin: 16px 0;
}
.qr-label {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 8px;
}

/* Points */
.points-circle {
  width: 140px;
  height: 140px;
  margin: 20px auto;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}
.points-num { font-size: 42px; font-weight: 700; }
.points-label { font-size: 14px; opacity: 0.9; }

/* Rewards */
.reward {
  background: #f9fafb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.reward h3 { font-size: 16px; margin: 0 0 4px 0; }
.reward .pts { font-size: 14px; color: #667eea; font-weight: 600; }
.reward button {
  width: auto;
  padding: 10px 20px;
  margin: 0;
  font-size: 14px;
}
.reward button:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  box-shadow: none;
}

/* Pending Codes */
.pending-code {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}
.pending-code h3 {
  color: #92400e;
  font-size: 16px;
  margin-bottom: 8px;
}
.pending-code .code {
  font-size: 32px;
  font-weight: 700;
  color: #f59e0b;
  letter-spacing: 6px;
  margin: 12px 0;
}

/* Screens */
.screen { display: none; }
.screen.active { display: block; }

/* Hero */
.hero {
  text-align: center;
  color: white;
  padding: 20px 0;
  margin-bottom: 20px;
}
.hero h1 {
  color: white;
  font-size: 36px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.hero p {
  font-size: 18px;
  opacity: 0.95;
  margin-top: 8px;
}
</style>
</head>
<body>

<div class="container">
  <!-- SCREEN 1: START -->
  <div id="screen-start" class="screen active">
    <div class="hero">
      <h1>üåØ D√∂nerkings</h1>
      <p>Treue wird belohnt!</p>
      <p style="font-size: 14px; opacity: 0.8; margin-top: 4px;">1 ‚Ç¨ = 10 Punkte</p>
    </div>
    
    <div class="card">
      <h2>Neu hier?</h2>
      <p class="subtitle">Registriere dich jetzt und sammle Punkte bei jedem Einkauf!</p>
      <button onclick="showScreen('register')">‚ú® Jetzt registrieren</button>
      <button class="secondary" onclick="showScreen('login')">üîë Ich habe schon einen Account</button>
    </div>
  </div>

  <!-- SCREEN 2: REGISTRIERUNG -->
  <div id="screen-register" class="screen">
    <div class="card">
      <h2>Jetzt registrieren</h2>
      <input id="reg-name" type="text" placeholder="Dein Name (z.B. Max Mustermann)">
      <input id="reg-phone" type="tel" placeholder="Handynummer (z.B. 01511234567)">
      <button onclick="register()">‚úÖ Registrieren</button>
      <button class="secondary" onclick="showScreen('start')">‚Ü©Ô∏è Zur√ºck</button>
      <div id="reg-result"></div>
    </div>
  </div>

  <!-- SCREEN 3: LOGIN -->
  <div id="screen-login" class="screen">
    <div class="card">
      <h2>Anmelden</h2>
      <input id="login-phone" type="tel" placeholder="Handynummer">
      <button onclick="login()">üîë Anmelden</button>
      <button class="secondary" onclick="showScreen('start')">‚Ü©Ô∏è Zur√ºck</button>
      <div id="login-result"></div>
    </div>
  </div>

  <!-- SCREEN 4: KUNDEN-APP -->
  <div id="screen-app" class="screen">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Mein Konto</h2>
        <button onclick="logout()" style="width: auto; padding: 8px 16px; background: #f3f4f6; color: #667eea; font-size: 14px; margin: 0; box-shadow: none;">Abmelden</button>
      </div>
      
      <div class="points-circle">
        <div class="points-num" id="app-points">0</div>
        <div class="points-label">Punkte</div>
      </div>
      
      <div style="text-align: center; margin-top: 16px;">
        <div style="font-weight: 600; font-size: 18px; color: #111;" id="app-name">-</div>
        <div style="font-size: 14px; color: #6b7280; margin-top: 4px;" id="app-phone">-</div>
      </div>
    </div>
    
    <div class="card">
      <h2>üì± Dein Treue-QR</h2>
      <div class="qr-box">
        <div class="qr-label">Zeige diesen Code beim Bezahlen</div>
        <img id="app-qr" class="qr-img" alt="QR Code">
        <div class="qr-label">Oder nenne diese ID:</div>
        <div class="qr-id" id="app-qr-id">------</div>
      </div>
    </div>

    <!-- Belohnungen -->
    <div id="rewards-section" style="display: none;">
      <div class="card">
        <h2>üéÅ Verf√ºgbare Belohnungen</h2>
        <div id="rewards-list"></div>
      </div>
    </div>

    <!-- Offene Einl√∂sungen -->
    <div id="pending-section" style="display: none;">
      <div class="card">
        <h2>‚è≥ Wartet auf Best√§tigung</h2>
        <div id="pending-list"></div>
      </div>
    </div>
    
    <div class="card">
      <h2>üéÅ Pr√§mien einl√∂sen</h2>
      <div class="reward">
        <div>
          <h3>Getr√§nk 0,5l</h3>
          <div class="pts">50 Punkte</div>
        </div>
        <button onclick="redeem('Getr√§nk 0,5l', 50)" id="btn-50">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div>
          <h3>Pommes</h3>
          <div class="pts">100 Punkte</div>
        </div>
        <button onclick="redeem('Pommes', 100)" id="btn-100">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div>
          <h3>D√∂ner</h3>
          <div class="pts">200 Punkte</div>
        </div>
        <button onclick="redeem('D√∂ner', 200)" id="btn-200">Einl√∂sen</button>
      </div>
      <div class="reward">
        <div>
          <h3>Men√º (D√∂ner + Getr√§nk)</h3>
          <div class="pts">300 Punkte</div>
        </div>
        <button onclick="redeem('Men√º', 300)" id="btn-300">Einl√∂sen</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
let currentCustomer = null
let refreshInterval = null

function showScreen(screenName) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'))
  document.getElementById(`screen-${screenName}`).classList.add('active')
}

function showResult(elementId, message, type) {
  const el = document.getElementById(elementId)
  el.className = `result ${type}`
  el.innerHTML = message
}

// === REGISTRIERUNG ===
async function register() {
  const name = document.getElementById('reg-name').value.trim()
  const phone = document.getElementById('reg-phone').value.trim()
  
  if (!name || !phone) {
    showResult('reg-result', '‚ùå Bitte Name und Handynummer eingeben!', 'error')
    return
  }
  
  try {
    showResult('reg-result', '‚è≥ Wird registriert...', 'info')
    
    const { data: existing } = await supabase
      .from('customers')
      .select('*')
      .eq('phone', phone)
      .limit(1)
    
    if (existing && existing.length > 0) {
      showResult('reg-result', '‚ùå Diese Nummer ist bereits registriert! Bitte anmelden.', 'error')
      return
    }
    
    const qrId = Math.floor(1000 + Math.random() * 9000).toString()
    
    const { data, error } = await supabase
      .from('customers')
      .insert({
        qr_id: qrId,
        name: name,
        phone: phone,
        points: 0
      })
      .select()
      .single()
    
    if (error) throw error
    
    showResult('reg-result', '‚úÖ Erfolgreich registriert!', 'success')
    
    setTimeout(() => {
      localStorage.setItem('customerData', JSON.stringify(data))
      loadCustomer(data)
    }, 1000)
    
  } catch (e) {
    showResult('reg-result', '‚ùå Fehler: ' + e.message, 'error')
  }
}

// === LOGIN ===
async function login() {
  const phone = document.getElementById('login-phone').value.trim()
  
  if (!phone) {
    showResult('login-result', '‚ùå Bitte Handynummer eingeben!', 'error')
    return
  }
  
  try {
    showResult('login-result', '‚è≥ Suche Konto...', 'info')
    
    const { data: customers, error } = await supabase
      .from('customers')
      .select('*')
      .eq('phone', phone)
      .limit(1)
    
    if (error) throw error
    
    if (!customers || customers.length === 0) {
      showResult('login-result', '‚ùå Handynummer nicht gefunden. Bitte registrieren!', 'error')
      return
    }
    
    showResult('login-result', '‚úÖ Erfolgreich angemeldet!', 'success')
    
    setTimeout(() => {
      localStorage.setItem('customerData', JSON.stringify(customers[0]))
      loadCustomer(customers[0])
    }, 500)
    
  } catch (e) {
    showResult('login-result', '‚ùå Fehler: ' + e.message, 'error')
  }
}

// === KUNDEN-APP ===
async function loadCustomer(customer) {
  currentCustomer = customer
  
  await refreshCustomerData()
  
  document.getElementById('app-qr-id').textContent = customer.qr_id
  document.getElementById('app-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${customer.qr_id}`
  
  showScreen('app')
  
  // Auto-Refresh alle 5 Sekunden
  if (refreshInterval) clearInterval(refreshInterval)
  refreshInterval = setInterval(refreshCustomerData, 5000)
  
  // Offene Codes laden
  loadPendingCodes()
}

async function refreshCustomerData() {
  if (!currentCustomer) return
  
  try {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .eq('id', currentCustomer.id)
      .single()
    
    if (error) throw error
    
    currentCustomer = data
    document.getElementById('app-name').textContent = data.name
    document.getElementById('app-phone').textContent = data.phone
    document.getElementById('app-points').textContent = data.points
    
    updateRewardButtons(data.points)
    localStorage.setItem('customerData', JSON.stringify(data))
  } catch (e) {
    console.error('Refresh error:', e)
  }
}

function updateRewardButtons(points) {
  document.getElementById('btn-50').disabled = points < 50
  document.getElementById('btn-100').disabled = points < 100
  document.getElementById('btn-200').disabled = points < 200
  document.getElementById('btn-300').disabled = points < 300
}

async function redeem(rewardName, cost) {
  if (!currentCustomer) return
  
  if (currentCustomer.points < cost) {
    alert('‚ùå Nicht genug Punkte!')
    return
  }
  
  if (!confirm(`${rewardName} f√ºr ${cost} Punkte einl√∂sen?\n\nDer Code muss vom Mitarbeiter best√§tigt werden.`)) return
  
  try {
    const code = Math.floor(1000 + Math.random() * 9000).toString()
    const expires = new Date(Date.now() + 24*60*60*1000)
    
    // Code erstellen mit Status "pending"
    const { error } = await supabase.from('redeem_codes').insert({
      code: code,
      customer_id: currentCustomer.id,
      reward_name: rewardName,
      points_cost: cost,
      valid_until: expires.toISOString(),
      used: false,
      confirmed: false
    })
    
    if (error) throw error
    
    alert(`‚úÖ Code erstellt!\n\nüîë Code: ${code}\n\nZeige diesen Code dem Mitarbeiter.\nPunkte werden nach Best√§tigung abgezogen.`)
    
    loadPendingCodes()
    
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

async function loadPendingCodes() {
  if (!currentCustomer) return
  
  try {
    const { data, error } = await supabase
      .from('redeem_codes')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('confirmed', false)
      .eq('used', false)
      .order('created_at', { ascending: false })
    
    if (error) throw error
    
    const section = document.getElementById('pending-section')
    const list = document.getElementById('pending-list')
    
    if (!data || data.length === 0) {
      section.style.display = 'none'
      return
    }
    
    section.style.display = 'block'
    
    list.innerHTML = data.map(item => {
      const expires = new Date(item.valid_until).toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
      
      return `
        <div class="pending-code">
          <h3>üéÅ ${item.reward_name}</h3>
          <div class="code">${item.code}</div>
          <div style="font-size: 13px; color: #92400e; margin-bottom: 12px;">
            G√ºltig bis: ${expires}<br>
            Kosten: ${item.points_cost} Punkte
          </div>
          <button class="small danger" onclick="cancelCode('${item.code}')">üóëÔ∏è Stornieren</button>
        </div>
      `
    }).join('')
    
  } catch (e) {
    console.error('Load pending error:', e)
  }
}

async function cancelCode(code) {
  if (!confirm('Code wirklich stornieren?')) return
  
  try {
    const { error } = await supabase
      .from('redeem_codes')
      .delete()
      .eq('code', code)
      .eq('confirmed', false)
    
    if (error) throw error
    
    alert('‚úÖ Code storniert!')
    loadPendingCodes()
    
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

function logout() {
  if (refreshInterval) clearInterval(refreshInterval)
  currentCustomer = null
  localStorage.removeItem('customerData')
  showScreen('start')
}

window.onload = () => {
  const stored = localStorage.getItem('customerData')
  if (stored) {
    try {
      const customer = JSON.parse(stored)
      loadCustomer(customer)
    } catch (e) {
      localStorage.removeItem('customerData')
    }
  }
}

console.log('‚úÖ Kunden-App geladen!')
</script>

</body>
</html>
