<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂nerkings Scanner PRO</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 900px; margin: 0 auto; }
.card {
  background: white;
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h1 { color: #667eea; margin-bottom: 10px; font-size: 28px; }
h2 { font-size: 18px; margin-bottom: 12px; }
h3 { font-size: 16px; margin: 16px 0 8px 0; color: #374151; }
input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 16px;
  margin-bottom: 10px;
}
button {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
}
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }
button.success { background: #10b981; }
button.danger { background: #ef4444; }
button.small { 
  width: auto; 
  padding: 8px 16px; 
  font-size: 14px; 
  margin: 0 4px;
}
.result {
  padding: 12px;
  border-radius: 8px;
  margin-top: 10px;
  font-size: 14px;
}
.success { background: #d1fae5; color: #065f46; }
.error { background: #fee2e2; color: #991b1b; }
.info { color: #666; font-size: 14px; margin-top: 8px; }

.video-container {
  position: relative;
  width: 100%;
  max-width: 500px;
  margin: 16px auto;
  background: #000;
  border-radius: 10px;
  overflow: hidden;
  display: none;
}
.video-container.active { display: block; }
#video { width: 100%; display: block; }
.scan-line {
  position: absolute;
  width: 80%;
  height: 2px;
  background: #10b981;
  left: 10%;
  top: 50%;
  box-shadow: 0 0 10px #10b981;
  animation: scan 2s ease-in-out infinite;
}
@keyframes scan {
  0%, 100% { top: 20%; }
  50% { top: 80%; }
}
.scan-corners {
  position: absolute;
  inset: 10%;
  border: 2px solid #10b981;
  border-radius: 10px;
}
.customer-info {
  background: #f9fafb;
  padding: 16px;
  border-radius: 10px;
  margin-top: 12px;
}
.customer-info h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: #667eea;
}
.customer-info p {
  margin: 4px 0;
  color: #374151;
}
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.tab {
  flex: 1;
  padding: 12px;
  background: #f3f4f6;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #6b7280;
}
.tab.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}
canvas { display: none; }

.history-item {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 10px;
}
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.history-customer {
  font-weight: 700;
  font-size: 16px;
  color: #111827;
}
.history-time {
  font-size: 12px;
  color: #6b7280;
}
.history-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin: 8px 0;
  font-size: 14px;
}
.history-amount {
  color: #059669;
  font-weight: 600;
}
.history-points {
  color: #667eea;
  font-weight: 600;
}
.history-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.edit-form {
  background: #fef3c7;
  padding: 12px;
  border-radius: 8px;
  margin-top: 10px;
  display: none;
}
.edit-form.active { display: block; }
.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>üåØ D√∂nerkings Scanner PRO</h1>
    <div class="info">Status: <span id="status">Bereit ‚úÖ</span></div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="showTab('scan')">üì∏ Scannen</button>
      <button class="tab" onclick="showTab('manual')">üì± Handynummer</button>
      <button class="tab" onclick="showTab('history')">üìã Verlauf</button>
      <button class="tab" onclick="showTab('code')">üéÅ Code</button>
    </div>
  </div>

  <!-- TAB 1: QR SCANNER -->
  <div id="tab-scan" class="card">
    <h2>üì∏ QR-Code scannen</h2>
    <button id="startBtn" onclick="startCamera()">üì∏ Kamera starten</button>
    <button id="stopBtn" onclick="stopCamera()" class="danger" style="display:none;">‚èπÔ∏è Stoppen</button>
    
    <div class="video-container" id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <div class="scan-corners"></div>
      <div class="scan-line"></div>
    </div>
    <canvas id="canvas"></canvas>
    
    <div id="scanResult"></div>
    
    <div id="customerCard" style="display:none;">
      <div class="customer-info">
        <h3 id="custName">-</h3>
        <p><strong>QR-ID:</strong> <span id="custQR">-</span></p>
        <p><strong>Punkte:</strong> <span id="custPoints">-</span></p>
      </div>
      
      <h3>Betrag eingeben:</h3>
      <input id="scannedAmount" type="number" step="0.01" placeholder="z.B. 7.50">
      <button onclick="addPointsFromScan()" class="success">üí∞ Punkte gutschreiben</button>
      <div id="addPointsResult"></div>
    </div>
  </div>

  <!-- TAB 2: HANDYNUMMER -->
  <div id="tab-manual" class="card" style="display:none;">
    <h2>üì± Eingabe per Handynummer</h2>
    <input id="phone" type="tel" placeholder="Handynummer (z.B. 0151...)">
    <input id="amount" type="number" step="0.01" placeholder="Betrag in ‚Ç¨ (z.B. 7.50)">
    <button onclick="addPointsByPhone()">üí∞ Punkte gutschreiben</button>
    <div id="phoneResult"></div>
  </div>

  <!-- TAB 3: VERLAUF -->
  <div id="tab-history" class="card" style="display:none;">
    <h2>üìã Scan-Verlauf (Heute)</h2>
    <div id="historyList">
      <div class="info" style="text-align: center; padding: 20px;">Noch keine Scans heute</div>
    </div>
  </div>

  <!-- TAB 4: CODE PR√úFEN -->
  <div id="tab-code" class="card" style="display:none;">
    <h2>üéÅ Code pr√ºfen</h2>
    <input id="code" placeholder="6-stelliger Code" maxlength="6" style="text-transform: uppercase;">
    <button onclick="verifyCode()">‚úÖ Code verifizieren</button>
    <div id="codeResult"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

let video = document.getElementById('video')
let canvas = document.getElementById('canvas')
let ctx = canvas.getContext('2d')
let scanning = false
let stream = null
let currentCustomer = null

function showResult(elementId, message, isSuccess) {
  const el = document.getElementById(elementId)
  el.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">${message}</div>`
}

function showTab(tab) {
  stopCamera()
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
  document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none')
  
  const tabs = ['scan', 'manual', 'history', 'code']
  const index = tabs.indexOf(tab)
  document.querySelector(`.tab:nth-child(${index + 1})`).classList.add('active')
  document.getElementById(`tab-${tab}`).style.display = 'block'
  
  if (tab === 'history') loadHistory()
}

async function startCamera() {
  try {
    document.getElementById('startBtn').style.display = 'none'
    document.getElementById('stopBtn').style.display = 'block'
    document.getElementById('videoContainer').classList.add('active')
    document.getElementById('customerCard').style.display = 'none'
    
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    })
    video.srcObject = stream
    
    video.onloadedmetadata = () => {
      video.play()
      scanning = true
      requestAnimationFrame(scanQR)
      showResult('scanResult', 'üì∏ Kamera aktiv', true)
    }
  } catch (err) {
    showResult('scanResult', '‚ùå Kamera-Fehler: ' + err.message, false)
    document.getElementById('startBtn').style.display = 'block'
    document.getElementById('stopBtn').style.display = 'none'
  }
}

function stopCamera() {
  scanning = false
  if (stream) {
    stream.getTracks().forEach(track => track.stop())
    stream = null
  }
  video.srcObject = null
  document.getElementById('videoContainer').classList.remove('active')
  document.getElementById('startBtn').style.display = 'block'
  document.getElementById('stopBtn').style.display = 'none'
}

function scanQR() {
  if (!scanning) return
  
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth
    canvas.height = video.videoHeight
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
    
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
    const code = jsQR(imageData.data, imageData.width, imageData.height)
    
    if (code) {
      scanning = false
      stopCamera()
      onQRDetected(code.data)
      return
    }
  }
  
  requestAnimationFrame(scanQR)
}

async function onQRDetected(qrCode) {
  showResult('scanResult', '‚úÖ QR erkannt: ' + qrCode, true)
  
  try {
    const { data, error } = await supabase.rpc('get_customer_by_qr', { p_qr_id: qrCode })
    
    if (error) throw error
    if (!data.ok) throw new Error('Kunde nicht gefunden')
    
    currentCustomer = {
      qr_id: data.qr_id,
      name: data.name,
      phone: data.phone,
      points: data.points
    }
    
    document.getElementById('custName').textContent = data.name
    document.getElementById('custQR').textContent = data.qr_id
    document.getElementById('custPoints').textContent = data.points
    document.getElementById('customerCard').style.display = 'block'
    document.getElementById('scannedAmount').value = ''
    document.getElementById('scannedAmount').focus()
  } catch (e) {
    showResult('scanResult', '‚ùå ' + e.message, false)
    setTimeout(() => {
      document.getElementById('scanResult').innerHTML = ''
      startCamera()
    }, 2000)
  }
}

async function addPointsFromScan() {
  const amount = parseFloat(document.getElementById('scannedAmount').value)
  if (!amount || amount <= 0) {
    showResult('addPointsResult', '‚ùå Betrag eingeben!', false)
    return
  }
  
  try {
    const { data, error } = await supabase.rpc('add_points', {
      p_qr_id: currentCustomer.qr_id,
      p_amount: amount,
      p_staff: 'SCANNER'
    })
    
    if (error) throw error
    
    alert(`‚úÖ ERFOLGREICH!\n\nKunde: ${currentCustomer.name}\nBetrag: ${amount.toFixed(2)} ‚Ç¨\nPunkte: +${data.added}\nNeuer Stand: ${data.points}`)
    
    document.getElementById('customerCard').style.display = 'none'
    document.getElementById('scanResult').innerHTML = ''
    document.getElementById('scannedAmount').value = ''
  } catch (e) {
    alert('‚ùå FEHLER!\n\n' + e.message)
  }
}

async function addPointsByPhone() {
  const phone = document.getElementById('phone').value.trim()
  const amount = parseFloat(document.getElementById('amount').value)
  
  if (!phone) {
    showResult('phoneResult', '‚ùå Handynummer eingeben!', false)
    return
  }
  if (!amount || amount <= 0) {
    showResult('phoneResult', '‚ùå Betrag eingeben!', false)
    return
  }
  
  try {
    // Erst Kunde finden
    const { data: customer, error: findErr } = await supabase.rpc('get_customer_by_phone', { p_phone: phone })
    if (findErr) throw findErr
    if (!customer.ok) throw new Error('Handynummer nicht gefunden')
    
    // Dann Punkte gutschreiben
    const { data, error } = await supabase.rpc('add_points', {
      p_qr_id: customer.qr_id,
      p_amount: amount,
      p_staff: 'SCANNER'
    })
    
    if (error) throw error
    
    showResult('phoneResult', 
      `‚úÖ Erfolgreich!<br>Kunde: ${customer.name}<br>Betrag: ${amount.toFixed(2)} ‚Ç¨<br>Punkte: +${data.added}<br>Neuer Stand: ${data.points}`,
      true)
    
    document.getElementById('phone').value = ''
    document.getElementById('amount').value = ''
  } catch (e) {
    showResult('phoneResult', '‚ùå ' + e.message, false)
  }
}

async function loadHistory() {
  try {
    const today = new Date().toISOString().split('T')[0]
    
    const { data, error } = await supabase
      .from('transactions')
      .select(`
        id,
        customer_id,
        amount_eur,
        points,
        created_at,
        customers (name, phone, qr_id)
      `)
      .eq('type', 'credit')
      .gte('created_at', today)
      .order('created_at', { ascending: false })
    
    if (error) throw error
    
    const list = document.getElementById('historyList')
    
    if (!data || data.length === 0) {
      list.innerHTML = '<div class="info" style="text-align:center;padding:20px">Noch keine Scans heute</div>'
      return
    }
    
    list.innerHTML = data.map(tx => {
      const time = new Date(tx.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
      const customer = tx.customers
      
      return `
        <div class="history-item">
          <div class="history-header">
            <div class="history-customer">${customer.name}</div>
            <div class="history-time">${time}</div>
          </div>
          <div class="history-details">
            <div>üì± ${customer.phone}</div>
            <div>üÜî ${customer.qr_id}</div>
            <div class="history-amount">üí∞ ${tx.amount_eur.toFixed(2)} ‚Ç¨</div>
            <div class="history-points">‚≠ê ${tx.points} Punkte</div>
          </div>
          <div class="history-actions">
            <button class="small secondary" onclick="editTransaction('${tx.id}', '${customer.qr_id}', ${tx.amount_eur}, ${tx.points})">‚úèÔ∏è Bearbeiten</button>
          </div>
          <div id="edit-${tx.id}" class="edit-form">
            <h4 style="margin-bottom:8px">Betrag korrigieren:</h4>
            <input type="number" step="0.01" id="newAmount-${tx.id}" value="${tx.amount_eur}" style="margin-bottom:8px">
            <div class="info" style="margin-bottom:8px">Neue Punkte: <strong id="newPoints-${tx.id}">${tx.points}</strong></div>
            <div class="two-col">
              <button class="small success" onclick="saveEdit('${tx.id}', '${customer.qr_id}', ${tx.points})">üíæ Speichern</button>
              <button class="small danger" onclick="cancelEdit('${tx.id}')">‚ùå Abbrechen</button>
            </div>
          </div>
        </div>
      `
    }).join('')
  } catch (e) {
    document.getElementById('historyList').innerHTML = `<div class="error">${e.message}</div>`
  }
}

function editTransaction(txId, qrId, oldAmount, oldPoints) {
  document.getElementById(`edit-${txId}`).classList.add('active')
  
  const input = document.getElementById(`newAmount-${txId}`)
  input.oninput = () => {
    const newAmount = parseFloat(input.value) || 0
    const newPoints = Math.round(newAmount * 10)
    document.getElementById(`newPoints-${txId}`).textContent = newPoints
  }
}

function cancelEdit(txId) {
  document.getElementById(`edit-${txId}`).classList.remove('active')
}

async function saveEdit(txId, qrId, oldPoints) {
  const newAmount = parseFloat(document.getElementById(`newAmount-${txId}`).value)
  const newPoints = Math.round(newAmount * 10)
  const diff = newPoints - oldPoints
  
  if (!confirm(`Betrag √§ndern?\n\nAlte Punkte: ${oldPoints}\nNeue Punkte: ${newPoints}\nDifferenz: ${diff > 0 ? '+' : ''}${diff}`)) return
  
  try {
    // Update transaction
    const { error: txErr } = await supabase
      .from('transactions')
      .update({ amount_eur: newAmount, points: newPoints })
      .eq('id', txId)
    
    if (txErr) throw txErr
    
    // Update customer points
    const { data: customer } = await supabase.rpc('get_customer_by_qr', { p_qr_id: qrId })
    if (customer.ok) {
      const { error: custErr } = await supabase
        .from('customers')
        .update({ points: customer.points + diff })
        .eq('qr_id', qrId)
      
      if (custErr) throw custErr
    }
    
    alert('‚úÖ Erfolgreich ge√§ndert!')
    loadHistory()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

async function verifyCode() {
  const code = document.getElementById('code').value.toUpperCase().trim()
  
  if (!code || code.length !== 6) {
    showResult('codeResult', '‚ùå 6-stelligen Code eingeben!', false)
    return
  }
  
  try {
    const { data, error } = await supabase.rpc('verify_code', { p_code: code })
    
    if (error) throw error
    
    showResult('codeResult', 
      `‚úÖ Code g√ºltig!<br>Pr√§mie: <strong>${data.reward_name}</strong><br>Kosten: ${data.points_cost} Punkte<br><br>üëâ Pr√§mie ausgeben!`,
      true)
    
    document.getElementById('code').value = ''
  } catch (e) {
    let msg = e.message
    if (msg.includes('not_found')) msg = 'Code nicht gefunden'
    if (msg.includes('already_used')) msg = 'Code bereits verwendet'
    if (msg.includes('expired')) msg = 'Code abgelaufen'
    
    showResult('codeResult', '‚ùå ' + msg, false)
  }
}

console.log('‚úÖ Scanner PRO geladen!')
</script>

</body>
</html>
