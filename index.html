<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂nerkings Scanner</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 800px; margin: 0 auto; }
.card {
  background: white;
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h1 { color: #667eea; margin-bottom: 10px; }
h2 { font-size: 18px; margin-bottom: 12px; }
input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 16px;
  margin-bottom: 10px;
}
button {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
}
button:hover { opacity: 0.9; }
.result {
  padding: 12px;
  border-radius: 8px;
  margin-top: 10px;
  font-size: 14px;
}
.success { background: #d1fae5; color: #065f46; }
.error { background: #fee2e2; color: #991b1b; }
.info { color: #666; font-size: 14px; margin-top: 8px; }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>üåØ D√∂nerkings Scanner</h1>
    <div class="info">Status: <span id="status">L√§dt...</span></div>
  </div>

  <div class="card">
    <h2>üîê Mitarbeiter Login</h2>
    <input id="email" type="email" placeholder="E-Mail">
    <input id="password" type="password" placeholder="Passwort">
    <button onclick="login()">Anmelden</button>
    <button onclick="logout()" style="background: #6b7280;">Abmelden</button>
    <div id="loginResult"></div>
  </div>

  <div class="card">
    <h2>üß™ Test: Kunde anlegen</h2>
    <input id="testName" placeholder="Name (z.B. Max Mustermann)" value="Test Kunde">
    <input id="testPhone" placeholder="Telefon (z.B. 0151...)" value="01511234567">
    <button onclick="createTestCustomer()">Kunde erstellen</button>
    <div id="testResult"></div>
  </div>

  <div class="card">
    <h2>üì± Punkte gutschreiben</h2>
    <input id="qrId" placeholder="QR-ID des Kunden">
    <input id="amount" type="number" step="0.01" placeholder="Betrag in ‚Ç¨ (z.B. 7.50)">
    <button onclick="addPoints()">Punkte gutschreiben</button>
    <div id="pointsResult"></div>
  </div>

  <div class="card">
    <h2>üéÅ Code pr√ºfen</h2>
    <input id="code" placeholder="6-stelliger Code (z.B. ABC123)" style="text-transform: uppercase;">
    <button onclick="verifyCode()">Code verifizieren</button>
    <div id="codeResult"></div>
  </div>
</div>

<!-- Supabase Library (CDN - funktioniert garantiert!) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ========================================
// HIER DEINE URLS EINTRAGEN! (bereits gesetzt)
// ========================================
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'

// Supabase Client erstellen
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

// Status anzeigen
document.getElementById('status').textContent = 'Bereit ‚úÖ'

// Hilfsfunktion f√ºr Nachrichten
function showResult(elementId, message, isSuccess) {
  const el = document.getElementById(elementId)
  el.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">${message}</div>`
}

// LOGIN
async function login() {
  const email = document.getElementById('email').value
  const password = document.getElementById('password').value
  
  if (!email || !password) {
    showResult('loginResult', 'Bitte E-Mail und Passwort eingeben!', false)
    return
  }
  
  const { data, error } = await supabase.auth.signInWithPassword({
    email: email,
    password: password
  })
  
  if (error) {
    showResult('loginResult', '‚ùå Login fehlgeschlagen: ' + error.message, false)
  } else {
    showResult('loginResult', '‚úÖ Erfolgreich angemeldet als: ' + data.user.email, true)
    document.getElementById('status').textContent = 'Angemeldet: ' + data.user.email
  }
}

// LOGOUT
async function logout() {
  await supabase.auth.signOut()
  showResult('loginResult', 'Abgemeldet', true)
  document.getElementById('status').textContent = 'Nicht angemeldet'
}

// TEST-KUNDE ERSTELLEN
async function createTestCustomer() {
  const name = document.getElementById('testName').value || 'Test Kunde'
  const phone = document.getElementById('testPhone').value || '01511234567'
  
  try {
    // Generiere zuf√§llige QR-ID
    const qrId = 'TEST-' + Math.random().toString(36).substr(2, 6).toUpperCase()
    
    // Kunde in DB einf√ºgen
    const { data, error } = await supabase
      .from('customers')
      .insert({
        name: name,
        phone: phone,
        qr_id: qrId,
        points: 0
      })
      .select()
      .single()
    
    if (error) throw error
    
    showResult('testResult', 
      `‚úÖ Kunde erstellt!<br>
      Name: ${data.name}<br>
      Telefon: ${data.phone}<br>
      QR-ID: <strong>${data.qr_id}</strong><br>
      Punkte: ${data.points}<br><br>
      üëâ Kopiere die QR-ID f√ºr den n√§chsten Schritt!`, 
      true)
    
    // QR-ID automatisch ins Feld eintragen
    document.getElementById('qrId').value = data.qr_id
    
  } catch (e) {
    showResult('testResult', '‚ùå Fehler: ' + e.message, false)
  }
}

// PUNKTE GUTSCHREIBEN
async function addPoints() {
  const qrId = document.getElementById('qrId').value
  const amount = parseFloat(document.getElementById('amount').value)
  
  if (!qrId) {
    showResult('pointsResult', '‚ùå Bitte QR-ID eingeben!', false)
    return
  }
  
  if (!amount || amount <= 0) {
    showResult('pointsResult', '‚ùå Bitte g√ºltigen Betrag eingeben!', false)
    return
  }
  
  try {
    const { data, error } = await supabase.rpc('add_points', {
      p_qr_id: qrId,
      p_amount: amount,
      p_staff: 'SCANNER'
    })
    
    if (error) throw error
    
    showResult('pointsResult', 
      `‚úÖ Erfolgreich gutgeschrieben!<br>
      Betrag: ${amount.toFixed(2)} ‚Ç¨<br>
      Gutgeschriebene Punkte: ${data.added}<br>
      Neuer Punktestand: ${data.points}`, 
      true)
    
    // Felder leeren
    document.getElementById('amount').value = ''
    
  } catch (e) {
    showResult('pointsResult', '‚ùå Fehler: ' + e.message, false)
  }
}

// CODE VERIFIZIEREN
async function verifyCode() {
  const code = document.getElementById('code').value.toUpperCase()
  
  if (!code || code.length !== 6) {
    showResult('codeResult', '‚ùå Bitte 6-stelligen Code eingeben!', false)
    return
  }
  
  try {
    const { data, error } = await supabase.rpc('verify_code', {
      p_code: code
    })
    
    if (error) throw error
    
    showResult('codeResult', 
      `‚úÖ Code g√ºltig!<br>
      Pr√§mie: <strong>${data.reward_name}</strong><br>
      Kosten: ${data.points_cost} Punkte<br><br>
      üëâ Pr√§mie kann ausgegeben werden!`, 
      true)
    
    document.getElementById('code').value = ''
    
  } catch (e) {
    let errorMsg = e.message
    if (errorMsg.includes('not_found')) errorMsg = 'Code nicht gefunden'
    if (errorMsg.includes('already_used')) errorMsg = 'Code wurde bereits verwendet'
    if (errorMsg.includes('expired')) errorMsg = 'Code ist abgelaufen'
    
    showResult('codeResult', '‚ùå ' + errorMsg, false)
  }
}

console.log('‚úÖ App geladen und bereit!')
</script>

</body>
</html>
