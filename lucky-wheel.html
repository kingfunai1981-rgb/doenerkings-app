<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Wheel - D√∂ner Boxx</title>
<link rel="icon" href="/favicon.png" type="image/png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.container {
  max-width: 600px;
  width: 100%;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.header {
  text-align: center;
  margin-bottom: 30px;
}

.header-logo {
  width: 80px;
  height: 80px;
  margin: 0 auto 16px;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  clip-path: circle(50%);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

h1 {
  color: #E31E24;
  font-size: 32px;
  margin-bottom: 8px;
}

.subtitle {
  color: #666;
  font-size: 16px;
}

.wheel-container {
  position: relative;
  width: 100%;
  max-width: 400px;
  margin: 0 auto 30px;
}

.wheel-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
}

canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  cursor: pointer;
}

.wheel-pointer {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 20px solid transparent;
  border-right: 20px solid transparent;
  border-top: 40px solid #E31E24;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  z-index: 10;
}

.wheel-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100px;
  height: 100px;
  background: white;
  border: 5px solid #333;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 5;
  pointer-events: none;
  padding: 12px;
}

.wheel-center img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.spin-button {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Flame', sans-serif;
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.3);
}

.spin-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(227, 30, 36, 0.4);
}

.spin-button:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.result-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.result-modal.active {
  display: flex;
}

.result-content {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes popIn {
  0% { transform: scale(0.5); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.result-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.result-title {
  font-size: 28px;
  font-weight: 700;
  color: #E31E24;
  margin-bottom: 12px;
}

.result-prize {
  font-size: 22px;
  color: #333;
  margin-bottom: 24px;
}

.result-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Flame', sans-serif;
}

.info-box {
  background: #f9fafb;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  text-align: center;
}

.info-box .timer {
  font-size: 24px;
  font-weight: 700;
  color: #E31E24;
  margin-top: 8px;
}

.test-controls {
  margin-top: 30px;
  padding: 20px;
  background: #f9fafb;
  border-radius: 12px;
  border: 2px dashed #ccc;
}

.test-controls h3 {
  color: #666;
  font-size: 16px;
  margin-bottom: 12px;
}

.test-controls input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 8px;
  font-family: 'Flame', sans-serif;
}

.test-controls button {
  width: 100%;
  padding: 12px;
  background: #6b7280;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  margin-top: 4px;
  font-family: 'Flame', sans-serif;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-logo">
      <img src="/logo-round.png" alt="D√∂ner Boxx">
    </div>
    <h1>üé° Lucky Wheel</h1>
    <p class="subtitle">Drehe am Gl√ºcksrad und gewinne tolle Preise!</p>
  </div>

  <div class="wheel-container">
    <div class="wheel-wrapper">
      <div class="wheel-pointer"></div>
      <canvas id="wheel" width="400" height="400"></canvas>
    </div>
  </div>

  <button id="spinButton" class="spin-button" onclick="spinWheel()">
    üé∞ Jetzt drehen!
  </button>

  <div class="info-box">
    <div id="spinInfo">Du kannst 1x pro Tag drehen</div>
    <div id="timer" class="timer" style="display: none;"></div>
  </div>

  <!-- Test Controls -->
  <div class="test-controls">
    <h3>üß™ Test-Steuerung (nur f√ºr Demo)</h3>
    <input id="testCustomerId" type="text" placeholder="Test Kunden-ID (z.B. 1)" value="1">
    <button onclick="resetSpin()">üîÑ Spin zur√ºcksetzen (nochmal drehen)</button>
    <button onclick="loadTestPrizes()">üéÅ Test-Preise laden</button>
  </div>
</div>

<!-- Result Modal -->
<div id="resultModal" class="result-modal">
  <div class="result-content">
    <div class="result-icon" id="resultIcon">üéâ</div>
    <div class="result-title" id="resultTitle">Gewonnen!</div>
    <div class="result-prize" id="resultPrize">100 Punkte</div>
    <button class="result-button" onclick="closeResult()">Weiter</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

const canvas = document.getElementById('wheel')
const ctx = canvas.getContext('2d')
let rotation = 0
let isSpinning = false
let testCustomerId = 1

// Wheel-Segmente (18 Felder) - Anordnung: rot, s, w, s, w, s, w, s, w, rot, w, s, w, s, w, s, w, s
const prizes = [
  { label: 'D√ñNER', color: '#E31E24', textColor: '#FFFFFF', type: 'reward', value: 'D√∂ner' },           // 1. ROT
  { label: '50 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },           // 2. SCHWARZ
  { label: 'AYRAN', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Ayran (0.25 l)' }, // 3. WEISS
  { label: '100 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 100 },         // 4. SCHWARZ
  { label: 'POMMES', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Pommes' },        // 5. WEISS
  { label: '75 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },           // 6. SCHWARZ
  { label: 'COLA', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Cola (0.33 l)' },   // 7. WEISS
  { label: '150 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 150 },         // 8. SCHWARZ
  { label: 'AYRAN', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Ayran (0.25 l)' }, // 9. WEISS
  { label: 'D√ñNER', color: '#E31E24', textColor: '#FFFFFF', type: 'reward', value: 'D√∂ner' },          // 10. ROT
  { label: '200 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 200 },         // 11. WEISS
  { label: '50 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },           // 12. SCHWARZ
  { label: 'POMMES', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Pommes' },        // 13. WEISS
  { label: '100 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 100 },         // 14. SCHWARZ
  { label: 'COLA', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Cola (0.33 l)' },   // 15. WEISS
  { label: '75 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },           // 16. SCHWARZ
  { label: 'AYRAN', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Ayran (0.25 l)' }, // 17. WEISS
  { label: '250 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 250 }          // 18. SCHWARZ
]

const logoImg = new Image()
logoImg.src = '/logo-round.png'

function drawWheel() {
  const centerX = canvas.width / 2
  const centerY = canvas.height / 2
  const radius = canvas.width / 2 - 10

  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.save()
  ctx.translate(centerX, centerY)
  ctx.rotate(rotation)

  const totalSegments = prizes.length
  const anglePerSegment = (2 * Math.PI) / totalSegments

  prizes.forEach((prize, i) => {
    const startAngle = i * anglePerSegment
    const endAngle = startAngle + anglePerSegment

    // Draw segment (ohne Striche)
    ctx.beginPath()
    ctx.moveTo(0, 0)
    ctx.arc(0, 0, radius, startAngle, endAngle)
    ctx.closePath()
    ctx.fillStyle = prize.color
    ctx.fill()

    // Draw text (rotated)
    ctx.save()
    ctx.rotate(startAngle + anglePerSegment / 2)
    ctx.textAlign = 'center'
    ctx.textBaseline = 'middle'
    ctx.fillStyle = prize.textColor
    
    // Split text into words for better layout
    const words = prize.label.split(' ')
    if (words.length === 1) {
      ctx.font = 'bold 16px Flame, Arial'
      ctx.fillText(prize.label, radius * 0.65, 0)
    } else {
      ctx.font = 'bold 14px Flame, Arial'
      ctx.fillText(words[0], radius * 0.65, -8)
      ctx.fillText(words[1], radius * 0.65, 8)
    }
    
    ctx.restore()
  })

  // Draw center circle with logo (ohne schwarzen Ring)
  ctx.beginPath()
  ctx.arc(0, 0, 50, 0, 2 * Math.PI)
  ctx.fillStyle = 'white'
  ctx.fill()

  // Draw logo in center
  if (logoImg.complete) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(0, 0, 40, 0, 2 * Math.PI)
    ctx.clip()
    ctx.drawImage(logoImg, -40, -40, 80, 80)
    ctx.restore()
  }

  ctx.restore()
}

function getRandomPrize() {
  // Crypto-secure random number (alle Felder gleich wahrscheinlich)
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  const randomIndex = Math.floor((array[0] / (0xFFFFFFFF + 1)) * prizes.length)
  return prizes[randomIndex]
}

async function canSpin() {
  try {
    const customerId = parseInt(document.getElementById('testCustomerId').value) || testCustomerId
    const today = new Date().toISOString().split('T')[0]
    
    const { data, error } = await supabase
      .from('wheel_spins')
      .select('*')
      .eq('customer_id', customerId)
      .gte('created_at', today + 'T00:00:00')
    
    if (error) {
      console.log('‚ö†Ô∏è Tabelle wheel_spins existiert nicht - erstelle sie sp√§ter')
      return true
    }
    
    return !data || data.length === 0
  } catch (e) {
    console.log('‚ö†Ô∏è Fehler bei canSpin:', e)
    return true
  }
}

async function spinWheel() {
  if (isSpinning) return
  
  const canSpinNow = await canSpin()
  if (!canSpinNow) {
    alert('‚ùå Du hast heute bereits gedreht! Komm morgen wieder.')
    return
  }

  isSpinning = true
  document.getElementById('spinButton').disabled = true

  const winningPrize = getRandomPrize()
  const winningIndex = prizes.indexOf(winningPrize)
  const anglePerSegment = (2 * Math.PI) / prizes.length
  
  // Calculate target rotation (pointer at top)
  const targetAngle = winningIndex * anglePerSegment + anglePerSegment / 2
  const spins = 5 // Number of full rotations
  const totalRotation = spins * 2 * Math.PI + (2 * Math.PI - targetAngle)

  const startTime = Date.now()
  const duration = 4000 // 4 seconds

  function animate() {
    const elapsed = Date.now() - startTime
    const progress = Math.min(elapsed / duration, 1)
    
    // Easing function (ease out cubic)
    const easeOut = 1 - Math.pow(1 - progress, 3)
    
    rotation = easeOut * totalRotation
    drawWheel()

    if (progress < 1) {
      requestAnimationFrame(animate)
    } else {
      isSpinning = false
      showResult(winningPrize)
      saveSpin(winningPrize)
    }
  }

  animate()
}

function showResult(prize) {
  const modal = document.getElementById('resultModal')
  const icon = document.getElementById('resultIcon')
  const title = document.getElementById('resultTitle')
  const prizeText = document.getElementById('resultPrize')

  // Icon basierend auf Preis-Typ
  if (prize.type === 'points') {
    icon.textContent = '‚≠ê'
  } else if (prize.type === 'reward') {
    if (prize.label.includes('D√ñNER')) icon.textContent = 'üçî'
    else if (prize.label.includes('AYRAN')) icon.textContent = 'ü•§'
    else if (prize.label.includes('COLA')) icon.textContent = 'ü•§'
    else if (prize.label.includes('POMMES')) icon.textContent = 'üçü'
    else icon.textContent = 'üéÅ'
  } else {
    icon.textContent = 'üéâ'
  }

  title.textContent = 'Gl√ºckwunsch! üéâ'
  prizeText.textContent = prize.label

  modal.classList.add('active')
}

function closeResult() {
  document.getElementById('resultModal').classList.remove('active')
  updateSpinInfo()
}

async function saveSpin(prize) {
  try {
    const customerId = parseInt(document.getElementById('testCustomerId').value) || testCustomerId
    
    await supabase.from('wheel_spins').insert({
      customer_id: customerId,
      prize_type: prize.type,
      prize_value: prize.value.toString(),
      prize_label: prize.label
    })
    
    console.log('‚úÖ Spin gespeichert:', prize.label)
  } catch (e) {
    console.log('‚ö†Ô∏è Fehler beim Speichern:', e)
  }
}

async function updateSpinInfo() {
  const canSpinNow = await canSpin()
  const button = document.getElementById('spinButton')
  const info = document.getElementById('spinInfo')
  
  if (canSpinNow) {
    button.disabled = false
    info.textContent = 'Du kannst 1x pro Tag drehen'
  } else {
    button.disabled = true
    info.textContent = 'Heute bereits gedreht! Komm morgen wieder üé°'
  }
}

async function resetSpin() {
  const customerId = parseInt(document.getElementById('testCustomerId').value) || testCustomerId
  const today = new Date().toISOString().split('T')[0]
  
  try {
    await supabase
      .from('wheel_spins')
      .delete()
      .eq('customer_id', customerId)
      .gte('created_at', today + 'T00:00:00')
    
    alert('‚úÖ Spin zur√ºckgesetzt! Du kannst jetzt nochmal drehen.')
    updateSpinInfo()
  } catch (e) {
    console.log('‚ö†Ô∏è Fehler beim Reset:', e)
  }
}

function loadTestPrizes() {
  const prizeList = prizes.map(p => `${p.label} (${p.color === '#E31E24' ? 'ROT' : p.color === '#000000' ? 'SCHWARZ' : 'WEISS'})`).join('\n')
  alert('üéÅ 18 Felder geladen:\n\n' + prizeList + '\n\n2x D√ñNER in ROT!')
}

// Initialize
logoImg.onload = () => {
  drawWheel()
}
drawWheel()
updateSpinInfo()

// Canvas Click-Event
canvas.addEventListener('click', spinWheel)

console.log('‚úÖ Lucky Wheel geladen!')
console.log('üé° 18 Felder:', prizes.map(p => p.label))
</script>

</body>
</html>
