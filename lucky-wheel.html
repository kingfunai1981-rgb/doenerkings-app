<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Wheel - D√∂ner Boxx</title>
<link rel="icon" href="/favicon.png" type="image/png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.container {
  max-width: 600px;
  width: 100%;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.header {
  text-align: center;
  margin-bottom: 30px;
}

.header-logo {
  width: 80px;
  height: 80px;
  margin: 0 auto 16px;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  clip-path: circle(50%);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

h1 {
  color: #E31E24;
  font-size: 32px;
  margin-bottom: 8px;
}

.subtitle {
  color: #666;
  font-size: 16px;
}

.wheel-container {
  position: relative;
  width: 100%;
  max-width: 400px;
  margin: 0 auto 30px;
}

.wheel-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
}

canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  cursor: pointer;
}

.wheel-pointer {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 20px solid transparent;
  border-right: 20px solid transparent;
  border-top: 40px solid #E31E24;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  z-index: 10;
}

.spin-button {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Flame', sans-serif;
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.3);
}

.spin-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(227, 30, 36, 0.4);
}

.spin-button:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.result-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.result-modal.active {
  display: flex;
}

.result-content {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes popIn {
  0% { transform: scale(0.5); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.result-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.result-title {
  font-size: 28px;
  font-weight: 700;
  color: #E31E24;
  margin-bottom: 12px;
}

.result-prize {
  font-size: 22px;
  color: #333;
  margin-bottom: 24px;
}

.result-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Flame', sans-serif;
}

.info-box {
  background: #f9fafb;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  text-align: center;
}

.test-controls {
  margin-top: 30px;
  padding: 20px;
  background: #f9fafb;
  border-radius: 12px;
  border: 2px dashed #ccc;
}

.test-controls h3 {
  color: #666;
  font-size: 16px;
  margin-bottom: 12px;
}

.test-controls input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 8px;
  font-family: 'Flame', sans-serif;
}

.test-controls button {
  width: 100%;
  padding: 12px;
  background: #6b7280;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  margin-top: 4px;
  font-family: 'Flame', sans-serif;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-logo">
      <img src="/logo-round.png" alt="D√∂ner Boxx">
    </div>
    <h1>üé° Lucky Wheel</h1>
    <p class="subtitle">Drehe am Gl√ºcksrad und gewinne tolle Preise!</p>
  </div>

  <div class="wheel-container">
    <div class="wheel-wrapper">
      <div class="wheel-pointer"></div>
      <canvas id="wheel" width="400" height="400"></canvas>
    </div>
  </div>

  <button id="spinButton" class="spin-button" onclick="spinWheel()">
    üé∞ Jetzt drehen!
  </button>

  <div class="info-box">
    <div id="spinInfo">Du kannst 1x pro Tag drehen</div>
  </div>

  <div class="test-controls">
    <h3>üõ†Ô∏è Test-Steuerung</h3>
    <input type="number" id="testCustomerId" placeholder="Kunden-ID" value="1">
    <button onclick="resetSpin()">üîÑ Spin zur√ºcksetzen</button>
    <button onclick="loadTestPrizes()">üìã Alle Preise anzeigen</button>
  </div>
</div>

<div id="resultModal" class="result-modal">
  <div class="result-content">
    <div class="result-icon" id="resultIcon">üéâ</div>
    <div class="result-title" id="resultTitle">Gewonnen!</div>
    <div class="result-prize" id="resultPrize">100 Punkte</div>
    <button class="result-button" onclick="closeResult()">Weiter</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

const canvas = document.getElementById('wheel')
const ctx = canvas.getContext('2d')

const anglePerSegment = (2 * Math.PI) / 18

// üî¥ WICHTIG: Fester Offset-Winkel
// Zeiger zeigt nach oben = -90¬∞ = -œÄ/2
// Wir wollen dass D√ñNER (Feld 0) genau unter dem Zeiger ist
// Das bedeutet: Die Mitte von Feld 0 muss bei -90¬∞ sein
// Feld 0 geht von 0¬∞ bis anglePerSegment, Mitte ist bei anglePerSegment/2
// Offset = -90¬∞ - anglePerSegment/2
const OFFSET = -Math.PI / 2 - anglePerSegment / 2

// Rotation startet bei 0 - wir zeichnen die Felder mit OFFSET
let rotation = 0
let isSpinning = false
let testCustomerId = 1

const prizes = [
  { label: 'D√ñNER', color: '#E31E24', textColor: '#FFFFFF', type: 'reward', value: 'D√∂ner' },
  { label: '50 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },
  { label: 'AYRAN', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Ayran (0.25 l)' },
  { label: '100 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 100 },
  { label: 'POMMES', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Pommes' },
  { label: '75 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },
  { label: 'COLA', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Cola (0.33 l)' },
  { label: '150 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 150 },
  { label: 'AYRAN', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Ayran (0.25 l)' },
  { label: 'D√ñNER', color: '#E31E24', textColor: '#FFFFFF', type: 'reward', value: 'D√∂ner' },
  { label: '200 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 200 },
  { label: '50 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },
  { label: 'POMMES', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Pommes' },
  { label: '100 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 100 },
  { label: 'COLA', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Cola (0.33 l)' },
  { label: '75 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },
  { label: 'AYRAN', color: '#FFFFFF', textColor: '#000000', type: 'reward', value: 'Ayran (0.25 l)' },
  { label: '250 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 250 }
]

const logoImg = new Image()
logoImg.src = '/logo-round.png'

function drawWheel() {
  const centerX = canvas.width / 2
  const centerY = canvas.height / 2
  const radius = canvas.width / 2 - 5

  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.save()
  ctx.translate(centerX, centerY)
  ctx.rotate(rotation + OFFSET)  // üî¥ OFFSET hier anwenden!

  // Zeichne Segmente (beginnen bei 0¬∞ im rotierten System)
  prizes.forEach((prize, i) => {
    const startAngle = i * anglePerSegment
    const endAngle = startAngle + anglePerSegment

    ctx.beginPath()
    ctx.moveTo(0, 0)
    ctx.arc(0, 0, radius, startAngle, endAngle)
    ctx.closePath()
    ctx.fillStyle = prize.color
    ctx.fill()

    ctx.save()
    ctx.rotate(startAngle + anglePerSegment / 2)
    ctx.textAlign = 'center'
    ctx.textBaseline = 'middle'
    ctx.fillStyle = prize.textColor
    
    const words = prize.label.split(' ')
    if (words.length === 1) {
      ctx.font = 'bold 16px Flame, Arial'
      ctx.fillText(prize.label, radius * 0.7, 0)
    } else {
      ctx.font = 'bold 14px Flame, Arial'
      ctx.fillText(words[0], radius * 0.7, -8)
      ctx.fillText(words[1], radius * 0.7, 8)
    }
    ctx.restore()
  })

  ctx.restore()
  
  // Logo SEPARAT zeichnen - OHNE Rotation
  ctx.save()
  ctx.translate(centerX, centerY)
  
  const centerRadius = 48
  const logoRadius = 47.8
  
  ctx.beginPath()
  ctx.arc(0, 0, centerRadius, 0, 2 * Math.PI)
  ctx.fillStyle = 'white'
  ctx.fill()

  if (logoImg.complete) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(0, 0, logoRadius, 0, 2 * Math.PI)
    ctx.clip()
    ctx.drawImage(logoImg, -logoRadius, -logoRadius, logoRadius * 2, logoRadius * 2)
    ctx.restore()
  }
  
  ctx.restore()
}

function getRandomPrize() {
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  const randomIndex = Math.floor((array[0] / (0xFFFFFFFF + 1)) * prizes.length)
  return prizes[randomIndex]
}

async function canSpin() {
  try {
    const customerId = parseInt(document.getElementById('testCustomerId').value) || testCustomerId
    const today = new Date().toISOString().split('T')[0]
    
    const { data, error } = await supabase
      .from('wheel_spins')
      .select('*')
      .eq('customer_id', customerId)
      .gte('created_at', today + 'T00:00:00')
    
    if (error) {
      console.log('‚ö†Ô∏è Tabelle wheel_spins existiert nicht')
      return true
    }
    
    return !data || data.length === 0
  } catch (e) {
    console.log('‚ö†Ô∏è Fehler bei canSpin:', e)
    return true
  }
}

async function spinWheel() {
  if (isSpinning) return
  
  const canSpinNow = await canSpin()
  if (!canSpinNow) {
    alert('‚ùå Du hast heute bereits gedreht! Komm morgen wieder.')
    return
  }

  isSpinning = true
  document.getElementById('spinButton').disabled = true

  const winningPrize = getRandomPrize()
  const winningIndex = prizes.indexOf(winningPrize)
  
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  const randomOffset = ((array[0] / 0xFFFFFFFF) - 0.5) * 0.6 * anglePerSegment
  
  // 5-7 volle Drehungen
  const spins = 5 + Math.floor((array[0] / 0xFFFFFFFF) * 3)
  const baseRotation = spins * 2 * Math.PI
  
  // üî¥ WICHTIG: Berechnung OHNE OFFSET
  // rotation ist die "reine" Drehung, OFFSET wird nur beim Zeichnen addiert
  // Wir wollen dass Feld winningIndex unter dem Zeiger (-90¬∞) landet
  // Feld i hat Mitte bei: i * anglePerSegment + anglePerSegment/2 (im System ohne OFFSET)
  // Mit OFFSET ist die Mitte bei: i * anglePerSegment + anglePerSegment/2 + OFFSET
  // Das soll bei -90¬∞ landen, also:
  // rotation + OFFSET + fieldMidAngle = -œÄ/2
  // rotation = -œÄ/2 - OFFSET - fieldMidAngle
  
  const fieldMidAngle = winningIndex * anglePerSegment + anglePerSegment / 2 + randomOffset
  const targetRotation = -Math.PI / 2 - OFFSET - fieldMidAngle
  
  // Normalisiere auf Bereich um aktuelle rotation
  let normalizedTarget = targetRotation
  while (normalizedTarget > rotation) {
    normalizedTarget -= 2 * Math.PI
  }
  
  const totalRotation = baseRotation + (normalizedTarget - rotation)

  const startRotation = rotation
  const startTime = Date.now()
  const duration = 4000 + Math.floor((array[0] / 0xFFFFFFFF) * 1000)

  function animate() {
    const elapsed = Date.now() - startTime
    const progress = Math.min(elapsed / duration, 1)
    const easeOut = 1 - Math.pow(1 - progress, 4)
    
    rotation = startRotation + (easeOut * totalRotation)
    drawWheel()

    if (progress < 1) {
      requestAnimationFrame(animate)
    } else {
      isSpinning = false
      
      // üî¥ GEWINN-BERECHNUNG mit OFFSET
      // Zeiger ist bei -90¬∞
      // Welches Feld ist dort?
      // rotation + OFFSET + fieldMidAngle = -œÄ/2
      // fieldMidAngle = -œÄ/2 - rotation - OFFSET
      
      let normalizedRotation = rotation % (2 * Math.PI)
      if (normalizedRotation > Math.PI) normalizedRotation -= 2 * Math.PI
      if (normalizedRotation < -Math.PI) normalizedRotation += 2 * Math.PI
      
      let fieldAngle = -Math.PI / 2 - normalizedRotation - OFFSET
      if (fieldAngle < 0) fieldAngle += 2 * Math.PI
      
      const fieldIndex = Math.floor(fieldAngle / anglePerSegment) % prizes.length
      const actualPrize = prizes[fieldIndex]
      
      console.log('üéØ Sollte gewinnen:', winningPrize.label, '(Index:', winningIndex, ')')
      console.log('üéØ Hat gewonnen:', actualPrize.label, '(Index:', fieldIndex, ')')
      console.log('üìê Rotation:', normalizedRotation.toFixed(3), 'Field Angle:', fieldAngle.toFixed(3))
      
      showResult(actualPrize)
      saveSpin(actualPrize)
    }
  }

  animate()
}

function showResult(prize) {
  const modal = document.getElementById('resultModal')
  const icon = document.getElementById('resultIcon')
  const title = document.getElementById('resultTitle')
  const prizeText = document.getElementById('resultPrize')

  if (prize.type === 'points') {
    icon.textContent = '‚≠ê'
  } else if (prize.type === 'reward') {
    if (prize.label.includes('D√ñNER')) icon.textContent = 'üçî'
    else if (prize.label.includes('AYRAN')) icon.textContent = 'ü•§'
    else if (prize.label.includes('COLA')) icon.textContent = 'ü•§'
    else if (prize.label.includes('POMMES')) icon.textContent = 'üçü'
    else icon.textContent = 'üéÅ'
  } else {
    icon.textContent = 'üéâ'
  }

  title.textContent = 'Gl√ºckwunsch! üéâ'
  prizeText.textContent = prize.label

  modal.classList.add('active')
}

function closeResult() {
  document.getElementById('resultModal').classList.remove('active')
  updateSpinInfo()
}

async function saveSpin(prize) {
  try {
    const customerId = parseInt(document.getElementById('testCustomerId').value) || testCustomerId
    
    await supabase.from('wheel_spins').insert({
      customer_id: customerId,
      prize_type: prize.type,
      prize_value: prize.value.toString(),
      prize_label: prize.label
    })
    
    console.log('‚úÖ Spin gespeichert:', prize.label)
  } catch (e) {
    console.log('‚ö†Ô∏è Fehler beim Speichern:', e)
  }
}

async function updateSpinInfo() {
  const canSpinNow = await canSpin()
  const button = document.getElementById('spinButton')
  const info = document.getElementById('spinInfo')
  
  if (canSpinNow) {
    button.disabled = false
    info.textContent = 'Du kannst 1x pro Tag drehen'
  } else {
    button.disabled = true
    info.textContent = 'Heute bereits gedreht! Komm morgen wieder üé°'
  }
}

async function resetSpin() {
  const customerId = parseInt(document.getElementById('testCustomerId').value) || testCustomerId
  const today = new Date().toISOString().split('T')[0]
  
  try {
    await supabase
      .from('wheel_spins')
      .delete()
      .eq('customer_id', customerId)
      .gte('created_at', today + 'T00:00:00')
    
    alert('‚úÖ Spin zur√ºckgesetzt!')
    updateSpinInfo()
  } catch (e) {
    console.log('‚ö†Ô∏è Fehler beim Reset:', e)
  }
}

function loadTestPrizes() {
  const prizeList = prizes.map((p, i) => `${i+1}. ${p.label}`).join('\n')
  alert('üéÅ 18 Felder:\n\n' + prizeList)
}

logoImg.onload = () => drawWheel()
drawWheel()
updateSpinInfo()
canvas.addEventListener('click', spinWheel)

console.log('‚úÖ Lucky Wheel mit OFFSET-Berechnung!')
console.log('üî¥ OFFSET =', OFFSET, '(wird beim Zeichnen & Berechnen verwendet)')
console.log('üî¥ rotation startet bei 0, Felder werden mit OFFSET gezeichnet')
console.log('üî¥ D√ñNER steht exakt mittig oben')
console.log('üéØ Gewinn-Berechnung ber√ºcksichtigt OFFSET')
</script>

</body>
</html>
