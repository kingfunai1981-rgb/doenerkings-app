<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Wheel - DÃ¶ner Boxx</title>
<link rel="icon" href="/favicon.png" type="image/png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Flame', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.container {
  max-width: 600px;
  width: 100%;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.header {
  text-align: center;
  margin-bottom: 30px;
}

.header-logo {
  width: 80px;
  height: 80px;
  margin: 0 auto 16px;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  clip-path: circle(50%);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

h1 {
  color: #E31E24;
  font-size: 32px;
  margin-bottom: 8px;
}

.subtitle {
  color: #666;
  font-size: 16px;
}

.wheel-container {
  position: relative;
  width: 100%;
  max-width: 400px;
  margin: 0 auto 30px;
}

.wheel-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
}

canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  cursor: pointer;
}

.wheel-pointer {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 20px solid transparent;
  border-right: 20px solid transparent;
  border-top: 40px solid #E31E24;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  z-index: 10;
}

.spin-button {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Flame', sans-serif;
  box-shadow: 0 4px 12px rgba(227, 30, 36, 0.3);
}

.spin-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(227, 30, 36, 0.4);
}

.spin-button:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.result-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.result-modal.active {
  display: flex;
}

.result-content {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes popIn {
  0% { transform: scale(0.5); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.result-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.result-title {
  font-size: 28px;
  font-weight: 700;
  color: #E31E24;
  margin-bottom: 12px;
}

.result-prize {
  font-size: 22px;
  color: #333;
  margin-bottom: 24px;
}

.result-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Flame', sans-serif;
}

.info-box {
  background: #f9fafb;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  text-align: center;
  font-size: 14px;
  color: #666;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-logo">
      <img src="/logo-round.png" alt="DÃ¶ner Boxx">
    </div>
    <h1>ðŸŽ¡ Lucky Wheel</h1>
    <p class="subtitle">Drehe am GlÃ¼cksrad und gewinne tolle Preise!</p>
  </div>

  <div class="wheel-container">
    <div class="wheel-wrapper">
      <div class="wheel-pointer"></div>
      <canvas id="wheel" width="400" height="400"></canvas>
    </div>
  </div>

  <button id="spinButton" class="spin-button" onclick="spinWheel()">
    ðŸŽ° Jetzt drehen!
  </button>

  <div class="info-box">
    <div id="spinInfo">ðŸ•’ Happy Hour: 15-18 Uhr | Bei Bestellung â‰¥10â‚¬</div>
  </div>
</div>

<div id="resultModal" class="result-modal">
  <div class="result-content">
    <div class="result-icon" id="resultIcon">ðŸŽ‰</div>
    <div class="result-title" id="resultTitle">GlÃ¼ckwunsch!</div>
    <div class="result-prize" id="resultPrize">100 Punkte</div>
    <button class="result-button" onclick="closeResult()">Weiter</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

const canvas = document.getElementById('wheel')
const ctx = canvas.getContext('2d')

const anglePerSegment = (2 * Math.PI) / 18

// ðŸ”´ Fester Offset-Winkel: DÃ–NER (rot) exakt mittig oben
const OFFSET = -Math.PI / 2 - anglePerSegment / 2

let rotation = 0
let isSpinning = false

// ðŸŽ¨ FESTE 18 FELDER - NICHT MEHR BEARBEITBAR
// Empfohlene Verteilung (im Uhrzeigersinn)
const prizes = [
  { label: 'DÃ–NER 500', color: '#E31E24', textColor: '#FFFFFF', type: 'points', value: 500 },      // 1
  { label: '50 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },       // 2
  { label: '100 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 100 },     // 3
  { label: '25 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 25 },       // 4
  { label: '75 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 75 },       // 5
  { label: 'SPIN AGAIN', color: '#000000', textColor: '#FFFFFF', type: 'spin_again', value: 0 },   // 6
  { label: '50 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 50 },       // 7
  { label: '100 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 100 },     // 8
  { label: '25 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 25 },       // 9
  { label: 'DÃ–NER 500', color: '#E31E24', textColor: '#FFFFFF', type: 'points', value: 500 },      // 10
  { label: '75 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 75 },       // 11
  { label: '50 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 50 },       // 12
  { label: 'SPIN AGAIN', color: '#000000', textColor: '#FFFFFF', type: 'spin_again', value: 0 },   // 13
  { label: '100 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 100 },     // 14
  { label: '25 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 25 },       // 15
  { label: '75 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 75 },       // 16
  { label: '50 PUNKTE', color: '#000000', textColor: '#FFFFFF', type: 'points', value: 50 },       // 17
  { label: '100 PUNKTE', color: '#FFFFFF', textColor: '#000000', type: 'points', value: 100 }      // 18
]

const logoImg = new Image()
logoImg.src = '/logo-round.png'

function drawWheel() {
  const centerX = canvas.width / 2
  const centerY = canvas.height / 2
  const radius = canvas.width / 2 - 5

  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.save()
  ctx.translate(centerX, centerY)
  ctx.rotate(rotation + OFFSET)

  prizes.forEach((prize, i) => {
    const startAngle = i * anglePerSegment
    const endAngle = startAngle + anglePerSegment

    ctx.beginPath()
    ctx.moveTo(0, 0)
    ctx.arc(0, 0, radius, startAngle, endAngle)
    ctx.closePath()
    ctx.fillStyle = prize.color
    ctx.fill()

    ctx.save()
    ctx.rotate(startAngle + anglePerSegment / 2)
    ctx.textAlign = 'center'
    ctx.textBaseline = 'middle'
    ctx.fillStyle = prize.textColor
    
    const words = prize.label.split(' ')
    if (words.length === 1) {
      ctx.font = 'bold 16px Flame, Arial'
      ctx.fillText(prize.label, radius * 0.7, 0)
    } else {
      ctx.font = 'bold 14px Flame, Arial'
      ctx.fillText(words[0], radius * 0.7, -8)
      ctx.fillText(words[1], radius * 0.7, 8)
    }
    ctx.restore()
  })

  ctx.restore()
  
  // Logo SEPARAT zeichnen - OHNE Rotation (bleibt horizontal)
  ctx.save()
  ctx.translate(centerX, centerY)
  
  const centerRadius = 48
  const logoRadius = 47.8
  
  ctx.beginPath()
  ctx.arc(0, 0, centerRadius, 0, 2 * Math.PI)
  ctx.fillStyle = 'white'
  ctx.fill()

  if (logoImg.complete) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(0, 0, logoRadius, 0, 2 * Math.PI)
    ctx.clip()
    ctx.drawImage(logoImg, -logoRadius, -logoRadius, logoRadius * 2, logoRadius * 2)
    ctx.restore()
  }
  
  ctx.restore()
}

function getRandomPrize() {
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  const randomIndex = Math.floor((array[0] / (0xFFFFFFFF + 1)) * prizes.length)
  return prizes[randomIndex]
}

async function canSpin(customerId) {
  try {
    const { data, error } = await supabase
      .from('wheel_unlocks')
      .select('*')
      .eq('customer_id', customerId)
      .eq('is_used', false)
      .gt('expires_at', new Date().toISOString())
      .limit(1)
    
    if (error) {
      console.log('âš ï¸ Tabelle wheel_unlocks nicht gefunden')
      return null
    }
    
    return data && data.length > 0 ? data[0] : null
  } catch (e) {
    console.log('âš ï¸ Fehler bei canSpin:', e)
    return null
  }
}

let currentUnlockId = null // Speichern der aktuellen unlock ID fÃ¼r Spin Again

async function spinWheel() {
  if (isSpinning) return
  
  // Hole customer_id aus URL Parameter
  const urlParams = new URLSearchParams(window.location.search)
  const customerId = urlParams.get('customer_id')
  
  if (!customerId) {
    alert('âŒ Fehler: Keine Kunden-ID gefunden')
    return
  }
  
  // Nur beim ersten Spin prÃ¼fen, ob unlock vorhanden ist
  if (!currentUnlockId) {
    const unlock = await canSpin(customerId)
    if (!unlock) {
      alert('âŒ Du hast derzeit keine freie Drehung!')
      return
    }
    currentUnlockId = unlock.id
  }

  isSpinning = true
  document.getElementById('spinButton').disabled = true

  const winningPrize = getRandomPrize()
  const winningIndex = prizes.indexOf(winningPrize)
  
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  const randomOffset = ((array[0] / 0xFFFFFFFF) - 0.5) * 0.6 * anglePerSegment
  
  // 5-7 volle Drehungen
  const spins = 5 + Math.floor((array[0] / 0xFFFFFFFF) * 3)
  const baseRotation = spins * 2 * Math.PI
  
  const fieldMidAngle = winningIndex * anglePerSegment + anglePerSegment / 2 + randomOffset
  const targetRotation = -Math.PI / 2 - OFFSET - fieldMidAngle
  
  let normalizedTarget = targetRotation
  while (normalizedTarget > rotation) {
    normalizedTarget -= 2 * Math.PI
  }
  
  const totalRotation = baseRotation + (normalizedTarget - rotation)

  const startRotation = rotation
  const startTime = Date.now()
  const duration = 4000 + Math.floor((array[0] / 0xFFFFFFFF) * 1000)

  function animate() {
    const elapsed = Date.now() - startTime
    const progress = Math.min(elapsed / duration, 1)
    const easeOut = 1 - Math.pow(1 - progress, 4)
    
    rotation = startRotation + (easeOut * totalRotation)
    drawWheel()

    if (progress < 1) {
      requestAnimationFrame(animate)
    } else {
      isSpinning = false
      
      // Gewinn-Berechnung
      let normalizedRotation = rotation % (2 * Math.PI)
      if (normalizedRotation > Math.PI) normalizedRotation -= 2 * Math.PI
      if (normalizedRotation < -Math.PI) normalizedRotation += 2 * Math.PI
      
      let fieldAngle = -Math.PI / 2 - normalizedRotation - OFFSET
      if (fieldAngle < 0) fieldAngle += 2 * Math.PI
      
      const fieldIndex = Math.floor(fieldAngle / anglePerSegment) % prizes.length
      const actualPrize = prizes[fieldIndex]
      
      console.log('ðŸŽ¯ Gewonnen:', actualPrize.label, actualPrize.type, actualPrize.value)
      
      // PrÃ¼fe ob "Spin Again"
      if (actualPrize.type === 'spin_again') {
        showSpinAgain(customerId)
      } else {
        // Echte Punkte gewonnen
        showResult(actualPrize)
        saveSpin(customerId, currentUnlockId, actualPrize)
        currentUnlockId = null // Reset fÃ¼r nÃ¤chstes Mal
      }
    }
  }

  animate()
}

function showSpinAgain(customerId) {
  const modal = document.getElementById('resultModal')
  const icon = document.getElementById('resultIcon')
  const title = document.getElementById('resultTitle')
  const prizeText = document.getElementById('resultPrize')

  icon.textContent = 'ðŸ”„'
  title.textContent = 'Spin Again!'
  prizeText.textContent = 'Du darfst nochmal drehen! ðŸŽ‰'

  modal.classList.add('active')
  
  // Button wird zu "Nochmal drehen"
  const button = document.querySelector('.result-button')
  button.textContent = 'ðŸŽ° Nochmal drehen!'
  button.onclick = () => {
    closeSpinAgainResult()
  }
}

function closeSpinAgainResult() {
  document.getElementById('resultModal').classList.remove('active')
  document.getElementById('spinButton').disabled = false
  document.getElementById('spinButton').textContent = 'ðŸŽ° Jetzt drehen!'
  
  // Button zurÃ¼cksetzen
  const button = document.querySelector('.result-button')
  button.textContent = 'Weiter'
  button.onclick = closeResult
}

function showResult(prize) {
  const modal = document.getElementById('resultModal')
  const icon = document.getElementById('resultIcon')
  const title = document.getElementById('resultTitle')
  const prizeText = document.getElementById('resultPrize')

  icon.textContent = 'â­'
  title.textContent = 'GlÃ¼ckwunsch! ðŸŽ‰'
  prizeText.textContent = `+${prize.value} Punkte`

  modal.classList.add('active')
}

function closeResult() {
  document.getElementById('resultModal').classList.remove('active')
  document.getElementById('spinButton').disabled = true
  document.getElementById('spinInfo').textContent = 'âœ… Punkte wurden gutgeschrieben!'
}

async function saveSpin(customerId, unlockId, prize) {
  try {
    // Markiere unlock als verwendet
    await supabase
      .from('wheel_unlocks')
      .update({ is_used: true })
      .eq('id', unlockId)
    
    // Speichere Spin
    await supabase.from('wheel_spins').insert({
      customer_id: customerId,
      unlock_id: unlockId,
      prize_label: prize.label,
      prize_points: prize.value
    })
    
    // Schreibe Punkte gut
    const { data: customer } = await supabase
      .from('customers')
      .select('points')
      .eq('id', customerId)
      .single()
    
    if (customer) {
      await supabase
        .from('customers')
        .update({ points: customer.points + prize.value })
        .eq('id', customerId)
    }
    
    console.log('âœ… Spin gespeichert und Punkte gutgeschrieben!')
  } catch (e) {
    console.log('âš ï¸ Fehler beim Speichern:', e)
  }
}

async function checkWheelStatus() {
  const urlParams = new URLSearchParams(window.location.search)
  const customerId = urlParams.get('customer_id')
  
  if (!customerId) {
    document.getElementById('spinButton').disabled = true
    document.getElementById('spinInfo').textContent = 'âŒ Keine Kunden-ID gefunden'
    return
  }
  
  const unlock = await canSpin(customerId)
  
  if (unlock) {
    document.getElementById('spinButton').disabled = false
    document.getElementById('spinInfo').textContent = 'ðŸŽ‰ Du hast 1 freie Drehung!'
  } else {
    document.getElementById('spinButton').disabled = true
    document.getElementById('spinInfo').textContent = 'ðŸ•’ Happy Hour: 15-18 Uhr | Bei Bestellung â‰¥10â‚¬'
  }
}

logoImg.onload = () => drawWheel()
drawWheel()
checkWheelStatus()
canvas.addEventListener('click', spinWheel)
</script>

</body>
</html>
