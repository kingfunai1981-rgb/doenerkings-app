<!DOCTYPE html>
<!--
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  DÃ¶ner Boxx Loyalty System - Scanner Interface
  Copyright Â© 2024 DÃ¶ner Boxx. Alle Rechte vorbehalten.
  
  âš ï¸ WARNUNG: Dieses System ist urheberrechtlich geschÃ¼tzt.
  Unerlaubtes Kopieren, Ã„ndern, Verbreiten oder Reverse Engineering
  ist verboten und wird zivil- und strafrechtlich verfolgt.
  
  Entwickelt exklusiv fÃ¼r DÃ¶ner Boxx.
  Bei Interesse an Lizenzen: kontakt@doenerboxx.de
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner - DÃ¶ner Boxx</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon-new.png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Flame', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.header-card {
  display: flex;
  align-items: center;
  gap: 20px;
}
.header-logo {
  width: 70px;
  height: 70px;
  flex-shrink: 0;
}
.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.header-text {
  flex: 1;
}
h1 { color: #E31E24; margin-bottom: 10px; font-size: 28px; }
h2 { font-size: 18px; margin-bottom: 12px; color: #374151; }

.tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.tab { flex: 1; min-width: 120px; padding: 12px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #6b7280; font-size: 14px; }
.tab.active { background: linear-gradient(135deg, #E31E24, #F9A825); color: white; }

input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 10px; }
button { width: 100%; padding: 14px; background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }
button.danger { background: #dc2626; }
button.success { background: #F9A825; }
button.small { width: auto; padding: 8px 16px; font-size: 14px; display: inline-block; margin: 4px; }

.result { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
.success { background: #fef3c7; color: #92400e; }
.error { background: #fee2e2; color: #991b1b; }
.info { background: #dbeafe; color: #1e40af; }

.video-container { position: relative; width: 100%; margin: 16px auto; background: #000; border-radius: 10px; overflow: hidden; display: none; }
.video-container.active { display: block; }
#video { width: 100%; display: block; }
#qr-shaded-region { position: absolute; border-style: solid; border-color: rgba(0, 0, 0, 0.48); box-sizing: border-box; inset: 0; }
/* WeiÃŸe Ecken - horizontal oben */
.corner-h-tl { position: absolute; background-color: #fff; width: 40px; height: 5px; top: -5px; left: 0; }
.corner-h-tr { position: absolute; background-color: #fff; width: 40px; height: 5px; top: -5px; right: 0; }
.corner-h-bl { position: absolute; background-color: #fff; width: 40px; height: 5px; bottom: -5px; left: 0; }
.corner-h-br { position: absolute; background-color: #fff; width: 40px; height: 5px; bottom: -5px; right: 0; }
/* WeiÃŸe Ecken - vertikal */
.corner-v-tl { position: absolute; background-color: #fff; width: 5px; height: 45px; top: -5px; left: -5px; }
.corner-v-bl { position: absolute; background-color: #fff; width: 5px; height: 45px; bottom: -5px; left: -5px; }
.corner-v-tr { position: absolute; background-color: #fff; width: 5px; height: 45px; top: -5px; right: -5px; }
.corner-v-br { position: absolute; background-color: #fff; width: 5px; height: 45px; bottom: -5px; right: -5px; }
canvas { display: none; }

.customer-info { background: #f9fafb; padding: 16px; border-radius: 10px; margin-top: 12px; }
.customer-info h3 { font-size: 18px; margin-bottom: 8px; color: #E31E24; }
.customer-info p { margin: 4px 0; color: #374151; }
.bonus-badge { display: inline-block; background: linear-gradient(135deg, #F9A825, #f59e0b); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-top: 8px; }

.history-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
.history-item.redeem { background: #fef3c7; border-color: #fbbf24; }
.history-item.wheel { background: #fffbeb; border-color: #fbbf24; border-left: 4px solid #f59e0b; }

.wheel-badge-small {
  display: inline-block;
  background: linear-gradient(135deg, #F9A825, #f59e0b);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 8px;
}

.code-item { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
.code-item h3 { color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 12px; }
.code-item .code { font-size: 28px; font-weight: 700; color: #f59e0b; letter-spacing: 8px; margin: 12px 0; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.wheel-badge {
  background: linear-gradient(135deg, #F9A825, #f59e0b);
  color: white;
  padding: 16px;
  border-radius: 12px;
  margin: 16px 0;
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  animation: pulse 2s infinite;
  box-shadow: 0 4px 12px rgba(249, 168, 37, 0.4);
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL STYLES fÃ¼r BestÃ¤tigungs-Dialoge
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

.modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 400px;
  width: 100%;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalIn 0.3s ease;
}

@keyframes modalIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal-icon {
  font-size: 60px;
  margin-bottom: 20px;
}

.modal-title {
  font-size: 22px;
  font-weight: 700;
  color: #E31E24;
  margin-bottom: 10px;
}

.modal-amount {
  font-size: 36px;
  font-weight: 700;
  color: #F9A825;
  margin: 20px 0;
}

.modal-points {
  font-size: 18px;
  color: #666;
  margin-bottom: 20px;
}

.modal-warning {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 20px;
  color: #92400e;
  font-size: 14px;
}

.modal-buttons {
  display: flex;
  gap: 12px;
}

.modal-buttons button {
  flex: 1;
  margin: 0;
}

.modal-pin-input {
  width: 100%;
  padding: 16px;
  border: 3px solid #E31E24;
  border-radius: 12px;
  font-size: 24px;
  text-align: center;
  letter-spacing: 8px;
  margin: 20px 0;
  font-weight: 700;
}

.modal-pin-input:focus {
  outline: none;
  border-color: #F9A825;
}

/* ====== BESTELLUNGEN STYLES ====== */
.order-card {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s;
}

.order-card.pending { border-left: 4px solid #ef4444; background: #fef2f2; }
.order-card.preparing { border-left: 4px solid #f59e0b; background: #fffbeb; }
.order-card.ready { border-left: 4px solid #10b981; background: #f0fdf4; }

.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.order-number { font-size: 20px; font-weight: 700; color: #E31E24; }
.order-time { font-size: 13px; color: #666; }
.order-customer { background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
.order-customer p { margin: 4px 0; font-size: 14px; }
.order-items { margin-bottom: 12px; }
.order-item { padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 6px; font-size: 14px; }
.order-item-name { font-weight: 600; color: #374151; }
.order-item-options { font-size: 13px; color: #6b7280; margin-top: 4px; }
.order-total { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 12px; font-size: 16px; font-weight: 700; }
.order-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.order-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; }
.order-badge.pending { background: #fee2e2; color: #991b1b; }
.order-badge.preparing { background: #fef3c7; color: #92400e; }
.order-badge.ready { background: #d1fae5; color: #065f46; }

.payment-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px; }
.payment-badge.cash { background: #fef3c7; color: #92400e; }
.payment-badge.paypal { background: #dbeafe; color: #1e40af; }

.wheel-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
.wheel-modal.active { display: flex; }
.wheel-modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 100%; text-align: center; animation: slideInWheel 0.3s; }
@keyframes slideInWheel { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.wheel-modal h2 { color: #E31E24; margin-bottom: 16px; }

</style>
</head>
<body>

<div class="container">
  <div class="card header-card">
    <div class="header-logo">
      <img src="/logo-round-new.png" alt="DÃ¶ner Boxx">
    </div>
    <div class="header-text">
      <h1>Scanner PRO</h1>
      <div style="color: #666; font-size: 14px;">Status: <span id="status">Bereit âœ…</span></div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab" onclick="showTab('orders')">ğŸ“¦ Bestellungen <span id="orderBadge" style="display:none; background:#ef4444; color:white; padding:2px 8px; border-radius:12px; font-size:12px; margin-left:4px;">0</span></button>
      <button class="tab active" onclick="showTab('phone')">ğŸ“± Handynummer</button>
      <button class="tab" onclick="showTab('qr')">ğŸ“¸ QR-Scanner</button>
      <button class="tab" onclick="showTab('history')">ğŸ“‹ Verlauf</button>
      <button class="tab" onclick="showTab('code')">ğŸ Code prÃ¼fen</button>
    </div>
  </div>

  <!-- ====== BESTELLUNGEN TAB ====== -->
  <div id="tab-orders" class="card tab-content">
    <h2>ğŸ“¦ Eingehende Bestellungen</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
      ğŸ”” Neue Bestellungen werden automatisch angezeigt und mit Ton benachrichtigt
    </p>
    
    <button onclick="loadOrders()" class="secondary" style="margin-bottom: 16px;">ğŸ”„ Aktualisieren</button>
    
    <div id="ordersList">
      <div style="text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
        <p>Keine offenen Bestellungen</p>
      </div>
    </div>
  </div>

  <div id="tab-phone" class="card tab-content active">
    <h2>ğŸ“± Punkte per Handynummer oder QR-ID gutschreiben</h2>
    <input id="phone" type="text" placeholder="Handynummer oder QR-ID">
    <input id="amount" type="number" step="0.01" placeholder="Betrag in â‚¬ (z.B. 10.00)">
    <button onclick="addPointsByPhone()">ğŸ’° Punkte gutschreiben</button>
    <div id="result-phone"></div>
  </div>

  <div id="tab-qr" class="card tab-content">
    <h2>ğŸ“¸ QR-Code scannen</h2>
    <button id="startBtn" onclick="startCamera()">ğŸ“¸ Kamera starten</button>
    <button id="stopBtn" onclick="stopCamera()" class="danger" style="display:none;">â¹ï¸ Stoppen</button>
    
    <div class="video-container" id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <div id="qr-shaded-region">
        <div class="corner-h-tl"></div>
        <div class="corner-h-tr"></div>
        <div class="corner-h-bl"></div>
        <div class="corner-h-br"></div>
        <div class="corner-v-tl"></div>
        <div class="corner-v-bl"></div>
        <div class="corner-v-tr"></div>
        <div class="corner-v-br"></div>
      </div>
    </div>
    <canvas id="canvas"></canvas>
    
    <div id="result-qr"></div>
    
    <div id="customerCard" style="display:none;">
      <div class="customer-info">
        <h3 id="custName">-</h3>
        <p><strong>QR-ID:</strong> <span id="custQR">-</span></p>
        <p><strong>Punkte:</strong> <span id="custPoints">-</span></p>
        <div id="activeBonusBadge"></div>
      </div>
      
      <h3>Betrag eingeben:</h3>
      <input id="scannedAmount" type="number" step="0.01" placeholder="z.B. 7.50">
      <button onclick="addPointsFromScan()" class="success">ğŸ’° Punkte gutschreiben</button>
      <div id="result-scan"></div>
    </div>
  </div>

  <div id="tab-history" class="card tab-content">
    <h2>ğŸ“‹ Verlauf (Letzte 50 Transaktionen)</h2>
    <button onclick="loadHistory()" class="secondary">ğŸ”„ Aktualisieren</button>
    <div id="historyList" style="margin-top: 16px;">
      <div style="text-align: center; padding: 20px; color: #666;">Noch keine Transaktionen</div>
    </div>
  </div>

  <div id="tab-code" class="card tab-content">
    <h2>ğŸ Code prÃ¼fen & einlÃ¶sen</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">PrÃ¤mien-Code oder Coupon-Code</p>
    <input id="code" placeholder="4-stelliger Code" maxlength="4">
    <button onclick="verifyAnyCode()">ğŸ” Code prÃ¼fen</button>
    <div id="result-code"></div>
    <div id="code-details" style="display: none; margin-top: 20px;"></div>
  </div>
</div>

<!-- Modal Container fÃ¼r BestÃ¤tigungs-Dialoge -->
<div id="modalContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” LIZENZ & DOMAIN-SCHUTZ - NICHT ENTFERNEN!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  const _0xB = 'DÃ¶ner Boxx';
  const _0xL = 'DNBX-2025-LOYALTY-SYSTEM-PROTECTED';
  const _0xD = ['localhost', 'doener-boxx.vercel.app', 'doenerboxx.de', 'www.doenerboxx.de'];
  const _0xH = ['528de417', '88a8ce6b', 'a1f62429', '5da2c3a0'];
  
  const _0xHost = window.location.hostname;
  
  // Schritt 1: Domain-Whitelist prÃ¼fen
  if (!_0xD.includes(_0xHost)) {
    document.body.innerHTML = '<div style="font-family:sans-serif;text-align:center;padding:50px;background:#1a1a1a;min-height:100vh;color:#ff4444;display:flex;flex-direction:column;align-items:center;justify-content:center;"><h1 style="font-size:48px;margin-bottom:20px;">â›”</h1><h2>LIZENZ UNGÃœLTIG</h2><p style="margin-top:15px;">Diese Software ist nicht fÃ¼r diese Domain lizenziert.</p><p style="font-size:12px;color:#666;margin-top:30px;">Â© DÃ¶ner Boxx - Alle Rechte vorbehalten</p></div>';
    throw new Error('Unauthorized domain');
  }
  
  // Schritt 2: Lizenz-Hash berechnen und prÃ¼fen
  function _0xHash(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) {
      h = (h * 31 + s.charCodeAt(i)) & 0xffffffff;
    }
    if (h < 0) h = h >>> 0;
    return h.toString(16);
  }
  
  const _0xCalc = _0xHash(_0xB + '|' + _0xHost + '|' + _0xL);
  
  if (!_0xH.includes(_0xCalc)) {
    document.body.innerHTML = '<div style="font-family:sans-serif;text-align:center;padding:50px;background:#1a1a1a;min-height:100vh;color:#ff4444;display:flex;flex-direction:column;align-items:center;justify-content:center;"><h1 style="font-size:48px;margin-bottom:20px;">â›”</h1><h2>LIZENZFEHLER</h2><p style="margin-top:15px;">Die LizenzprÃ¼fung ist fehlgeschlagen.</p><p style="font-size:12px;color:#666;margin-top:30px;">Â© DÃ¶ner Boxx - Alle Rechte vorbehalten</p></div>';
    throw new Error('Invalid license');
  }
})();
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” PASSWORT-SCHUTZ MIT 5-MINUTEN-SPERRE - NICHT ENTFERNEN!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PASSWORT_HASH = 'efc68709a6bc20b7983129e56ce1d98739876e4274463aaece1a3edef374d47e';
const LOCKOUT_DURATION = 5 * 60 * 1000; // 5 Minuten in Millisekunden
const MAX_VERSUCHE = 3;

function getAuthState() {
  const stored = localStorage.getItem('db_auth_state');
  if (!stored) return { versuche: MAX_VERSUCHE, gesperrtBis: null };
  try { return JSON.parse(stored); } catch(e) { return { versuche: MAX_VERSUCHE, gesperrtBis: null }; }
}

function setAuthState(state) {
  localStorage.setItem('db_auth_state', JSON.stringify(state));
}

function clearAuthState() {
  localStorage.removeItem('db_auth_state');
}

function isLocked() {
  const state = getAuthState();
  if (state.gesperrtBis && Date.now() < state.gesperrtBis) {
    return true;
  }
  if (state.gesperrtBis && Date.now() >= state.gesperrtBis) {
    clearAuthState();
  }
  return false;
}

function getRemainingLockTime() {
  const state = getAuthState();
  if (!state.gesperrtBis) return 0;
  return Math.max(0, Math.ceil((state.gesperrtBis - Date.now()) / 1000));
}

async function sha256(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}

function showLockScreen() {
  const updateTimer = () => {
    const remaining = getRemainingLockTime();
    if (remaining <= 0) {
      clearAuthState();
      location.reload();
      return;
    }
    const minutes = Math.floor(remaining / 60);
    const seconds = remaining % 60;
    const timerEl = document.getElementById('lockTimer');
    if (timerEl) timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };
  
  document.body.innerHTML = `
    <div style="font-family:'Flame',system-ui,sans-serif;background:linear-gradient(135deg,#dc2626,#991b1b);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:20px;padding:40px;max-width:400px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);text-align:center;">
        <div style="font-size:60px;margin-bottom:20px;">ğŸš«</div>
        <h1 style="color:#dc2626;margin-bottom:10px;font-size:24px;">Zugriff gesperrt</h1>
        <p style="color:#666;margin-bottom:20px;">Zu viele Fehlversuche!</p>
        <div style="background:#fee2e2;border:2px solid #dc2626;border-radius:12px;padding:20px;margin-bottom:20px;">
          <p style="color:#991b1b;font-size:14px;margin-bottom:10px;">Sperre endet in:</p>
          <div id="lockTimer" style="font-size:36px;font-weight:700;color:#dc2626;">5:00</div>
        </div>
        <p style="color:#666;font-size:13px;">Die Seite wird automatisch entsperrt.</p>
        <a href="/" style="display:inline-block;margin-top:20px;color:#dc2626;font-size:14px;">â† ZurÃ¼ck zur Startseite</a>
      </div>
    </div>
  `;
  updateTimer();
  setInterval(updateTimer, 1000);
}

function showLoginScreen() {
  if (isLocked()) {
    showLockScreen();
    return;
  }
  
  const state = getAuthState();
  const versuche = state.versuche;
  
  document.body.innerHTML = `
    <div style="font-family:'Flame',system-ui,sans-serif;background:linear-gradient(135deg,#E31E24,#F9A825);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:20px;padding:40px;max-width:400px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.2);text-align:center;">
        <div style="font-size:60px;margin-bottom:20px;">ğŸ”</div>
        <h1 style="color:#E31E24;margin-bottom:10px;font-size:24px;">ğŸ“¦ Eingehende Bestellungen</h1>
        <p style="color:#666;margin-bottom:30px;">Bitte Passwort eingeben</p>
        <input type="password" id="loginPassword" placeholder="Passwort" style="width:100%;padding:14px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;margin-bottom:15px;text-align:center;" onkeypress="if(event.key==='Enter')checkLogin()">
        <button onclick="checkLogin()" style="width:100%;padding:14px;background:linear-gradient(135deg,#E31E24,#F9A825);color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;">ğŸ”“ Einloggen</button>
        <p id="loginError" style="color:#dc2626;margin-top:15px;font-size:14px;display:none;"></p>
        <p id="loginVersuche" style="color:#666;margin-top:10px;font-size:12px;">${versuche} Versuche Ã¼brig</p>
      </div>
    </div>
  `;
  setTimeout(() => document.getElementById('loginPassword').focus(), 100);
}

async function checkLogin() {
  if (isLocked()) {
    showLockScreen();
    return;
  }
  
  const eingabe = document.getElementById('loginPassword').value;
  const errorEl = document.getElementById('loginError');
  const versucheEl = document.getElementById('loginVersuche');
  
  if (!eingabe) {
    errorEl.textContent = 'âŒ Bitte Passwort eingeben!';
    errorEl.style.display = 'block';
    return;
  }
  
  const hash = await sha256(eingabe);
  
  if (hash === PASSWORT_HASH) {
    sessionStorage.setItem('db_auth', PASSWORT_HASH);
    clearAuthState();
    location.reload();
    return;
  }
  
  const state = getAuthState();
  state.versuche--;
  
  if (state.versuche <= 0) {
    state.gesperrtBis = Date.now() + LOCKOUT_DURATION;
    state.versuche = 0;
    setAuthState(state);
    showLockScreen();
    return;
  }
  
  setAuthState(state);
  
  errorEl.textContent = 'âŒ Falsches Passwort!';
  errorEl.style.display = 'block';
  versucheEl.textContent = state.versuche + ' Versuche Ã¼brig';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginPassword').focus();
}

// PrÃ¼fe Session und Sperre beim Laden
if (isLocked()) {
  showLockScreen();
  throw new Error('Zugriff gesperrt');
}

if (sessionStorage.getItem('db_auth') !== PASSWORT_HASH) {
  showLoginScreen();
  throw new Error('Login erforderlich');
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” ENDE PASSWORT-SCHUTZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”’ BETRAGS-SICHERHEIT: BestÃ¤tigung ab 40â‚¬, Chef-PIN ab 100â‚¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BETRAG_WARNUNG_AB = 40;      // Ab diesem Betrag: BestÃ¤tigungsabfrage
const BETRAG_CHEF_PIN_AB = 100;   // Ab diesem Betrag: zusÃ¤tzlich Chef-PIN
// Chef-PIN Hash (Standard: 1234 - BITTE Ã„NDERN!)
// Um einen neuen Hash zu generieren: In der Browser-Konsole sha256('DEIN_PIN') ausfÃ¼hren
const CHEF_PIN_HASH = '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4'; // Hash fÃ¼r "1234"

function showModal(html) {
  document.getElementById('modalContainer').innerHTML = html;
}

function closeModal() {
  document.getElementById('modalContainer').innerHTML = '';
}

// BestÃ¤tigungs-Dialog fÃ¼r hohe BetrÃ¤ge (40-99â‚¬)
function showAmountConfirmation(amount, points, onConfirm, onCancel) {
  const html = `
    <div class="modal-overlay" onclick="event.target === this && closeModal()">
      <div class="modal-content">
        <div class="modal-icon">âš ï¸</div>
        <div class="modal-title">Hoher Betrag!</div>
        <div class="modal-amount">${amount.toFixed(2)} â‚¬</div>
        <div class="modal-points">= ${points} Punkte</div>
        <div class="modal-warning">
          <strong>Achtung:</strong> Dieser Betrag ist ungewÃ¶hnlich hoch.<br>
          Bitte Ã¼berprÃ¼fen Sie die Eingabe!
        </div>
        <p style="margin-bottom: 20px; color: #666;">Ist dieser Betrag korrekt?</p>
        <div class="modal-buttons">
          <button class="secondary" onclick="window._modalCancel()">âŒ Abbrechen</button>
          <button onclick="window._modalConfirm()">âœ… Ja, korrekt</button>
        </div>
      </div>
    </div>
  `;
  
  window._modalConfirm = () => { closeModal(); onConfirm(); };
  window._modalCancel = () => { closeModal(); onCancel(); };
  
  showModal(html);
}

// Chef-PIN Dialog fÃ¼r sehr hohe BetrÃ¤ge (ab 100â‚¬)
function showChefPinDialog(amount, points, onSuccess, onCancel) {
  const html = `
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-icon">ğŸ”</div>
        <div class="modal-title">Chef-Freigabe erforderlich!</div>
        <div class="modal-amount">${amount.toFixed(2)} â‚¬</div>
        <div class="modal-points">= ${points} Punkte</div>
        <div class="modal-warning" style="background: #fee2e2; border-color: #dc2626; color: #991b1b;">
          <strong>âš ï¸ Sehr hoher Betrag!</strong><br>
          FÃ¼r BetrÃ¤ge ab ${BETRAG_CHEF_PIN_AB} â‚¬ ist eine Chef-PIN erforderlich.
        </div>
        <input type="password" 
               id="chefPinInput" 
               class="modal-pin-input" 
               placeholder="PIN" 
               maxlength="6"
               onkeypress="if(event.key==='Enter')window._checkChefPin()">
        <p id="chefPinError" style="color: #dc2626; font-size: 14px; margin-bottom: 15px; display: none;">âŒ Falscher PIN!</p>
        <div class="modal-buttons">
          <button class="danger" onclick="window._modalCancel()">âŒ Abbrechen</button>
          <button onclick="window._checkChefPin()">ğŸ”“ Freigeben</button>
        </div>
      </div>
    </div>
  `;
  
  window._checkChefPin = async () => {
    const pin = document.getElementById('chefPinInput').value;
    if (!pin) {
      document.getElementById('chefPinError').textContent = 'âŒ Bitte PIN eingeben!';
      document.getElementById('chefPinError').style.display = 'block';
      return;
    }
    
    const hash = await sha256(pin);
    if (hash === CHEF_PIN_HASH) {
      closeModal();
      onSuccess();
    } else {
      document.getElementById('chefPinError').textContent = 'âŒ Falscher PIN!';
      document.getElementById('chefPinError').style.display = 'block';
      document.getElementById('chefPinInput').value = '';
      document.getElementById('chefPinInput').focus();
    }
  };
  
  window._modalCancel = () => { closeModal(); onCancel(); };
  
  showModal(html);
  setTimeout(() => document.getElementById('chefPinInput').focus(), 100);
}

// Validierung mit Callback-System
async function validateAmount(amount, onValid, onCancel, resultId) {
  const points = Math.round(amount * 10);
  
  // Fall 1: Normaler Betrag (unter 40â‚¬) â†’ direkt ausfÃ¼hren
  if (amount < BETRAG_WARNUNG_AB) {
    onValid();
    return;
  }
  
  // Fall 2: Hoher Betrag (40-99â‚¬) â†’ BestÃ¤tigungsabfrage
  if (amount < BETRAG_CHEF_PIN_AB) {
    showAmountConfirmation(amount, points, onValid, () => {
      showResult(resultId, 'âŒ Vorgang abgebrochen.', 'error');
      onCancel();
    });
    return;
  }
  
  // Fall 3: Sehr hoher Betrag (ab 100â‚¬) â†’ Erst BestÃ¤tigung, dann Chef-PIN
  showAmountConfirmation(amount, points, () => {
    // Nach BestÃ¤tigung: Chef-PIN abfragen
    showChefPinDialog(amount, points, onValid, () => {
      showResult(resultId, 'âŒ Vorgang abgebrochen - Chef-PIN nicht eingegeben.', 'error');
      onCancel();
    });
  }, () => {
    showResult(resultId, 'âŒ Vorgang abgebrochen.', 'error');
    onCancel();
  });
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

// ğŸ¤– Telegram Bot Konfiguration
const TELEGRAM_BOT_TOKEN = '8216843337:AAGEHoVsQPW6f3zYw5jFhK61GPKIbgfnKZI'
const TELEGRAM_CHAT_ID = '8253938141'

// Request Throttling - verhindert zu viele parallele Supabase Requests
let requestQueue = []
let activeRequests = 0
const MAX_CONCURRENT_REQUESTS = 3

// ğŸ¤– Telegram Benachrichtigungen
async function sendTelegramUpdate(orderNumber, customerName, status, message) {
  try {
    const statusEmojis = {
      'pending': 'ğŸ†•',
      'paid': 'ğŸ’°',
      'preparing': 'ğŸ³',
      'ready': 'ğŸ“¦',
      'completed': 'âœ…'
    }
    
    const emoji = statusEmojis[status] || 'ğŸ“‹'
    
    const text = `${emoji} *BESTELLUNG #${orderNumber}*

ğŸ‘¤ ${customerName}
ğŸ“Š Status: ${message}

â° ${new Date().toLocaleTimeString('de-DE')}`

    await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: text,
        parse_mode: 'Markdown'
      })
    })
    
    console.log('âœ… Telegram Update gesendet:', status)
  } catch (error) {
    console.error('âŒ Telegram Fehler:', error)
  }
}

async function throttledRequest(requestFn) {
  while (activeRequests >= MAX_CONCURRENT_REQUESTS) {
    await new Promise(resolve => setTimeout(resolve, 100))
  }
  
  activeRequests++
  try {
    return await requestFn()
  } finally {
    activeRequests--
  }
}


// ============================================
// ğŸ” ROBUSTE CUSTOMER LOOKUP FUNKTION
// ============================================
async function findCustomer(searchValue, searchType = 'qr_id') {
  console.log(`ğŸ” Suche Customer: ${searchType} = "${searchValue}"`)
  
  if (!searchValue) {
    console.error('âŒ Kein Suchwert angegeben!')
    return null
  }
  
  try {
    // Versuch 1: Direkte Suche
    let { data, error } = await supabase
      .from('customers')
      .select('*')
      .eq(searchType, searchValue)
      .limit(1)
    
    if (data && data.length > 0) {
      console.log('âœ… Kunde gefunden (direkt):', data[0].name)
      return data[0]
    }
    
    // Versuch 2: Als String (falls Number Ã¼bergeben wurde)
    if (typeof searchValue !== 'string') {
      const strValue = String(searchValue)
      const result = await supabase
        .from('customers')
        .select('*')
        .eq(searchType, strValue)
        .limit(1)
      
      if (result.data && result.data.length > 0) {
        console.log('âœ… Kunde gefunden (als String):', result.data[0].name)
        return result.data[0]
      }
    }
    
    // Versuch 3: Als Number (falls String Ã¼bergeben wurde)
    if (typeof searchValue === 'string' && !isNaN(searchValue)) {
      const numValue = parseInt(searchValue)
      const result = await supabase
        .from('customers')
        .select('*')
        .eq(searchType, numValue)
        .limit(1)
      
      if (result.data && result.data.length > 0) {
        console.log('âœ… Kunde gefunden (als Number):', result.data[0].name)
        return result.data[0]
      }
    }
    
    // Versuch 4: Suche in orders Tabelle nach customer_id
    if (searchType === 'qr_id') {
      console.log('ğŸ”„ Suche in orders Tabelle...')
      const { data: orders } = await supabase
        .from('orders')
        .select('customer_id')
        .eq('qr_id', searchValue)
        .limit(1)
      
      if (orders && orders.length > 0 && orders[0].customer_id) {
        console.log('ğŸ“¦ Customer ID aus Order gefunden:', orders[0].customer_id)
        const { data: customer } = await supabase
          .from('customers')
          .select('*')
          .eq('id', orders[0].customer_id)
          .limit(1)
        
        if (customer && customer.length > 0) {
          console.log('âœ… Kunde Ã¼ber Order gefunden:', customer[0].name)
          return customer[0]
        }
      }
    }
    
    console.error('âŒ Kunde nicht gefunden nach allen Versuchen')
    return null
    
  } catch (e) {
    console.error('âŒ Fehler bei Customer Lookup:', e)
    return null
  }
}



// ============================================
// ğŸ” DIAGNOSE & DEBUGGING
// ============================================

async function diagnoseSystem() {
  console.log('ğŸ” System-Diagnose gestartet...')
  
  try {
    // 1. PrÃ¼fe orders Tabelle
    console.log('ğŸ“‹ PrÃ¼fe orders Tabelle...')
    const { data: orders, error: ordersError } = await supabase.from('orders').select('*').limit(1)
    if (ordersError) {
      console.error('âŒ Orders Tabelle Fehler:', ordersError)
      console.log('ğŸ’¡ Tipp: Die orders Tabelle existiert mÃ¶glicherweise noch nicht oder RLS blockiert den Zugriff')
    } else {
      console.log('âœ… Orders Tabelle OK')
      if (orders && orders.length > 0) {
        console.log('ğŸ“¦ Beispiel Order:', orders[0])
      }
    }
    
    // 2. PrÃ¼fe customers Tabelle
    console.log('ğŸ‘¥ PrÃ¼fe customers Tabelle...')
    const { data: customers, error: customersError } = await supabase.from('customers').select('id, name, qr_id').limit(1)
    if (customersError) {
      console.error('âŒ Customers Tabelle Fehler:', customersError)
    } else {
      console.log('âœ… Customers Tabelle OK')
    }
    
    // 3. PrÃ¼fe wheel_config
    console.log('ğŸ¡ PrÃ¼fe wheel_config...')
    const { data: wheelConf, error: wheelError } = await supabase.from('wheel_config').select('*').limit(1)
    if (wheelError) {
      console.error('âŒ Wheel Config Fehler:', wheelError)
    } else {
      console.log('âœ… Wheel Config OK:', wheelConf)
    }
    
    console.log('âœ… System-Diagnose abgeschlossen')
    
  } catch (e) {
    console.error('âŒ Diagnose Fehler:', e)
  }
}

// Diagnose beim Start ausfÃ¼hren
setTimeout(() => {
  console.log('ğŸš€ Scanner.html geladen - starte Diagnose...')
  diagnoseSystem()
}, 2000)



let video = document.getElementById('video')
let canvas = document.getElementById('canvas')
let ctx = canvas.getContext('2d')
let scanning = false
let stream = null
let currentCustomer = null
let currentCodeData = null

async function checkAndUpdateChallenges(customerId, amount) {
  try {
    const now = new Date().toISOString().split('T')[0]
    const { data: activeChallenges } = await supabase.from('challenges').select('*').eq('is_active', true).lte('start_date', now).gte('end_date', now)
    if (!activeChallenges || activeChallenges.length === 0) return
    
    for (const challenge of activeChallenges) {
      if (amount < challenge.min_order_amount) continue
      
      const { data: progressRows, error: progressError } = await supabase
        .from('challenge_progress')
        .select('*')
        .eq('customer_id', customerId)
        .eq('challenge_id', challenge.id)
        .limit(1)
      
      if (progressError) {
        console.error('Challenge progress error:', progressError)
        continue
      }
      
      let progress = (progressRows && progressRows.length > 0) ? progressRows[0] : null
      
      // âœ… FIX: Erstelle Progress wenn nicht vorhanden!
      if (!progress) {
        console.log('ğŸ¯ Erstelle neuen Challenge-Progress fÃ¼r Kunde:', customerId)
        const { data: newProgress, error: createError } = await supabase
          .from('challenge_progress')
          .insert({
            customer_id: customerId,
            challenge_id: challenge.id,
            completed_orders: 0,
            is_completed: false
          })
          .select()
          .single()
        
        if (createError) {
          console.error('âŒ Fehler beim Erstellen:', createError)
          continue
        }
        
        progress = newProgress
      }
      
      if (progress.is_completed) continue
      
      const newOrders = progress.completed_orders + 1
      if (newOrders >= challenge.required_orders) {
        await supabase.from('challenge_progress').update({ completed_orders: newOrders, is_completed: true, completed_at: new Date().toISOString() }).eq('id', progress.id)
        const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
        if (customer) {
          await supabase.from('customers').update({ points: customer.points + challenge.bonus_points }).eq('id', customerId)
          await supabase.from('transactions').insert({ customer_id: customerId, type: 'earn', amount: 0, points: challenge.bonus_points, staff: 'CHALLENGE', notes: `Challenge: ${challenge.bonus_points}P` })
          console.log(`ğŸ‰ Challenge abgeschlossen! +${challenge.bonus_points}P`)
        }
      } else {
        await supabase.from('challenge_progress').update({ completed_orders: newOrders }).eq('id', progress.id)
        console.log(`ğŸ¯ Challenge-Fortschritt: ${newOrders}/${challenge.required_orders}`)
      }
    }
  } catch (e) { console.error('Challenge error:', e) }
}

async function checkAndUnlockWheel(customerId, amount) {
  try {
    const { data: config, error: configError } = await supabase.from('wheel_config').select('*').limit(1)
    if (configError || !config || config.length === 0) { console.log('â„¹ï¸ Wheel Config nicht gefunden'); return false }
    const wheelConfig = config[0]
    if (!wheelConfig.is_active) { return false }
    if (wheelConfig.active_days && wheelConfig.active_days.length > 0) {
      const now = new Date()
      const currentDay = now.getDay()
      if (!wheelConfig.active_days.includes(currentDay)) { console.log('â„¹ï¸ GlÃ¼cksrad heute nicht aktiv'); return false }
    }
    if (wheelConfig.start_time && wheelConfig.end_time) {
      const now = new Date()
      const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0')
      const startTime = wheelConfig.start_time.substring(0, 5)
      const endTime = wheelConfig.end_time.substring(0, 5)
      if (currentTime < startTime || currentTime > endTime) { console.log('â„¹ï¸ AuÃŸerhalb der Happy Hour'); return false }
    }
    if (amount < parseFloat(wheelConfig.min_order_amount)) { console.log('â„¹ï¸ Betrag zu gering fÃ¼r Wheel'); return false }
    await supabase.from('wheel_unlocks').insert({ customer_id: customerId, order_amount: amount, is_used: false, expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() })
    console.log('âœ… GlÃ¼cksrad freigeschaltet!')
    return true
  } catch (e) { console.error('Wheel check error:', e); return false }
}

function normalizePhone(phone) {
  let n = phone.replace(/[\s\-\(\)]/g, '')
  if (n.startsWith('+')) n = n.substring(1)
  if (n.startsWith('00')) n = n.substring(2)
  if (n.startsWith('49') && n.length > 10) n = '0' + n.substring(2)
  if (!n.startsWith('0') && n.length >= 10) n = '0' + n
  return n
}

function showResult(id, msg, type) {
  const el = document.getElementById(id)
  if (!msg) { el.className = ''; el.innerHTML = ''; return }
  el.className = `result ${type}`
  el.innerHTML = msg
}

function showTab(name) {
  if (name !== 'qr') stopCamera()
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
  const tabs = ['orders', 'phone', 'qr', 'history', 'code']
  document.querySelectorAll('.tab')[tabs.indexOf(name)].classList.add('active')
  document.getElementById(`tab-${name}`).classList.add('active')
  if (name === 'history') loadHistory()
  if (name === 'orders') loadOrders()
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEÃ„NDERT: addPointsByPhone mit Betrags-Sicherheit
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addPointsByPhone() {
  const phoneOrId = document.getElementById('phone').value.trim()
  const amount = parseFloat(document.getElementById('amount').value)
  if (!phoneOrId) { showResult('result-phone', 'âŒ Handynummer/QR-ID eingeben!', 'error'); return }
  if (!amount || amount <= 0) { showResult('result-phone', 'âŒ GÃ¼ltigen Betrag eingeben!', 'error'); return }
  
  // Betrags-Validierung mit Callback
  await validateAmount(amount, 
    // onValid - Wird ausgefÃ¼hrt wenn Betrag bestÃ¤tigt wurde
    async () => {
      showResult('result-phone', 'ğŸ” Suche Kunde...', 'info')
      try {
        let customer = null
        if (/^\d{4}$/.test(phoneOrId)) {
          const { data } = await supabase.from('customers').select('*').eq('qr_id', phoneOrId).limit(1)
          if (data && data.length > 0) customer = data[0]
        }
        if (!customer) {
          const { data } = await supabase.from('customers').select('*').eq('phone', normalizePhone(phoneOrId)).limit(1)
          if (data && data.length > 0) customer = data[0]
        }
        if (!customer) throw new Error('Kunde nicht gefunden')
        
        console.log('ğŸ” Suche Global Bonusse fÃ¼r customer_id:', customer.id)
        
        const { data: activeGlobalBonuses, error: bonusError } = await supabase.from('activated_global_bonuses').select('*, global_bonuses(*)').eq('customer_id', customer.id).eq('is_used', false)
        
        console.log('ğŸ“Š Global Bonusse Query Resultat:', activeGlobalBonuses)
        console.log('ğŸ“Š Global Bonusse Error:', bonusError)
        console.log('ğŸ“Š Anzahl gefunden:', activeGlobalBonuses?.length || 0)
        
        if (activeGlobalBonuses && activeGlobalBonuses.length > 0) {
          console.log('ğŸ¯ Erster Bonus:', activeGlobalBonuses[0])
          console.log('ğŸ¯ global_bonuses Objekt:', activeGlobalBonuses[0].global_bonuses)
        }
        
        const { data: activatedCoupons } = await supabase.from('activated_coupons').select('*, coupons(*)').eq('customer_id', customer.id).eq('is_used', false)
        let pointsToAdd = Math.round(amount * 10)
        let bonusApplied = null, bonusPointsAdded = 0, couponUsed = null
        if (activeGlobalBonuses && activeGlobalBonuses.length > 0) {
          const globalBonus = activeGlobalBonuses[0]
          const bonus = globalBonus.global_bonuses
          if (bonus.bonus_type === 'double_points') { bonusPointsAdded = pointsToAdd; pointsToAdd *= 2; bonusApplied = 'â­ Doppelte Punkte!' }
          else if (bonus.bonus_type === 'bonus_points') { bonusPointsAdded = bonus.bonus_amount || 100; pointsToAdd += bonusPointsAdded; bonusApplied = `ğŸ’° +${bonusPointsAdded} Bonus!` }
          // âœ… LÃ¶sche Bonus (statt is_used = true setzen, damit Kunde ihn nochmal aktivieren kann)
          await supabase.from('activated_global_bonuses').delete().eq('id', globalBonus.id)
          // âœ… Setze last_global_bonus_used_at fÃ¼r heute
          await supabase.from('customers').update({ last_global_bonus_used_at: new Date().toISOString() }).eq('id', customer.id)
          console.log('âœ… Globaler Bonus verwendet:', bonusApplied)
        }
        if (activatedCoupons && activatedCoupons.length > 0) {
          const c = activatedCoupons[0]
          await supabase.from('activated_coupons').delete().eq('id', c.id)
          couponUsed = `ğŸŸï¸ Coupon: ${c.coupons.product}`
        }
        const newTotal = customer.points + pointsToAdd
        await supabase.from('transactions').insert({ customer_id: customer.id, type: 'earn', amount, points: pointsToAdd, staff: 'SCANNER' })
        await supabase.from('customers').update({ points: newTotal }).eq('id', customer.id)
        await checkAndUpdateChallenges(customer.id, amount)
        const wheelUnlocked = await checkAndUnlockWheel(customer.id, amount)
        let msg = `âœ… <strong>ERFOLG!</strong><br>ğŸ‘¤ ${customer.name}<br>ğŸ’° ${amount.toFixed(2)} â‚¬<br>â­ +${Math.round(amount * 10)}P`
        if (bonusApplied) msg += `<br>ğŸ‰ ${bonusApplied} (+${bonusPointsAdded}P)`
        if (couponUsed) msg += `<br>âœ… ${couponUsed}`
        msg += `<br>ğŸ“Š Neu: <strong>${newTotal}P</strong>`
        if (wheelUnlocked) { msg += `<br><br><div class="wheel-badge">ğŸ¡ GLÃœCKSRAD FREIGESCHALTET!</div>` }
        showResult('result-phone', msg, 'success')
        document.getElementById('phone').value = ''
        document.getElementById('amount').value = ''
      } catch (e) { showResult('result-phone', `âŒ ${e.message}`, 'error'); console.error('Add points error:', e) }
    },
    // onCancel - Wird ausgefÃ¼hrt wenn abgebrochen wurde
    () => {
      // Nichts tun, Fehlermeldung wird bereits in validateAmount angezeigt
    },
    'result-phone'
  );
}

async function startCamera() {
  try {
    document.getElementById('startBtn').style.display = 'none'
    document.getElementById('stopBtn').style.display = 'block'
    document.getElementById('videoContainer').classList.add('active')
    document.getElementById('customerCard').style.display = 'none'
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } })
    video.srcObject = stream
    video.onloadedmetadata = () => {
      video.play()
      scanning = true
      // Berechne Border dynamisch wie BonusQR
      const videoWidth = video.offsetWidth
      const videoHeight = video.offsetHeight
      const scanBoxSize = 220
      const borderH = (videoHeight - scanBoxSize) / 2
      const borderW = (videoWidth - scanBoxSize) / 2
      document.getElementById('qr-shaded-region').style.borderWidth = borderH + 'px ' + borderW + 'px'
      scanQR()
      showResult('result-qr', 'ğŸ“¸ Kamera aktiv', 'success')
    }
  } catch (e) { showResult('result-qr', 'âŒ Kamera-Fehler: ' + e.message, 'error'); document.getElementById('startBtn').style.display = 'block'; document.getElementById('stopBtn').style.display = 'none'; console.error('Camera error:', e) }
}

function stopCamera() {
  scanning = false
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null }
  if (video) video.srcObject = null
  document.getElementById('videoContainer').classList.remove('active')
  document.getElementById('startBtn').style.display = 'block'
  document.getElementById('stopBtn').style.display = 'none'
}

function scanQR() {
  if (!scanning || !video) return
  try {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth; canvas.height = video.videoHeight
      if (canvas.width > 0 && canvas.height > 0) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" })
        if (code && code.data) { scanning = false; stopCamera(); onQRDetected(code.data); return }
      }
    }
  } catch (e) { console.error('Scan error:', e) }
  if (scanning) setTimeout(() => requestAnimationFrame(scanQR), 100)
}

async function onQRDetected(qrCode) {
  showResult('result-qr', 'âœ… QR: ' + qrCode, 'success')
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ›’ NEU: PrÃ¼fen ob es ein Order-QR ist
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (qrCode.startsWith('ORDER:')) {
    try {
      const parts = qrCode.split(':')
      const customerQRID = parts[1]  // Kunden-Nummer
      const orderNumber = parts[2]   // Bestellnummer
      const orderTotal = parseFloat(parts[3])  // Betrag
      
      // Kunde finden
      const { data: customerData, error: customerError } = await supabase
        .from('customers')
        .select('*')
        .eq('qr_id', customerQRID)
        .limit(1)
      
      if (customerError) throw customerError
      if (!customerData || customerData.length === 0) throw new Error('Kunde nicht gefunden')
      
      const customer = customerData[0]
      currentCustomer = customer
      
      // Order-BestÃ¤tigungs-UI anzeigen
      document.getElementById('customerCard').style.display = 'block'
      const whatsappBadge = customer.whatsapp_optin ? ' <span style="display: inline-block; background: #25D366; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">ğŸ“± WA</span>' : ''
      document.getElementById('custName').innerHTML = customer.name + whatsappBadge + ' <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 12px;"><div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 8px;">ğŸ›’ ONLINE BESTELLUNG</div><div style="font-size: 12px; color: #92400e;">Bestellung: <strong>' + orderNumber + '</strong></div><div style="font-size: 16px; font-weight: 700; color: #E31E24; margin-top: 6px;">Betrag: ' + orderTotal.toFixed(2) + ' â‚¬</div></div>'
      document.getElementById('custQR').textContent = customer.qr_id
      document.getElementById('custPoints').textContent = customer.points
      
      // Spezial-Button fÃ¼r Zahlung bestÃ¤tigen
      document.getElementById('scannedAmount').value = orderTotal.toFixed(2)
      document.getElementById('scannedAmount').readOnly = true
      
      showResult('result-qr', 'ğŸ›’ Online-Bestellung erkannt! Betrag prÃ¼fen und Zahlung bestÃ¤tigen.', 'info')
      
      return  // Fertig - normale QR-Verarbeitung Ã¼berspringen
      
    } catch (e) {
      showResult('result-qr', 'âŒ Fehler bei Order-QR: ' + e.message, 'error')
      console.error('Order QR error:', e)
      setTimeout(() => {
        showResult('result-qr', '', 'info')
        startCamera()
      }, 2000)
      return
    }
  }
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Normale Kunden-QR Verarbeitung (Original Code)
  try {
    const { data, error } = await supabase.from('customers').select('*').eq('qr_id', qrCode).limit(1)
    if (error) throw error
    if (!data || data.length === 0) throw new Error('Kunde nicht gefunden')
    currentCustomer = data[0]
    const whatsappBadge = currentCustomer.whatsapp_optin ? ' <span style="display: inline-block; background: #25D366; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">ğŸ“± WA</span>' : ''
    document.getElementById('custName').innerHTML = currentCustomer.name + whatsappBadge
    document.getElementById('custQR').textContent = currentCustomer.qr_id
    document.getElementById('custPoints').textContent = currentCustomer.points
    const { data: globalBonuses } = await supabase.from('activated_global_bonuses').select('*, global_bonuses(*)').eq('customer_id', currentCustomer.id).eq('is_used', false)
    const badge = document.getElementById('activeBonusBadge')
    if (globalBonuses && globalBonuses.length > 0) { const b = globalBonuses[0].global_bonuses; badge.innerHTML = `<div class="bonus-badge">${b.bonus_type === 'double_points' ? 'ğŸ”¥ 2x Punkte!' : `ğŸ +${b.bonus_amount}P Bonus!`}</div>` }
    else { badge.innerHTML = '' }
    document.getElementById('customerCard').style.display = 'block'
    document.getElementById('scannedAmount').value = ''
    document.getElementById('scannedAmount').readOnly = false
    document.getElementById('scannedAmount').focus()
  } catch (e) { showResult('result-qr', 'âŒ ' + e.message, 'error'); console.error('QR detection error:', e); setTimeout(() => { showResult('result-qr', '', 'info'); startCamera() }, 2000) }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEÃ„NDERT: addPointsFromScan mit Betrags-Sicherheit
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addPointsFromScan() {
  const amount = parseFloat(document.getElementById('scannedAmount').value)
  if (!amount || amount <= 0) { showResult('result-scan', 'âŒ Betrag eingeben!', 'error'); return }
  
  // Betrags-Validierung mit Callback
  await validateAmount(amount,
    // onValid
    async () => {
      try {
        const { data: globalBonuses } = await supabase.from('activated_global_bonuses').select('*, global_bonuses(*)').eq('customer_id', currentCustomer.id).eq('is_used', false)
        let pointsToAdd = Math.round(amount * 10)
        let bonusApplied = null, bonusPointsAdded = 0
        if (globalBonuses && globalBonuses.length > 0) {
          const globalBonus = globalBonuses[0]; const b = globalBonus.global_bonuses
          if (b.bonus_type === 'double_points') { bonusPointsAdded = pointsToAdd; pointsToAdd *= 2; bonusApplied = 'â­ 2x Punkte!' }
          else { bonusPointsAdded = b.bonus_amount || 100; pointsToAdd += bonusPointsAdded; bonusApplied = `ğŸ’° +${bonusPointsAdded}P!` }
          // âœ… LÃ¶sche Bonus (statt is_used = true setzen)
          await supabase.from('activated_global_bonuses').delete().eq('id', globalBonus.id)
          // âœ… Setze last_global_bonus_used_at
          await supabase.from('customers').update({ last_global_bonus_used_at: new Date().toISOString() }).eq('id', currentCustomer.id)
        }
        const newTotal = currentCustomer.points + pointsToAdd
        await supabase.from('transactions').insert({ customer_id: currentCustomer.id, type: 'earn', amount, points: pointsToAdd, staff: 'SCANNER' })
        await supabase.from('customers').update({ points: newTotal }).eq('id', currentCustomer.id)
        await checkAndUpdateChallenges(currentCustomer.id, amount)
        const wheelUnlocked = await checkAndUnlockWheel(currentCustomer.id, amount)
        let msg = `âœ… <strong>ERFOLG!</strong><br>ğŸ‘¤ ${currentCustomer.name}<br>ğŸ’° ${amount.toFixed(2)} â‚¬<br>â­ +${Math.round(amount * 10)}P`
        if (bonusApplied) msg += `<br>ğŸ‰ ${bonusApplied} (+${bonusPointsAdded}P)`
        msg += `<br>ğŸ“Š Neu: <strong>${newTotal}P</strong>`
        if (wheelUnlocked) { msg += `<br><br><div class="wheel-badge">ğŸ¡ GLÃœCKSRAD FREIGESCHALTET!</div>` }
        showResult('result-scan', msg, 'success')
        setTimeout(() => { document.getElementById('customerCard').style.display = 'none'; showResult('result-qr', '', 'info'); document.getElementById('scannedAmount').value = ''; showResult('result-scan', '', 'info') }, 3000)
      } catch (e) { showResult('result-scan', 'âŒ ' + e.message, 'error'); console.error('Scan points error:', e) }
    },
    // onCancel
    () => {
      // Nichts tun
    },
    'result-scan'
  );
}

async function loadHistory() {
  try {
    const { data, error } = await supabase.from('transactions').select('id, customer_id, type, amount, points, notes, staff, created_at').order('created_at', { ascending: false }).limit(50)
    if (error) throw error
    const list = document.getElementById('historyList')
    if (!data || data.length === 0) { list.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Keine Transaktionen</div>'; return }
    
    // Lade Kunden separat
    const customerIds = [...new Set(data.map(t => t.customer_id).filter(Boolean))]
    const { data: customers } = await supabase.from('customers').select('id, name, phone, qr_id').in('id', customerIds)
    const customerMap = {}
    if (customers) {
      customers.forEach(c => { customerMap[c.id] = c })
    }
    
    list.innerHTML = data.map(tx => {
      const date = new Date(tx.created_at)
      const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
      const time = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
      const c = customerMap[tx.customer_id] || { name: 'Unbekannt', phone: '-', qr_id: '-' }
      const isRedeem = tx.type === 'redeem'
      const isWheel = tx.staff === 'WHEEL' || (tx.notes && (tx.notes.includes('WHEEL') || tx.notes.includes('Lucky Wheel') || tx.notes.includes('Wheel')))
      const wheelClass = isWheel ? 'wheel' : ''; const redeemClass = isRedeem ? 'redeem' : ''
      return `<div class="history-item ${redeemClass} ${wheelClass}"><div style="display:flex;justify-content:space-between;margin-bottom:8px;align-items:center;"><div style="font-weight:700;font-size:16px;">${isRedeem ? 'ğŸ' : (isWheel ? 'ğŸ¡' : 'ğŸ’°')} ${c.name}${isWheel ? '<span class="wheel-badge-small">ğŸ¡ Lucky Wheel</span>' : ''}</div><div style="font-size:12px;color:#666;">${dateStr} ${time}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;"><div>ğŸ“± ${c.phone}</div><div>ğŸ†” ${c.qr_id}</div>${isRedeem ? `<div style="color:#92400e;font-weight:600;">ğŸ ${tx.notes || 'EingelÃ¶st'}</div>` : (isWheel ? `<div style="color:#f59e0b;font-weight:600;">ğŸ¡ Lucky Wheel Gewinn</div>` : `<div style="color:#059669;font-weight:600;">ğŸ’° ${tx.amount.toFixed(2)} â‚¬</div>`)}<div style="color:${isRedeem ? '#ef4444' : '#E31E24'};font-weight:600;">â­ ${isRedeem ? Math.abs(tx.points) : '+' + tx.points}P${isWheel ? ' (ğŸ¡ Gewinn)' : ''}</div></div><div style="display:flex;gap:6px;margin-top:10px;"><button class="small secondary" onclick="editTransaction(${tx.id}, ${tx.amount}, ${tx.points}, ${tx.customer_id})">âœï¸ Bearbeiten</button><button class="small danger" onclick="deleteTransaction(${tx.id}, ${tx.customer_id}, ${tx.points})">ğŸ—‘ï¸ LÃ¶schen</button></div></div>`
    }).join('')
  } catch (e) { console.error('Load history error:', e); document.getElementById('historyList').innerHTML = `<div class="result error">${e.message}</div>` }
}

async function verifyAnyCode() {
  const code = document.getElementById('code').value.trim()
  if (!code || code.length !== 4) { showResult('result-code', 'âŒ 4-stelligen Code eingeben!', 'error'); return }
  showResult('result-code', 'ğŸ” Suche Code...', 'info')
  try {
    const { data, error } = await supabase.from('activated_coupons').select('*').eq('unique_code', code).eq('is_used', false).limit(1)
    if (error) throw error
    const activation = data && data[0]
    if (activation) {
      const { data: coupon } = await supabase.from('coupons').select('*').eq('id', activation.coupon_id).single()
      const { data: customer } = await supabase.from('customers').select('name, phone, qr_id, points').eq('id', activation.customer_id).single()
      activation.coupons = coupon; activation.customers = customer
      await handleCouponCode(activation, code); return
    }
  } catch (e) { console.error('Coupon check error:', e) }
  try {
    const { data, error } = await supabase.from('redeem_codes').select('*').eq('code', code).limit(1)
    if (error) throw error
    if (!data || data.length === 0) throw new Error('Code nicht gefunden')
    const { data: customer } = await supabase.from('customers').select('name, phone, qr_id, points').eq('id', data[0].customer_id).single()
    data[0].customers = customer
    await handleRedeemCode(data[0], code)
  } catch (e) { showResult('result-code', 'âŒ ' + e.message, 'error'); console.error('Code verification error:', e) }
}

async function handleCouponCode(activation, code) {
  try {
    const coupon = activation.coupons; const customer = activation.customers
    // Check expiry using end_date with end of day logic
    const endDate = coupon.end_date ? new Date(coupon.end_date) : new Date(coupon.expires_at)
    endDate.setHours(23, 59, 59, 999)
    if (endDate < new Date()) throw new Error('Coupon abgelaufen')
    const expires = endDate.toLocaleDateString('de-DE')
    const price = parseFloat(coupon.price || 0).toFixed(2).replace('.', ',') + ' â‚¬'
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `<div class="code-item" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid #f59e0b;"><h3>ğŸŸï¸ ${coupon.title}</h3><div class="code">${code}</div><div style="font-size:14px;color:#92400e;margin:12px 0;"><strong>Produkt:</strong> ${coupon.product}<br><strong>Preis:</strong> ${price}<br><strong>Kunde:</strong> ${customer.name} (${customer.phone})<br><strong>Punkte:</strong> ${customer.points}<br><strong>GÃ¼ltig bis:</strong> ${expires}</div><button onclick="useCoupon('${activation.id}')" class="success" style="width:100%;margin-bottom:8px;">âœ… Coupon einlÃ¶sen</button><button onclick="cancelCodeConfirm()" class="secondary" style="width:100%;">âŒ Abbrechen</button></div>`
    showResult('result-code', 'âœ… Coupon gefunden!', 'success')
  } catch (e) { showResult('result-code', 'âŒ ' + e.message, 'error'); document.getElementById('code-details').style.display = 'none'; console.error('Handle coupon error:', e) }
}

async function handleRedeemCode(codeData, code) {
  try {
    if (codeData.used) throw new Error('Code bereits verwendet')
    if (new Date(codeData.valid_until) < new Date()) throw new Error('Code abgelaufen')
    const customer = codeData.customers
    showResult('result-code', 'â³ Code wird eingelÃ¶st...', 'info')
    const newPoints = customer.points - codeData.points_cost
    await supabase.from('transactions').insert({ customer_id: codeData.customer_id, type: 'redeem', amount: 0, points: -codeData.points_cost, staff: 'Scanner', notes: `${codeData.reward_name} (Code: ${code})` })
    await supabase.from('customers').update({ points: newPoints }).eq('id', codeData.customer_id)
    await supabase.from('redeem_codes').update({ used: true, used_at: new Date().toISOString() }).eq('code', code)
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `<div class="code-item" style="background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:2px solid #10b981;"><div style="font-size:60px;text-align:center;margin:20px 0;">âœ…</div><h3 style="text-align:center;color:#065f46;font-size:28px;margin-bottom:16px;">Erfolgreich eingelÃ¶st!</h3><div style="font-size:22px;font-weight:700;color:#059669;text-align:center;margin:20px 0;">ğŸ ${codeData.reward_name}</div><div style="font-size:16px;color:#065f46;text-align:center;margin:16px 0;"><strong>Kunde:</strong> ${customer.name}<br><strong>Neue Punkte:</strong> ${newPoints}</div><button onclick="closeCodeDetails()" class="success" style="width:100%;margin-top:16px;">Weiter</button></div>`
    showResult('result-code', 'âœ… Code erfolgreich eingelÃ¶st!', 'success')
  } catch (e) { showResult('result-code', 'âŒ ' + e.message, 'error'); console.error('Handle redeem error:', e) }
}

function closeCodeDetails() { document.getElementById('code').value = ''; document.getElementById('code-details').style.display = 'none' }

async function useCoupon(activationId) {
  try {
    showResult('result-code', 'â³ LÃ¶se Coupon ein...', 'info')
    await supabase.from('activated_coupons').delete().eq('id', activationId)
    showResult('result-code', 'âœ… Coupon erfolgreich eingelÃ¶st!', 'success')
    document.getElementById('code').value = ''; document.getElementById('code-details').style.display = 'none'
  } catch (e) { showResult('result-code', 'âŒ Fehler: ' + e.message, 'error'); console.error('Use coupon error:', e) }
}

function cancelCodeConfirm() { document.getElementById('code-details').style.display = 'none'; currentCodeData = null; showResult('result-code', '', 'info') }

async function editTransaction(txId, currentAmount, currentPoints, customerId) {
  const newAmount = prompt('Neuer Betrag in â‚¬ eingeben:', currentAmount)
  if (!newAmount || isNaN(newAmount)) return
  const amount = parseFloat(newAmount); const newPoints = Math.round(amount * 10); const pointsDiff = newPoints - currentPoints
  try {
    await supabase.from('transactions').update({ amount: amount, points: newPoints }).eq('id', txId)
    const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
    if (customer) { await supabase.from('customers').update({ points: customer.points + pointsDiff }).eq('id', customerId) }
    loadHistory(); alert('âœ… Transaktion bearbeitet!')
  } catch (e) { alert('âŒ Fehler: ' + e.message); console.error('Edit transaction error:', e) }
}

async function deleteTransaction(txId, customerId, points) {
  if (!confirm('Transaktion wirklich lÃ¶schen? Punkte werden zurÃ¼ckgesetzt.')) return
  try {
    await supabase.from('transactions').delete().eq('id', txId)
    const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
    if (customer) { await supabase.from('customers').update({ points: customer.points - points }).eq('id', customerId) }
    loadHistory(); alert('âœ… Transaktion gelÃ¶scht!')
  } catch (e) { alert('âŒ Fehler: ' + e.message); console.error('Delete transaction error:', e) }
}


// ============================================
// ğŸ“¦ BESTELLUNGS-SYSTEM
// ============================================

let ordersSubscription = null
let wheelConfig = null
let notificationSound = null

const NOTIFICATION_SOUND_BASE64 = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQwOUKLe77JZGQg4kdv1sn0oRD8E'

function initNotificationSound() {
  notificationSound = new Audio(NOTIFICATION_SOUND_BASE64)
  notificationSound.volume = 1.0
}

function playNotificationSound() {
  if (notificationSound) {
    notificationSound.currentTime = 0
    notificationSound.play().catch(e => console.log('Sound play error:', e))
  }
}

function showBrowserNotification(title, body) {
  if (!('Notification' in window)) return
  if (Notification.permission === 'granted') {
    new Notification(title, { body: body, icon: '/logo-round-new.png', badge: '/favicon-new.png', tag: 'doener-boxx-order', requireInteraction: true })
  } else if (Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') new Notification(title, { body: body, icon: '/logo-round-new.png' })
    })
  }
}

function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission()
}

function testNotification() {
  playNotificationSound()
  showBrowserNotification('Test Benachrichtigung', 'Das Benachrichtigungssystem funktioniert! ğŸ‰')
  alert('âœ… Test-Benachrichtigung wurde ausgelÃ¶st!')
}

async function loadWheelConfig() {
  try {
    const { data, error } = await supabase.from('wheel_config').select('*').limit(1)
    if (error) throw error
    if (data && data.length > 0) {
      wheelConfig = data[0]
      console.log('âœ… Wheel Config geladen:', wheelConfig)
    }
  } catch (e) {
    console.error('Fehler beim Laden der Wheel Config:', e)
    wheelConfig = null
  }
}

function isWheelAvailable(orderAmount) {
  if (!wheelConfig || !wheelConfig.is_active || orderAmount < wheelConfig.min_order_amount) return false
  if (wheelConfig.active_days && wheelConfig.active_days.length > 0) {
    const today = new Date().getDay()
    if (!wheelConfig.active_days.includes(today)) return false
  }
  if (wheelConfig.start_time && wheelConfig.end_time) {
    const now = new Date()
    const currentTime = now.getHours() * 60 + now.getMinutes()
    const [startH, startM] = wheelConfig.start_time.split(':').map(Number)
    const [endH, endM] = wheelConfig.end_time.split(':').map(Number)
    const startMinutes = startH * 60 + startM
    const endMinutes = endH * 60 + endM
    if (currentTime < startMinutes || currentTime > endMinutes) return false
  }
  return true
}

async function loadOrders() {
  try {
    const { data, error } = await supabase.from('orders').select('*').in('status', ['pending', 'preparing', 'ready']).order('created_at', { ascending: false })
    
    if (error) {
      console.error('loadOrders Fehler:', error)
      
      // Zeige hilfreiche Fehlermeldung
      const container = document.getElementById('ordersList')
      if (container) {
        if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
          // Tabelle existiert nicht
          container.innerHTML = `
            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 24px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
              <h3 style="color: #92400e; margin-bottom: 12px;">Orders-Tabelle fehlt</h3>
              <p style="color: #78350f; margin-bottom: 16px;">
                Die Supabase Tabelle "orders" existiert noch nicht.<br>
                Bitte erstelle sie in der Supabase Console.
              </p>
              <details style="text-align: left; background: white; padding: 12px; border-radius: 8px; font-size: 13px;">
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 8px;">ğŸ“‹ SQL Schema anzeigen</summary>
                <pre style="overflow-x: auto; font-size: 11px;">CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_number TEXT UNIQUE NOT NULL,
  customer_id UUID REFERENCES customers(id),
  customer_name TEXT NOT NULL,
  customer_phone TEXT NOT NULL,
  qr_id TEXT NOT NULL,
  items JSONB NOT NULL,
  total DECIMAL(10,2) NOT NULL,
  payment_method TEXT NOT NULL,
  payment_status TEXT DEFAULT 'pending',
  pickup_type TEXT DEFAULT 'now',
  pickup_time TEXT,
  notes TEXT,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ
);</pre>
              </details>
            </div>
          `
        } else {
          // Anderer Fehler
          container.innerHTML = `
            <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 24px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
              <h3 style="color: #991b1b; margin-bottom: 12px;">Fehler beim Laden</h3>
              <p style="color: #7f1d1d;">${error.message}</p>
            </div>
          `
        }
      }
      return
    }
    
    renderOrders(data || [])
    updateOrderBadge(data ? data.filter(o => o.status === 'pending').length : 0)
  } catch (e) {
    console.error('Fehler beim Laden der Bestellungen:', e)
  }
}

function updateOrderBadge(count) {
  const badge = document.getElementById('orderBadge')
  if (badge) {
    if (count > 0) {
      badge.textContent = count
      badge.style.display = 'inline-block'
    } else {
      badge.style.display = 'none'
    }
  }
}

function formatPrice(price) {
  return price.toFixed(2).replace('.', ',') + ' â‚¬'
}

function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000)
  if (seconds < 60) return 'Gerade eben'
  if (seconds < 3600) return `vor ${Math.floor(seconds / 60)} Min`
  if (seconds < 86400) return `vor ${Math.floor(seconds / 3600)} Std`
  return `vor ${Math.floor(seconds / 86400)} Tagen`
}

function renderOrders(orders) {
  const container = document.getElementById('ordersList')
  if (!container) return
  
  if (!orders || orders.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div><p>Keine offenen Bestellungen</p></div>'
    return
  }
  
  container.innerHTML = orders.map(order => {
    const createdAt = new Date(order.created_at)
    const timeAgo = getTimeAgo(createdAt)
    let statusText = 'Neu', statusClass = 'pending'
    if (order.status === 'preparing') { statusText = 'In Vorbereitung'; statusClass = 'preparing' }
    else if (order.status === 'ready') { statusText = 'Bereit zur Abholung'; statusClass = 'ready' }
    const paymentText = order.payment_method === 'paypal' ? 'PayPal' : 'Bar'
    const paymentClass = order.payment_method === 'paypal' ? 'paypal' : 'cash'
    
    const items = order.items.map(item => {
      let optionsText = ''
      if (item.options) {
        const optionsList = Object.keys(item.options).filter(key => {
          const value = item.options[key]
          const defaultValue = item.product.options[key]?.default
          return value !== defaultValue
        }).map(key => {
          const value = item.options[key]
          const label = item.product.options[key]?.label || key
          if (typeof value === 'string') return `${label}: ${value}`
          return `${label}: ${value === 0 ? 'Ohne' : value === 1 ? '1x' : '2x'}`
        })
        const extrasList = item.extras?.map(extraId => {
          const extra = item.product.extras?.find(e => e.id === extraId)
          return extra ? `+ ${extra.name}` : ''
        }).filter(Boolean) || []
        const allOptions = [...optionsList, ...extrasList].filter(Boolean)
        if (allOptions.length > 0) optionsText = `<div class="order-item-options">${allOptions.join(', ')}</div>`
      }
      return `<div class="order-item"><div class="order-item-name">${item.product.name} - ${formatPrice(item.price)}</div>${optionsText}</div>`
    }).join('')
    
    const pickupInfo = order.pickup_type === 'later' && order.pickup_time ? `<p><strong>Abholzeit:</strong> ${order.pickup_time} Uhr</p>` : '<p><strong>Abholzeit:</strong> Sofort</p>'
    
    let actions = ''
    if (order.status === 'pending') {
      if (order.payment_method === 'cash') {
        // Nur EIN Button - macht automatisch alles
        actions = `<button onclick="markOrderPaid('${order.id}', '${order.customer_id}', ${order.total})" class="success">ğŸ’° Bar bezahlt âœ…</button>`
      } else {
        // PayPal: Nur EIN Button - macht automatisch alles
        actions = `<button onclick="markPayPalPaid('${order.id}', '${order.customer_id}', ${order.total})" class="success">ğŸ’³ PayPal bezahlt âœ…</button>`
      }
    }
    // Alle anderen Status zeigen keine Buttons mehr - wird automatisch abgeschlossen!
    
    return `<div class="order-card ${statusClass}"><div class="order-header"><div><span class="order-number">#${order.order_number}</span><span class="order-badge ${statusClass}">${statusText}</span><span class="payment-badge ${paymentClass}">${paymentText}</span></div><div class="order-time">${timeAgo}</div></div><div class="order-customer"><p><strong>ğŸ‘¤ ${order.customer_name}</strong></p><p>ğŸ“± ${order.customer_phone}</p><p>ğŸ« QR-ID: ${order.qr_id}</p>${pickupInfo}${order.notes ? `<p><strong>ğŸ’¬ Notiz:</strong> ${order.notes}</p>` : ''}</div><div class="order-items">${items}</div><div class="order-total"><span>Gesamt:</span><span style="color: #E31E24;">${formatPrice(order.total)}</span></div><div class="order-actions">${actions}</div></div>`
  }).join('')
}

async function markOrderPaid(orderId, customerId, total) {
  try {
    console.log('ğŸ’° Bar bezahlt - Auto-Workflow startet...')
    
    // Hole die Bestellung
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .select('*')
      .eq('id', orderId)
      .single()
    
    if (orderError || !order) {
      throw new Error('Bestellung nicht gefunden')
    }
    
    // 1. Status: preparing
    await supabase.from('orders').update({ status: 'preparing' }).eq('id', orderId)
    
    // 2. Punkte gutschreiben
    if (order.customer_phone && total) {
      await addPointsForPhone(order.customer_phone, total)
    } else if (customerId && total) {
      await addPointsForCustomerId(customerId, total)
    }
    
    // 3. Telegram: Bar bezahlt
    await sendTelegramUpdate(order.order_number, order.customer_name, 'paid', 'ğŸ’° Bar bezahlt')
    
    // 4. Status: ready
    await supabase.from('orders').update({ status: 'ready' }).eq('id', orderId)
    await sendTelegramUpdate(order.order_number, order.customer_name, 'ready', 'ğŸ“¦ Bereit zur Abholung!')
    
    // 5. Status: completed
    await supabase.from('orders').update({ 
      status: 'completed', 
      completed_at: new Date().toISOString() 
    }).eq('id', orderId)
    await sendTelegramUpdate(order.order_number, order.customer_name, 'completed', 'âœ… Abgeschlossen!')
    
    console.log('âœ… Bestellung komplett abgewickelt!')
    loadOrders()
  } catch (e) {
    console.error('markOrderPaid Fehler:', e)
  }
}

async function markPayPalPaid(orderId, customerId, total) {
  try {
    console.log('ğŸ’³ PayPal bezahlt - Auto-Workflow startet...')
    
    // Hole die Bestellung
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .select('*')
      .eq('id', orderId)
      .single()
    
    if (orderError || !order) {
      throw new Error('Bestellung nicht gefunden')
    }
    
    // 1. Status: preparing
    await supabase.from('orders').update({ status: 'preparing' }).eq('id', orderId)
    
    // 2. Punkte gutschreiben
    if (order.customer_phone && total) {
      await addPointsForPhone(order.customer_phone, total)
    } else if (customerId && total) {
      await addPointsForCustomerId(customerId, total)
    }
    
    // 3. Telegram: PayPal bezahlt
    await sendTelegramUpdate(order.order_number, order.customer_name, 'paid', 'ğŸ’³ PayPal bezahlt')
    
    // 4. Status: ready
    await supabase.from('orders').update({ status: 'ready' }).eq('id', orderId)
    await sendTelegramUpdate(order.order_number, order.customer_name, 'ready', 'ğŸ“¦ Bereit zur Abholung!')
    
    // 5. Status: completed
    await supabase.from('orders').update({ 
      status: 'completed', 
      completed_at: new Date().toISOString() 
    }).eq('id', orderId)
    await sendTelegramUpdate(order.order_number, order.customer_name, 'completed', 'âœ… Abgeschlossen!')
    
    console.log('âœ… Bestellung komplett abgewickelt!')
    loadOrders()
  } catch (e) {
    console.error('markPayPalPaid Fehler:', e)
  }
}

async function markOrderPreparing(orderId) {
  try {
    console.log('Marking order as preparing:', orderId)
    const { error } = await supabase.from('orders').update({ status: 'preparing' }).eq('id', orderId)
    if (error) {
      console.error('Update error:', error)
      throw error
    }
    loadOrders()
  } catch (e) {
    console.error('markOrderPreparing Fehler:', e)
    alert('âŒ Fehler: ' + e.message)
  }
}

async function markOrderReady(orderId) {
  try {
    console.log('Marking order as ready:', orderId)
    
    // Hole Bestellung fÃ¼r Telegram
    const { data: order } = await supabase.from('orders').select('*').eq('id', orderId).single()
    
    const { error } = await supabase.from('orders').update({ status: 'ready' }).eq('id', orderId)
    if (error) {
      console.error('Update error:', error)
      throw error
    }
    
    // ğŸ¤– Telegram Benachrichtigung
    if (order) {
      await sendTelegramUpdate(order.order_number, order.customer_name, 'ready', 'ğŸ“¦ Bereit zur Abholung!')
    }
    
    loadOrders()
  } catch (e) {
    console.error('markOrderReady Fehler:', e)
    alert('âŒ Fehler: ' + e.message)
  }
}

async function completeOrder(orderId, customerId, qrId, total, paymentMethod) {
  try {
    console.log('ğŸ‰ Completing order:', { orderId, customerId, qrId, total, paymentMethod })
    
    // EINFACH: Verwende die customer_id die wir bereits haben!
    if (!customerId) {
      console.error('âŒ Keine customer_id Ã¼bergeben!')
      alert('Fehler: Keine Kunden-ID vorhanden')
      return
    }
    
    console.log('âœ… Verwende customer_id:', customerId)
    
    // PrÃ¼fe Wheel-Berechtigung
    const wheelAvailable = isWheelAvailable(total)
    if (wheelAvailable) {
      // Automatisch freischalten ohne Modal
      await triggerLuckyWheel(orderId, customerId, paymentMethod)
    } else {
      await finalizeOrder(orderId, customerId, paymentMethod)
    }
  } catch (e) {
    console.error('âŒ completeOrder Fehler:', e)
    alert('âŒ Fehler: ' + e.message)
  }
}
async function finalizeOrder(orderId, customerId, paymentMethod) {
  try {
    // Hole Bestellung fÃ¼r Telegram
    const { data: order } = await supabase.from('orders').select('*').eq('id', orderId).single()
    
    const { error } = await supabase.from('orders').update({ status: 'completed', completed_at: new Date().toISOString() }).eq('id', orderId)
    if (error) throw error
    
    // ğŸ¤– Telegram Benachrichtigung
    if (order) {
      await sendTelegramUpdate(order.order_number, order.customer_name, 'completed', 'âœ… Abgeschlossen!')
    }
    
    loadOrders()
  } catch (e) {
    console.error('Fehler:', e)
  }
}

async function cancelOrder(orderId) {
  try {
    console.log('Cancelling order:', orderId)
    const { error } = await supabase.from('orders').update({ status: 'cancelled', cancelled_at: new Date().toISOString() }).eq('id', orderId)
    if (error) {
      console.error('Cancel error:', error)
      throw error
    }
    loadOrders()
  } catch (e) {
    console.error('cancelOrder Fehler:', e)
  }
}

async function addPointsForOrder(qrId, amount) {
  try {
    console.log('ğŸ’° Gutschreibe Punkte fÃ¼r QR-ID:', qrId, 'Betrag:', amount)
    
    // Robuste Customer Suche
    let customer = await findCustomer(qrId, 'qr_id')
    
    if (!customer) {
      console.error('âŒ Kunde nicht gefunden - Punkte kÃ¶nnen nicht gutgeschrieben werden')
      return
    }
    
    console.log('âœ… Kunde gefunden:', customer.name)
    
    const points = Math.floor(amount * 10) // 1â‚¬ = 10 Punkte
    
    // Update Punkte
    const { error: updateError } = await supabase
      .from('customers')
      .update({ points: customer.points + points })
      .eq('id', customer.id)
    
    if (updateError) {
      console.error('âŒ Fehler beim Update:', updateError)
      return
    }
    
    // Transaktion speichern
    await supabase
      .from('transactions')
      .insert({
        customer_id: customer.id,
        type: 'earn',
        amount: amount,
        points: points,
        staff: 'ONLINE-ORDER',
        notes: `Online-Bestellung: ${points}P`
      })
    
    // Challenges prÃ¼fen
    await checkAndUpdateChallenges(customer.id, amount)
    
    console.log(`âœ… ${points} Punkte gutgeschrieben fÃ¼r ${customer.name}`)
  } catch (e) {
    console.error('âŒ Fehler beim Gutschreiben der Punkte:', e)
  }
}
function showLuckyWheelModal(orderId, customerId, qrId, total, paymentMethod) {
  const modal = document.createElement('div')
  modal.className = 'wheel-modal active'
  modal.id = 'wheelModal'
  modal.innerHTML = `<div class="wheel-modal-content"><h2>ğŸ¡ GlÃ¼cksrad verfÃ¼gbar!</h2><p style="margin-bottom: 20px;">Der Kunde hat Ã¼ber ${wheelConfig.min_order_amount.toFixed(2)}â‚¬ bestellt und kann am GlÃ¼cksrad drehen!</p><div style="margin-bottom: 20px;"><p style="font-size: 14px; color: #666;">Bestellsumme: <strong>${formatPrice(total)}</strong></p><p style="font-size: 14px; color: #666;">QR-ID: <strong>${qrId}</strong></p></div><button onclick="triggerLuckyWheel('${orderId}', '${customerId}', '${paymentMethod}')" class="success" style="width: 100%; margin-bottom: 10px;">ğŸ¡ GlÃ¼cksrad freischalten</button><button onclick="skipLuckyWheel('${orderId}', '${customerId}', '${paymentMethod}')" class="secondary" style="width: 100%;">â­ï¸ Ãœberspringen</button></div>`
  document.body.appendChild(modal)
}

function closeLuckyWheelModal() {
  const modal = document.getElementById('wheelModal')
  if (modal) modal.remove()
}


async function addPointsForCustomerId(customerId, amount) {
  try {
    console.log('ğŸ’° Gutschreibe Punkte fÃ¼r customer_id:', customerId, 'Betrag:', amount)
    
    // Hole Customer
    const { data: customers, error: lookupError } = await supabase
      .from('customers')
      .select('*')
      .eq('id', customerId)
      .limit(1)
    
    if (lookupError || !customers || customers.length === 0) {
      console.error('âŒ Kunde nicht gefunden:', lookupError)
      return
    }
    
    const customer = customers[0]
    console.log('âœ… Kunde gefunden:', customer.name)
    
    // âœ… Global Bonusse prÃ¼fen
    const { data: activeGlobalBonuses } = await supabase
      .from('activated_global_bonuses')
      .select('*, global_bonuses(*)')
      .eq('customer_id', customer.id)
      .eq('is_used', false)
    
    let points = Math.floor(amount * 10) // 1â‚¬ = 10 Punkte
    let bonusApplied = null
    
    if (activeGlobalBonuses && activeGlobalBonuses.length > 0) {
      const globalBonus = activeGlobalBonuses[0]
      const bonus = globalBonus.global_bonuses
      
      if (bonus.bonus_type === 'double_points') {
        points *= 2  // Doppelte Punkte!
        bonusApplied = 'â­ Doppelte Punkte!'
        console.log('ğŸ‰ Global Bonus angewendet: Doppelte Punkte!', points)
      }
      else if (bonus.bonus_type === 'bonus_points') {
        points += (bonus.bonus_amount || 100)
        bonusApplied = `ğŸ’° +${bonus.bonus_amount}P Bonus!`
        console.log(`ğŸ‰ Global Bonus angewendet: +${bonus.bonus_amount}P`, points)
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… BONUS EINLÃ–SEN: LÃ¶sche aus activated_global_bonuses
      // âœ… NEU: Speichere in used_global_bonuses_history fÃ¼r permanente Historie
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      await supabase.from('activated_global_bonuses').delete().eq('id', globalBonus.id)
      
      // âœ… NEU: Erstelle Eintrag in Historie - Kunde kann diesen Bonus nie wieder einlÃ¶sen
      await supabase.from('used_global_bonuses_history').insert({
        customer_id: customer.id,
        global_bonus_id: bonus.id  // WICHTIG: Die ID des global_bonuses, nicht der Aktivierung!
      })
      
      console.log('âœ… Bonus eingelÃ¶st und in Historie gespeichert')
    }
    
    // Update Punkte
    const { error: updateError } = await supabase
      .from('customers')
      .update({ points: customer.points + points })
      .eq('id', customer.id)
    
    if (updateError) {
      console.error('âŒ Fehler beim Update:', updateError)
      return
    }
    
    // Transaktion speichern
    await supabase
      .from('transactions')
      .insert({
        customer_id: customer.id,
        type: 'earn',
        amount: amount,
        points: points,
        staff: 'ONLINE-ORDER',
        notes: bonusApplied ? `Online-Bestellung: ${points}P (${bonusApplied})` : `Online-Bestellung: ${points}P`
      })
    
    // Challenges prÃ¼fen
    await checkAndUpdateChallenges(customer.id, amount)
    
    // ğŸ¡ Lucky Wheel prÃ¼fen (bei Online-Bestellung)
    await checkAndUnlockWheel(customer.id, amount)
    
    console.log(`âœ… ${points} Punkte gutgeschrieben fÃ¼r ${customer.name}`)
  } catch (e) {
    console.error('âŒ Fehler beim Gutschreiben der Punkte:', e)
  }
}

async function addPointsForPhone(phone, amount) {
  try {
    console.log('ğŸ’° Gutschreibe Punkte fÃ¼r Telefon:', phone, 'Betrag:', amount)
    
    // Normalisiere Telefonnummer
    let normalized = phone.replace(/[\s\-\(\)]/g, '')
    if (normalized.startsWith('+')) normalized = normalized.substring(1)
    if (normalized.startsWith('00')) normalized = normalized.substring(2)
    if (normalized.startsWith('49') && normalized.length > 10) normalized = '0' + normalized.substring(2)
    if (!normalized.startsWith('0') && normalized.length >= 10) normalized = '0' + normalized
    
    // Hole Customer Ã¼ber Telefon
    const { data: customers, error: lookupError } = await supabase
      .from('customers')
      .select('*')
      .eq('phone', normalized)
      .limit(1)
    
    if (lookupError || !customers || customers.length === 0) {
      console.error('âŒ Kunde mit Telefon nicht gefunden:', phone, normalized)
      alert('âš ï¸ Kunde nicht in System gefunden!\nTelefon: ' + phone + '\nKunde muss sich zuerst registrieren.')
      return
    }
    
    const customer = customers[0]
    console.log('âœ… Kunde gefunden:', customer.name)
    
    // âœ… Global Bonusse prÃ¼fen
    const { data: activeGlobalBonuses } = await supabase
      .from('activated_global_bonuses')
      .select('*, global_bonuses(*)')
      .eq('customer_id', customer.id)
      .eq('is_used', false)
    
    let points = Math.floor(amount * 10) // 1â‚¬ = 10 Punkte
    let bonusApplied = null
    
    if (activeGlobalBonuses && activeGlobalBonuses.length > 0) {
      const globalBonus = activeGlobalBonuses[0]
      const bonus = globalBonus.global_bonuses
      
      if (bonus.bonus_type === 'double_points') {
        points *= 2  // Doppelte Punkte!
        bonusApplied = 'â­ Doppelte Punkte!'
        console.log('ğŸ‰ Global Bonus angewendet: Doppelte Punkte!', points)
      }
      else if (bonus.bonus_type === 'bonus_points') {
        points += (bonus.bonus_amount || 100)
        bonusApplied = `ğŸ’° +${bonus.bonus_amount}P Bonus!`
        console.log(`ğŸ‰ Global Bonus angewendet: +${bonus.bonus_amount}P`, points)
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… BONUS EINLÃ–SEN: LÃ¶sche aus activated_global_bonuses
      // âœ… NEU: Speichere in used_global_bonuses_history fÃ¼r permanente Historie
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      await supabase.from('activated_global_bonuses').delete().eq('id', globalBonus.id)
      
      // âœ… NEU: Erstelle Eintrag in Historie - Kunde kann diesen Bonus nie wieder einlÃ¶sen
      await supabase.from('used_global_bonuses_history').insert({
        customer_id: customer.id,
        global_bonus_id: bonus.id  // WICHTIG: Die ID des global_bonuses, nicht der Aktivierung!
      })
      
      console.log('âœ… Bonus eingelÃ¶st und in Historie gespeichert')
    }
    
    // Update Punkte
    const { error: updateError } = await supabase
      .from('customers')
      .update({ points: customer.points + points })
      .eq('id', customer.id)
    
    if (updateError) {
      console.error('âŒ Fehler beim Update:', updateError)
      return
    }
    
    // Transaktion speichern
    await supabase
      .from('transactions')
      .insert({
        customer_id: customer.id,
        type: 'earn',
        amount: amount,
        points: points,
        staff: 'PAYPAL-ORDER',
        notes: bonusApplied ? `PayPal-Bestellung: ${points}P (${bonusApplied})` : `PayPal-Bestellung: ${points}P`
      })
    
    // Challenges prÃ¼fen
    await checkAndUpdateChallenges(customer.id, amount)
    
    // ğŸ¡ Lucky Wheel prÃ¼fen (bei Online-Bestellung)
    await checkAndUnlockWheel(customer.id, amount)
    
    console.log(`âœ… ${points} Punkte gutgeschrieben fÃ¼r ${customer.name}`)
  } catch (e) {
    console.error('âŒ Fehler beim Gutschreiben der Punkte:', e)
  }
}

async function triggerLuckyWheel(orderId, customerId, paymentMethod) {
  try {
    // Erstelle wheel_unlock Eintrag fÃ¼r den Kunden
    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + 7) // 7 Tage gÃ¼ltig
    
    const { error: unlockError } = await supabase
      .from('wheel_unlocks')
      .insert({
        customer_id: customerId,
        is_used: false,
        expires_at: expiresAt.toISOString()
      })
    
    if (unlockError) {
      console.error('Wheel unlock error:', unlockError)
    } else {
      console.log('âœ… GlÃ¼cksrad automatisch freigeschaltet!')
    }
    
    await finalizeOrder(orderId, customerId, paymentMethod)
  } catch (e) {
    console.error('Fehler:', e)
  }
}

async function skipLuckyWheel(orderId, customerId, paymentMethod) {
  try {
    await finalizeOrder(orderId, customerId, paymentMethod)
    closeLuckyWheelModal()
  } catch (e) {
    alert('âŒ Fehler: ' + e.message)
  }
}

function setupRealtimeSubscription() {
  if (ordersSubscription) ordersSubscription.unsubscribe()
  ordersSubscription = supabase.channel('orders_channel')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, (payload) => {
      console.log('ğŸ†• Neue Bestellung:', payload.new)
      handleNewOrder(payload.new)
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders' }, () => loadOrders())
    .subscribe()
  console.log('âœ… Realtime Subscription aktiv')
}

function handleNewOrder(order) {
  playNotificationSound()
  showBrowserNotification(`ğŸ†• Neue Bestellung #${order.order_number}`, `${order.customer_name} - ${formatPrice(order.total)} - ${order.payment_method === 'paypal' ? 'PayPal' : 'Bar'}`)
  loadOrders()
  // âš ï¸ KEINE automatische Punkte-Gutschrift bei PayPal!
  // Punkte werden erst gutgeschrieben wenn Mitarbeiter PayPal-Zahlung bestÃ¤tigt
}

function initOrderSystem() {
  console.log('ğŸš€ Initialisiere Bestellungs-System...')
  initNotificationSound()
  requestNotificationPermission()
  loadWheelConfig()
  setupRealtimeSubscription()
  loadOrders()
  
  // ğŸ”„ Auto-Refresh: Lade Bestellungen alle 15 Sekunden
  // (ZusÃ¤tzlich zu Realtime, falls Realtime ausfÃ¤llt)
  setInterval(() => {
    console.log('ğŸ”„ Auto-Refresh: Lade Bestellungen...')
    loadOrders()
  }, 15000)
  
  console.log('âœ… Bestellungs-System bereit!')
  console.log('ğŸ”„ Auto-Refresh aktiv: Alle 15 Sekunden')
}

setTimeout(initOrderSystem, 1000)


console.log('âœ… DÃ¶ner Boxx Scanner PRO geladen!')
console.log('ğŸ”’ Betrags-Sicherheit aktiv: Warnung ab ' + BETRAG_WARNUNG_AB + 'â‚¬, Chef-PIN ab ' + BETRAG_CHEF_PIN_AB + 'â‚¬')
console.log('%câš ï¸ COPYRIGHT WARNUNG', 'color: #E31E24; font-size: 20px; font-weight: bold; padding: 10px;')
console.log('%cğŸ”’ Dieser Code ist urheberrechtlich geschÃ¼tzt.', 'font-size: 14px; font-weight: bold;')
console.log('%cUnerlaubtes Kopieren oder Verwenden ist illegal und wird verfolgt.', 'font-size: 12px; color: #666;')
console.log('%cÂ© 2024 DÃ¶ner Boxx - Alle Rechte vorbehalten', 'font-size: 11px; color: #999;')
</script>

<footer style="text-align: center; padding: 20px 10px; color: #fff; font-size: 11px; margin-top: 40px; background: rgba(0,0,0,0.1); border-radius: 12px;">
  <div style="margin-bottom: 8px;">Â© 2024 DÃ¶ner Boxx. Alle Rechte vorbehalten.</div>
  <div style="font-size: 10px; opacity: 0.8;">Entwickelt exklusiv fÃ¼r DÃ¶ner Boxx. Unerlaubte Nutzung verboten.</div>
</footer>

</body>
</html>
