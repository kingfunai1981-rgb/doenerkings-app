<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√∂ner Boxx Scanner PRO</title>
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Flame', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1200px; margin: 0 auto; }
.card {
  background: white;
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h1 { color: #667eea; margin-bottom: 10px; font-size: 28px; }
h2 { font-size: 18px; margin-bottom: 12px; color: #374151; }
h3 { font-size: 16px; margin: 16px 0 8px 0; color: #374151; }

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.tab {
  flex: 1;
  min-width: 120px;
  padding: 12px;
  background: #f3f4f6;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: #6b7280;
  font-size: 14px;
}
.tab.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 16px;
  margin-bottom: 10px;
}
button {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
}
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }
button.danger { background: #ef4444; }
button.success { background: #10b981; }
button.small { 
  width: auto; 
  padding: 8px 16px; 
  font-size: 14px; 
  display: inline-block;
  margin: 4px;
}

.result {
  padding: 12px;
  border-radius: 8px;
  margin-top: 10px;
  font-size: 14px;
}
.success { background: #d1fae5; color: #065f46; }
.error { background: #fee2e2; color: #991b1b; }
.info { background: #dbeafe; color: #1e40af; }

.video-container {
  position: relative;
  width: 100%;
  max-width: 500px;
  margin: 16px auto;
  background: #000;
  border-radius: 10px;
  overflow: hidden;
  display: none;
}
.video-container.active { display: block; }
#video { width: 100%; display: block; }
.scan-line {
  position: absolute;
  width: 80%;
  height: 2px;
  background: #10b981;
  left: 10%;
  top: 50%;
  box-shadow: 0 0 10px #10b981;
  animation: scan 2s ease-in-out infinite;
}
@keyframes scan {
  0%, 100% { top: 20%; }
  50% { top: 80%; }
}
.scan-corners {
  position: absolute;
  inset: 10%;
  border: 2px solid #10b981;
  border-radius: 10px;
}
canvas { display: none; }

.customer-info {
  background: #f9fafb;
  padding: 16px;
  border-radius: 10px;
  margin-top: 12px;
}
.customer-info h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: #667eea;
}
.customer-info p {
  margin: 4px 0;
  color: #374151;
}

.bonus-badge {
  display: inline-block;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  margin-top: 8px;
}

.history-item {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 10px;
}
.history-item.redeem {
  background: #fef3c7;
  border-color: #fbbf24;
}
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.history-customer {
  font-weight: 700;
  font-size: 16px;
  color: #111827;
}
.history-time {
  font-size: 12px;
  color: #6b7280;
}
.history-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 14px;
}
.history-amount {
  color: #059669;
  font-weight: 600;
}
.history-points {
  color: #667eea;
  font-weight: 600;
}
.history-points.negative {
  color: #ef4444;
}

.edit-form {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 8px;
  padding: 12px;
  margin-top: 12px;
  display: none;
}
.edit-form.active { display: block; }
.edit-form h4 {
  font-size: 14px;
  color: #92400e;
  margin-bottom: 8px;
}
.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 8px;
}

.code-item {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}
.code-item h3 {
  color: #92400e;
  font-size: 18px;
  margin-bottom: 8px;
}
.code-item .code {
  font-size: 36px;
  font-weight: 700;
  color: #f59e0b;
  letter-spacing: 8px;
  margin: 12px 0;
}

.tab-content { display: none; }
.tab-content.active { display: block; }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>üåØ D√∂ner Boxx Scanner PRO</h1>
    <div style="color: #666; font-size: 14px;">Status: <span id="status">Bereit ‚úÖ</span></div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="showTab('phone')">üì± Handynummer</button>
      <button class="tab" onclick="showTab('qr')">üì∏ QR-Scanner</button>
      <button class="tab" onclick="showTab('history')">üìã Verlauf</button>
      <button class="tab" onclick="showTab('code')">üéÅ Code pr√ºfen</button>
    </div>
  </div>

  <div id="tab-phone" class="card tab-content active">
    <h2>üì± Punkte per Handynummer oder QR-ID gutschreiben</h2>
    <input id="phone" type="text" placeholder="Handynummer oder QR-ID">
    <input id="amount" type="number" step="0.01" placeholder="Betrag in ‚Ç¨ (z.B. 10.00)">
    <button onclick="addPointsByPhone()">üí∞ Punkte gutschreiben</button>
    <div id="result-phone"></div>
  </div>

  <div id="tab-qr" class="card tab-content">
    <h2>üì∏ QR-Code scannen</h2>
    <button id="startBtn" onclick="startCamera()">üì∏ Kamera starten</button>
    <button id="stopBtn" onclick="stopCamera()" class="danger" style="display:none;">‚èπÔ∏è Stoppen</button>
    
    <div class="video-container" id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <div class="scan-corners"></div>
      <div class="scan-line"></div>
    </div>
    <canvas id="canvas"></canvas>
    
    <div id="result-qr"></div>
    
    <div id="customerCard" style="display:none;">
      <div class="customer-info">
        <h3 id="custName">-</h3>
        <p><strong>QR-ID:</strong> <span id="custQR">-</span></p>
        <p><strong>Punkte:</strong> <span id="custPoints">-</span></p>
        <div id="activeBonusBadge"></div>
      </div>
      
      <h3>Betrag eingeben:</h3>
      <input id="scannedAmount" type="number" step="0.01" placeholder="z.B. 7.50">
      <button onclick="addPointsFromScan()" class="success">üí∞ Punkte gutschreiben</button>
      <div id="result-scan"></div>
    </div>
  </div>

  <div id="tab-history" class="card tab-content">
    <h2>üìã Verlauf (Letzte 50 Transaktionen)</h2>
    <button onclick="loadHistory()" class="secondary">üîÑ Aktualisieren</button>
    <div id="historyList" style="margin-top: 16px;">
      <div style="text-align: center; padding: 20px; color: #666;">Noch keine Transaktionen</div>
    </div>
  </div>

  <div id="tab-code" class="card tab-content">
    <h2>üéÅ Code pr√ºfen & einl√∂sen</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
      Pr√§mien-Code (Einl√∂sung f√ºr Ayran, Pommes, etc.) ODER Coupon-Code (Deal der Woche)
    </p>
    <input id="code" placeholder="4-stelliger Code" maxlength="4">
    <button onclick="verifyAnyCode()">üîç Code pr√ºfen</button>
    <div id="result-code"></div>
    <div id="code-details" style="display: none; margin-top: 20px;"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

let video = document.getElementById('video')
let canvas = document.getElementById('canvas')
let ctx = canvas.getContext('2d')
let scanning = false
let stream = null
let currentCustomer = null
let currentCodeData = null
let rewardPattern = []

async function loadRewardPattern() {
  try {
    const { data, error } = await supabase
      .from('reward_pattern')
      .select('*')
      .single()
    
    if (error && error.code !== 'PGRST116') throw error
    
    if (data && data.pattern) {
      rewardPattern = data.pattern
    } else {
      rewardPattern = [
        { type: 'normal', bonus: 0 },
        { type: 'double', bonus: 0 },
        { type: 'normal', bonus: 0 },
        { type: 'double', bonus: 0 },
        { type: 'normal', bonus: 0 },
        { type: 'bonus', bonus: 100 },
        { type: 'normal', bonus: 0 },
        { type: 'double', bonus: 0 },
        { type: 'normal', bonus: 0 },
        { type: 'double', bonus: 0 }
      ]
    }
  } catch (e) {
    console.error('Fehler beim Laden des Musters:', e)
    rewardPattern = [
      { type: 'normal', bonus: 0 },
      { type: 'double', bonus: 0 },
      { type: 'normal', bonus: 0 },
      { type: 'double', bonus: 0 },
      { type: 'normal', bonus: 0 },
      { type: 'bonus', bonus: 100 },
      { type: 'normal', bonus: 0 },
      { type: 'double', bonus: 0 },
      { type: 'normal', bonus: 0 },
      { type: 'double', bonus: 0 }
    ]
  }
}

loadRewardPattern()

function normalizePhone(phone) {
  let normalized = phone.replace(/[\s\-\(\)]/g, '')
  
  if (normalized.startsWith('+')) {
    normalized = normalized.substring(1)
  }
  if (normalized.startsWith('00')) {
    normalized = normalized.substring(2)
  }
  
  if (normalized.startsWith('49') && normalized.length > 10) {
    normalized = '0' + normalized.substring(2)
  }
  
  if (!normalized.startsWith('0') && normalized.length >= 10) {
    normalized = '0' + normalized
  }
  
  return normalized
}

function showResult(elementId, message, type) {
  const el = document.getElementById(elementId)
  el.className = `result ${type}`
  el.innerHTML = message
}

function showTab(tabName) {
  if (tabName !== 'qr') stopCamera()
  
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
  
  const tabs = ['phone', 'qr', 'history', 'code']
  const index = tabs.indexOf(tabName)
  document.querySelectorAll('.tab')[index].classList.add('active')
  document.getElementById(`tab-${tabName}`).classList.add('active')
  
  if (tabName === 'history') loadHistory()
}

async function addPointsByPhone() {
  const phoneOrId = document.getElementById('phone').value.trim()
  const amount = parseFloat(document.getElementById('amount').value)
  
  if (!phoneOrId) {
    showResult('result-phone', '‚ùå Handynummer oder QR-ID eingeben!', 'error')
    return
  }
  if (!amount || amount <= 0) {
    showResult('result-phone', '‚ùå G√ºltigen Betrag eingeben!', 'error')
    return
  }
  
  showResult('result-phone', 'üîç Suche Kunde...', 'info')
  
  try {
    let customer = null
    
    if (/^\d{4}$/.test(phoneOrId)) {
      const { data: customers, error: findError } = await supabase
        .from('customers')
        .select('*')
        .eq('qr_id', phoneOrId)
        .limit(1)
      
      if (findError) throw findError
      if (customers && customers.length > 0) {
        customer = customers[0]
      }
    }
    
    if (!customer) {
      const normalizedPhone = normalizePhone(phoneOrId)
      
      const { data: customers, error: findError } = await supabase
        .from('customers')
        .select('*')
        .eq('phone', normalizedPhone)
        .limit(1)
      
      if (findError) throw findError
      if (customers && customers.length > 0) {
        customer = customers[0]
      }
    }
    
    if (!customer) {
      throw new Error('Handynummer oder QR-ID nicht gefunden')
    }
    
    const { data: txCount } = await supabase
      .from('transactions')
      .select('id', { count: 'exact' })
      .eq('customer_id', customer.id)
      .eq('type', 'earn')
    
    const totalOrders = txCount ? txCount.length : 0
    
    const { data: activeBonuses } = await supabase
      .from('bonuses')
      .select('*')
      .eq('customer_id', customer.id)
      .eq('status', 'active')
    
    const { data: activatedCoupons } = await supabase
      .from('activated_coupons')
      .select('*, coupons(*)')
      .eq('customer_id', customer.id)
      .eq('is_used', false)
    
    let pointsToAdd = Math.round(amount * 10)
    let bonusApplied = null
    let bonusPointsAdded = 0
    let couponUsed = null
    
    if (activeBonuses && activeBonuses.length > 0) {
      const bonus = activeBonuses[0]
      
      if (bonus.bonus_type === 'double_points') {
        bonusPointsAdded = pointsToAdd
        pointsToAdd = pointsToAdd * 2
        bonusApplied = '‚≠ê Doppelte Punkte angewendet!'
      } else if (bonus.bonus_type === 'bonus_points') {
        const bonusAmount = bonus.bonus_amount || 100
        bonusPointsAdded = bonusAmount
        pointsToAdd = pointsToAdd + bonusAmount
        bonusApplied = `üí∞ +${bonusAmount} Bonus-Punkte angewendet!`
      }
      
      await supabase
        .from('bonuses')
        .update({ status: 'used' })
        .eq('id', bonus.id)
    }
    
    if (activatedCoupons && activatedCoupons.length > 0) {
      const activated = activatedCoupons[0]
      const coupon = activated.coupons
      
      await supabase
        .from('activated_coupons')
        .update({ 
          is_used: true,
          used_at: new Date().toISOString()
        })
        .eq('id', activated.id)
      
      couponUsed = `üéüÔ∏è Coupon eingel√∂st: ${coupon.product} (${coupon.price})`
    }
    
    const newTotal = customer.points + pointsToAdd
    
    const { error: txError } = await supabase
      .from('transactions')
      .insert({
        customer_id: customer.id,
        type: 'earn',
        amount: amount,
        points: pointsToAdd,
        staff: 'SCANNER'
      })
    
    if (txError) throw txError
    
    const { error: updateError } = await supabase
      .from('customers')
      .update({ points: newTotal })
      .eq('id', customer.id)
    
    if (updateError) throw updateError
    
    const nextVisitIndex = (totalOrders + 1) % 10
    
    if (rewardPattern && rewardPattern[nextVisitIndex]) {
      const reward = rewardPattern[nextVisitIndex]
      
      if (reward.type === 'double') {
        await supabase.from('bonuses').insert({
          customer_id: customer.id,
          bonus_type: 'double_points',
          bonus_amount: 0,
          status: 'pending'
        })
      } else if (reward.type === 'bonus' && reward.bonus > 0) {
        await supabase.from('bonuses').insert({
          customer_id: customer.id,
          bonus_type: 'bonus_points',
          bonus_amount: reward.bonus,
          status: 'pending'
        })
      }
    }
    
    let resultHTML = `‚úÖ <strong>ERFOLGREICH!</strong><br><br>` +
      `üë§ Kunde: <strong>${customer.name}</strong><br>` +
      `üí∞ Betrag: ${amount.toFixed(2)} ‚Ç¨<br>` +
      `‚≠ê Punkte: +${Math.round(amount * 10)}`
    
    if (bonusApplied) {
      resultHTML += `<br>üéâ <strong>${bonusApplied}</strong><br>üéÅ Bonus: +${bonusPointsAdded} Punkte`
    }
    
    if (couponUsed) {
      resultHTML += `<br>‚úÖ <strong>${couponUsed}</strong>`
    }
    
    resultHTML += `<br>üìä Neuer Stand: <strong>${newTotal} Punkte</strong>`
    
    showResult('result-phone', resultHTML, 'success')
    
    document.getElementById('phone').value = ''
    document.getElementById('amount').value = ''
    
  } catch (err) {
    showResult('result-phone', `‚ùå <strong>Fehler:</strong> ${err.message}`, 'error')
  }
}

async function startCamera() {
  try {
    document.getElementById('startBtn').style.display = 'none'
    document.getElementById('stopBtn').style.display = 'block'
    document.getElementById('videoContainer').classList.add('active')
    document.getElementById('customerCard').style.display = 'none'
    
    const constraints = {
      video: {
        facingMode: 'environment',
        width: { ideal: 1280, max: 1920 },
        height: { ideal: 720, max: 1080 }
      }
    }
    
    stream = await navigator.mediaDevices.getUserMedia(constraints)
    video.srcObject = stream
    
    video.onloadedmetadata = () => {
      video.play()
      scanning = true
      scanQR()
      showResult('result-qr', 'üì∏ Kamera aktiv - Halte QR-Code vor die Kamera', 'success')
    }
  } catch (err) {
    console.error('Camera error:', err)
    showResult('result-qr', '‚ùå Kamera-Fehler: ' + err.message, 'error')
    document.getElementById('startBtn').style.display = 'block'
    document.getElementById('stopBtn').style.display = 'none'
  }
}

function stopCamera() {
  scanning = false
  if (stream) {
    stream.getTracks().forEach(track => track.stop())
    stream = null
  }
  if (video) video.srcObject = null
  document.getElementById('videoContainer').classList.remove('active')
  document.getElementById('startBtn').style.display = 'block'
  document.getElementById('stopBtn').style.display = 'none'
}

function scanQR() {
  if (!scanning || !video) return
  
  try {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth
      canvas.height = video.videoHeight
      
      if (canvas.width > 0 && canvas.height > 0) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert"
        })
        
        if (code && code.data) {
          scanning = false
          stopCamera()
          onQRDetected(code.data)
          return
        }
      }
    }
  } catch (err) {
    console.error('Scan error:', err)
  }
  
  if (scanning) {
    setTimeout(() => requestAnimationFrame(scanQR), 100)
  }
}

async function onQRDetected(qrCode) {
  showResult('result-qr', '‚úÖ QR erkannt: ' + qrCode, 'success')
  
  try {
    const { data: customers, error } = await supabase
      .from('customers')
      .select('*')
      .eq('qr_id', qrCode)
      .limit(1)
    
    if (error) throw error
    if (!customers || customers.length === 0) throw new Error('Kunde nicht gefunden')
    
    currentCustomer = customers[0]
    
    document.getElementById('custName').textContent = currentCustomer.name
    document.getElementById('custQR').textContent = currentCustomer.qr_id
    document.getElementById('custPoints').textContent = currentCustomer.points
    
    const { data: activeBonuses } = await supabase
      .from('bonuses')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('status', 'active')
    
    const badgeEl = document.getElementById('activeBonusBadge')
    if (activeBonuses && activeBonuses.length > 0) {
      const bonus = activeBonuses[0]
      const text = bonus.bonus_type === 'double_points' ? 'üî• Doppelte Punkte aktiv!' : 'üéÅ +100 Bonus aktiv!'
      badgeEl.innerHTML = `<div class="bonus-badge">${text}</div>`
    } else {
      badgeEl.innerHTML = ''
    }
    
    document.getElementById('customerCard').style.display = 'block'
    document.getElementById('scannedAmount').value = ''
    document.getElementById('scannedAmount').focus()
  } catch (e) {
    showResult('result-qr', '‚ùå ' + e.message, 'error')
    setTimeout(() => {
      document.getElementById('result-qr').innerHTML = ''
      startCamera()
    }, 2000)
  }
}

async function addPointsFromScan() {
  const amount = parseFloat(document.getElementById('scannedAmount').value)
  if (!amount || amount <= 0) {
    showResult('result-scan', '‚ùå Betrag eingeben!', 'error')
    return
  }
  
  try {
    const { data: activeBonuses } = await supabase
      .from('bonuses')
      .select('*')
      .eq('customer_id', currentCustomer.id)
      .eq('status', 'active')
    
    let pointsToAdd = Math.round(amount * 10)
    let bonusApplied = null
    let bonusPointsAdded = 0
    
    if (activeBonuses && activeBonuses.length > 0) {
      const bonus = activeBonuses[0]
      
      if (bonus.bonus_type === 'double_points') {
        bonusPointsAdded = pointsToAdd
        pointsToAdd = pointsToAdd * 2
        bonusApplied = '‚≠ê Doppelte Punkte angewendet!'
      } else if (bonus.bonus_type === 'bonus_points') {
        bonusPointsAdded = 100
        pointsToAdd = pointsToAdd + 100
        bonusApplied = 'üí∞ +100 Bonus-Punkte angewendet!'
      }
      
      await supabase
        .from('bonuses')
        .update({ status: 'used' })
        .eq('id', bonus.id)
    }
    
    const newTotal = currentCustomer.points + pointsToAdd
    
    const { error: txError } = await supabase
      .from('transactions')
      .insert({
        customer_id: currentCustomer.id,
        type: 'earn',
        amount: amount,
        points: pointsToAdd,
        staff: 'SCANNER'
      })
    
    if (txError) throw txError
    
    const { error: updateError } = await supabase
      .from('customers')
      .update({ points: newTotal })
      .eq('id', currentCustomer.id)
    
    if (updateError) throw updateError
    
    const { data: txCount } = await supabase
      .from('transactions')
      .select('id', { count: 'exact' })
      .eq('customer_id', currentCustomer.id)
      .eq('type', 'earn')
    
    const totalOrders = txCount ? txCount.length : 0
    const cyclePosition = totalOrders % 10
    
    if (cyclePosition === 2 || cyclePosition === 4 || cyclePosition === 8 || (cyclePosition === 0 && totalOrders > 0)) {
      await supabase.from('bonuses').insert({
        customer_id: currentCustomer.id,
        bonus_type: 'double_points',
        status: 'pending'
      })
    }
    
    if (cyclePosition === 6) {
      await supabase.from('bonuses').insert({
        customer_id: currentCustomer.id,
        bonus_type: 'bonus_points',
        status: 'pending'
      })
    }
    
    let resultHTML = `‚úÖ <strong>ERFOLGREICH!</strong><br><br>` +
      `üë§ Kunde: <strong>${currentCustomer.name}</strong><br>` +
      `üí∞ Betrag: ${amount.toFixed(2)} ‚Ç¨<br>` +
      `‚≠ê Punkte: +${Math.round(amount * 10)}`
    
    if (bonusApplied) {
      resultHTML += `<br>üéâ <strong>${bonusApplied}</strong><br>üéÅ Bonus: +${bonusPointsAdded} Punkte`
    }
    
    resultHTML += `<br>üìä Neuer Stand: <strong>${newTotal} Punkte</strong>`
    
    showResult('result-scan', resultHTML, 'success')
    
    setTimeout(() => {
      document.getElementById('customerCard').style.display = 'none'
      document.getElementById('result-qr').innerHTML = ''
      document.getElementById('scannedAmount').value = ''
      document.getElementById('result-scan').innerHTML = ''
    }, 3000)
    
  } catch (e) {
    showResult('result-scan', '‚ùå Fehler: ' + e.message, 'error')
  }
}

async function loadHistory() {
  try {
    const { data, error } = await supabase
      .from('transactions')
      .select(`
        id,
        customer_id,
        type,
        amount,
        points,
        created_at,
        customers (name, phone, qr_id)
      `)
      .order('created_at', { ascending: false })
      .limit(50)
    
    if (error) throw error
    
    const list = document.getElementById('historyList')
    
    if (!data || data.length === 0) {
      list.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Noch keine Transaktionen</div>'
      return
    }
    
    const redeemTxs = data.filter(tx => tx.type === 'redeem')
    const customerIds = [...new Set(redeemTxs.map(tx => tx.customer_id))]
    
    const codeByTxId = {}
    
    if (customerIds.length > 0) {
      for (const customerId of customerIds) {
        const customerTxs = redeemTxs
          .filter(tx => tx.customer_id === customerId)
          .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
        
        const { data: codes } = await supabase
          .from('redeem_codes')
          .select('code, used_at')
          .eq('customer_id', customerId)
          .eq('used', true)
          .order('used_at', { ascending: true })
        
        if (codes && codes.length > 0) {
          let codeIndex = 0
          
          customerTxs.forEach(tx => {
            if (codeIndex < codes.length) {
              const txTime = new Date(tx.created_at).getTime()
              const code = codes[codeIndex]
              const codeTime = new Date(code.used_at).getTime()
              
              if (Math.abs(codeTime - txTime) <= 5 * 60 * 1000) {
                codeByTxId[tx.id] = code.code
                codeIndex++
              }
            }
          })
        }
      }
    }
    
    list.innerHTML = data.map(tx => {
      const date = new Date(tx.created_at)
      const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
      const time = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
      const customer = tx.customers
      
      const isRedeem = tx.type === 'redeem'
      const itemClass = isRedeem ? 'history-item redeem' : 'history-item'
      const pointsClass = isRedeem ? 'history-points negative' : 'history-points'
      const pointsDisplay = isRedeem ? `‚≠ê ${Math.abs(tx.points)} Punkte` : `‚≠ê +${tx.points} Punkte`
      const typeIcon = isRedeem ? 'üéÅ' : 'üí∞'
      const typeLabel = isRedeem ? 'Eingel√∂st' : 'Gutgeschrieben'
      
      let idDisplay = `üÜî ${customer.qr_id}`
      
      if (isRedeem && codeByTxId[tx.id]) {
        idDisplay = `üîë Code: ${codeByTxId[tx.id]}`
      }
      
      return `
        <div class="${itemClass}">
          <div class="history-header">
            <div class="history-customer">${typeIcon} ${customer.name}</div>
            <div class="history-time">${dateStr} ${time}</div>
          </div>
          <div class="history-details">
            <div>üì± ${customer.phone}</div>
            <div>${idDisplay}</div>
            ${isRedeem ? 
              `<div style="color: #92400e; font-weight: 600;">${typeLabel}</div>` :
              `<div class="history-amount">${typeIcon} ${tx.amount.toFixed(2)} ‚Ç¨</div>`
            }
            <div class="${pointsClass}">${pointsDisplay}</div>
          </div>
          ${!isRedeem ? `
          <div style="margin-top: 8px;">
            <button class="small secondary" onclick="editTransaction('${tx.id}', '${customer.qr_id}', ${tx.amount}, ${tx.points})">‚úèÔ∏è Korrigieren</button>
            <button class="small danger" onclick="deleteTransaction('${tx.id}', '${customer.qr_id}', ${tx.points})">üóëÔ∏è L√∂schen</button>
          </div>
          <div id="edit-${tx.id}" class="edit-form">
            <h4>Betrag korrigieren:</h4>
            <input type="number" step="0.01" id="newAmount-${tx.id}" value="${tx.amount}" style="margin-bottom: 8px;">
            <div style="font-size: 13px; color: #92400e; margin-bottom: 8px;">
              Alte Punkte: ${tx.points} ‚Üí Neue Punkte: <strong id="newPoints-${tx.id}">${tx.points}</strong>
            </div>
            <div class="two-col">
              <button class="small success" onclick="saveEdit('${tx.id}', '${customer.qr_id}', ${tx.points})">üíæ Speichern</button>
              <button class="small secondary" onclick="cancelEdit('${tx.id}')">‚ùå Abbrechen</button>
            </div>
          </div>
          ` : ''}
        </div>
      `
    }).join('')
  } catch (e) {
    document.getElementById('historyList').innerHTML = `<div class="result error">${e.message}</div>`
  }
}

function editTransaction(txId, qrId, oldAmount, oldPoints) {
  document.getElementById(`edit-${txId}`).classList.add('active')
  
  const input = document.getElementById(`newAmount-${txId}`)
  input.oninput = () => {
    const newAmount = parseFloat(input.value) || 0
    const newPoints = Math.round(newAmount * 10)
    document.getElementById(`newPoints-${txId}`).textContent = newPoints
  }
  input.focus()
}

function cancelEdit(txId) {
  document.getElementById(`edit-${txId}`).classList.remove('active')
}

async function saveEdit(txId, qrId, oldPoints) {
  const newAmount = parseFloat(document.getElementById(`newAmount-${txId}`).value)
  
  if (!newAmount || newAmount <= 0) {
    alert('‚ùå Bitte g√ºltigen Betrag eingeben!')
    return
  }
  
  const newPoints = Math.round(newAmount * 10)
  const diff = newPoints - oldPoints
  
  if (!confirm(`Betrag √§ndern?\n\nAlter Betrag: ${(oldPoints / 10).toFixed(2)} ‚Ç¨ (${oldPoints} Punkte)\nNeuer Betrag: ${newAmount.toFixed(2)} ‚Ç¨ (${newPoints} Punkte)\nDifferenz: ${diff > 0 ? '+' : ''}${diff} Punkte`)) return
  
  try {
    const { error: txErr } = await supabase
      .from('transactions')
      .update({ amount: newAmount, points: newPoints })
      .eq('id', txId)
    
    if (txErr) throw txErr
    
    const { data: customer } = await supabase
      .from('customers')
      .select('points')
      .eq('qr_id', qrId)
      .single()
    
    if (customer) {
      const { error: custErr } = await supabase
        .from('customers')
        .update({ points: customer.points + diff })
        .eq('qr_id', qrId)
      
      if (custErr) throw custErr
    }
    
    alert('‚úÖ Erfolgreich ge√§ndert!')
    loadHistory()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

async function deleteTransaction(txId, qrId, points) {
  if (!confirm(`Diese Transaktion wirklich l√∂schen?\n\n${points} Punkte werden vom Kunden abgezogen!`)) return
  
  try {
    const { error: txErr } = await supabase
      .from('transactions')
      .delete()
      .eq('id', txId)
    
    if (txErr) throw txErr
    
    const { data: customer } = await supabase
      .from('customers')
      .select('points')
      .eq('qr_id', qrId)
      .single()
    
    if (customer) {
      const { error: custErr } = await supabase
        .from('customers')
        .update({ points: customer.points - points })
        .eq('qr_id', qrId)
      
      if (custErr) throw custErr
    }
    
    alert('‚úÖ Transaktion gel√∂scht!')
    loadHistory()
  } catch (e) {
    alert('‚ùå Fehler: ' + e.message)
  }
}

async function verifyAnyCode() {
  const code = document.getElementById('code').value.trim()
  
  if (!code || code.length !== 4) {
    showResult('result-code', '‚ùå 4-stelligen Code eingeben!', 'error')
    return
  }
  
  showResult('result-code', 'üîç Suche Code...', 'info')
  
  try {
    const { data: activation, error: activationError } = await supabase
      .from('activated_coupons')
      .select('*, coupons(*), customers(name, phone, qr_id, points)')
      .eq('unique_code', code)
      .eq('is_used', false)
      .single()
    
    if (activation && activation.coupons) {
      await handleCouponCode(activation, code)
      return
    }
  } catch (e) {
    // Kein Coupon
  }
  
  try {
    const { data, error } = await supabase
      .from('redeem_codes')
      .select('*, customers(name, phone, qr_id, points)')
      .eq('code', code)
      .limit(1)
    
    if (error) throw error
    if (!data || data.length === 0) throw new Error('Code nicht gefunden')
    
    await handleRedeemCode(data[0], code)
    
  } catch (e) {
    showResult('result-code', '‚ùå ' + e.message, 'error')
  }
}

async function handleCouponCode(activation, code) {
  try {
    const coupon = activation.coupons
    const customer = activation.customers
    
    if (new Date(coupon.expires_at) < new Date()) {
      throw new Error('Coupon ist abgelaufen')
    }
    
    const expires = new Date(coupon.expires_at).toLocaleDateString('de-DE')
    const formattedPrice = parseFloat(coupon.price || 0).toFixed(2).replace('.', ',') + ' ‚Ç¨'
    
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `
      <div class="code-item" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b;">
        <h3>üéüÔ∏è ${coupon.title}</h3>
        <div class="code">${code}</div>
        <div style="font-size: 14px; color: #92400e; margin: 12px 0;">
          <strong>Produkt:</strong> ${coupon.product}<br>
          <strong>Preis:</strong> ${formattedPrice}<br>
          <strong>Kunde:</strong> ${customer.name} (${customer.phone})<br>
          <strong>Punkte:</strong> ${customer.points}<br>
          <strong>G√ºltig bis:</strong> ${expires}
        </div>
        <button onclick="useCoupon('${activation.id}')" class="success" style="width: 100%; margin-bottom: 8px;">
          ‚úÖ Coupon einl√∂sen
        </button>
        <button onclick="cancelCodeConfirm()" class="secondary" style="width: 100%;">
          ‚ùå Abbrechen
        </button>
      </div>
    `
    
    showResult('result-code', '‚úÖ Coupon gefunden!', 'success')
    
  } catch (e) {
    showResult('result-code', '‚ùå ' + e.message, 'error')
    document.getElementById('code-details').style.display = 'none'
  }
}

async function handleRedeemCode(codeData, code) {
  try {
    currentCodeData = codeData
    
    if (codeData.used) throw new Error('Code bereits verwendet')
    if (new Date(codeData.valid_until) < new Date()) throw new Error('Code abgelaufen')
    
    const customer = codeData.customers
    const expires = new Date(codeData.valid_until).toLocaleString('de-DE', {
      day: '2-digit',
      month: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
    
    showResult('result-code', '‚úÖ Pr√§mien-Code gefunden!', 'success')
    
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `
      <div class="code-item">
        <h3>üéÅ ${codeData.reward_name}</h3>
        <div class="code">${code}</div>
        <div style="font-size: 14px; color: #92400e; margin-bottom: 16px;">
          <strong>Kunde:</strong> ${customer.name}<br>
          <strong>Aktuell:</strong> ${customer.points} Punkte<br>
          <strong>Kosten:</strong> ${codeData.points_cost} Punkte<br>
          <strong>Danach:</strong> ${customer.points - codeData.points_cost} Punkte<br>
          <strong>G√ºltig bis:</strong> ${expires}
        </div>
        <button onclick="confirmRedeemCode()" class="success" style="width: 100%; margin-bottom: 8px;">
          ‚úÖ Best√§tigen & Punkte abziehen
        </button>
        <button onclick="cancelCodeConfirm()" class="secondary" style="width: 100%;">
          ‚ùå Abbrechen
        </button>
      </div>
    `
  } catch (e) {
    showResult('result-code', '‚ùå ' + e.message, 'error')
  }
}

async function confirmRedeemCode() {
  if (!currentCodeData) return
  
  try {
    showResult('result-code', '‚è≥ Best√§tige Code...', 'info')
    
    const newPoints = currentCodeData.customers.points - currentCodeData.points_cost
    
    const { error: txError } = await supabase
      .from('transactions')
      .insert({
        customer_id: currentCodeData.customer_id,
        type: 'redeem',
        amount: 0,
        points: -currentCodeData.points_cost,
        staff: 'Scanner',
        notes: currentCodeData.reward_name
      })
    
    if (txError) throw txError
    
    const { error: updateError } = await supabase
      .from('customers')
      .update({ points: newPoints })
      .eq('id', currentCodeData.customer_id)
    
    if (updateError) throw updateError
    
    const { error: codeError } = await supabase
      .from('redeem_codes')
      .update({ 
        used: true, 
        used_at: new Date().toISOString() 
      })
      .eq('code', currentCodeData.code)
    
    if (codeError) throw codeError
    
    showResult('result-code', '‚úÖ Code erfolgreich eingel√∂st!', 'success')
    
    document.getElementById('code').value = ''
    document.getElementById('code-details').style.display = 'none'
    currentCodeData = null
    
  } catch (e) {
    showResult('result-code', '‚ùå Fehler: ' + e.message, 'error')
  }
}

async function useCoupon(activationId) {
  try {
    showResult('result-code', '‚è≥ L√∂se Coupon ein...', 'info')
    
    const { error } = await supabase
      .from('activated_coupons')
      .update({ 
        is_used: true,
        used_at: new Date().toISOString()
      })
      .eq('id', activationId)
    
    if (error) throw error
    
    showResult('result-code', '‚úÖ Coupon erfolgreich eingel√∂st!', 'success')
    
    document.getElementById('code').value = ''
    document.getElementById('code-details').style.display = 'none'
    
  } catch (e) {
    showResult('result-code', '‚ùå Fehler: ' + e.message, 'error')
  }
}

function cancelCodeConfirm() {
  document.getElementById('code-details').style.display = 'none'
  currentCodeData = null
  showResult('result-code', '', 'info')
}

console.log('‚úÖ Scanner PRO geladen mit Flame Font & Belohnungen!')
</script>

</body>
</html>
