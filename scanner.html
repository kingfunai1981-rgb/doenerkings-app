<!DOCTYPE html>
<!--
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  D√∂ner Boxx Loyalty System - Scanner Interface
  Copyright ¬© 2024 D√∂ner Boxx. Alle Rechte vorbehalten.
  
  ‚ö†Ô∏è WARNUNG: Dieses System ist urheberrechtlich gesch√ºtzt.
  Unerlaubtes Kopieren, √Ñndern, Verbreiten oder Reverse Engineering
  ist verboten und wird zivil- und strafrechtlich verfolgt.
  
  Entwickelt exklusiv f√ºr D√∂ner Boxx.
  Bei Interesse an Lizenzen: kontakt@doenerboxx.de
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner - D√∂ner Boxx</title>
<link rel="icon" href="/favicon-new.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon-new.png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Flame', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
}

/* Login Bildschirm Styles */
.login-container {
  max-width: 400px;
  margin: 100px auto;
  background: white;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  text-align: center;
}
.login-logo {
  width: 100px;
  height: 100px;
  margin: 0 auto 30px;
}
.login-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.login-title {
  color: #E31E24;
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 10px;
}
.login-subtitle {
  color: #6b7280;
  font-size: 16px;
  margin-bottom: 30px;
}
.password-container {
  position: relative;
  margin-bottom: 20px;
}
.password-container input {
  width: 100%;
  padding: 16px 50px 16px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 4px;
  transition: all 0.3s;
}
.password-container input:focus {
  outline: none;
  border-color: #E31E24;
  box-shadow: 0 0 0 4px rgba(227, 30, 36, 0.1);
}
.toggle-password {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 20px;
  color: #6b7280;
  transition: all 0.2s;
}
.toggle-password:hover {
  color: #E31E24;
}
.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #E31E24, #F9A825);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}
.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(227, 30, 36, 0.3);
}
.login-error {
  background: #fee2e2;
  color: #991b1b;
  padding: 12px;
  border-radius: 8px;
  margin-top: 16px;
  font-size: 14px;
  font-weight: 600;
  display: none;
}
.daily-pass-badge {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  color: #92400e;
  padding: 12px;
  border-radius: 10px;
  margin-top: 20px;
  font-size: 13px;
  font-weight: 600;
}

/* Haupt-App Styles (hidden initially) */
#app {
  display: none;
}

.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.header-card {
  display: flex;
  align-items: center;
  gap: 20px;
}
.header-logo {
  width: 70px;
  height: 70px;
  flex-shrink: 0;
}
.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.header-text {
  flex: 1;
}
.logout-btn {
  padding: 10px 20px;
  background: #dc2626;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}
.logout-btn:hover {
  background: #b91c1c;
}
h1 { color: #E31E24; margin-bottom: 10px; font-size: 28px; }
h2 { font-size: 18px; margin-bottom: 12px; color: #374151; }

.tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.tab { flex: 1; min-width: 120px; padding: 12px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #6b7280; font-size: 14px; }
.tab.active { background: linear-gradient(135deg, #E31E24, #F9A825); color: white; }

input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 10px; }
button { width: 100%; padding: 14px; background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }
button.danger { background: #dc2626; }
button.success { background: #F9A825; }
button.small { width: auto; padding: 8px 16px; font-size: 14px; display: inline-block; margin: 4px; }

.result { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
.success { background: #fef3c7; color: #92400e; }
.error { background: #fee2e2; color: #991b1b; }
.info { background: #dbeafe; color: #1e40af; }

.video-container { position: relative; width: 100%; margin: 16px auto; background: #000; border-radius: 10px; overflow: hidden; display: none; }
.video-container.active { display: block; }
#video { width: 100%; display: block; }
#qr-shaded-region { position: absolute; border-style: solid; border-color: rgba(0, 0, 0, 0.48); box-sizing: border-box; inset: 0; }
/* Wei√üe Ecken - horizontal oben */
.corner-h-tl { position: absolute; background-color: #fff; width: 40px; height: 5px; top: -5px; left: 0; }
.corner-h-tr { position: absolute; background-color: #fff; width: 40px; height: 5px; top: -5px; right: 0; }
.corner-h-bl { position: absolute; background-color: #fff; width: 40px; height: 5px; bottom: -5px; left: 0; }
.corner-h-br { position: absolute; background-color: #fff; width: 40px; height: 5px; bottom: -5px; right: 0; }
/* Wei√üe Ecken - vertikal */
.corner-v-tl { position: absolute; background-color: #fff; width: 5px; height: 45px; top: -5px; left: -5px; }
.corner-v-bl { position: absolute; background-color: #fff; width: 5px; height: 45px; bottom: -5px; left: -5px; }
.corner-v-tr { position: absolute; background-color: #fff; width: 5px; height: 45px; top: -5px; right: -5px; }
.corner-v-br { position: absolute; background-color: #fff; width: 5px; height: 45px; bottom: -5px; right: -5px; }
canvas { display: none; }

.customer-info { background: #f9fafb; padding: 16px; border-radius: 10px; margin-top: 12px; }
.customer-info h3 { font-size: 18px; margin-bottom: 8px; color: #E31E24; }
.customer-info p { margin: 4px 0; color: #374151; }
.bonus-badge { display: inline-block; background: linear-gradient(135deg, #F9A825, #f59e0b); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-top: 8px; }

.history-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
.history-item.redeem { background: #fef3c7; border-color: #fbbf24; }
.history-item.wheel { background: #fffbeb; border-color: #fbbf24; border-left: 4px solid #f59e0b; }

.wheel-badge-small {
  display: inline-block;
  background: linear-gradient(135deg, #F9A825, #f59e0b);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 8px;
}

.code-item { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
.code-item h3 { color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 12px; }
.code-item .code { font-size: 28px; font-weight: 700; color: #f59e0b; letter-spacing: 8px; margin: 12px 0; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.wheel-badge {
  background: linear-gradient(135deg, #F9A825, #f59e0b);
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 700;
  display: inline-block;
  margin: 0 6px;
}
</style>
</head>
<body>

<!-- Login Bildschirm -->
<div id="loginScreen" class="login-container">
  <div class="login-logo">
    <img src="/logo-round-new.png" alt="D√∂ner Boxx">
  </div>
  <div class="login-title">Scanner Login</div>
  <div class="login-subtitle">Tages-Passwort eingeben</div>
  
  <div class="password-container">
    <input type="password" id="dailyPassword" placeholder="Passwort eingeben" autocomplete="off">
    <span class="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
  </div>
  
  <button class="login-btn" onclick="handleLogin()">üîì Anmelden</button>
  
  <div class="login-error" id="loginError">‚ùå Falsches Passwort!</div>
  
  <div class="daily-pass-badge">
    üîí Dieses Passwort ist nur heute g√ºltig<br>
    Hol dir das neue Passwort vom Admin-Bereich
  </div>
</div>

<!-- Haupt-App (nach Login) -->
<div id="app">
<div class="container">
  <div class="card header-card">
    <div class="header-logo"><img src="/logo-round-new.png" alt="D√∂ner Boxx"></div>
    <div class="header-text">
      <h1>üí≥ Scanner</h1>
      <p style="color: #6b7280; font-size: 14px;">QR-Codes scannen & Punkte vergeben</p>
    </div>
    <button class="logout-btn" onclick="handleLogout()">üö™ Ausloggen</button>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('scan')">üì± QR Scannen</button>
      <button class="tab" onclick="switchTab('phone')">‚òéÔ∏è Telefon</button>
      <button class="tab" onclick="switchTab('code')">üéüÔ∏è Code</button>
      <button class="tab" onclick="switchTab('history')">üìú Historie</button>
    </div>

    <div id="tab-scan" class="tab-content active">
      <h2>üì± QR-Code scannen</h2>
      <button onclick="startScanner()" id="startBtn">üì∑ Kamera starten</button>
      <button onclick="stopScanner()" id="stopBtn" style="background:#dc2626; display:none;">‚èπÔ∏è Kamera stoppen</button>
      <div class="video-container" id="videoContainer">
        <video id="video" playsinline></video>
        <div id="qr-shaded-region"></div>
      </div>
      <canvas id="canvas"></canvas>
      <div id="result-scan" class="result" style="display:none;"></div>
      <div id="customer-info" class="customer-info" style="display:none;"></div>
    </div>

    <div id="tab-phone" class="tab-content">
      <h2>‚òéÔ∏è Telefonnummer eingeben</h2>
      <input type="tel" id="phone" placeholder="z.B. 015712345678" maxlength="15">
      <button onclick="verifyPhone()">üîç Kunde suchen</button>
      <div id="result-phone"></div>
      <div id="customer-info-phone" class="customer-info" style="display:none;"></div>
    </div>

    <div id="tab-code" class="tab-content">
      <h2>üéüÔ∏è Code eingeben</h2>
      <p style="color:#6b7280;font-size:14px;margin-bottom:12px;">Coupon-Code oder Einl√∂se-Code scannen</p>
      <input type="text" id="code" placeholder="4-stelliger Code" maxlength="4" style="text-transform:uppercase;letter-spacing:4px;font-weight:600;text-align:center;font-size:24px;">
      <button onclick="verifyAnyCode()">‚úÖ Code pr√ºfen</button>
      <div id="result-code"></div>
      <div id="code-details" style="display:none;"></div>
    </div>

    <div id="tab-history" class="tab-content">
      <h2>üìú Letzte Transaktionen</h2>
      <p style="color:#6b7280;font-size:14px;margin-bottom:12px;">Letzte 20 K√§ufe und Einl√∂sungen</p>
      <button onclick="loadHistory()" class="secondary">üîÑ Aktualisieren</button>
      <div id="historyList" style="margin-top:16px;"></div>
    </div>
  </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
// üîí SUPABASE CONFIG
const supabaseUrl = 'https://bbndphcixevfjkhvjmtj.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibmRwaGNpeGV2ZmpraHZqbXRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1Mzk0MTAsImV4cCI6MjA0ODExNTQxMH0.9VfmZ-RJT3ujMI4b4gJMx5cXl7f6awJRxSmrSJMuHDY'
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

// üîê Login System
let isLoggedIn = false
const SESSION_KEY = 'scanner_session'
const SESSION_DURATION = 12 * 60 * 60 * 1000 // 12 Stunden

// Check if already logged in
function checkSession() {
  const session = localStorage.getItem(SESSION_KEY)
  if (session) {
    const sessionData = JSON.parse(session)
    const now = new Date().getTime()
    
    // Check if session is still valid and from today
    const sessionDate = new Date(sessionData.timestamp).toDateString()
    const today = new Date().toDateString()
    
    if (sessionDate === today && (now - sessionData.timestamp) < SESSION_DURATION) {
      isLoggedIn = true
      showApp()
      return
    } else {
      localStorage.removeItem(SESSION_KEY)
    }
  }
}

async function handleLogin() {
  const password = document.getElementById('dailyPassword').value.trim()
  const errorDiv = document.getElementById('loginError')
  
  if (!password) {
    errorDiv.textContent = '‚ùå Bitte Passwort eingeben!'
    errorDiv.style.display = 'block'
    return
  }
  
  try {
    // Get today's password from Supabase
    const today = new Date().toISOString().split('T')[0]
    const { data, error } = await supabase
      .from('daily_passwords')
      .select('password')
      .eq('date', today)
      .single()
    
    if (error) throw error
    
    if (data && data.password === password) {
      // Correct password
      isLoggedIn = true
      const sessionData = {
        timestamp: new Date().getTime(),
        date: today
      }
      localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData))
      errorDiv.style.display = 'none'
      showApp()
    } else {
      // Wrong password
      errorDiv.textContent = '‚ùå Falsches Passwort!'
      errorDiv.style.display = 'block'
      document.getElementById('dailyPassword').value = ''
    }
  } catch (e) {
    console.error('Login error:', e)
    errorDiv.textContent = '‚ùå Fehler beim Login. Bitte Admin kontaktieren.'
    errorDiv.style.display = 'block'
  }
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none'
  document.getElementById('app').style.display = 'block'
}

function handleLogout() {
  localStorage.removeItem(SESSION_KEY)
  isLoggedIn = false
  document.getElementById('app').style.display = 'none'
  document.getElementById('loginScreen').style.display = 'block'
  document.getElementById('dailyPassword').value = ''
  stopScanner()
}

function togglePasswordVisibility() {
  const input = document.getElementById('dailyPassword')
  const toggle = document.querySelector('.toggle-password')
  if (input.type === 'password') {
    input.type = 'text'
    toggle.textContent = 'üôà'
  } else {
    input.type = 'password'
    toggle.textContent = 'üëÅÔ∏è'
  }
}

// Enter key to login
document.getElementById('dailyPassword')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') handleLogin()
})

// Check session on load
checkSession()

// BETRAGS-SICHERHEIT üîí
const BETRAG_WARNUNG_AB = 20
const BETRAG_CHEF_PIN_AB = 50
const CHEF_PIN = 'Ahmet00461963!'

// REST DER URSPR√úNGLICHEN FUNKTIONEN (Scanner, Telefon, Code, etc.)
let stream = null
let scanning = false
let currentCustomerData = null
let currentQrId = null
let currentCodeData = null

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'))
  event.target.classList.add('active')
  document.getElementById('tab-' + tabName).classList.add('active')
  if (tabName !== 'scan') stopScanner()
  if (tabName === 'history') loadHistory()
}

function showResult(id, message, type = 'info') {
  const el = document.getElementById(id)
  el.textContent = message
  el.className = `result ${type}`
  el.style.display = 'block'
  setTimeout(() => el.style.display = 'none', 5000)
}

async function startScanner() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    const video = document.getElementById('video')
    video.srcObject = stream
    video.play()
    document.getElementById('videoContainer').classList.add('active')
    document.getElementById('startBtn').style.display = 'none'
    document.getElementById('stopBtn').style.display = 'block'
    scanning = true
    requestAnimationFrame(tick)
  } catch (e) { showResult('result-scan', '‚ùå Kamera-Zugriff verweigert', 'error'); console.error('Camera error:', e) }
}

function stopScanner() {
  scanning = false
  if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null }
  document.getElementById('videoContainer').classList.remove('active')
  document.getElementById('startBtn').style.display = 'block'
  document.getElementById('stopBtn').style.display = 'none'
}

function tick() {
  if (!scanning) return
  const video = document.getElementById('video'); const canvas = document.getElementById('canvas')
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.height = video.videoHeight; canvas.width = video.videoWidth
    const ctx = canvas.getContext('2d', { willReadFrequently: true })
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' })
    if (code) { handleQrCode(code.data); return }
  }
  requestAnimationFrame(tick)
}

async function handleQrCode(data) {
  try {
    const match = data.match(/qr_id=([A-Z0-9]{8})/)
    if (!match) throw new Error('Ung√ºltiger QR-Code')
    const qrId = match[1]; currentQrId = qrId
    showResult('result-scan', 'üîç Lade Kundendaten...', 'info')
    const { data: customer, error } = await supabase.from('customers').select('*').eq('qr_id', qrId).single()
    if (error) throw error
    if (!customer) throw new Error('Kunde nicht gefunden')
    currentCustomerData = customer
    const activeBonus = await checkActiveBonus(customer.id)
    let bonusHtml = ''
    if (activeBonus) {
      const endDate = new Date(activeBonus.end_date).toLocaleDateString('de-DE')
      bonusHtml = activeBonus.type === 'bonus_points' ?
        `<div class="bonus-badge">üéÅ +${activeBonus.amount} Bonus-Punkte (bis ${endDate})</div>` :
        `<div class="bonus-badge">‚≠ê Doppelte Punkte (bis ${endDate})</div>`
    }
    document.getElementById('customer-info').innerHTML = `<h3>${customer.name}</h3><p>üì± ${customer.phone}</p><p>üÜî ${customer.qr_id}</p><p style="font-size:20px;font-weight:700;color:#E31E24;margin-top:8px;">‚≠ê ${customer.points} Punkte</p>${bonusHtml}<input type="number" id="amount" placeholder="Betrag in ‚Ç¨ (z.B. 12.50)" step="0.01" style="margin-top:12px;"><button onclick="addPoints()">üí∞ Punkte hinzuf√ºgen</button>`
    document.getElementById('customer-info').style.display = 'block'
    showResult('result-scan', '‚úÖ Kunde gefunden!', 'success')
    stopScanner()
  } catch (e) { showResult('result-scan', '‚ùå ' + e.message, 'error'); console.error('QR handle error:', e) }
}

async function verifyPhone() {
  const phone = document.getElementById('phone').value.trim()
  if (!phone) { showResult('result-phone', '‚ùå Telefonnummer eingeben!', 'error'); return }
  showResult('result-phone', 'üîç Suche Kunde...', 'info')
  try {
    const { data: customer, error } = await supabase.from('customers').select('*').eq('phone', phone).single()
    if (error) throw error
    if (!customer) throw new Error('Kunde nicht gefunden')
    currentCustomerData = customer; currentQrId = customer.qr_id
    const activeBonus = await checkActiveBonus(customer.id)
    let bonusHtml = ''
    if (activeBonus) {
      const endDate = new Date(activeBonus.end_date).toLocaleDateString('de-DE')
      bonusHtml = activeBonus.type === 'bonus_points' ?
        `<div class="bonus-badge">üéÅ +${activeBonus.amount} Bonus-Punkte (bis ${endDate})</div>` :
        `<div class="bonus-badge">‚≠ê Doppelte Punkte (bis ${endDate})</div>`
    }
    document.getElementById('customer-info-phone').innerHTML = `<h3>${customer.name}</h3><p>üì± ${customer.phone}</p><p>üÜî ${customer.qr_id}</p><p style="font-size:20px;font-weight:700;color:#E31E24;margin-top:8px;">‚≠ê ${customer.points} Punkte</p>${bonusHtml}<input type="number" id="amount-phone" placeholder="Betrag in ‚Ç¨ (z.B. 12.50)" step="0.01" style="margin-top:12px;"><button onclick="addPointsPhone()">üí∞ Punkte hinzuf√ºgen</button>`
    document.getElementById('customer-info-phone').style.display = 'block'
    showResult('result-phone', '‚úÖ Kunde gefunden!', 'success')
  } catch (e) { showResult('result-phone', '‚ùå ' + e.message, 'error'); console.error('Phone verification error:', e) }
}

async function checkActiveBonus(customerId) {
  try {
    const today = new Date().toISOString().split('T')[0]
    const { data, error } = await supabase.from('global_bonuses').select('*').lte('start_date', today).gte('end_date', today).eq('is_active', true).limit(1)
    if (error) throw error
    return data && data[0] ? data[0] : null
  } catch (e) { console.error('Bonus check error:', e); return null }
}

async function addPoints() {
  const amount = parseFloat(document.getElementById('amount').value)
  if (!amount || amount <= 0) { showResult('result-scan', '‚ùå G√ºltigen Betrag eingeben!', 'error'); return }
  
  // SICHERHEITSPR√úFUNG
  if (amount >= BETRAG_WARNUNG_AB) {
    const confirmMsg = amount >= BETRAG_CHEF_PIN_AB ?
      `‚ö†Ô∏è HOHER BETRAG: ${amount}‚Ç¨!\n\nChef-PIN erforderlich:` :
      `‚ö†Ô∏è WARNUNG: Betrag von ${amount}‚Ç¨ ist ungew√∂hnlich hoch!\n\nFortfahren?`
    
    if (amount >= BETRAG_CHEF_PIN_AB) {
      const pin = prompt(confirmMsg)
      if (pin !== CHEF_PIN) { alert('‚ùå Falsche PIN!'); return }
    } else {
      if (!confirm(confirmMsg)) return
    }
  }
  
  showResult('result-scan', '‚è≥ Speichere Punkte...', 'info')
  try {
    let points = Math.round(amount * 10)
    const activeBonus = await checkActiveBonus(currentCustomerData.id)
    let bonusNote = ''
    if (activeBonus) {
      if (activeBonus.type === 'bonus_points') { points += activeBonus.amount; bonusNote = ` (+${activeBonus.amount} Bonus)` }
      else if (activeBonus.type === 'double_points') { points = points * 2; bonusNote = ' (Doppelt)' }
    }
    const newPoints = currentCustomerData.points + points
    await supabase.from('transactions').insert({ customer_id: currentCustomerData.id, type: 'purchase', amount: amount, points: points, staff: 'Scanner', notes: `Kauf: ${amount.toFixed(2)}‚Ç¨${bonusNote}` })
    await supabase.from('customers').update({ points: newPoints }).eq('id', currentCustomerData.id)
    showResult('result-scan', `‚úÖ ${points} Punkte hinzugef√ºgt! (${bonusNote})`, 'success')
    document.getElementById('customer-info').style.display = 'none'; document.getElementById('amount').value = ''
    currentCustomerData = null; currentQrId = null
  } catch (e) { showResult('result-scan', '‚ùå Fehler: ' + e.message, 'error'); console.error('Add points error:', e) }
}

async function addPointsPhone() {
  const amount = parseFloat(document.getElementById('amount-phone').value)
  if (!amount || amount <= 0) { showResult('result-phone', '‚ùå G√ºltigen Betrag eingeben!', 'error'); return }
  
  // SICHERHEITSPR√úFUNG
  if (amount >= BETRAG_WARNUNG_AB) {
    const confirmMsg = amount >= BETRAG_CHEF_PIN_AB ?
      `‚ö†Ô∏è HOHER BETRAG: ${amount}‚Ç¨!\n\nChef-PIN erforderlich:` :
      `‚ö†Ô∏è WARNUNG: Betrag von ${amount}‚Ç¨ ist ungew√∂hnlich hoch!\n\nFortfahren?`
    
    if (amount >= BETRAG_CHEF_PIN_AB) {
      const pin = prompt(confirmMsg)
      if (pin !== CHEF_PIN) { alert('‚ùå Falsche PIN!'); return }
    } else {
      if (!confirm(confirmMsg)) return
    }
  }
  
  showResult('result-phone', '‚è≥ Speichere Punkte...', 'info')
  try {
    let points = Math.round(amount * 10)
    const activeBonus = await checkActiveBonus(currentCustomerData.id)
    let bonusNote = ''
    if (activeBonus) {
      if (activeBonus.type === 'bonus_points') { points += activeBonus.amount; bonusNote = ` (+${activeBonus.amount} Bonus)` }
      else if (activeBonus.type === 'double_points') { points = points * 2; bonusNote = ' (Doppelt)' }
    }
    const newPoints = currentCustomerData.points + points
    await supabase.from('transactions').insert({ customer_id: currentCustomerData.id, type: 'purchase', amount: amount, points: points, staff: 'Scanner', notes: `Kauf: ${amount.toFixed(2)}‚Ç¨${bonusNote}` })
    await supabase.from('customers').update({ points: newPoints }).eq('id', currentCustomerData.id)
    showResult('result-phone', `‚úÖ ${points} Punkte hinzugef√ºgt!${bonusNote}`, 'success')
    document.getElementById('customer-info-phone').style.display = 'none'; document.getElementById('amount-phone').value = ''; document.getElementById('phone').value = ''
    currentCustomerData = null; currentQrId = null
  } catch (e) { showResult('result-phone', '‚ùå Fehler: ' + e.message, 'error'); console.error('Add points error:', e) }
}

async function loadHistory() {
  try {
    const { data, error } = await supabase.from('transactions').select('*, customers(name, phone, qr_id)').order('created_at', { ascending: false }).limit(20)
    if (error) throw error
    const list = document.getElementById('historyList')
    if (!data || data.length === 0) { list.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Keine Transaktionen</div>'; return }
    list.innerHTML = data.map(tx => {
      const date = new Date(tx.created_at)
      const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
      const time = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
      const c = tx.customers; const isRedeem = tx.type === 'redeem'
      const isWheel = tx.staff === 'WHEEL' || (tx.notes && (tx.notes.includes('WHEEL') || tx.notes.includes('Lucky Wheel') || tx.notes.includes('Wheel')))
      const wheelClass = isWheel ? 'wheel' : ''; const redeemClass = isRedeem ? 'redeem' : ''
      return `<div class="history-item ${redeemClass} ${wheelClass}"><div style="display:flex;justify-content:space-between;margin-bottom:8px;align-items:center;"><div style="font-weight:700;font-size:16px;">${isRedeem ? 'üéÅ' : (isWheel ? 'üé°' : 'üí∞')} ${c.name}${isWheel ? '<span class="wheel-badge-small">üé° Lucky Wheel</span>' : ''}</div><div style="font-size:12px;color:#666;">${dateStr} ${time}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;"><div>üì± ${c.phone}</div><div>üÜî ${c.qr_id}</div>${isRedeem ? `<div style="color:#92400e;font-weight:600;">üéÅ ${tx.notes || 'Eingel√∂st'}</div>` : (isWheel ? `<div style="color:#f59e0b;font-weight:600;">üé° Lucky Wheel Gewinn</div>` : `<div style="color:#059669;font-weight:600;">üí∞ ${tx.amount.toFixed(2)} ‚Ç¨</div>`)}<div style="color:${isRedeem ? '#ef4444' : '#E31E24'};font-weight:600;">‚≠ê ${isRedeem ? Math.abs(tx.points) : '+' + tx.points}P${isWheel ? ' (üé° Gewinn)' : ''}</div></div><div style="display:flex;gap:6px;margin-top:10px;"><button class="small secondary" onclick="editTransaction(${tx.id}, ${tx.amount}, ${tx.points}, ${tx.customer_id})">‚úèÔ∏è Bearbeiten</button><button class="small danger" onclick="deleteTransaction(${tx.id}, ${tx.customer_id}, ${tx.points})">üóëÔ∏è L√∂schen</button></div></div>`
    }).join('')
  } catch (e) { console.error('Load history error:', e); document.getElementById('historyList').innerHTML = `<div class="result error">${e.message}</div>` }
}

async function verifyAnyCode() {
  const code = document.getElementById('code').value.trim()
  if (!code || code.length !== 4) { showResult('result-code', '‚ùå 4-stelligen Code eingeben!', 'error'); return }
  showResult('result-code', 'üîç Suche Code...', 'info')
  try {
    const { data, error } = await supabase.from('activated_coupons').select('*').eq('unique_code', code).eq('is_used', false).limit(1)
    if (error) throw error
    const activation = data && data[0]
    if (activation) {
      const { data: coupon } = await supabase.from('coupons').select('*').eq('id', activation.coupon_id).single()
      const { data: customer } = await supabase.from('customers').select('name, phone, qr_id, points').eq('id', activation.customer_id).single()
      activation.coupons = coupon; activation.customers = customer
      await handleCouponCode(activation, code); return
    }
  } catch (e) { console.error('Coupon check error:', e) }
  try {
    const { data, error } = await supabase.from('redeem_codes').select('*').eq('code', code).limit(1)
    if (error) throw error
    if (!data || data.length === 0) throw new Error('Code nicht gefunden')
    const { data: customer } = await supabase.from('customers').select('name, phone, qr_id, points').eq('id', data[0].customer_id).single()
    data[0].customers = customer
    await handleRedeemCode(data[0], code)
  } catch (e) { showResult('result-code', '‚ùå ' + e.message, 'error'); console.error('Code verification error:', e) }
}

async function handleCouponCode(activation, code) {
  try {
    const coupon = activation.coupons; const customer = activation.customers
    const endDate = coupon.end_date ? new Date(coupon.end_date) : new Date(coupon.expires_at)
    endDate.setHours(23, 59, 59, 999)
    if (endDate < new Date()) throw new Error('Coupon abgelaufen')
    const expires = endDate.toLocaleDateString('de-DE')
    const price = parseFloat(coupon.price || 0).toFixed(2).replace('.', ',') + ' ‚Ç¨'
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `<div class="code-item" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid #f59e0b;"><h3>üéüÔ∏è ${coupon.title}</h3><div class="code">${code}</div><div style="font-size:14px;color:#92400e;margin:12px 0;"><strong>Produkt:</strong> ${coupon.product}<br><strong>Preis:</strong> ${price}<br><strong>Kunde:</strong> ${customer.name} (${customer.phone})<br><strong>Punkte:</strong> ${customer.points}<br><strong>G√ºltig bis:</strong> ${expires}</div><button onclick="useCoupon('${activation.id}')" class="success" style="width:100%;margin-bottom:8px;">‚úÖ Coupon einl√∂sen</button><button onclick="cancelCodeConfirm()" class="secondary" style="width:100%;">‚ùå Abbrechen</button></div>`
    showResult('result-code', '‚úÖ Coupon gefunden!', 'success')
  } catch (e) { showResult('result-code', '‚ùå ' + e.message, 'error'); document.getElementById('code-details').style.display = 'none'; console.error('Handle coupon error:', e) }
}

async function handleRedeemCode(codeData, code) {
  try {
    if (codeData.used) throw new Error('Code bereits verwendet')
    if (new Date(codeData.valid_until) < new Date()) throw new Error('Code abgelaufen')
    const customer = codeData.customers
    showResult('result-code', '‚è≥ Code wird eingel√∂st...', 'info')
    const newPoints = customer.points - codeData.points_cost
    await supabase.from('transactions').insert({ customer_id: codeData.customer_id, type: 'redeem', amount: 0, points: -codeData.points_cost, staff: 'Scanner', notes: `${codeData.reward_name} (Code: ${code})` })
    await supabase.from('customers').update({ points: newPoints }).eq('id', codeData.customer_id)
    await supabase.from('redeem_codes').update({ used: true, used_at: new Date().toISOString() }).eq('code', code)
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `<div class="code-item" style="background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:2px solid #10b981;"><div style="font-size:60px;text-align:center;margin:20px 0;">‚úÖ</div><h3 style="text-align:center;color:#065f46;font-size:28px;margin-bottom:16px;">Erfolgreich eingel√∂st!</h3><div style="font-size:22px;font-weight:700;color:#059669;text-align:center;margin:20px 0;">üéÅ ${codeData.reward_name}</div><div style="font-size:16px;color:#065f46;text-align:center;margin:16px 0;"><strong>Kunde:</strong> ${customer.name}<br><strong>Neue Punkte:</strong> ${newPoints}</div><button onclick="closeCodeDetails()" class="success" style="width:100%;margin-top:16px;">Weiter</button></div>`
    showResult('result-code', '‚úÖ Code erfolgreich eingel√∂st!', 'success')
  } catch (e) { showResult('result-code', '‚ùå ' + e.message, 'error'); console.error('Handle redeem error:', e) }
}

function closeCodeDetails() { document.getElementById('code').value = ''; document.getElementById('code-details').style.display = 'none' }

async function useCoupon(activationId) {
  try {
    showResult('result-code', '‚è≥ L√∂se Coupon ein...', 'info')
    await supabase.from('activated_coupons').update({ is_used: true, used_at: new Date().toISOString() }).eq('id', activationId)
    showResult('result-code', '‚úÖ Coupon erfolgreich eingel√∂st!', 'success')
    document.getElementById('code').value = ''; document.getElementById('code-details').style.display = 'none'
  } catch (e) { showResult('result-code', '‚ùå Fehler: ' + e.message, 'error'); console.error('Use coupon error:', e) }
}

function cancelCodeConfirm() { document.getElementById('code-details').style.display = 'none'; currentCodeData = null; showResult('result-code', '', 'info') }

async function editTransaction(txId, currentAmount, currentPoints, customerId) {
  const newAmount = prompt('Neuer Betrag in ‚Ç¨ eingeben:', currentAmount)
  if (!newAmount || isNaN(newAmount)) return
  const amount = parseFloat(newAmount); const newPoints = Math.round(amount * 10); const pointsDiff = newPoints - currentPoints
  try {
    await supabase.from('transactions').update({ amount: amount, points: newPoints }).eq('id', txId)
    const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
    if (customer) { await supabase.from('customers').update({ points: customer.points + pointsDiff }).eq('id', customerId) }
    loadHistory(); alert('‚úÖ Transaktion bearbeitet!')
  } catch (e) { alert('‚ùå Fehler: ' + e.message); console.error('Edit transaction error:', e) }
}

async function deleteTransaction(txId, customerId, points) {
  if (!confirm('Transaktion wirklich l√∂schen? Punkte werden zur√ºckgesetzt.')) return
  try {
    await supabase.from('transactions').delete().eq('id', txId)
    const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
    if (customer) { await supabase.from('customers').update({ points: customer.points - points }).eq('id', customerId) }
    loadHistory(); alert('‚úÖ Transaktion gel√∂scht!')
  } catch (e) { alert('‚ùå Fehler: ' + e.message); console.error('Delete transaction error:', e) }
}

console.log('‚úÖ D√∂ner Boxx Scanner PRO mit Daily Password System geladen!')
console.log('üîí Betrags-Sicherheit aktiv: Warnung ab ' + BETRAG_WARNUNG_AB + '‚Ç¨, Chef-PIN ab ' + BETRAG_CHEF_PIN_AB + '‚Ç¨')
</script>

<footer style="text-align: center; padding: 20px 10px; color: #fff; font-size: 11px; margin-top: 40px; background: rgba(0,0,0,0.1); border-radius: 12px;">
  <div style="margin-bottom: 8px;">¬© 2024 D√∂ner Boxx. Alle Rechte vorbehalten.</div>
  <div style="font-size: 10px; opacity: 0.8;">Entwickelt exklusiv f√ºr D√∂ner Boxx. Unerlaubte Nutzung verboten.</div>
</footer>

</body>
</html>
