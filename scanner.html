<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner - DÃ¶ner Boxx</title>
<link rel="icon" href="/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<style>
@font-face {
  font-family: 'Flame';
  src: url('Flame-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Flame', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #E31E24 0%, #F9A825 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 1200px; margin: 0 auto; }
.card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.header-card {
  display: flex;
  align-items: center;
  gap: 20px;
}
.header-logo {
  width: 70px;
  height: 70px;
  flex-shrink: 0;
}
.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.header-text {
  flex: 1;
}
h1 { color: #E31E24; margin-bottom: 10px; font-size: 28px; }
h2 { font-size: 18px; margin-bottom: 12px; color: #374151; }

.tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.tab { flex: 1; min-width: 110px; padding: 12px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #6b7280; font-size: 13px; }
.tab.active { background: linear-gradient(135deg, #E31E24, #F9A825); color: white; }

input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 10px; }
button { width: 100%; padding: 14px; background: linear-gradient(135deg, #E31E24, #F9A825); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
button:hover { opacity: 0.9; }
button.secondary { background: #6b7280; }
button.danger { background: #dc2626; }
button.success { background: #F9A825; }
button.small { width: auto; padding: 8px 16px; font-size: 14px; display: inline-block; margin: 4px; }

.result { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
.success { background: #fef3c7; color: #92400e; }
.error { background: #fee2e2; color: #991b1b; }
.info { background: #dbeafe; color: #1e40af; }

.video-container { position: relative; width: 100%; max-width: 500px; margin: 16px auto; background: #000; border-radius: 10px; overflow: hidden; display: none; }
.video-container.active { display: block; }
#video { width: 100%; display: block; }
.scan-line { position: absolute; width: 80%; height: 2px; background: #F9A825; left: 10%; top: 50%; box-shadow: 0 0 10px #F9A825; animation: scan 2s ease-in-out infinite; }
@keyframes scan { 0%, 100% { top: 20%; } 50% { top: 80%; } }
.scan-corners { position: absolute; inset: 10%; border: 2px solid #F9A825; border-radius: 10px; }
canvas { display: none; }

.customer-info { background: #f9fafb; padding: 16px; border-radius: 10px; margin-top: 12px; }
.customer-info h3 { font-size: 18px; margin-bottom: 8px; color: #E31E24; }
.customer-info p { margin: 4px 0; color: #374151; }
.bonus-badge { display: inline-block; background: linear-gradient(135deg, #F9A825, #f59e0b); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-top: 8px; }

.history-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
.history-item.redeem { background: #fef3c7; border-color: #fbbf24; }

.code-item { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
.code-item h3 { color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 12px; }
.code-item .code { font-size: 28px; font-weight: 700; color: #f59e0b; letter-spacing: 8px; margin: 12px 0; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.wheel-badge { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-top: 8px; display: inline-block; }
</style>
</head>
<body>

<div class="container">
  <div class="card header-card">
    <div class="header-logo">
      <img src="/logo-round.png" alt="DÃ¶ner Boxx">
    </div>
    <div class="header-text">
      <h1>Scanner PRO</h1>
      <div style="color: #666; font-size: 14px;">Status: <span id="status">Bereit âœ…</span></div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="showTab('phone')">ğŸ“± Nummer</button>
      <button class="tab" onclick="showTab('qr')">ğŸ“¸ QR</button>
      <button class="tab" onclick="showTab('history')">ğŸ“‹ Verlauf</button>
      <button class="tab" onclick="showTab('code')">ğŸ Code</button>
      <button class="tab" onclick="showTab('wheel')">ğŸ¡ Wheel</button>
    </div>
  </div>

  <div id="tab-phone" class="card tab-content active">
    <h2>ğŸ“± Punkte per Handynummer oder QR-ID gutschreiben</h2>
    <input id="phone" type="text" placeholder="Handynummer oder QR-ID">
    <input id="amount" type="number" step="0.01" placeholder="Betrag in â‚¬ (z.B. 10.00)">
    <button onclick="addPointsByPhone()">ğŸ’° Punkte gutschreiben</button>
    <div id="result-phone"></div>
  </div>

  <div id="tab-qr" class="card tab-content">
    <h2>ğŸ“¸ QR-Code scannen</h2>
    <button id="startBtn" onclick="startCamera()">ğŸ“¸ Kamera starten</button>
    <button id="stopBtn" onclick="stopCamera()" class="danger" style="display:none;">â¹ï¸ Stoppen</button>
    
    <div class="video-container" id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <div class="scan-corners"></div>
      <div class="scan-line"></div>
    </div>
    <canvas id="canvas"></canvas>
    
    <div id="result-qr"></div>
    
    <div id="customerCard" style="display:none;">
      <div class="customer-info">
        <h3 id="custName">-</h3>
        <p><strong>QR-ID:</strong> <span id="custQR">-</span></p>
        <p><strong>Punkte:</strong> <span id="custPoints">-</span></p>
        <div id="activeBonusBadge"></div>
      </div>
      
      <h3>Betrag eingeben:</h3>
      <input id="scannedAmount" type="number" step="0.01" placeholder="z.B. 7.50">
      <button onclick="addPointsFromScan()" class="success">ğŸ’° Punkte gutschreiben</button>
      <div id="result-scan"></div>
    </div>
  </div>

  <div id="tab-history" class="card tab-content">
    <h2>ğŸ“‹ Verlauf (Letzte 50 Transaktionen)</h2>
    <button onclick="loadHistory()" class="secondary">ğŸ”„ Aktualisieren</button>
    <div id="historyList" style="margin-top: 16px;">
      <div style="text-align: center; padding: 20px; color: #666;">Noch keine Transaktionen</div>
    </div>
  </div>

  <div id="tab-code" class="card tab-content">
    <h2>ğŸ Code prÃ¼fen & einlÃ¶sen</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">PrÃ¤mien-Code oder Coupon-Code</p>
    <input id="code" placeholder="4-stelliger Code" maxlength="4">
    <button onclick="verifyAnyCode()">ğŸ” Code prÃ¼fen</button>
    <div id="result-code"></div>
    <div id="code-details" style="display: none; margin-top: 20px;"></div>
  </div>

  <div id="tab-wheel" class="card tab-content">
    <h2>ğŸ¡ GlÃ¼cksrad-Code einlÃ¶sen</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Kunde zeigt Gewinn-Code vom GlÃ¼cksrad</p>
    <input id="wheel-code" placeholder="4-stelliger Wheel-Code" maxlength="4">
    <button onclick="redeemWheel()">ğŸ¡ Code einlÃ¶sen</button>
    <div id="result-wheel"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
const SUPABASE_URL = 'https://pskuvrahvxlzrnxmuqnc.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBza3V2cmFodnhsenJueG11cW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NTA2MTYsImV4cCI6MjA3ODEyNjYxNn0.Ji5dTEFsGbgW9t79yhJg-nOHkzc0Z0oHtVe6c-iBvds'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

let video = document.getElementById('video')
let canvas = document.getElementById('canvas')
let ctx = canvas.getContext('2d')
let scanning = false
let stream = null
let currentCustomer = null
let currentCodeData = null

// ==========================================
// CRYPTO HELPER (Sichere Zufallszahlen)
// ==========================================

function generateSecureCode() {
  const array = new Uint32Array(1);
  crypto.getRandomValues(array);
  const code = 1000 + (array[0] % 9000);
  return code.toString();
}

function getSecureRandomFloat() {
  const array = new Uint32Array(1);
  crypto.getRandomValues(array);
  return array[0] / (0xFFFFFFFF + 1);
}

// ==========================================
// WHEEL HELPER FUNCTIONS
// ==========================================

async function isWheelActive() {
  try {
    const { data, error } = await supabase.from('wheel_config').select('*').single();
    if (error || !data) return false;
    const now = new Date();
    const start = new Date(data.start_date);
    const end = new Date(data.end_date);
    return data.is_active && now >= start && now <= end;
  } catch (e) {
    console.error('âŒ Wheel config error:', e);
    return false;
  }
}

async function getWheelMinAmount() {
  try {
    const { data } = await supabase.from('wheel_config').select('min_order_amount').single();
    return data?.min_order_amount || 10.00;
  } catch (e) {
    return 10.00;
  }
}

async function unlockWheel(customerId, orderAmount) {
  try {
    const active = await isWheelActive();
    if (!active) return false;
    const minAmount = await getWheelMinAmount();
    if (orderAmount < minAmount) return false;
    const { data, error } = await supabase.from('wheel_unlocks').insert({
      customer_id: customerId,
      order_amount: orderAmount,
      is_used: false,
      expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    }).select().single();
    if (error) throw error;
    console.log('âœ… Wheel freigeschaltet fÃ¼r Kunde:', customerId);
    return true;
  } catch (e) {
    console.error('âŒ Wheel unlock error:', e);
    return false;
  }
}

async function redeemWheelCode(code, staffName = 'Scanner') {
  try {
    const { data: spin, error } = await supabase.from('wheel_spins').select('*, customers(name, phone, qr_id, points)').eq('prize_code', code).eq('is_redeemed', false).single();
    if (error) throw new Error('Code nicht gefunden oder bereits eingelÃ¶st');
    if (new Date(spin.expires_at) < new Date()) throw new Error('Code ist abgelaufen');
    let result = { success: true, message: '', customer: spin.customers };
    if (spin.prize_type === 'points') {
      const points = parseInt(spin.prize_value);
      const newTotal = spin.customers.points + points;
      await supabase.from('customers').update({ points: newTotal }).eq('id', spin.customer_id);
      await supabase.from('transactions').insert({ customer_id: spin.customer_id, type: 'earn', amount: 0, points: points, staff: staffName, notes: `GlÃ¼cksrad: ${spin.prize_label}` });
      result.message = `âœ… ${points} Punkte gutgeschrieben!`;
      result.points = points;
    } else if (spin.prize_type === 'reward') {
      result.message = `âœ… PrÃ¤mie bestÃ¤tigt: ${spin.prize_label}`;
      result.reward = spin.prize_value;
    } else if (spin.prize_type === 'discount') {
      result.message = `âœ… Rabatt bestÃ¤tigt: ${spin.prize_label}`;
      result.discount = spin.prize_value;
    }
    await supabase.from('wheel_spins').update({ is_redeemed: true, redeemed_at: new Date().toISOString(), redeemed_by: staffName }).eq('id', spin.id);
    return result;
  } catch (e) {
    console.error('âŒ Redeem code error:', e);
    throw e;
  }
}

// ==========================================
// ORIGINAL FUNCTIONS (unchanged)
// ==========================================

async function checkAndUpdateChallenges(customerId, amount) {
  try {
    const now = new Date().toISOString().split('T')[0]
    const { data: activeChallenges } = await supabase.from('challenges').select('*').eq('is_active', true).lte('start_date', now).gte('end_date', now)
    if (!activeChallenges || activeChallenges.length === 0) return
    
    for (const challenge of activeChallenges) {
      if (amount < challenge.min_order_amount) continue
      const { data: progressRows, error: progressError} = await supabase.from('challenge_progress').select('*').eq('customer_id', customerId).eq('challenge_id', challenge.id).limit(1)
      if (progressError) { console.error('Challenge progress error:', progressError); continue }
      const progress = (progressRows && progressRows.length > 0) ? progressRows[0] : null
      if (!progress) continue
      if (progress.is_completed) continue
      const newOrders = progress.completed_orders + 1
      if (newOrders >= challenge.required_orders) {
        await supabase.from('challenge_progress').update({ completed_orders: newOrders, is_completed: true, completed_at: new Date().toISOString() }).eq('id', progress.id)
        const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
        if (customer) {
          await supabase.from('customers').update({ points: customer.points + challenge.bonus_points }).eq('id', customerId)
          await supabase.from('transactions').insert({ customer_id: customerId, type: 'earn', amount: 0, points: challenge.bonus_points, staff: 'CHALLENGE', notes: `Challenge: ${challenge.bonus_points}P` })
        }
      } else {
        await supabase.from('challenge_progress').update({ completed_orders: newOrders }).eq('id', progress.id)
      }
    }
  } catch (e) { console.error('Challenge error:', e) }
}

function normalizePhone(phone) {
  let n = phone.replace(/[\s\-\(\)]/g, '')
  if (n.startsWith('+')) n = n.substring(1)
  if (n.startsWith('00')) n = n.substring(2)
  if (n.startsWith('49') && n.length > 10) n = '0' + n.substring(2)
  if (!n.startsWith('0') && n.length >= 10) n = '0' + n
  return n
}

function showResult(id, msg, type) {
  const el = document.getElementById(id)
  if (!msg) { el.className = ''; el.innerHTML = ''; return }
  el.className = `result ${type}`
  el.innerHTML = msg
}

function showTab(name) {
  if (name !== 'qr') stopCamera()
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
  const tabs = ['phone', 'qr', 'history', 'code', 'wheel']
  document.querySelectorAll('.tab')[tabs.indexOf(name)].classList.add('active')
  document.getElementById(`tab-${name}`).classList.add('active')
  if (name === 'history') loadHistory()
}

async function addPointsByPhone() {
  const phoneOrId = document.getElementById('phone').value.trim()
  const amount = parseFloat(document.getElementById('amount').value)
  
  if (!phoneOrId) { showResult('result-phone', 'âŒ Handynummer/QR-ID eingeben!', 'error'); return }
  if (!amount || amount <= 0) { showResult('result-phone', 'âŒ GÃ¼ltigen Betrag eingeben!', 'error'); return }
  
  showResult('result-phone', 'ğŸ” Suche Kunde...', 'info')
  
  try {
    let customer = null
    
    if (/^\d{4}$/.test(phoneOrId)) {
      const { data } = await supabase.from('customers').select('*').eq('qr_id', phoneOrId).limit(1)
      if (data && data.length > 0) customer = data[0]
    }
    
    if (!customer) {
      const { data } = await supabase.from('customers').select('*').eq('phone', normalizePhone(phoneOrId)).limit(1)
      if (data && data.length > 0) customer = data[0]
    }
    
    if (!customer) throw new Error('Kunde nicht gefunden')
    
    const { data: activeGlobalBonuses } = await supabase.from('activated_global_bonuses').select('*, global_bonuses(*)').eq('customer_id', customer.id).eq('is_used', false)
    const { data: activatedCoupons } = await supabase.from('activated_coupons').select('*, coupons(*)').eq('customer_id', customer.id).eq('is_used', false)
    
    let pointsToAdd = Math.round(amount * 10)
    let bonusApplied = null, bonusPointsAdded = 0, couponUsed = null
    
    if (activeGlobalBonuses && activeGlobalBonuses.length > 0) {
      const globalBonus = activeGlobalBonuses[0]
      const bonus = globalBonus.global_bonuses
      if (bonus.bonus_type === 'double_points') {
        bonusPointsAdded = pointsToAdd
        pointsToAdd *= 2
        bonusApplied = 'â­ Doppelte Punkte!'
      } else if (bonus.bonus_type === 'bonus_points') {
        bonusPointsAdded = bonus.bonus_amount || 100
        pointsToAdd += bonusPointsAdded
        bonusApplied = `ğŸ’° +${bonusPointsAdded} Bonus!`
      }
      await supabase.from('activated_global_bonuses').update({ is_used: true, used_at: new Date().toISOString() }).eq('id', globalBonus.id)
      console.log('âœ… Globaler Bonus verwendet:', bonusApplied)
    }
    
    if (activatedCoupons && activatedCoupons.length > 0) {
      const c = activatedCoupons[0]
      await supabase.from('activated_coupons').update({ is_used: true, used_at: new Date().toISOString() }).eq('id', c.id)
      couponUsed = `ğŸŸï¸ Coupon: ${c.coupons.product}`
    }
    
    const newTotal = customer.points + pointsToAdd
    await supabase.from('transactions').insert({ customer_id: customer.id, type: 'earn', amount, points: pointsToAdd, staff: 'SCANNER' })
    await supabase.from('customers').update({ points: newTotal }).eq('id', customer.id)
    await checkAndUpdateChallenges(customer.id, amount)
    
    // ğŸ¡ WHEEL FREISCHALTEN
    const wheelUnlocked = await unlockWheel(customer.id, amount)
    
    let msg = `âœ… <strong>ERFOLG!</strong><br>ğŸ‘¤ ${customer.name}<br>ğŸ’° ${amount.toFixed(2)} â‚¬<br>â­ +${Math.round(amount * 10)}P`
    if (bonusApplied) msg += `<br>ğŸ‰ ${bonusApplied} (+${bonusPointsAdded}P)`
    if (couponUsed) msg += `<br>âœ… ${couponUsed}`
    msg += `<br>ğŸ“Š Neu: <strong>${newTotal}P</strong>`
    if (wheelUnlocked) msg += `<br><span class="wheel-badge">ğŸ¡ GLÃœCKSRAD FREIGESCHALTET!</span>`
    
    showResult('result-phone', msg, 'success')
    document.getElementById('phone').value = ''
    document.getElementById('amount').value = ''
    
  } catch (e) {
    showResult('result-phone', `âŒ ${e.message}`, 'error')
    console.error('Add points error:', e)
  }
}

async function startCamera() {
  try {
    document.getElementById('startBtn').style.display = 'none'
    document.getElementById('stopBtn').style.display = 'block'
    document.getElementById('videoContainer').classList.add('active')
    document.getElementById('customerCard').style.display = 'none'
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } })
    video.srcObject = stream
    video.onloadedmetadata = () => { video.play(); scanning = true; scanQR(); showResult('result-qr', 'ğŸ“¸ Kamera aktiv', 'success') }
  } catch (e) {
    showResult('result-qr', 'âŒ Kamera-Fehler: ' + e.message, 'error')
    document.getElementById('startBtn').style.display = 'block'
    document.getElementById('stopBtn').style.display = 'none'
    console.error('Camera error:', e)
  }
}

function stopCamera() {
  scanning = false
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null }
  if (video) video.srcObject = null
  document.getElementById('videoContainer').classList.remove('active')
  document.getElementById('startBtn').style.display = 'block'
  document.getElementById('stopBtn').style.display = 'none'
}

function scanQR() {
  if (!scanning || !video) return
  try {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth
      canvas.height = video.videoHeight
      if (canvas.width > 0 && canvas.height > 0) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" })
        if (code && code.data) { scanning = false; stopCamera(); onQRDetected(code.data); return }
      }
    }
  } catch (e) { console.error('Scan error:', e) }
  if (scanning) setTimeout(() => requestAnimationFrame(scanQR), 100)
}

async function onQRDetected(qrCode) {
  showResult('result-qr', 'âœ… QR: ' + qrCode, 'success')
  try {
    const { data, error } = await supabase.from('customers').select('*').eq('qr_id', qrCode).limit(1)
    if (error) throw error
    if (!data || data.length === 0) throw new Error('Kunde nicht gefunden')
    currentCustomer = data[0]
    document.getElementById('custName').textContent = currentCustomer.name
    document.getElementById('custQR').textContent = currentCustomer.qr_id
    document.getElementById('custPoints').textContent = currentCustomer.points
    const { data: globalBonuses } = await supabase.from('activated_global_bonuses').select('*, global_bonuses(*)').eq('customer_id', currentCustomer.id).eq('is_used', false)
    const badge = document.getElementById('activeBonusBadge')
    if (globalBonuses && globalBonuses.length > 0) {
      const b = globalBonuses[0].global_bonuses
      badge.innerHTML = `<div class="bonus-badge">${b.bonus_type === 'double_points' ? 'ğŸ”¥ 2x Punkte!' : `ğŸ +${b.bonus_amount}P Bonus!`}</div>`
    } else { badge.innerHTML = '' }
    document.getElementById('customerCard').style.display = 'block'
    document.getElementById('scannedAmount').value = ''
    document.getElementById('scannedAmount').focus()
  } catch (e) {
    showResult('result-qr', 'âŒ ' + e.message, 'error')
    console.error('QR detection error:', e)
    setTimeout(() => { showResult('result-qr', '', 'info'); startCamera() }, 2000)
  }
}

async function addPointsFromScan() {
  const amount = parseFloat(document.getElementById('scannedAmount').value)
  if (!amount || amount <= 0) { showResult('result-scan', 'âŒ Betrag eingeben!', 'error'); return }
  try {
    const { data: globalBonuses } = await supabase.from('activated_global_bonuses').select('*, global_bonuses(*)').eq('customer_id', currentCustomer.id).eq('is_used', false)
    let pointsToAdd = Math.round(amount * 10)
    let bonusApplied = null, bonusPointsAdded = 0
    if (globalBonuses && globalBonuses.length > 0) {
      const globalBonus = globalBonuses[0]
      const b = globalBonus.global_bonuses
      if (b.bonus_type === 'double_points') {
        bonusPointsAdded = pointsToAdd
        pointsToAdd *= 2
        bonusApplied = 'â­ 2x Punkte!'
      } else {
        bonusPointsAdded = b.bonus_amount || 100
        pointsToAdd += bonusPointsAdded
        bonusApplied = `ğŸ’° +${bonusPointsAdded}P!`
      }
      await supabase.from('activated_global_bonuses').update({ is_used: true, used_at: new Date().toISOString() }).eq('id', globalBonus.id)
    }
    const newTotal = currentCustomer.points + pointsToAdd
    await supabase.from('transactions').insert({ customer_id: currentCustomer.id, type: 'earn', amount, points: pointsToAdd, staff: 'SCANNER' })
    await supabase.from('customers').update({ points: newTotal }).eq('id', currentCustomer.id)
    await checkAndUpdateChallenges(currentCustomer.id, amount)
    
    // ğŸ¡ WHEEL FREISCHALTEN
    const wheelUnlocked = await unlockWheel(currentCustomer.id, amount)
    
    let msg = `âœ… <strong>ERFOLG!</strong><br>ğŸ‘¤ ${currentCustomer.name}<br>ğŸ’° ${amount.toFixed(2)} â‚¬<br>â­ +${Math.round(amount * 10)}P`
    if (bonusApplied) msg += `<br>ğŸ‰ ${bonusApplied} (+${bonusPointsAdded}P)`
    msg += `<br>ğŸ“Š Neu: <strong>${newTotal}P</strong>`
    if (wheelUnlocked) msg += `<br><span class="wheel-badge">ğŸ¡ GLÃœCKSRAD FREIGESCHALTET!</span>`
    
    showResult('result-scan', msg, 'success')
    setTimeout(() => {
      document.getElementById('customerCard').style.display = 'none'
      showResult('result-qr', '', 'info')
      document.getElementById('scannedAmount').value = ''
      showResult('result-scan', '', 'info')
    }, 3000)
  } catch (e) {
    showResult('result-scan', 'âŒ ' + e.message, 'error')
    console.error('Scan points error:', e)
  }
}

async function loadHistory() {
  try {
    const { data, error } = await supabase.from('transactions').select('id, customer_id, type, amount, points, notes, created_at, customers(name, phone, qr_id)').order('created_at', { ascending: false }).limit(50)
    if (error) throw error
    const list = document.getElementById('historyList')
    if (!data || data.length === 0) {
      list.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Keine Transaktionen</div>'
      return
    }
    list.innerHTML = data.map(tx => {
      const date = new Date(tx.created_at)
      const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
      const time = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
      const c = tx.customers
      const isRedeem = tx.type === 'redeem'
      return `<div class="history-item ${isRedeem ? 'redeem' : ''}"><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><div style="font-weight:700;font-size:16px;">${isRedeem ? 'ğŸ' : 'ğŸ’°'} ${c.name}</div><div style="font-size:12px;color:#666;">${dateStr} ${time}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;"><div>ğŸ“± ${c.phone}</div><div>ğŸ†” ${c.qr_id}</div>${isRedeem ? `<div style="color:#92400e;font-weight:600;">ğŸ ${tx.notes || 'EingelÃ¶st'}</div>` : `<div style="color:#059669;font-weight:600;">ğŸ’° ${tx.amount.toFixed(2)} â‚¬</div>`}<div style="color:${isRedeem ? '#ef4444' : '#E31E24'};font-weight:600;">â­ ${isRedeem ? Math.abs(tx.points) : '+' + tx.points}P</div></div><div style="display:flex;gap:6px;margin-top:10px;"><button class="small secondary" onclick="editTransaction(${tx.id}, ${tx.amount}, ${tx.points}, ${tx.customer_id})">âœï¸ Bearbeiten</button><button class="small danger" onclick="deleteTransaction(${tx.id}, ${tx.customer_id}, ${tx.points})">ğŸ—‘ï¸ LÃ¶schen</button></div></div>`
    }).join('')
  } catch (e) {
    console.error('Load history error:', e)
    document.getElementById('historyList').innerHTML = `<div class="result error">${e.message}</div>`
  }
}

async function verifyAnyCode() {
  const code = document.getElementById('code').value.trim()
  if (!code || code.length !== 4) { showResult('result-code', 'âŒ 4-stelligen Code eingeben!', 'error'); return }
  showResult('result-code', 'ğŸ” Suche Code...', 'info')
  try {
    const { data, error } = await supabase.from('activated_coupons').select('*').eq('unique_code', code).eq('is_used', false).limit(1)
    if (error) throw error
    const activation = data && data[0]
    if (activation) {
      const { data: coupon } = await supabase.from('coupons').select('*').eq('id', activation.coupon_id).single()
      const { data: customer } = await supabase.from('customers').select('name, phone, qr_id, points').eq('id', activation.customer_id).single()
      activation.coupons = coupon
      activation.customers = customer
      await handleCouponCode(activation, code)
      return
    }
  } catch (e) {
    console.error('Coupon check error:', e)
  }
  try {
    const { data, error } = await supabase.from('redeem_codes').select('*').eq('code', code).limit(1)
    if (error) throw error
    if (!data || data.length === 0) throw new Error('Code nicht gefunden')
    const { data: customer } = await supabase.from('customers').select('name, phone, qr_id, points').eq('id', data[0].customer_id).single()
    data[0].customers = customer
    await handleRedeemCode(data[0], code)
  } catch (e) {
    showResult('result-code', 'âŒ ' + e.message, 'error')
    console.error('Code verification error:', e)
  }
}

async function handleCouponCode(activation, code) {
  try {
    const coupon = activation.coupons
    const customer = activation.customers
    if (new Date(coupon.expires_at) < new Date()) throw new Error('Coupon abgelaufen')
    const expires = new Date(coupon.expires_at).toLocaleDateString('de-DE')
    const price = parseFloat(coupon.price || 0).toFixed(2).replace('.', ',') + ' â‚¬'
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `<div class="code-item" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid #f59e0b;"><h3>ğŸŸï¸ ${coupon.title}</h3><div class="code">${code}</div><div style="font-size:14px;color:#92400e;margin:12px 0;"><strong>Produkt:</strong> ${coupon.product}<br><strong>Preis:</strong> ${price}<br><strong>Kunde:</strong> ${customer.name} (${customer.phone})<br><strong>Punkte:</strong> ${customer.points}<br><strong>GÃ¼ltig bis:</strong> ${expires}</div><button onclick="useCoupon('${activation.id}')" class="success" style="width:100%;margin-bottom:8px;">âœ… Coupon einlÃ¶sen</button><button onclick="cancelCodeConfirm()" class="secondary" style="width:100%;">âŒ Abbrechen</button></div>`
    showResult('result-code', 'âœ… Coupon gefunden!', 'success')
  } catch (e) {
    showResult('result-code', 'âŒ ' + e.message, 'error')
    document.getElementById('code-details').style.display = 'none'
    console.error('Handle coupon error:', e)
  }
}

async function handleRedeemCode(codeData, code) {
  try {
    currentCodeData = codeData
    if (codeData.used) throw new Error('Code bereits verwendet')
    if (new Date(codeData.valid_until) < new Date()) throw new Error('Code abgelaufen')
    const customer = codeData.customers
    const expires = new Date(codeData.valid_until).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
    showResult('result-code', 'âœ… PrÃ¤mien-Code gefunden!', 'success')
    document.getElementById('code-details').style.display = 'block'
    document.getElementById('code-details').innerHTML = `<div class="code-item"><h3>ğŸ ${codeData.reward_name}</h3><div class="code">${code}</div><div style="font-size:14px;color:#92400e;margin-bottom:16px;"><strong>Kunde:</strong> ${customer.name}<br><strong>Aktuell:</strong> ${customer.points} Punkte<br><strong>Kosten:</strong> ${codeData.points_cost} Punkte<br><strong>Danach:</strong> ${customer.points - codeData.points_cost} Punkte<br><strong>GÃ¼ltig bis:</strong> ${expires}</div><button onclick="confirmRedeemCode()" class="success" style="width:100%;margin-bottom:8px;">âœ… BestÃ¤tigen & Punkte abziehen</button><button onclick="cancelCodeConfirm()" class="secondary" style="width:100%;">âŒ Abbrechen</button></div>`
  } catch (e) {
    showResult('result-code', 'âŒ ' + e.message, 'error')
    console.error('Handle redeem error:', e)
  }
}

async function confirmRedeemCode() {
  if (!currentCodeData) return
  try {
    showResult('result-code', 'â³ BestÃ¤tige...', 'info')
    const newPoints = currentCodeData.customers.points - currentCodeData.points_cost
    await supabase.from('transactions').insert({ customer_id: currentCodeData.customer_id, type: 'redeem', amount: 0, points: -currentCodeData.points_cost, staff: 'Scanner', notes: `${currentCodeData.reward_name} (Code: ${currentCodeData.code})` })
    await supabase.from('customers').update({ points: newPoints }).eq('id', currentCodeData.customer_id)
    await supabase.from('redeem_codes').update({ used: true, used_at: new Date().toISOString() }).eq('code', currentCodeData.code)
    showResult('result-code', 'âœ… Code erfolgreich eingelÃ¶st!', 'success')
    document.getElementById('code').value = ''
    document.getElementById('code-details').style.display = 'none'
    currentCodeData = null
  } catch (e) {
    showResult('result-code', 'âŒ Fehler: ' + e.message, 'error')
    console.error('Confirm redeem error:', e)
  }
}

async function useCoupon(activationId) {
  try {
    showResult('result-code', 'â³ LÃ¶se Coupon ein...', 'info')
    await supabase.from('activated_coupons').update({ is_used: true, used_at: new Date().toISOString() }).eq('id', activationId)
    showResult('result-code', 'âœ… Coupon erfolgreich eingelÃ¶st!', 'success')
    document.getElementById('code').value = ''
    document.getElementById('code-details').style.display = 'none'
  } catch (e) {
    showResult('result-code', 'âŒ Fehler: ' + e.message, 'error')
    console.error('Use coupon error:', e)
  }
}

function cancelCodeConfirm() {
  document.getElementById('code-details').style.display = 'none'
  currentCodeData = null
  showResult('result-code', '', 'info')
}

async function editTransaction(txId, currentAmount, currentPoints, customerId) {
  const newAmount = prompt('Neuer Betrag in â‚¬ eingeben:', currentAmount)
  if (!newAmount || isNaN(newAmount)) return
  const amount = parseFloat(newAmount)
  const newPoints = Math.round(amount * 10)
  const pointsDiff = newPoints - currentPoints
  try {
    await supabase.from('transactions').update({ amount: amount, points: newPoints }).eq('id', txId)
    const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
    if (customer) { await supabase.from('customers').update({ points: customer.points + pointsDiff }).eq('id', customerId) }
    loadHistory()
    alert('âœ… Transaktion bearbeitet!')
  } catch (e) {
    alert('âŒ Fehler: ' + e.message)
    console.error('Edit transaction error:', e)
  }
}

async function deleteTransaction(txId, customerId, points) {
  if (!confirm('Transaktion wirklich lÃ¶schen? Punkte werden zurÃ¼ckgesetzt.')) return
  try {
    await supabase.from('transactions').delete().eq('id', txId)
    const { data: customer } = await supabase.from('customers').select('points').eq('id', customerId).single()
    if (customer) { await supabase.from('customers').update({ points: customer.points - points }).eq('id', customerId) }
    loadHistory()
    alert('âœ… Transaktion gelÃ¶scht!')
  } catch (e) {
    alert('âŒ Fehler: ' + e.message)
    console.error('Delete transaction error:', e)
  }
}

// ==========================================
// ğŸ¡ WHEEL CODE EINLÃ–SEN (NEU)
// ==========================================

async function redeemWheel() {
  const code = document.getElementById('wheel-code').value.trim()
  if (!code || code.length !== 4) { showResult('result-wheel', 'âŒ 4-stelligen Code eingeben!', 'error'); return }
  showResult('result-wheel', 'ğŸ” PrÃ¼fe Code...', 'info')
  try {
    const result = await redeemWheelCode(code, 'SCANNER')
    const customer = result.customer
    let msg = `âœ… <strong>CODE EINGELÃ–ST!</strong><br>ğŸ‘¤ ${customer.name}<br>ğŸ“± ${customer.phone}`
    if (result.points) {
      msg += `<br>â­ +${result.points} Punkte gutgeschrieben`
    } else if (result.reward) {
      msg += `<br>ğŸ PrÃ¤mie: ${result.reward}`
    } else if (result.discount) {
      msg += `<br>ğŸ’° Rabatt: ${result.discount}`
    }
    showResult('result-wheel', msg, 'success')
    document.getElementById('wheel-code').value = ''
  } catch (e) {
    showResult('result-wheel', `âŒ ${e.message}`, 'error')
  }
}

console.log('âœ… DÃ¶ner Boxx Scanner PRO geladen (mit Wheel Integration)')
console.log('ğŸ”’ Verwendet crypto.getRandomValues() fÃ¼r sichere Zufallszahlen')
</script>

</body>
</html>
